/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

//     Underscore.js 1.8.3
//     http://underscorejs.org
//     (c) 2009-2015 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     Underscore may be freely distributed under the MIT license.

/*
 * Copyright (c) 2012 Brandon Jones, Colin MacKenzie IV
 *
 * This software is provided 'as-is', without any express or implied
 * warranty. In no event will the authors be held liable for any damages
 * arising from the use of this software.
 *
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 *
 *    1. The origin of this software must not be misrepresented; you must not
 *    claim that you wrote the original software. If you use this software
 *    in a product, an acknowledgment in the product documentation would be
 *    appreciated but is not required.
 *
 *    2. Altered source versions must be plainly marked as such, and must not
 *    be misrepresented as being the original software.
 *
 *    3. This notice may not be removed or altered from any source
 *    distribution.
 */

/*! jQuery v1.11.1 | (c) 2005, 2014 jQuery Foundation, Inc. | jquery.org/license */

/*******************************************************************************
 * Copyright 2012-2015 CNES - CENTRE NATIONAL d'ETUDES SPATIALES
 *
 * This file is part of SITools2.
 *
 * SITools2 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SITools2 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SITools2. If not, see <http://www.gnu.org/licenses/>.
 ******************************************************************************/

!function(e,t){"function"==typeof define&&define.amd?define([],t):e.libGlobalName=t()}(this,function(){var e,t,r;return function(n){function i(e,t){return b.call(e,t)}function o(e,t){var r,n,i,o,a,s,l,u,h,c,d=t&&t.split("/"),f=y.map,p=f&&f["*"]||{};if(e&&"."===e.charAt(0))if(t){for(d=d.slice(0,d.length-1),e=d.concat(e.split("/")),u=0;u<e.length;u+=1)if(c=e[u],"."===c)e.splice(u,1),u-=1;else if(".."===c){if(1===u&&(".."===e[2]||".."===e[0]))break;u>0&&(e.splice(u-1,2),u-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((d||p)&&f){for(r=e.split("/"),u=r.length;u>0;u-=1){if(n=r.slice(0,u).join("/"),d)for(h=d.length;h>0;h-=1)if(i=f[d.slice(0,h).join("/")],i&&(i=i[n])){o=i,a=u;break}if(o)break;!s&&p&&p[n]&&(s=p[n],l=u)}!o&&s&&(o=s,a=l),o&&(r.splice(0,a,o),e=r.join("/"))}return e}function a(e,t){return function(){return f.apply(n,T.call(arguments,0).concat([e,t]))}}function s(e){return function(t){return o(t,e)}}function l(e){return function(t){v[e]=t}}function u(e){if(i(g,e)){var t=g[e];delete g[e],x[e]=!0,d.apply(n,t)}if(!i(v,e)&&!i(x,e))throw new Error("No "+e);return v[e]}function h(e){var t,r=e?e.indexOf("!"):-1;return r>-1&&(t=e.substring(0,r),e=e.substring(r+1,e.length)),[t,e]}function c(e){return function(){return y&&y.config&&y.config[e]||{}}}var d,f,p,m,v={},g={},y={},x={},b=Object.prototype.hasOwnProperty,T=[].slice;p=function(e,t){var r,n=h(e),i=n[0];return e=n[1],i&&(i=o(i,t),r=u(i)),i?e=r&&r.normalize?r.normalize(e,s(t)):o(e,t):(e=o(e,t),n=h(e),i=n[0],e=n[1],i&&(r=u(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:r}},m={require:function(e){return a(e)},exports:function(e){var t=v[e];return"undefined"!=typeof t?t:v[e]={}},module:function(e){return{id:e,uri:"",exports:v[e],config:c(e)}}},d=function(e,t,r,o){var s,h,c,d,f,y,b=[];if(o=o||e,"function"==typeof r){for(t=!t.length&&r.length?["require","exports","module"]:t,f=0;f<t.length;f+=1)if(d=p(t[f],o),h=d.f,"require"===h)b[f]=m.require(e);else if("exports"===h)b[f]=m.exports(e),y=!0;else if("module"===h)s=b[f]=m.module(e);else if(i(v,h)||i(g,h)||i(x,h))b[f]=u(h);else{if(!d.p)throw new Error(e+" missing "+h);d.p.load(d.n,a(o,!0),l(h),{}),b[f]=v[h]}c=r.apply(v[e],b),e&&(s&&s.exports!==n&&s.exports!==v[e]?v[e]=s.exports:c===n&&y||(v[e]=c))}else e&&(v[e]=r)},e=t=f=function(e,t,r,i,o){return"string"==typeof e?m[e]?m[e](t):u(p(e,t).f):(e.splice||(y=e,t.splice?(e=t,t=r,r=null):e=n),t=t||function(){},"function"==typeof r&&(r=i,i=o),i?d(n,e,t,r):setTimeout(function(){d(n,e,t,r)},4),f)},f.config=function(e){return y=e,y.deps&&f(y.deps,y.callback),f},r=function(e,t,r){t.splice||(r=t,t=[]),i(v,e)||i(g,e)||(g[e]=[e,t,r])},r.amd={jQuery:!0}}(),r("../build/almond",function(){}),r("Utils/Stats",[],function(){var e=function(e,t){this.type=null,e.planet.renderContext.stats=this,this.context=e;var r=t?t.element:void 0;r&&("string"==typeof r?(this.element=document.getElementById(r),this.type="dom"):(this.element=r,this.type="jquery")),this.showFPS=this.context.planet.continuousRendering,this.verbose=!(!t||!t.verbose)&&t.verbose,this.numFrames=0;var n=this;window.setInterval(function(){n.print()},1e3)};return e.prototype.start=function(e){this[e]=Date.now()},e.prototype.end=function(e){var t=Date.now()-this[e],r=this["max_"+e]||-1;r<t&&(r=t);var n=this["sum_"+e]||0;n+=t,this[e]=t,this["max_"+e]=r,this["sum_"+e]=n,"globalRenderTime"===e&&this.numFrames++},e.prototype.print=function(){if(this.numFrames>0){var e="";this.showFPS&&(e+="FPS : "+this.numFrames+"<br>"),e+="Average render time : "+(this.sum_globalRenderTime/this.numFrames).toFixed(2)+" ms",this.verbose&&(e+="<br>Average traverse tiles time : "+(this.sum_traverseTime/this.numFrames).toFixed(2)+" ms",e+="<br>Average render tiles time : "+(this.sum_renderTime/this.numFrames).toFixed(2)+" ms",e+="<br>Average generate tiles time : "+(this.sum_generateTime/this.numFrames).toFixed(2)+" ms",e+="<br>Average request tiles time : "+(this.sum_requestTime/this.numFrames).toFixed(2)+" ms",e+="<br>Max render time : "+this.max_globalRenderTime+" ms",e+="<br>Max traverse tiles time : "+this.max_traverseTime+" ms",e+="<br>Max render tiles time : "+this.max_renderTime+" ms",e+="<br>Max generate tiles time : "+this.max_generateTime+" ms",e+="<br>Max request tiles time : "+this.max_requestTime+" ms"),this.element&&("dom"===this.type?this.element.innerHTML=e:"jquery"===this.type&&this.element.html(e)),this.sum_globalRenderTime=0,this.sum_traverseTime=0,this.sum_renderTime=0,this.sum_generateTime=0,this.sum_requestTime=0,this.max_globalRenderTime=0,this.max_traverseTime=0,this.max_renderTime=0,this.max_generateTime=0,this.max_requestTime=0,this.numFrames=0}},e}),r("Utils/Constantes",[],function(){var e=function(){};return e.CONTEXT={Planet:"Planet",Sky:"Sky"},e.LAYER={WMS:"WMS",WMTS:"WMTS",WMSElevation:"WMSElevation",WCSElevation:"WCSElevation",Vector:"Vector",Atmosphere:"Atmosphere",Bing:"Bing",GroundOverlay:"GroundOverlay",OSM:"OSM",TileWireframe:"TileWireframe",CoordinateGrid:"CoordinateGrid",HipsFits:"HipsFits",Hips:"Hips",Moc:"Moc",OpenSearch:"OpenSearch",Planet:"Planet"},e.PROJECTION={Aitoff:"Aitoff",August:"August",Mercator:"Mercator",Mollweide:"Mollweide",Plate:"Plate",Azimuth:"Azimuth"},e}),function(){function e(e){function t(t,r,n,i,o,a){for(;o>=0&&a>o;o+=e){var s=i?i[o]:o;n=r(n,t[s],s,t)}return n}return function(r,n,i,o){n=b(n,o,4);var a=!E(r)&&x.keys(r),s=(a||r).length,l=e>0?0:s-1;return arguments.length<3&&(i=r[a?a[l]:l],l+=e),t(r,n,i,a,l,s)}}function t(e){return function(t,r,n){r=T(r,n);for(var i=C(t),o=e>0?0:i-1;o>=0&&i>o;o+=e)if(r(t[o],o,t))return o;return-1}}function n(e,t,r){return function(n,i,o){var a=0,s=C(n);if("number"==typeof o)e>0?a=o>=0?o:Math.max(o+s,a):s=o>=0?Math.min(o+1,s):o+s+1;else if(r&&o&&s)return o=r(n,i),n[o]===i?o:-1;if(i!==i)return o=t(c.call(n,a,s),x.isNaN),o>=0?o+a:-1;for(o=e>0?a:s-1;o>=0&&s>o;o+=e)if(n[o]===i)return o;return-1}}function i(e,t){var r=_.length,n=e.constructor,i=x.isFunction(n)&&n.prototype||l,o="constructor";for(x.has(e,o)&&!x.contains(t,o)&&t.push(o);r--;)o=_[r],o in e&&e[o]!==i[o]&&!x.contains(t,o)&&t.push(o)}var o=this,a=o._,s=Array.prototype,l=Object.prototype,u=Function.prototype,h=s.push,c=s.slice,d=l.toString,f=l.hasOwnProperty,p=Array.isArray,m=Object.keys,v=u.bind,g=Object.create,y=function(){},x=function(e){return e instanceof x?e:this instanceof x?void(this._wrapped=e):new x(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=x),exports._=x):o._=x,x.VERSION="1.8.3";var b=function(e,t,r){if(void 0===t)return e;switch(null==r?3:r){case 1:return function(r){return e.call(t,r)};case 2:return function(r,n){return e.call(t,r,n)};case 3:return function(r,n,i){return e.call(t,r,n,i)};case 4:return function(r,n,i,o){return e.call(t,r,n,i,o)}}return function(){return e.apply(t,arguments)}},T=function(e,t,r){return null==e?x.identity:x.isFunction(e)?b(e,t,r):x.isObject(e)?x.matcher(e):x.property(e)};x.iteratee=function(e,t){return T(e,t,1/0)};var w=function(e,t){return function(r){var n=arguments.length;if(2>n||null==r)return r;for(var i=1;n>i;i++)for(var o=arguments[i],a=e(o),s=a.length,l=0;s>l;l++){var u=a[l];t&&void 0!==r[u]||(r[u]=o[u])}return r}},S=function(e){if(!x.isObject(e))return{};if(g)return g(e);y.prototype=e;var t=new y;return y.prototype=null,t},A=function(e){return function(t){return null==t?void 0:t[e]}},M=Math.pow(2,53)-1,C=A("length"),E=function(e){var t=C(e);return"number"==typeof t&&t>=0&&M>=t};x.each=x.forEach=function(e,t,r){t=b(t,r);var n,i;if(E(e))for(n=0,i=e.length;i>n;n++)t(e[n],n,e);else{var o=x.keys(e);for(n=0,i=o.length;i>n;n++)t(e[o[n]],o[n],e)}return e},x.map=x.collect=function(e,t,r){t=T(t,r);for(var n=!E(e)&&x.keys(e),i=(n||e).length,o=Array(i),a=0;i>a;a++){var s=n?n[a]:a;o[a]=t(e[s],s,e)}return o},x.reduce=x.foldl=x.inject=e(1),x.reduceRight=x.foldr=e(-1),x.find=x.detect=function(e,t,r){var n;return n=E(e)?x.findIndex(e,t,r):x.findKey(e,t,r),void 0!==n&&n!==-1?e[n]:void 0},x.filter=x.select=function(e,t,r){var n=[];return t=T(t,r),x.each(e,function(e,r,i){t(e,r,i)&&n.push(e)}),n},x.reject=function(e,t,r){return x.filter(e,x.negate(T(t)),r)},x.every=x.all=function(e,t,r){t=T(t,r);for(var n=!E(e)&&x.keys(e),i=(n||e).length,o=0;i>o;o++){var a=n?n[o]:o;if(!t(e[a],a,e))return!1}return!0},x.some=x.any=function(e,t,r){t=T(t,r);for(var n=!E(e)&&x.keys(e),i=(n||e).length,o=0;i>o;o++){var a=n?n[o]:o;if(t(e[a],a,e))return!0}return!1},x.contains=x.includes=x.include=function(e,t,r,n){return E(e)||(e=x.values(e)),("number"!=typeof r||n)&&(r=0),x.indexOf(e,t,r)>=0},x.invoke=function(e,t){var r=c.call(arguments,2),n=x.isFunction(t);return x.map(e,function(e){var i=n?t:e[t];return null==i?i:i.apply(e,r)})},x.pluck=function(e,t){return x.map(e,x.property(t))},x.where=function(e,t){return x.filter(e,x.matcher(t))},x.findWhere=function(e,t){return x.find(e,x.matcher(t))},x.max=function(e,t,r){var n,i,o=-1/0,a=-1/0;if(null==t&&null!=e){e=E(e)?e:x.values(e);for(var s=0,l=e.length;l>s;s++)n=e[s],n>o&&(o=n)}else t=T(t,r),x.each(e,function(e,r,n){i=t(e,r,n),(i>a||i===-1/0&&o===-1/0)&&(o=e,a=i)});return o},x.min=function(e,t,r){var n,i,o=1/0,a=1/0;if(null==t&&null!=e){e=E(e)?e:x.values(e);for(var s=0,l=e.length;l>s;s++)n=e[s],o>n&&(o=n)}else t=T(t,r),x.each(e,function(e,r,n){i=t(e,r,n),(a>i||1/0===i&&1/0===o)&&(o=e,a=i)});return o},x.shuffle=function(e){for(var t,r=E(e)?e:x.values(e),n=r.length,i=Array(n),o=0;n>o;o++)t=x.random(0,o),t!==o&&(i[o]=i[t]),i[t]=r[o];return i},x.sample=function(e,t,r){return null==t||r?(E(e)||(e=x.values(e)),e[x.random(e.length-1)]):x.shuffle(e).slice(0,Math.max(0,t))},x.sortBy=function(e,t,r){return t=T(t,r),x.pluck(x.map(e,function(e,r,n){return{value:e,index:r,criteria:t(e,r,n)}}).sort(function(e,t){var r=e.criteria,n=t.criteria;if(r!==n){if(r>n||void 0===r)return 1;if(n>r||void 0===n)return-1}return e.index-t.index}),"value")};var P=function(e){return function(t,r,n){var i={};return r=T(r,n),x.each(t,function(n,o){var a=r(n,o,t);e(i,n,a)}),i}};x.groupBy=P(function(e,t,r){x.has(e,r)?e[r].push(t):e[r]=[t]}),x.indexBy=P(function(e,t,r){e[r]=t}),x.countBy=P(function(e,t,r){x.has(e,r)?e[r]++:e[r]=1}),x.toArray=function(e){return e?x.isArray(e)?c.call(e):E(e)?x.map(e,x.identity):x.values(e):[]},x.size=function(e){return null==e?0:E(e)?e.length:x.keys(e).length},x.partition=function(e,t,r){t=T(t,r);var n=[],i=[];return x.each(e,function(e,r,o){(t(e,r,o)?n:i).push(e)}),[n,i]},x.first=x.head=x.take=function(e,t,r){return null==e?void 0:null==t||r?e[0]:x.initial(e,e.length-t)},x.initial=function(e,t,r){return c.call(e,0,Math.max(0,e.length-(null==t||r?1:t)))},x.last=function(e,t,r){return null==e?void 0:null==t||r?e[e.length-1]:x.rest(e,Math.max(0,e.length-t))},x.rest=x.tail=x.drop=function(e,t,r){return c.call(e,null==t||r?1:t)},x.compact=function(e){return x.filter(e,x.identity)};var R=function(e,t,r,n){for(var i=[],o=0,a=n||0,s=C(e);s>a;a++){var l=e[a];if(E(l)&&(x.isArray(l)||x.isArguments(l))){t||(l=R(l,t,r));var u=0,h=l.length;for(i.length+=h;h>u;)i[o++]=l[u++]}else r||(i[o++]=l)}return i};x.flatten=function(e,t){return R(e,t,!1)},x.without=function(e){return x.difference(e,c.call(arguments,1))},x.uniq=x.unique=function(e,t,r,n){x.isBoolean(t)||(n=r,r=t,t=!1),null!=r&&(r=T(r,n));for(var i=[],o=[],a=0,s=C(e);s>a;a++){var l=e[a],u=r?r(l,a,e):l;t?(a&&o===u||i.push(l),o=u):r?x.contains(o,u)||(o.push(u),i.push(l)):x.contains(i,l)||i.push(l)}return i},x.union=function(){return x.uniq(R(arguments,!0,!0))},x.intersection=function(e){for(var t=[],r=arguments.length,n=0,i=C(e);i>n;n++){var o=e[n];if(!x.contains(t,o)){for(var a=1;r>a&&x.contains(arguments[a],o);a++);a===r&&t.push(o)}}return t},x.difference=function(e){var t=R(arguments,!0,!0,1);return x.filter(e,function(e){return!x.contains(t,e)})},x.zip=function(){return x.unzip(arguments)},x.unzip=function(e){for(var t=e&&x.max(e,C).length||0,r=Array(t),n=0;t>n;n++)r[n]=x.pluck(e,n);return r},x.object=function(e,t){for(var r={},n=0,i=C(e);i>n;n++)t?r[e[n]]=t[n]:r[e[n][0]]=e[n][1];return r},x.findIndex=t(1),x.findLastIndex=t(-1),x.sortedIndex=function(e,t,r,n){r=T(r,n,1);for(var i=r(t),o=0,a=C(e);a>o;){var s=Math.floor((o+a)/2);r(e[s])<i?o=s+1:a=s}return o},x.indexOf=n(1,x.findIndex,x.sortedIndex),x.lastIndexOf=n(-1,x.findLastIndex),x.range=function(e,t,r){null==t&&(t=e||0,e=0),r=r||1;for(var n=Math.max(Math.ceil((t-e)/r),0),i=Array(n),o=0;n>o;o++,e+=r)i[o]=e;return i};var L=function(e,t,r,n,i){if(!(n instanceof t))return e.apply(r,i);var o=S(e.prototype),a=e.apply(o,i);return x.isObject(a)?a:o};x.bind=function(e,t){if(v&&e.bind===v)return v.apply(e,c.call(arguments,1));if(!x.isFunction(e))throw new TypeError("Bind must be called on a function");var r=c.call(arguments,2),n=function(){return L(e,n,t,this,r.concat(c.call(arguments)))};return n},x.partial=function(e){var t=c.call(arguments,1),r=function(){for(var n=0,i=t.length,o=Array(i),a=0;i>a;a++)o[a]=t[a]===x?arguments[n++]:t[a];for(;n<arguments.length;)o.push(arguments[n++]);return L(e,r,this,this,o)};return r},x.bindAll=function(e){var t,r,n=arguments.length;if(1>=n)throw new Error("bindAll must be passed function names");for(t=1;n>t;t++)r=arguments[t],e[r]=x.bind(e[r],e);return e},x.memoize=function(e,t){var r=function(n){var i=r.cache,o=""+(t?t.apply(this,arguments):n);return x.has(i,o)||(i[o]=e.apply(this,arguments)),i[o]};return r.cache={},r},x.delay=function(e,t){var r=c.call(arguments,2);return setTimeout(function(){return e.apply(null,r)},t)},x.defer=x.partial(x.delay,x,1),x.throttle=function(e,t,r){var n,i,o,a=null,s=0;r||(r={});var l=function(){s=r.leading===!1?0:x.now(),a=null,o=e.apply(n,i),a||(n=i=null)};return function(){var u=x.now();s||r.leading!==!1||(s=u);var h=t-(u-s);return n=this,i=arguments,0>=h||h>t?(a&&(clearTimeout(a),a=null),s=u,o=e.apply(n,i),a||(n=i=null)):a||r.trailing===!1||(a=setTimeout(l,h)),o}},x.debounce=function(e,t,r){var n,i,o,a,s,l=function(){var u=x.now()-a;t>u&&u>=0?n=setTimeout(l,t-u):(n=null,r||(s=e.apply(o,i),n||(o=i=null)))};return function(){o=this,i=arguments,a=x.now();var u=r&&!n;return n||(n=setTimeout(l,t)),u&&(s=e.apply(o,i),o=i=null),s}},x.wrap=function(e,t){return x.partial(t,e)},x.negate=function(e){return function(){return!e.apply(this,arguments)}},x.compose=function(){var e=arguments,t=e.length-1;return function(){for(var r=t,n=e[t].apply(this,arguments);r--;)n=e[r].call(this,n);return n}},x.after=function(e,t){return function(){return--e<1?t.apply(this,arguments):void 0}},x.before=function(e,t){var r;return function(){return--e>0&&(r=t.apply(this,arguments)),1>=e&&(t=null),r}},x.once=x.partial(x.before,2);var I=!{toString:null}.propertyIsEnumerable("toString"),_=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];x.keys=function(e){if(!x.isObject(e))return[];if(m)return m(e);var t=[];for(var r in e)x.has(e,r)&&t.push(r);return I&&i(e,t),t},x.allKeys=function(e){if(!x.isObject(e))return[];var t=[];for(var r in e)t.push(r);return I&&i(e,t),t},x.values=function(e){for(var t=x.keys(e),r=t.length,n=Array(r),i=0;r>i;i++)n[i]=e[t[i]];return n},x.mapObject=function(e,t,r){t=T(t,r);for(var n,i=x.keys(e),o=i.length,a={},s=0;o>s;s++)n=i[s],a[n]=t(e[n],n,e);return a},x.pairs=function(e){for(var t=x.keys(e),r=t.length,n=Array(r),i=0;r>i;i++)n[i]=[t[i],e[t[i]]];return n},x.invert=function(e){for(var t={},r=x.keys(e),n=0,i=r.length;i>n;n++)t[e[r[n]]]=r[n];return t},x.functions=x.methods=function(e){var t=[];for(var r in e)x.isFunction(e[r])&&t.push(r);return t.sort()},x.extend=w(x.allKeys),x.extendOwn=x.assign=w(x.keys),x.findKey=function(e,t,r){t=T(t,r);for(var n,i=x.keys(e),o=0,a=i.length;a>o;o++)if(n=i[o],t(e[n],n,e))return n},x.pick=function(e,t,r){var n,i,o={},a=e;if(null==a)return o;x.isFunction(t)?(i=x.allKeys(a),n=b(t,r)):(i=R(arguments,!1,!1,1),n=function(e,t,r){return t in r},a=Object(a));for(var s=0,l=i.length;l>s;s++){var u=i[s],h=a[u];n(h,u,a)&&(o[u]=h)}return o},x.omit=function(e,t,r){if(x.isFunction(t))t=x.negate(t);else{var n=x.map(R(arguments,!1,!1,1),String);t=function(e,t){return!x.contains(n,t)}}return x.pick(e,t,r)},x.defaults=w(x.allKeys,!0),x.create=function(e,t){var r=S(e);return t&&x.extendOwn(r,t),r},x.clone=function(e){return x.isObject(e)?x.isArray(e)?e.slice():x.extend({},e):e},x.tap=function(e,t){return t(e),e},x.isMatch=function(e,t){var r=x.keys(t),n=r.length;if(null==e)return!n;for(var i=Object(e),o=0;n>o;o++){var a=r[o];if(t[a]!==i[a]||!(a in i))return!1}return!0};var F=function(e,t,r,n){if(e===t)return 0!==e||1/e===1/t;if(null==e||null==t)return e===t;e instanceof x&&(e=e._wrapped),t instanceof x&&(t=t._wrapped);var i=d.call(e);if(i!==d.call(t))return!1;switch(i){case"[object RegExp]":case"[object String]":return""+e==""+t;case"[object Number]":return+e!==+e?+t!==+t:0===+e?1/+e===1/t:+e===+t;case"[object Date]":case"[object Boolean]":return+e===+t}var o="[object Array]"===i;if(!o){if("object"!=typeof e||"object"!=typeof t)return!1;var a=e.constructor,s=t.constructor;if(a!==s&&!(x.isFunction(a)&&a instanceof a&&x.isFunction(s)&&s instanceof s)&&"constructor"in e&&"constructor"in t)return!1}r=r||[],n=n||[];for(var l=r.length;l--;)if(r[l]===e)return n[l]===t;if(r.push(e),n.push(t),o){if(l=e.length,l!==t.length)return!1;for(;l--;)if(!F(e[l],t[l],r,n))return!1}else{var u,h=x.keys(e);if(l=h.length,x.keys(t).length!==l)return!1;for(;l--;)if(u=h[l],!x.has(t,u)||!F(e[u],t[u],r,n))return!1}return r.pop(),n.pop(),!0};x.isEqual=function(e,t){return F(e,t)},x.isEmpty=function(e){return null==e||(E(e)&&(x.isArray(e)||x.isString(e)||x.isArguments(e))?0===e.length:0===x.keys(e).length)},x.isElement=function(e){return!(!e||1!==e.nodeType)},x.isArray=p||function(e){return"[object Array]"===d.call(e)},x.isObject=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},x.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(e){x["is"+e]=function(t){return d.call(t)==="[object "+e+"]"}}),x.isArguments(arguments)||(x.isArguments=function(e){return x.has(e,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(x.isFunction=function(e){return"function"==typeof e||!1}),x.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},x.isNaN=function(e){return x.isNumber(e)&&e!==+e},x.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"===d.call(e)},x.isNull=function(e){return null===e},x.isUndefined=function(e){return void 0===e},x.has=function(e,t){return null!=e&&f.call(e,t)},x.noConflict=function(){return o._=a,this},x.identity=function(e){return e},x.constant=function(e){return function(){return e}},x.noop=function(){},x.property=A,x.propertyOf=function(e){return null==e?function(){}:function(t){return e[t]}},x.matcher=x.matches=function(e){return e=x.extendOwn({},e),function(t){return x.isMatch(t,e)}},x.times=function(e,t,r){var n=Array(Math.max(0,e));t=b(t,r,1);for(var i=0;e>i;i++)n[i]=t(i);return n},x.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))},x.now=Date.now||function(){return(new Date).getTime()};var k={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},B=x.invert(k),N=function(e){var t=function(t){return e[t]},r="(?:"+x.keys(e).join("|")+")",n=RegExp(r),i=RegExp(r,"g");return function(e){return e=null==e?"":""+e,n.test(e)?e.replace(i,t):e}};x.escape=N(k),x.unescape=N(B),x.result=function(e,t,r){var n=null==e?void 0:e[t];return void 0===n&&(n=r),x.isFunction(n)?n.call(e):n};var D=0;x.uniqueId=function(e){var t=++D+"";return e?e+t:t},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var O=/(.)^/,U={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},j=/\\|'|\r|\n|\u2028|\u2029/g,q=function(e){return"\\"+U[e]};x.template=function(e,t,r){!t&&r&&(t=r),t=x.defaults({},t,x.templateSettings);var n=RegExp([(t.escape||O).source,(t.interpolate||O).source,(t.evaluate||O).source].join("|")+"|$","g"),i=0,o="__p+='";e.replace(n,function(t,r,n,a,s){return o+=e.slice(i,s).replace(j,q),i=s+t.length,r?o+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'":n?o+="'+\n((__t=("+n+"))==null?'':__t)+\n'":a&&(o+="';\n"+a+"\n__p+='"),t}),o+="';\n",t.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{var a=new Function(t.variable||"obj","_",o)}catch(e){throw e.source=o,e}var s=function(e){return a.call(this,e,x)},l=t.variable||"obj";return s.source="function("+l+"){\n"+o+"}",s},x.chain=function(e){var t=x(e);return t._chain=!0,t};var G=function(e,t){return e._chain?x(t).chain():t};x.mixin=function(e){x.each(x.functions(e),function(t){var r=x[t]=e[t];x.prototype[t]=function(){var e=[this._wrapped];return h.apply(e,arguments),G(this,r.apply(x,e))}})},x.mixin(x),x.each(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=s[e];x.prototype[e]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!==e&&"splice"!==e||0!==r.length||delete r[0],G(this,r)}}),x.each(["concat","join","slice"],function(e){var t=s[e];x.prototype[e]=function(){return G(this,t.apply(this._wrapped,arguments))}}),x.prototype.value=function(){return this._wrapped},x.prototype.valueOf=x.prototype.toJSON=x.prototype.value,x.prototype.toString=function(){return""+this._wrapped},"function"==typeof r&&r.amd&&r("underscore",[],function(){return x})}.call(this),r("underscore-min",function(){}),r("Utils/Numeric",[],function(){var e={};return e.lerp=function(e,t,r){return t+(r-t)*e},e.coserp=function(e,t,r){var n=(1-Math.cos(e*Math.PI))/2;return t+(r-t)*n},e.cubicInterpolation=function(e,t,r,n,i){var o=e*e,a=o*e,s=2*t[0]-2*n[0]+r[0]+i[0],l=2*t[1]-2*n[1]+r[1]+i[1],u=2*t[2]-2*n[2]+r[2]+i[2],h=-3*t[0]+3*n[0]-2*r[0]-i[0],c=-3*t[1]+3*n[1]-2*r[1]-i[1],d=-3*t[2]+3*n[2]-2*r[2]-i[2],f=vec3.create();return f[0]=s*a+h*o+r[0]*e+t[0],f[1]=l*a+c*o+r[1]*e+t[1],f[2]=u*a+d*o+r[2]*e+t[2],f},e.cubicInterpolationDerivative=function(e,t,r,n,i){var o=e*e,a=6*t[0]-6*n[0]+3*r[0]+3*i[0],s=6*t[1]-6*n[1]+3*r[1]+3*i[1],l=6*t[2]-6*n[2]+3*r[2]+3*i[2],u=-6*t[0]+6*n[0]-4*r[0]-2*i[0],h=-6*t[1]+6*n[1]-4*r[1]-2*i[1],c=-6*t[2]+6*n[2]-4*r[2]-2*i[2],d=vec3.create();return d[0]=a*o+u*e+r[0],d[1]=s*o+h*e+r[1],d[2]=l*o+c*e+r[2],d},e.map01=function(e,t,r){return t!==r?(e-t)/(r-t):0},e.mapLinear=function(t,r,n,i,o){return e.lerp(e.map01(t,r,n),i,o)},e.easeInQuad=function(e){return e*e},e.easeOutQuad=function(e){var t=e-1;return 1-t*t},e.easeInOutQuad=function(e){var t=e;return t<.5?(t+=t,t=.5*(t*t)):(t=t+t-2,t=.5*(1-t*t),t=.5+t),t},e.easeOutInQuad=function(e){var t=e;return t<.5?(t=t+t-1,t=.5*(1-t*t)):(t=t+t-1,t=.5*(t*t),t=.5+t),t},e.toRadian=function(e){return e*Math.PI/180},e.toDegree=function(e){return 180*e/Math.PI},e.lineIntersection=function(e,t,r,n,i,o,a,s){var l=(s-o)*(r-e)-(a-i)*(n-t);if(0===l)return[-1,-1];var u=(a-i)*(t-o)-(s-o)*(e-i),h=(r-e)*(t-o)-(n-t)*(e-i);return u/=l,h/=l,[u,h]},e.roundNumber=function(e,t){var r=Math.round(e*Math.pow(10,t))/Math.pow(10,t);return r},e}),r("CoordinateSystem/Geoide",[],function(){var e=function(e){this.radius=e&&e.hasOwnProperty("radius")?e.radius:1,this.realPlanetRadius=e&&e.hasOwnProperty("realPlanetRadius")?e.realPlanetRadius:6356752.3142,this.heightScale=1/this.realPlanetRadius};return e.prototype.getRealPlanetRadius=function(){return this.realPlanetRadius},e.prototype.setRealPlanetRadius=function(e){this.realPlanetRadius=e},e.prototype.getRadius=function(){return this.radius},e.prototype.setRadius=function(e){this.radius=e},e.prototype.getHeightScale=function(){return this.heightScale},e}),r("CoordinateSystem/CoordinateSystem",["../Utils/Numeric","./Geoide"],function(e,t){var r=function(e){if(this.geoide=null,this.projectionName=null,this.geoBound=[-180,-90,180,90],e&&e.geoideName){var r={};"WGS84"===e.geoideName?(r.radius=1,r.realPlanetRadius=6356752.3142):"Mars"===e.geoideName?(r.radius=1,r.realPlanetRadius=6356752.3142):"Sky"===e.geoideName&&(r.radius=10),this.geoide=new t(r)}else e&&e.geoide?this.geoide=e.geoide:(console.log("Info : no geoide provided in coordinate system constructor, set it to Earth"),this.geoide=new t({radius:1,realPlanetRadius:6356752.3142}));e&&e.projectionName&&(this.projectionName=e.projectionName),this.isFlat=null!==this.projectionName};return r.prototype.getVerticalAt3D=function(e,t){return t||(t=new Array(3)),this.isFlat?(t[0]=0,t[1]=0,t[2]=1):vec3.normalize(e,t),t},r.prototype.fromGeoTo3D=function(t,r){r||(r=new Array(3)),t.length<2&&console.log("Erreur !");var n=e.toRadian(t[0]),i=e.toRadian(t[1]),o=Math.cos(i),a=t.length>2?this.geoide.heightScale*t[2]:0,s=this.geoide.radius+a;return r[0]=s*Math.cos(n)*o,r[1]=s*Math.sin(n)*o,r[2]=s*Math.sin(i),r},r.prototype.from3DToGeo=function(t,r){r||(r=new Array(3));var n=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=Math.atan2(t[1]/n,t[0]/n),o=Math.asin(t[2]/n);return r[0]=e.toDegree(i),r[1]=e.toDegree(o),r[2]=this.geoide.getRealPlanetRadius()*(n-this.geoide.getRadius()),r},r.prototype.getLocalTransform=function(e,t){t||(t=mat4.create());var r=e[0]*Math.PI/180,n=e[1]*Math.PI/180,i=[Math.cos(r)*Math.cos(n),Math.sin(r)*Math.cos(n),Math.sin(n)],o=[-Math.sin(r),Math.cos(r),0],a=vec3.create();return vec3.cross(i,o,a),t[0]=o[0],t[1]=o[1],t[2]=o[2],t[3]=0,t[4]=a[0],t[5]=a[1],t[6]=a[2],t[7]=0,t[8]=i[0],t[9]=i[1],t[10]=i[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},r.prototype.getLHVTransform=function(e,t){t||(t=mat4.create());var r=e[0]*Math.PI/180,n=e[1]*Math.PI/180,i=[Math.cos(r)*Math.cos(n),Math.sin(r)*Math.cos(n),Math.sin(n)],o=[-Math.sin(r),Math.cos(r),0],a=vec3.create();vec3.cross(i,o,a);var s=this.fromGeoTo3D(e);return t[0]=o[0],t[1]=o[1],t[2]=o[2],t[3]=0,t[4]=a[0],t[5]=a[1],t[6]=a[2],t[7]=0,t[8]=i[0],t[9]=i[1],t[10]=i[2],t[11]=0,t[12]=s[0],t[13]=s[1],t[14]=s[2],t[15]=1,t},r.prototype.getSideVector=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},r.prototype.getFrontVector=function(e,t){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t},r.prototype.getUpVector=function(e,t){return t[0]=e[8],t[1]=e[9],t[2]=e[10],t},r}),r("Renderer/glMatrix",[],function(){var e=1e-6,t=Array,r={};r.create=function(e){var r=new t(3);return e?(r[0]=e[0],r[1]=e[1],r[2]=e[2]):r[0]=r[1]=r[2]=0,r},r.createFrom=function(e,r,n){var i=new t(3);return i[0]=e,i[1]=r,i[2]=n,i},r.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},r.equal=function(t,r){return t===r||Math.abs(t[0]-r[0])<e&&Math.abs(t[1]-r[1])<e&&Math.abs(t[2]-r[2])<e},r.add=function(e,t,r){return r&&e!==r?(r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r):(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e)},r.subtract=function(e,t,r){return r&&e!==r?(r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r):(e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],e)},r.multiply=function(e,t,r){return r&&e!==r?(r[0]=e[0]*t[0],r[1]=e[1]*t[1],r[2]=e[2]*t[2],r):(e[0]*=t[0],e[1]*=t[1],e[2]*=t[2],e)},r.negate=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},r.scale=function(e,t,r){return r&&e!==r?(r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r):(e[0]*=t,e[1]*=t,e[2]*=t,e)},r.normalize=function(e,t){t||(t=e);var r=e[0],n=e[1],i=e[2],o=Math.sqrt(r*r+n*n+i*i);return o?1===o?(t[0]=r,t[1]=n,t[2]=i,t):(o=1/o,t[0]=r*o,t[1]=n*o,t[2]=i*o,t):(t[0]=0,t[1]=0,t[2]=0,t)},r.cross=function(e,t,r){r||(r=e);var n=e[0],i=e[1],o=e[2],a=t[0],s=t[1],l=t[2];return r[0]=i*l-o*s,r[1]=o*a-n*l,r[2]=n*s-i*a,r},r.length=function(e){var t=e[0],r=e[1],n=e[2];return Math.sqrt(t*t+r*r+n*n)},r.squaredLength=function(e){var t=e[0],r=e[1],n=e[2];return t*t+r*r+n*n},r.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},r.lerp=function(e,t,r,n){return n||(n=e),n[0]=e[0]+r*(t[0]-e[0]),n[1]=e[1]+r*(t[1]-e[1]),n[2]=e[2]+r*(t[2]-e[2]),n},r.dist=function(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(r*r+n*n+i*i)},r.angle=function(e,t){return Math.atan2(r.length(r.cross(e,t)),r.dot(e,t))},r.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]"},r.createZPhi=function(e,t){var n=Math.sqrt((1-e)*(1+e)),i=n*Math.cos(t),o=n*Math.sin(t);return r.createFrom(i,o,e)},r.createPhiTheta=function(e,t){var n=Math.sin(t),i=n*Math.cos(e),o=n*Math.sin(e),a=n*Math.cos(t);return r.createFrom(i,o,a)},r.add2=function(e,t){var r=e[0],n=e[1],i=e[2],o=t[0],a=t[1],s=t[2];return[r+o,n+a,i+s]},r.subtract2=function(e,t){var r=e[0],n=e[1],i=e[2],o=t[0],a=t[1],s=t[2];return[r-o,n-a,i-s]},r.flip=function(e){var t=e[0],r=e[1],n=e[2];return[t=-t,r=-r,n=-n]},r.scale2=function(e,t){var r=e.x,n=e.y,i=e.z;return{x:r*t,y:n*=t,z:i*=t}},r.normalize2=function(e){var t=e[0],r=e[1],n=e[2],i=1/Math.sqrt(t*t+r*r+n*n);return[t*=i,r*=i,n*=i]},r.cross2=function(e,t){return{x:e[1]*t[2]-t[1]*e[2],y:e[2]*t[0]-t[2]*e[0],z:e[0]*t[1]-t[0]*e[1]}},r.length2=function(e){var t=e.x,r=e.y,n=e.z;return Math.sqrt(t*t+r*r+n*n)},r.dot2=function(e,t){var r=void 0!==e.x?e.x:e[0],n=void 0!==e.y?e.y:e[1],i=void 0!==e.z?e.z:e[2],o=void 0!==t.x?t.x:t[0],a=void 0!==t.y?t.y:t[1],s=void 0!==t.z?t.z:t[2];return r*o+n*a+i*s},r.angle2=function(e,t){return Math.atan2(r.length2(r.cross2(e,t)),r.dot2(e,t))};var n={};n.create=function(e){var r=new t(9);return e&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8]),r};var i={};i.create=function(e){var r=new t(16);return e&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r},i.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},i.identity=function(e){return e||(e=i.create()),e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},i.transpose=function(e,t){if(!t||e===t){var r=e[1],n=e[2],i=e[3],o=e[6],a=e[7],s=e[11];return e[1]=e[4],e[2]=e[8],e[3]=e[12],e[4]=r,e[6]=e[9],e[7]=e[13],e[8]=n,e[9]=o,e[11]=e[14],e[12]=i,e[13]=a,e[14]=s,e}return t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},i.determinant=function(e){var t=e[0],r=e[1],n=e[2],i=e[3],o=e[4],a=e[5],s=e[6],l=e[7],u=e[8],h=e[9],c=e[10],d=e[11],f=e[12],p=e[13],m=e[14],v=e[15];return f*h*s*i-u*p*s*i-f*a*c*i+o*p*c*i+u*a*m*i-o*h*m*i-f*h*n*l+u*p*n*l+f*r*c*l-t*p*c*l-u*r*m*l+t*h*m*l+f*a*n*d-o*p*n*d-f*r*s*d+t*p*s*d+o*r*m*d-t*a*m*d-u*a*n*v+o*h*n*v+u*r*s*v-t*h*s*v-o*r*c*v+t*a*c*v},i.inverse=function(e,t){t||(t=e);var r,n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],l=e[5],u=e[6],h=e[7],c=e[8],d=e[9],f=e[10],p=e[11],m=e[12],v=e[13],g=e[14],y=e[15],x=n*l-i*s,b=n*u-o*s,T=n*h-a*s,w=i*u-o*l,S=i*h-a*l,A=o*h-a*u,M=c*v-d*m,C=c*g-f*m,E=c*y-p*m,P=d*g-f*v,R=d*y-p*v,L=f*y-p*g,I=x*L-b*R+T*P+w*E-S*C+A*M;return I?(r=1/I,t[0]=(l*L-u*R+h*P)*r,t[1]=(-i*L+o*R-a*P)*r,t[2]=(v*A-g*S+y*w)*r,t[3]=(-d*A+f*S-p*w)*r,t[4]=(-s*L+u*E-h*C)*r,t[5]=(n*L-o*E+a*C)*r,t[6]=(-m*A+g*T-y*b)*r,t[7]=(c*A-f*T+p*b)*r,t[8]=(s*R-l*E+h*M)*r,t[9]=(-n*R+i*E-a*M)*r,t[10]=(m*S-v*T+y*x)*r,t[11]=(-c*S+d*T-p*x)*r,t[12]=(-s*P+l*C-u*M)*r,t[13]=(n*P-i*C+o*M)*r,t[14]=(-m*w+v*b-g*x)*r,t[15]=(c*w-d*b+f*x)*r,t):null},i.toRotationMat=function(e,t){return t||(t=i.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},i.toMat3=function(e,t){return t||(t=n.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},i.multiply=function(e,t,r){r||(r=e);var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],l=e[5],u=e[6],h=e[7],c=e[8],d=e[9],f=e[10],p=e[11],m=e[12],v=e[13],g=e[14],y=e[15],x=t[0],b=t[1],T=t[2],w=t[3];return r[0]=x*n+b*s+T*c+w*m,r[1]=x*i+b*l+T*d+w*v,r[2]=x*o+b*u+T*f+w*g,r[3]=x*a+b*h+T*p+w*y,x=t[4],b=t[5],T=t[6],w=t[7],r[4]=x*n+b*s+T*c+w*m,r[5]=x*i+b*l+T*d+w*v,r[6]=x*o+b*u+T*f+w*g,r[7]=x*a+b*h+T*p+w*y,x=t[8],b=t[9],T=t[10],w=t[11],r[8]=x*n+b*s+T*c+w*m,r[9]=x*i+b*l+T*d+w*v,r[10]=x*o+b*u+T*f+w*g,r[11]=x*a+b*h+T*p+w*y,x=t[12],b=t[13],T=t[14],w=t[15],r[12]=x*n+b*s+T*c+w*m,r[13]=x*i+b*l+T*d+w*v,r[14]=x*o+b*u+T*f+w*g,
r[15]=x*a+b*h+T*p+w*y,r},i.multiplyVec3=function(e,t,r){r||(r=t);var n=t[0],i=t[1],o=t[2];return r[0]=e[0]*n+e[4]*i+e[8]*o+e[12],r[1]=e[1]*n+e[5]*i+e[9]*o+e[13],r[2]=e[2]*n+e[6]*i+e[10]*o+e[14],r},i.multiplyVec4=function(e,t,r){r||(r=t);var n=t[0],i=t[1],o=t[2],a=t[3];return r[0]=e[0]*n+e[4]*i+e[8]*o+e[12]*a,r[1]=e[1]*n+e[5]*i+e[9]*o+e[13]*a,r[2]=e[2]*n+e[6]*i+e[10]*o+e[14]*a,r[3]=e[3]*n+e[7]*i+e[11]*o+e[15]*a,r},i.project=function(e,t,r){r||(r=t),i.multiplyVec4(e,t,r);var n=1/r[3];return r[0]*=n,r[1]*=n,r[2]*=n,r},i.rotateVec3=function(e,t,r){r||(r=t);var n=t[0],i=t[1],o=t[2];return r[0]=e[0]*n+e[4]*i+e[8]*o,r[1]=e[1]*n+e[5]*i+e[9]*o,r[2]=e[2]*n+e[6]*i+e[10]*o,r},i.translate=function(e,t,r){var n,i,o,a,s,l,u,h,c,d,f,p,m=t[0],v=t[1],g=t[2];return r&&e!==r?(n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],l=e[5],u=e[6],h=e[7],c=e[8],d=e[9],f=e[10],p=e[11],r[0]=n,r[1]=i,r[2]=o,r[3]=a,r[4]=s,r[5]=l,r[6]=u,r[7]=h,r[8]=c,r[9]=d,r[10]=f,r[11]=p,r[12]=n*m+s*v+c*g+e[12],r[13]=i*m+l*v+d*g+e[13],r[14]=o*m+u*v+f*g+e[14],r[15]=a*m+h*v+p*g+e[15],r):(e[12]=e[0]*m+e[4]*v+e[8]*g+e[12],e[13]=e[1]*m+e[5]*v+e[9]*g+e[13],e[14]=e[2]*m+e[6]*v+e[10]*g+e[14],e[15]=e[3]*m+e[7]*v+e[11]*g+e[15],e)},i.scale=function(e,t,r){var n=t[0],i=t[1],o=t[2];return r&&e!==r?(r[0]=e[0]*n,r[1]=e[1]*n,r[2]=e[2]*n,r[3]=e[3]*n,r[4]=e[4]*i,r[5]=e[5]*i,r[6]=e[6]*i,r[7]=e[7]*i,r[8]=e[8]*o,r[9]=e[9]*o,r[10]=e[10]*o,r[11]=e[11]*o,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r):(e[0]*=n,e[1]*=n,e[2]*=n,e[3]*=n,e[4]*=i,e[5]*=i,e[6]*=i,e[7]*=i,e[8]*=o,e[9]*=o,e[10]*=o,e[11]*=o,e)},i.rotate=function(e,t,r,n){var i,o,a,s,l,u,h,c,d,f,p,m,v,g,y,x,b,T,w,S,A,M,C,E,P=r[0],R=r[1],L=r[2],I=Math.sqrt(P*P+R*R+L*L);return I?(1!==I&&(I=1/I,P*=I,R*=I,L*=I),i=Math.sin(t),o=Math.cos(t),a=1-o,s=e[0],l=e[1],u=e[2],h=e[3],c=e[4],d=e[5],f=e[6],p=e[7],m=e[8],v=e[9],g=e[10],y=e[11],x=P*P*a+o,b=R*P*a+L*i,T=L*P*a-R*i,w=P*R*a-L*i,S=R*R*a+o,A=L*R*a+P*i,M=P*L*a+R*i,C=R*L*a-P*i,E=L*L*a+o,n?e!==n&&(n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[0]=s*x+c*b+m*T,n[1]=l*x+d*b+v*T,n[2]=u*x+f*b+g*T,n[3]=h*x+p*b+y*T,n[4]=s*w+c*S+m*A,n[5]=l*w+d*S+v*A,n[6]=u*w+f*S+g*A,n[7]=h*w+p*S+y*A,n[8]=s*M+c*C+m*E,n[9]=l*M+d*C+v*E,n[10]=u*M+f*C+g*E,n[11]=h*M+p*C+y*E,n):null},i.rotateX=function(e,t,r){var n=Math.sin(t),i=Math.cos(t),o=e[4],a=e[5],s=e[6],l=e[7],u=e[8],h=e[9],c=e[10],d=e[11];return r?e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[4]=o*i+u*n,r[5]=a*i+h*n,r[6]=s*i+c*n,r[7]=l*i+d*n,r[8]=o*-n+u*i,r[9]=a*-n+h*i,r[10]=s*-n+c*i,r[11]=l*-n+d*i,r},i.rotateY=function(e,t,r){var n=Math.sin(t),i=Math.cos(t),o=e[0],a=e[1],s=e[2],l=e[3],u=e[8],h=e[9],c=e[10],d=e[11];return r?e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=o*i+u*-n,r[1]=a*i+h*-n,r[2]=s*i+c*-n,r[3]=l*i+d*-n,r[8]=o*n+u*i,r[9]=a*n+h*i,r[10]=s*n+c*i,r[11]=l*n+d*i,r},i.rotateZ=function(e,t,r){var n=Math.sin(t),i=Math.cos(t),o=e[0],a=e[1],s=e[2],l=e[3],u=e[4],h=e[5],c=e[6],d=e[7];return r?e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=o*i+u*n,r[1]=a*i+h*n,r[2]=s*i+c*n,r[3]=l*i+d*n,r[4]=o*-n+u*i,r[5]=a*-n+h*i,r[6]=s*-n+c*i,r[7]=l*-n+d*i,r},i.frustum=function(e,t,r,n,o,a,s){s||(s=i.create());var l=t-e,u=n-r,h=a-o;return s[0]=2*o/l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2*o/u,s[6]=0,s[7]=0,s[8]=(t+e)/l,s[9]=(n+r)/u,s[10]=-(a+o)/h,s[11]=-1,s[12]=0,s[13]=0,s[14]=-(a*o*2)/h,s[15]=0,s},i.perspective=function(e,t,r,n,o){var a=r*Math.tan(e*Math.PI/360),s=a*t;return i.frustum(-s,s,-a,a,r,n,o)},i.ortho=function(e,t,r,n,o,a,s){s||(s=i.create());var l=t-e,u=n-r,h=a-o;return s[0]=2/l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2/u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=-2/h,s[11]=0,s[12]=-(e+t)/l,s[13]=-(n+r)/u,s[14]=-(a+o)/h,s[15]=1,s},i.lookAt=function(e,t,r,n){n||(n=i.create());var o,a,s,l,u,h,c,d,f,p,m=e[0],v=e[1],g=e[2],y=r[0],x=r[1],b=r[2],T=t[0],w=t[1],S=t[2];return m===T&&v===w&&g===S?i.identity(n):(c=m-T,d=v-w,f=g-S,p=1/Math.sqrt(c*c+d*d+f*f),c*=p,d*=p,f*=p,o=x*f-b*d,a=b*c-y*f,s=y*d-x*c,p=Math.sqrt(o*o+a*a+s*s),p?(p=1/p,o*=p,a*=p,s*=p):(o=0,a=0,s=0),l=d*s-f*a,u=f*o-c*s,h=c*a-d*o,p=Math.sqrt(l*l+u*u+h*h),p?(p=1/p,l*=p,u*=p,h*=p):(l=0,u=0,h=0),n[0]=o,n[1]=l,n[2]=c,n[3]=0,n[4]=a,n[5]=u,n[6]=d,n[7]=0,n[8]=s,n[9]=h,n[10]=f,n[11]=0,n[12]=-(o*m+a*v+s*g),n[13]=-(l*m+u*v+h*g),n[14]=-(c*m+d*v+f*g),n[15]=1,n)},i.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]"};var o={};return o.create=function(e){var r=new t(4);return e?(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3]):r[0]=r[1]=r[2]=r[3]=0,r},o.createFrom=function(e,r,n,i){var o=new t(4);return o[0]=e,o[1]=r,o[2]=n,o[3]=i,o},o.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},o.equal=function(t,r){return t===r||Math.abs(t[0]-r[0])<e&&Math.abs(t[1]-r[1])<e&&Math.abs(t[2]-r[2])<e&&Math.abs(t[3]-r[3])<e},o.identity=function(e){return e||(e=o.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},o.calculateW=function(e,t){var r=e[0],n=e[1],i=e[2];return t&&e!==t?(t[0]=r,t[1]=n,t[2]=i,t[3]=-Math.sqrt(Math.abs(1-r*r-n*n-i*i)),t):(e[3]=-Math.sqrt(Math.abs(1-r*r-n*n-i*i)),e)},o.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},o.inverse=function(e,t){var r=e[0],n=e[1],i=e[2],o=e[3],a=r*r+n*n+i*i+o*o,s=a?1/a:0;return t&&e!==t?(t[0]=-e[0]*s,t[1]=-e[1]*s,t[2]=-e[2]*s,t[3]=e[3]*s,t):(e[0]*=-s,e[1]*=-s,e[2]*=-s,e[3]*=s,e)},o.conjugate=function(e,t){return t&&e!==t?(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t):(e[0]*=-1,e[1]*=-1,e[2]*=-1,e)},o.length=function(e){var t=e[0],r=e[1],n=e[2],i=e[3];return Math.sqrt(t*t+r*r+n*n+i*i)},o.normalize=function(e,t){t||(t=e);var r=e[0],n=e[1],i=e[2],o=e[3],a=Math.sqrt(r*r+n*n+i*i+o*o);return 0===a?(t[0]=0,t[1]=0,t[2]=0,t[3]=0,t):(a=1/a,t[0]=r*a,t[1]=n*a,t[2]=i*a,t[3]=o*a,t)},o.add=function(e,t,r){return r&&e!==r?(r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r[3]=e[3]+t[3],r):(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[3],e)},o.multiply=function(e,t,r){r||(r=e);var n=e[0],i=e[1],o=e[2],a=e[3],s=t[0],l=t[1],u=t[2],h=t[3];return r[0]=n*h+a*s+i*u-o*l,r[1]=i*h+a*l+o*s-n*u,r[2]=o*h+a*u+n*l-i*s,r[3]=a*h-n*s-i*l-o*u,r},o.multiplyVec3=function(e,t,r){r||(r=t);var n=t[0],i=t[1],o=t[2],a=e[0],s=e[1],l=e[2],u=e[3],h=u*n+s*o-l*i,c=u*i+l*n-a*o,d=u*o+a*i-s*n,f=-a*n-s*i-l*o;return r[0]=h*u+f*-a+c*-l-d*-s,r[1]=c*u+f*-s+d*-a-h*-l,r[2]=d*u+f*-l+h*-s-c*-a,r},o.scale=function(e,t,r){return r&&e!==r?(r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r[3]=e[3]*t,r):(e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e)},o.toMat4=function(e,t){t||(t=i.create());var r=e[0],n=e[1],o=e[2],a=e[3],s=r+r,l=n+n,u=o+o,h=r*s,c=r*l,d=r*u,f=n*l,p=n*u,m=o*u,v=a*s,g=a*l,y=a*u;return t[0]=1-(f+m),t[1]=c+y,t[2]=d-g,t[3]=0,t[4]=c-y,t[5]=1-(h+m),t[6]=p+v,t[7]=0,t[8]=d+g,t[9]=p-v,t[10]=1-(h+f),t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},o.slerp=function(e,t,r,n){n||(n=e);var i,o,a,s,l=e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3];return Math.abs(l)>=1?(n!==e&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3]),n):(i=Math.acos(l),o=Math.sqrt(1-l*l),Math.abs(o)<.001?(n[0]=.5*e[0]+.5*t[0],n[1]=.5*e[1]+.5*t[1],n[2]=.5*e[2]+.5*t[2],n[3]=.5*e[3]+.5*t[3],n):(a=Math.sin((1-r)*i)/o,s=Math.sin(r*i)/o,n[0]=e[0]*a+t[0]*s,n[1]=e[1]*a+t[1]*s,n[2]=e[2]*a+t[2]*s,n[3]=e[3]*a+t[3]*s,n))},o.fromRotationMatrix=function(e,t){t||(t=o.create());var r,n=e[0]+e[4]+e[8];if(n>0)r=Math.sqrt(n+1),t[3]=.5*r,r=.5/r,t[0]=(e[7]-e[5])*r,t[1]=(e[2]-e[6])*r,t[2]=(e[3]-e[1])*r;else{var i=o.fromRotationMatrix.s_iNext=o.fromRotationMatrix.s_iNext||[1,2,0],a=0;e[4]>e[0]&&(a=1),e[8]>e[3*a+a]&&(a=2);var s=i[a],l=i[s];r=Math.sqrt(e[3*a+a]-e[3*s+s]-e[3*l+l]+1),t[a]=.5*r,r=.5/r,t[3]=(e[3*l+s]-e[3*s+l])*r,t[s]=(e[3*s+a]+e[3*a+s])*r,t[l]=(e[3*l+a]+e[3*a+l])*r}return t},o.identity=function(e){return e||(e=o.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},o.fromAngleAxis=function(e,t,r){r||(r=o.create());var n=.5*e,i=Math.sin(n);return r[3]=Math.cos(n),r[0]=i*t[0],r[1]=i*t[1],r[2]=i*t[2],r},o.toAngleAxis=function(e,t){t||(t=e);var r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(r>0){t[3]=2*Math.acos(e[3]);var n=1/Math.sqrt(r);t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}else t[3]=0,t[0]=1,t[1]=0,t[2]=0;return t},o.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"},window.vec3=r,window.mat4=i,window.quat4=o,i}),r("Renderer/Frustum",["./glMatrix"],function(){var e=function(){this.normal=vec3.create([0,0,0]),this.d=0};e.prototype.init=function(e,t,r){var n=[],i=[];vec3.subtract(t,e,n),vec3.subtract(r,e,i),vec3.cross(n,i,this.normal),vec3.normalize(this.normal),this.d=-vec3.dot(e,this.normal)},e.prototype.transform=function(e){var t=[this.normal[0],this.normal[1],this.normal[2],this.d];mat4.multiplyVec4(e,t),this.normal[0]=t[0],this.normal[1]=t[1],this.normal[2]=t[2],this.d=t[3]},e.prototype.intersectSphere=function(e,t){var r=vec3.dot(e,this.normal)+this.d;return r>t?1:r<-t?-1:0},e.prototype.distance=function(e){return e[0]*this.normal[0]+e[1]*this.normal[1]+e[2]*this.normal[2]+this.d},e.prototype.intersectBoundingBox=function(e){var t=(this.normal[0]>=0?1:0)|(this.normal[1]>=0?2:0)|(this.normal[2]>=0?4:0),r=7&~t;return this.distance(e.getCorner(r))>0?1:this.distance(e.getCorner(t))<0?-1:0};var t=function(){this.planes=[new e,new e,new e,new e,new e]};return t.prototype.compute=function(e){var t=mat4.create();mat4.inverse(e,t);var r=mat4.project(t,[-1,-1,-1,1]),n=mat4.project(t,[-1,1,-1,1]),i=mat4.project(t,[1,1,-1,1]),o=mat4.project(t,[1,-1,-1,1]);this.planes[0].init([0,0,0],r,n),this.planes[1].init([0,0,0],n,i),this.planes[2].init([0,0,0],i,o),this.planes[3].init([0,0,0],o,r),this.planes[4].init(r,n,i)},t.prototype.transform=function(e,t){var r=mat4.create();mat4.inverse(t,r),this.inverseTransform(e,r)},t.prototype.inverseTransform=function(e,t){for(var r=0;r<e.planes.length;r++){var n=e.planes[r],i=n.normal[0],o=n.normal[1],a=n.normal[2],s=n.d;n=this.planes[r],n.normal[0]=t[0]*i+t[1]*o+t[2]*a+t[3]*s,n.normal[1]=t[4]*i+t[5]*o+t[6]*a+t[7]*s,n.normal[2]=t[8]*i+t[9]*o+t[10]*a+t[11]*s,n.d=t[12]*i+t[13]*o+t[14]*a+t[15]*s}},t.prototype.containsSphere=function(e,t){for(var r=1,n=0;n<this.planes.length;n++){var i=this.planes[n].normal,o=e[0]*i[0]+e[1]*i[1]+e[2]*i[2]+this.planes[n].d;if(o<=t){if(o<-t)return-1;r=0}}return r},t.prototype.containsBoundingBox=function(e){for(var t=0;t<this.planes.length;t++){var r=this.planes[t],n=r.normal[0]>=0?e.max[0]:e.min[0],i=r.normal[1]>=0?e.max[1]:e.min[1],o=r.normal[2]>=0?e.max[2]:e.min[2],a=n*r.normal[0]+i*r.normal[1]+o*r.normal[2]+r.d;if(a<0)return!1}return!0},t.Plane=e,t}),r("glMatrix",[],function(){var e=1e-6,t=Array,r={};r.create=function(e){var r=new t(3);return e?(r[0]=e[0],r[1]=e[1],r[2]=e[2]):r[0]=r[1]=r[2]=0,r},r.createFrom=function(e,r,n){var i=new t(3);return i[0]=e,i[1]=r,i[2]=n,i},r.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},r.equal=function(t,r){return t===r||Math.abs(t[0]-r[0])<e&&Math.abs(t[1]-r[1])<e&&Math.abs(t[2]-r[2])<e},r.add=function(e,t,r){return r&&e!==r?(r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r):(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e)},r.subtract=function(e,t,r){return r&&e!==r?(r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r):(e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],e)},r.multiply=function(e,t,r){return r&&e!==r?(r[0]=e[0]*t[0],r[1]=e[1]*t[1],r[2]=e[2]*t[2],r):(e[0]*=t[0],e[1]*=t[1],e[2]*=t[2],e)},r.negate=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},r.scale=function(e,t,r){return r&&e!==r?(r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r):(e[0]*=t,e[1]*=t,e[2]*=t,e)},r.normalize=function(e,t){t||(t=e);var r=e[0],n=e[1],i=e[2],o=Math.sqrt(r*r+n*n+i*i);return o?1===o?(t[0]=r,t[1]=n,t[2]=i,t):(o=1/o,t[0]=r*o,t[1]=n*o,t[2]=i*o,t):(t[0]=0,t[1]=0,t[2]=0,t)},r.cross=function(e,t,r){r||(r=e);var n=e[0],i=e[1],o=e[2],a=t[0],s=t[1],l=t[2];return r[0]=i*l-o*s,r[1]=o*a-n*l,r[2]=n*s-i*a,r},r.length=function(e){var t=e[0],r=e[1],n=e[2];return Math.sqrt(t*t+r*r+n*n)},r.squaredLength=function(e){var t=e[0],r=e[1],n=e[2];return t*t+r*r+n*n},r.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},r.lerp=function(e,t,r,n){return n||(n=e),n[0]=e[0]+r*(t[0]-e[0]),n[1]=e[1]+r*(t[1]-e[1]),n[2]=e[2]+r*(t[2]-e[2]),n},r.dist=function(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(r*r+n*n+i*i)},r.angle=function(e,t){return Math.atan2(r.length(r.cross(e,t)),r.dot(e,t))},r.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]"},r.createZPhi=function(e,t){var n=Math.sqrt((1-e)*(1+e)),i=n*Math.cos(t),o=n*Math.sin(t);return r.createFrom(i,o,e)},r.createPhiTheta=function(e,t){var n=Math.sin(t),i=n*Math.cos(e),o=n*Math.sin(e),a=n*Math.cos(t);return r.createFrom(i,o,a)},r.add2=function(e,t){var r=e[0],n=e[1],i=e[2],o=t[0],a=t[1],s=t[2];return[r+o,n+a,i+s]},r.subtract2=function(e,t){var r=e[0],n=e[1],i=e[2],o=t[0],a=t[1],s=t[2];return[r-o,n-a,i-s]},r.flip=function(e){var t=e[0],r=e[1],n=e[2];return[t=-t,r=-r,n=-n]},r.scale2=function(e,t){var r=e.x,n=e.y,i=e.z;return{x:r*t,y:n*=t,z:i*=t}},r.normalize2=function(e){var t=e[0],r=e[1],n=e[2],i=1/Math.sqrt(t*t+r*r+n*n);return[t*=i,r*=i,n*=i]},r.cross2=function(e,t){return{x:e[1]*t[2]-t[1]*e[2],y:e[2]*t[0]-t[2]*e[0],z:e[0]*t[1]-t[0]*e[1]}},r.length2=function(e){var t=e.x,r=e.y,n=e.z;return Math.sqrt(t*t+r*r+n*n)},r.dot2=function(e,t){var r=void 0!==e.x?e.x:e[0],n=void 0!==e.y?e.y:e[1],i=void 0!==e.z?e.z:e[2],o=void 0!==t.x?t.x:t[0],a=void 0!==t.y?t.y:t[1],s=void 0!==t.z?t.z:t[2];return r*o+n*a+i*s},r.angle2=function(e,t){return Math.atan2(r.length2(r.cross2(e,t)),r.dot2(e,t))};var n={};n.create=function(e){var r=new t(9);return e&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8]),r};var i={};i.create=function(e){var r=new t(16);return e&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r},i.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},i.identity=function(e){return e||(e=i.create()),e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},i.transpose=function(e,t){if(!t||e===t){var r=e[1],n=e[2],i=e[3],o=e[6],a=e[7],s=e[11];return e[1]=e[4],e[2]=e[8],e[3]=e[12],e[4]=r,e[6]=e[9],e[7]=e[13],e[8]=n,e[9]=o,e[11]=e[14],e[12]=i,e[13]=a,e[14]=s,e}return t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},i.determinant=function(e){var t=e[0],r=e[1],n=e[2],i=e[3],o=e[4],a=e[5],s=e[6],l=e[7],u=e[8],h=e[9],c=e[10],d=e[11],f=e[12],p=e[13],m=e[14],v=e[15];return f*h*s*i-u*p*s*i-f*a*c*i+o*p*c*i+u*a*m*i-o*h*m*i-f*h*n*l+u*p*n*l+f*r*c*l-t*p*c*l-u*r*m*l+t*h*m*l+f*a*n*d-o*p*n*d-f*r*s*d+t*p*s*d+o*r*m*d-t*a*m*d-u*a*n*v+o*h*n*v+u*r*s*v-t*h*s*v-o*r*c*v+t*a*c*v},i.inverse=function(e,t){t||(t=e);var r,n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],l=e[5],u=e[6],h=e[7],c=e[8],d=e[9],f=e[10],p=e[11],m=e[12],v=e[13],g=e[14],y=e[15],x=n*l-i*s,b=n*u-o*s,T=n*h-a*s,w=i*u-o*l,S=i*h-a*l,A=o*h-a*u,M=c*v-d*m,C=c*g-f*m,E=c*y-p*m,P=d*g-f*v,R=d*y-p*v,L=f*y-p*g,I=x*L-b*R+T*P+w*E-S*C+A*M;return I?(r=1/I,t[0]=(l*L-u*R+h*P)*r,t[1]=(-i*L+o*R-a*P)*r,t[2]=(v*A-g*S+y*w)*r,t[3]=(-d*A+f*S-p*w)*r,t[4]=(-s*L+u*E-h*C)*r,t[5]=(n*L-o*E+a*C)*r,t[6]=(-m*A+g*T-y*b)*r,t[7]=(c*A-f*T+p*b)*r,t[8]=(s*R-l*E+h*M)*r,t[9]=(-n*R+i*E-a*M)*r,t[10]=(m*S-v*T+y*x)*r,t[11]=(-c*S+d*T-p*x)*r,t[12]=(-s*P+l*C-u*M)*r,t[13]=(n*P-i*C+o*M)*r,t[14]=(-m*w+v*b-g*x)*r,t[15]=(c*w-d*b+f*x)*r,t):null},i.toRotationMat=function(e,t){return t||(t=i.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},i.toMat3=function(e,t){return t||(t=n.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},i.multiply=function(e,t,r){r||(r=e);var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],l=e[5],u=e[6],h=e[7],c=e[8],d=e[9],f=e[10],p=e[11],m=e[12],v=e[13],g=e[14],y=e[15],x=t[0],b=t[1],T=t[2],w=t[3];return r[0]=x*n+b*s+T*c+w*m,r[1]=x*i+b*l+T*d+w*v,r[2]=x*o+b*u+T*f+w*g,r[3]=x*a+b*h+T*p+w*y,x=t[4],b=t[5],T=t[6],w=t[7],r[4]=x*n+b*s+T*c+w*m,r[5]=x*i+b*l+T*d+w*v,r[6]=x*o+b*u+T*f+w*g,r[7]=x*a+b*h+T*p+w*y,x=t[8],b=t[9],T=t[10],w=t[11],r[8]=x*n+b*s+T*c+w*m,r[9]=x*i+b*l+T*d+w*v,r[10]=x*o+b*u+T*f+w*g,r[11]=x*a+b*h+T*p+w*y,x=t[12],b=t[13],T=t[14],w=t[15],r[12]=x*n+b*s+T*c+w*m,r[13]=x*i+b*l+T*d+w*v,r[14]=x*o+b*u+T*f+w*g,r[15]=x*a+b*h+T*p+w*y,r},i.multiplyVec3=function(e,t,r){r||(r=t);var n=t[0],i=t[1],o=t[2];return r[0]=e[0]*n+e[4]*i+e[8]*o+e[12],r[1]=e[1]*n+e[5]*i+e[9]*o+e[13],r[2]=e[2]*n+e[6]*i+e[10]*o+e[14],r},i.multiplyVec4=function(e,t,r){r||(r=t);var n=t[0],i=t[1],o=t[2],a=t[3];return r[0]=e[0]*n+e[4]*i+e[8]*o+e[12]*a,r[1]=e[1]*n+e[5]*i+e[9]*o+e[13]*a,r[2]=e[2]*n+e[6]*i+e[10]*o+e[14]*a,r[3]=e[3]*n+e[7]*i+e[11]*o+e[15]*a,r},i.project=function(e,t,r){r||(r=t),i.multiplyVec4(e,t,r);var n=1/r[3];return r[0]*=n,r[1]*=n,r[2]*=n,r},i.rotateVec3=function(e,t,r){r||(r=t);var n=t[0],i=t[1],o=t[2];return r[0]=e[0]*n+e[4]*i+e[8]*o,r[1]=e[1]*n+e[5]*i+e[9]*o,r[2]=e[2]*n+e[6]*i+e[10]*o,r},i.translate=function(e,t,r){var n,i,o,a,s,l,u,h,c,d,f,p,m=t[0],v=t[1],g=t[2];return r&&e!==r?(n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],l=e[5],u=e[6],h=e[7],c=e[8],d=e[9],f=e[10],p=e[11],r[0]=n,r[1]=i,r[2]=o,r[3]=a,r[4]=s,r[5]=l,r[6]=u,r[7]=h,r[8]=c,r[9]=d,r[10]=f,r[11]=p,r[12]=n*m+s*v+c*g+e[12],r[13]=i*m+l*v+d*g+e[13],r[14]=o*m+u*v+f*g+e[14],r[15]=a*m+h*v+p*g+e[15],r):(e[12]=e[0]*m+e[4]*v+e[8]*g+e[12],e[13]=e[1]*m+e[5]*v+e[9]*g+e[13],e[14]=e[2]*m+e[6]*v+e[10]*g+e[14],e[15]=e[3]*m+e[7]*v+e[11]*g+e[15],e)},i.scale=function(e,t,r){var n=t[0],i=t[1],o=t[2];return r&&e!==r?(r[0]=e[0]*n,r[1]=e[1]*n,r[2]=e[2]*n,r[3]=e[3]*n,r[4]=e[4]*i,r[5]=e[5]*i,r[6]=e[6]*i,r[7]=e[7]*i,r[8]=e[8]*o,r[9]=e[9]*o,r[10]=e[10]*o,r[11]=e[11]*o,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r):(e[0]*=n,e[1]*=n,e[2]*=n,e[3]*=n,e[4]*=i,e[5]*=i,e[6]*=i,e[7]*=i,e[8]*=o,e[9]*=o,e[10]*=o,e[11]*=o,e)},i.rotate=function(e,t,r,n){var i,o,a,s,l,u,h,c,d,f,p,m,v,g,y,x,b,T,w,S,A,M,C,E,P=r[0],R=r[1],L=r[2],I=Math.sqrt(P*P+R*R+L*L);return I?(1!==I&&(I=1/I,P*=I,R*=I,L*=I),i=Math.sin(t),o=Math.cos(t),a=1-o,s=e[0],l=e[1],u=e[2],h=e[3],c=e[4],d=e[5],f=e[6],p=e[7],m=e[8],v=e[9],g=e[10],y=e[11],x=P*P*a+o,b=R*P*a+L*i,T=L*P*a-R*i,w=P*R*a-L*i,S=R*R*a+o,A=L*R*a+P*i,M=P*L*a+R*i,C=R*L*a-P*i,E=L*L*a+o,n?e!==n&&(n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[0]=s*x+c*b+m*T,n[1]=l*x+d*b+v*T,n[2]=u*x+f*b+g*T,n[3]=h*x+p*b+y*T,n[4]=s*w+c*S+m*A,n[5]=l*w+d*S+v*A,n[6]=u*w+f*S+g*A,n[7]=h*w+p*S+y*A,n[8]=s*M+c*C+m*E,n[9]=l*M+d*C+v*E,n[10]=u*M+f*C+g*E,n[11]=h*M+p*C+y*E,n):null},i.rotateX=function(e,t,r){var n=Math.sin(t),i=Math.cos(t),o=e[4],a=e[5],s=e[6],l=e[7],u=e[8],h=e[9],c=e[10],d=e[11];return r?e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[4]=o*i+u*n,r[5]=a*i+h*n,r[6]=s*i+c*n,r[7]=l*i+d*n,r[8]=o*-n+u*i,r[9]=a*-n+h*i,r[10]=s*-n+c*i,r[11]=l*-n+d*i,r},i.rotateY=function(e,t,r){var n=Math.sin(t),i=Math.cos(t),o=e[0],a=e[1],s=e[2],l=e[3],u=e[8],h=e[9],c=e[10],d=e[11];return r?e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=o*i+u*-n,r[1]=a*i+h*-n,r[2]=s*i+c*-n,r[3]=l*i+d*-n,r[8]=o*n+u*i,r[9]=a*n+h*i,r[10]=s*n+c*i,r[11]=l*n+d*i,r},i.rotateZ=function(e,t,r){var n=Math.sin(t),i=Math.cos(t),o=e[0],a=e[1],s=e[2],l=e[3],u=e[4],h=e[5],c=e[6],d=e[7];return r?e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=o*i+u*n,r[1]=a*i+h*n,r[2]=s*i+c*n,r[3]=l*i+d*n,r[4]=o*-n+u*i,r[5]=a*-n+h*i,r[6]=s*-n+c*i,r[7]=l*-n+d*i,r},i.frustum=function(e,t,r,n,o,a,s){s||(s=i.create());var l=t-e,u=n-r,h=a-o;return s[0]=2*o/l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2*o/u,s[6]=0,s[7]=0,s[8]=(t+e)/l,s[9]=(n+r)/u,s[10]=-(a+o)/h,s[11]=-1,s[12]=0,s[13]=0,s[14]=-(a*o*2)/h,s[15]=0,s},i.perspective=function(e,t,r,n,o){var a=r*Math.tan(e*Math.PI/360),s=a*t;return i.frustum(-s,s,-a,a,r,n,o)},i.ortho=function(e,t,r,n,o,a,s){s||(s=i.create());var l=t-e,u=n-r,h=a-o;return s[0]=2/l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2/u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=-2/h,s[11]=0,s[12]=-(e+t)/l,s[13]=-(n+r)/u,s[14]=-(a+o)/h,s[15]=1,s},i.lookAt=function(e,t,r,n){n||(n=i.create());var o,a,s,l,u,h,c,d,f,p,m=e[0],v=e[1],g=e[2],y=r[0],x=r[1],b=r[2],T=t[0],w=t[1],S=t[2];return m===T&&v===w&&g===S?i.identity(n):(c=m-T,d=v-w,f=g-S,p=1/Math.sqrt(c*c+d*d+f*f),c*=p,d*=p,f*=p,o=x*f-b*d,a=b*c-y*f,s=y*d-x*c,p=Math.sqrt(o*o+a*a+s*s),p?(p=1/p,o*=p,a*=p,s*=p):(o=0,a=0,s=0),l=d*s-f*a,u=f*o-c*s,h=c*a-d*o,p=Math.sqrt(l*l+u*u+h*h),p?(p=1/p,l*=p,u*=p,h*=p):(l=0,u=0,h=0),n[0]=o,n[1]=l,n[2]=c,n[3]=0,n[4]=a,n[5]=u,n[6]=d,n[7]=0,n[8]=s,n[9]=h,n[10]=f,n[11]=0,n[12]=-(o*m+a*v+s*g),n[13]=-(l*m+u*v+h*g),n[14]=-(c*m+d*v+f*g),n[15]=1,n)},i.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]"};var o={};return o.create=function(e){var r=new t(4);return e?(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3]):r[0]=r[1]=r[2]=r[3]=0,r},o.createFrom=function(e,r,n,i){var o=new t(4);return o[0]=e,o[1]=r,o[2]=n,o[3]=i,o},o.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},o.equal=function(t,r){return t===r||Math.abs(t[0]-r[0])<e&&Math.abs(t[1]-r[1])<e&&Math.abs(t[2]-r[2])<e&&Math.abs(t[3]-r[3])<e},o.identity=function(e){return e||(e=o.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},o.calculateW=function(e,t){var r=e[0],n=e[1],i=e[2];return t&&e!==t?(t[0]=r,t[1]=n,t[2]=i,t[3]=-Math.sqrt(Math.abs(1-r*r-n*n-i*i)),t):(e[3]=-Math.sqrt(Math.abs(1-r*r-n*n-i*i)),e)},o.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},o.inverse=function(e,t){var r=e[0],n=e[1],i=e[2],o=e[3],a=r*r+n*n+i*i+o*o,s=a?1/a:0;return t&&e!==t?(t[0]=-e[0]*s,t[1]=-e[1]*s,t[2]=-e[2]*s,t[3]=e[3]*s,t):(e[0]*=-s,e[1]*=-s,e[2]*=-s,e[3]*=s,e)},o.conjugate=function(e,t){return t&&e!==t?(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t):(e[0]*=-1,e[1]*=-1,e[2]*=-1,e)},o.length=function(e){var t=e[0],r=e[1],n=e[2],i=e[3];return Math.sqrt(t*t+r*r+n*n+i*i)},o.normalize=function(e,t){t||(t=e);var r=e[0],n=e[1],i=e[2],o=e[3],a=Math.sqrt(r*r+n*n+i*i+o*o);return 0===a?(t[0]=0,t[1]=0,t[2]=0,t[3]=0,t):(a=1/a,t[0]=r*a,t[1]=n*a,t[2]=i*a,t[3]=o*a,t)},o.add=function(e,t,r){return r&&e!==r?(r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r[3]=e[3]+t[3],r):(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[3],e)},o.multiply=function(e,t,r){r||(r=e);var n=e[0],i=e[1],o=e[2],a=e[3],s=t[0],l=t[1],u=t[2],h=t[3];return r[0]=n*h+a*s+i*u-o*l,r[1]=i*h+a*l+o*s-n*u,r[2]=o*h+a*u+n*l-i*s,r[3]=a*h-n*s-i*l-o*u,r},o.multiplyVec3=function(e,t,r){r||(r=t);var n=t[0],i=t[1],o=t[2],a=e[0],s=e[1],l=e[2],u=e[3],h=u*n+s*o-l*i,c=u*i+l*n-a*o,d=u*o+a*i-s*n,f=-a*n-s*i-l*o;return r[0]=h*u+f*-a+c*-l-d*-s,r[1]=c*u+f*-s+d*-a-h*-l,r[2]=d*u+f*-l+h*-s-c*-a,r},o.scale=function(e,t,r){return r&&e!==r?(r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r[3]=e[3]*t,r):(e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e)},o.toMat4=function(e,t){t||(t=i.create());var r=e[0],n=e[1],o=e[2],a=e[3],s=r+r,l=n+n,u=o+o,h=r*s,c=r*l,d=r*u,f=n*l,p=n*u,m=o*u,v=a*s,g=a*l,y=a*u;return t[0]=1-(f+m),t[1]=c+y,t[2]=d-g,t[3]=0,t[4]=c-y,t[5]=1-(h+m),t[6]=p+v,t[7]=0,t[8]=d+g,t[9]=p-v,t[10]=1-(h+f),t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},o.slerp=function(e,t,r,n){n||(n=e);var i,o,a,s,l=e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3];return Math.abs(l)>=1?(n!==e&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3]),n):(i=Math.acos(l),o=Math.sqrt(1-l*l),Math.abs(o)<.001?(n[0]=.5*e[0]+.5*t[0],n[1]=.5*e[1]+.5*t[1],n[2]=.5*e[2]+.5*t[2],n[3]=.5*e[3]+.5*t[3],n):(a=Math.sin((1-r)*i)/o,s=Math.sin(r*i)/o,n[0]=e[0]*a+t[0]*s,n[1]=e[1]*a+t[1]*s,n[2]=e[2]*a+t[2]*s,n[3]=e[3]*a+t[3]*s,n))},o.fromRotationMatrix=function(e,t){t||(t=o.create());var r,n=e[0]+e[4]+e[8];if(n>0)r=Math.sqrt(n+1),t[3]=.5*r,r=.5/r,t[0]=(e[7]-e[5])*r,t[1]=(e[2]-e[6])*r,t[2]=(e[3]-e[1])*r;else{var i=o.fromRotationMatrix.s_iNext=o.fromRotationMatrix.s_iNext||[1,2,0],a=0;e[4]>e[0]&&(a=1),e[8]>e[3*a+a]&&(a=2);var s=i[a],l=i[s];r=Math.sqrt(e[3*a+a]-e[3*s+s]-e[3*l+l]+1),t[a]=.5*r,r=.5/r,t[3]=(e[3*l+s]-e[3*s+l])*r,t[s]=(e[3*s+a]+e[3*a+s])*r,t[l]=(e[3*l+a]+e[3*a+l])*r}return t},o.identity=function(e){return e||(e=o.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},o.fromAngleAxis=function(e,t,r){r||(r=o.create());var n=.5*e,i=Math.sin(n);return r[3]=Math.cos(n),r[0]=i*t[0],r[1]=i*t[1],r[2]=i*t[2],r},o.toAngleAxis=function(e,t){t||(t=e);var r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(r>0){t[3]=2*Math.acos(e[3]);var n=1/Math.sqrt(r);t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}else t[3]=0,t[0]=1,t[1]=0,t[2]=0;return t},o.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"},window.vec3=r,window.mat4=i,window.quat4=o,i}),r("Renderer/RenderContext",["./Frustum","glMatrix"],function(e){var t=function(r){this.activeAnimations=[],this.shadersPath=r.shadersPath||"../shaders/",this.tileErrorTreshold=r.tileErrorTreshold||4,this.lighting=r.lighting||!1,this.continuousRendering=r.continuousRendering||!1,this.stats=null,this.isActive=!0;var n=null;if(!r.canvas)throw"Mizar : no canvas in options";if(n="string"==typeof r.canvas?$(r.canvas):r.canvas,!(n instanceof HTMLCanvasElement))throw"GlobWeb : invalid canvas";for(var i=["webgl","experimental-webgl","webkit-3d","moz-webgl"],o=null,a=0;a<i.length&&null===o;++a)try{o=n.getContext(i[a],t.contextAttributes)}catch(e){}if(null===o)throw"GlobWeb : WebGL context cannot be initialized";if(r.backgroundColor){var s=r.backgroundColor;o.clearColor(s[0],s[1],s[2],s[3])}else o.clearColor(0,0,0,1);o.getExtension("OES_element_index_uint"),o.pixelStorei(o.UNPACK_COLORSPACE_CONVERSION_WEBGL,o.NONE),o.enable(o.DEPTH_TEST),o.enable(o.CULL_FACE),this.viewMatrix=mat4.create(),this.modelViewMatrix=mat4.create(),this.projectionMatrix=mat4.create(),this.gl=o,this.canvas=n,this.frustum=new e,this.worldFrustum=new e,this.localFrustum=new e,this.eyePosition=vec3.create(),this.eyeDirection=vec3.create(),this.minNear=1e-4,this.minFar=r.minFar||0,this.near=t.minNear,this.far=6,this.numActiveAttribArray=0,this.frameRequested=!1,this.fov=45,this.renderers=[],window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}());var l=this;this.frameCallback=function(){l.frame()}};return t.contextAttributes={},t.prototype.requestFrame=function(){this.frameRequested||(window.requestAnimationFrame(this.frameCallback),this.frameRequested=!0)},t.prototype.deactivate=function(){this.isActive=!1,this.frameRequested=!1},t.prototype.activate=function(){this.isActive=!0},t.prototype.frame=function(){if(this.isActive){this.frameRequested=!1;var e,r=(this.stats,this.gl);if(this.stats&&this.stats.start("globalRenderTime"),this.activeAnimations.length>0){var n=Date.now();for(e=0;e<this.activeAnimations.length;e++)this.activeAnimations[e].update(n)}if(t.contextAttributes.stencil?r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT|r.STENCIL_BUFFER_BIT):r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),0===this.canvas.width||0===this.canvas.height)return;for(r.viewport(0,0,this.canvas.width,this.canvas.height),this.updateViewDependentProperties(),e=0;e<this.renderers.length;e++)this.renderers[e].render();this.stats&&this.stats.end("globalRenderTime"),this.continuousRendering?this.requestFrame():this.activeAnimations.length>0&&this.requestFrame()}},t.prototype.updateViewDependentProperties=function(){var e=mat4.create();mat4.inverse(this.viewMatrix,e),vec3.set([0,0,0],this.eyePosition),mat4.multiplyVec3(e,this.eyePosition),vec3.set([0,0,-1],this.eyeDirection),mat4.rotateVec3(e,this.eyeDirection),mat4.perspective(this.fov,this.canvas.width/this.canvas.height,this.minNear,this.far,this.projectionMatrix),this.frustum.compute(this.projectionMatrix),this.worldFrustum.inverseTransform(this.frustum,this.viewMatrix),this.pixelSizeVector=this.computePixelSizeVector()},t.prototype.getXYRelativeToCanvas=function(e){var t=[];e.pageX||e.pageY?(t[0]=e.pageX,t[1]=e.pageY):(t[0]=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,t[1]=e.clientY+document.body.scrollTop+document.documentElement.scrollTop);for(var r=this.canvas;r;)t[0]-=r.offsetLeft,t[1]-=r.offsetTop,r=r.offsetParent;return t},t.prototype.computePixelSizeVector=function(e){var t=this.canvas.width,r=this.canvas.height,n=this.projectionMatrix,i=e||this.viewMatrix,o=n[0]*t*.5,a=n[8]*t*.5+n[11]*t*.5,s=[i[0]*o+i[2]*a,i[4]*o+i[6]*a,i[8]*o+i[10]*a],l=n[5]*r*.5,u=n[9]*r*.5+n[11]*r*.5,h=[i[1]*l+i[2]*u,i[5]*l+i[6]*u,i[9]*l+i[10]*u],c=n[11],d=n[15],f=[i[2]*c,i[6]*c,i[10]*c,i[14]*c+i[15]*d],p=.7071067811/Math.sqrt(vec3.dot(s,s)+vec3.dot(h,h));return f[0]*=p,f[1]*=p,f[2]*=p,f[3]*=p,f},t.prototype.getPixelFrom3D=function(e,t,r){var n=mat4.create();mat4.multiply(this.projectionMatrix,this.viewMatrix,n);var i=[e,t,r,1];mat4.project(n,i);var o=Math.round(.5*(1+i[0])*this.canvas.width),a=Math.round(.5*(1-i[1])*this.canvas.height);return[o,a]},t.prototype.createNonPowerOfTwoTextureFromImage=function(e,t){var r=this.gl,n=r.createTexture();return r.bindTexture(r.TEXTURE_2D,n),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,t),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!1),n},t}),r("Renderer/BoundingBox",[],function(){var e=function(e,t){e&&(this.min=vec3.create(e)),t&&(this.max=vec3.create(t))};return e.prototype.extend=function(e,t,r){this.min?(e<this.min[0]&&(this.min[0]=e),t<this.min[1]&&(this.min[1]=t),r<this.min[2]&&(this.min[2]=r),e>this.max[0]&&(this.max[0]=e),t>this.max[1]&&(this.max[1]=t),r>this.max[2]&&(this.max[2]=r)):(this.min=vec3.create(),this.max=vec3.create(),this.min[0]=e,this.min[1]=t,this.min[2]=r,this.max[0]=e,this.max[1]=t,this.max[2]=r)},e.prototype.compute=function(e,t,r){this.min||(this.min=vec3.create(),this.max=vec3.create()),this.min[0]=e[0],this.min[1]=e[1],this.min[2]=e[2],this.max[0]=e[0],this.max[1]=e[1],this.max[2]=e[2];var n,i,o=r||3,a=t||e.length;for(n=o;n<a;n+=o)for(i=0;i<3;i++)e[n+i]<this.min[i]&&(this.min[i]=e[n+i]),e[n+i]>this.max[i]&&(this.max[i]=e[n+i])},e.prototype.getCorner=function(e){return[1&e?this.max[0]:this.min[0],2&e?this.max[1]:this.min[1],4&e?this.max[2]:this.min[2]]},e.prototype.getCenter=function(){return[.5*(this.max[0]+this.min[0]),.5*(this.max[1]+this.min[1]),.5*(this.max[2]+this.min[2])]},e.prototype.getRadius=function(){var e=vec3.create();return vec3.subtract(this.max,this.min,e),.5*vec3.length(e)},e}),r("Tiling/Tile",["../Renderer/BoundingBox","../Renderer/glMatrix"],function(e){var t=function(){this.parent=null,this.parentIndex=-1,this.children=null,this.vertices=null,this.texture=null,this.vertexBuffer=null,this.texTransform=[1,1,0,0],this.matrix=null,this.inverseMatrix=null,this.bbox=new e,this.radius=0,this.distance=0,this.closestPointToEye=[0,0,0],this.extension={},this.state=t.State.NONE,this.config=null,this.imageSize=256};return t.State={ERROR:-10,NONE:0,REQUESTED:1,LOADING:2,LOADED:3},t.prototype.computePosition=function(e,t){var r=this.config.tesselation;e=Math.min(r-1,Math.max(0,e)),t=Math.min(r-1,Math.max(0,t));for(var n=Math.floor(t),i=t-n,o=Math.floor(e),a=e-o,s=this.config.vertexSize,l=s*(n*r+o),u=[0,0,0],h=0;h<3;h++)u[h]=(1-i)*(1-a)*this.vertices[l+h]+i*(1-a)*this.vertices[l+s*r+h]+i*a*this.vertices[l+s*r+s+h]+(1-i)*a*this.vertices[l+s+h];return u},t.prototype.initFromParent=function(e,t,r){this.parent=e,this.parentIndex=2*r+t,this.matrix=e.matrix,this.inverseMatrix=e.inverseMatrix,
this.texture=e.texture,this.config=e.config,this.vertexBuffer=e.vertexBuffer;for(var n=this.config.tesselation,i=(n-1)/2,o=0;o<=i;o++)for(var a=this.config.vertexSize*((o+r*i)*n+t*i),s=0;s<=i;s++)this.bbox.extend(e.vertices[a],e.vertices[a+1],e.vertices[a+2]),a+=this.config.vertexSize;this.radius=this.bbox.getRadius();for(var l in e.extension){var u=e.extension[l];u.initChild&&u.initChild(this,t,r)}},t.prototype.needsToBeRefined=function(e){if(this.distance<this.radius)return!0;var t=.25*(this.bbox.max[0]-this.bbox.min[0]+(this.bbox.max[1]-this.bbox.min[1]))/this.imageSize,r=this.matrix,n=this.closestPointToEye,i=r[0]*n[0]+r[4]*n[1]+r[8]*n[2]+r[12],o=r[1]*n[0]+r[5]*n[1]+r[9]*n[2]+r[13],a=r[2]*n[0]+r[6]*n[1]+r[10]*n[2]+r[14],s=e.pixelSizeVector,l=t/(i*s[0]+o*s[1]+a*s[2]+s[3]);return Math.abs(l)>e.tileErrorTreshold},t.prototype.isCulled=function(e){var t=this.inverseMatrix,r=e.eyePosition,n=t[0]*r[0]+t[4]*r[1]+t[8]*r[2]+t[12],i=t[1]*r[0]+t[5]*r[1]+t[9]*r[2]+t[13],o=t[2]*r[0]+t[6]*r[1]+t[10]*r[2]+t[14];if(this.distance=Math.sqrt(n*n+i*i+o*o),this.distance<this.radius)return this.distance=0,!1;var a=this.closestPointToEye;if(a[0]=Math.min(Math.max(n,this.bbox.min[0]),this.bbox.max[0]),a[1]=Math.min(Math.max(i,this.bbox.min[1]),this.bbox.max[1]),a[2]=Math.min(Math.max(o,this.bbox.min[2]),this.bbox.max[2]),o<0&&!this.config.coordinateSystem.isFlat){var s=a[0],l=a[1],u=a[2]+this.config.coordinateSystem.geoide.radius,h=Math.sqrt(s*s+l*l+u*u);s/=h,l/=h,u/=h;var c=n-s*this.config.coordinateSystem.geoide.radius,d=i-l*this.config.coordinateSystem.geoide.radius,f=o-(u-1)*this.config.coordinateSystem.geoide.radius,p=Math.sqrt(c*c+d*d+f*f),m=(c*s+d*l+f*u)/p;if(m*=this.config.cullSign,m<-.05)return!0}var v=e.localFrustum;return v.inverseTransform(e.worldFrustum,this.matrix),!v.containsBoundingBox(this.bbox)},t.prototype.dispose=function(e,r){for(var n in this.extension)this.extension[n].dispose&&this.extension[n].dispose(e,r);this.state===t.State.LOADED&&(r.disposeGLBuffer(this.vertexBuffer),this.texture&&r.disposeGLTexture(this.texture),this.vertexBuffer=null,this.texture=null,this.parent=null,this.state=t.State.NONE)},t.prototype.deleteChildren=function(e,t){if(this.children){for(var r=0;r<4;r++)this.children[r].deleteChildren(e,t),this.children[r].dispose(e,t);this.children=null}},t.prototype.buildSkirtVertices=function(e,t,r,n){for(var i=this.vertices,o=.05*this.radius,a=this.config.tesselation,s=0;s<a;s++){var l=i[t]-e[0],u=i[t+1]-e[1],h=i[t+2]-e[2],c=o/Math.sqrt(l*l+u*u+h*h);l*=c,u*=c,h*=c,i[n]=i[t]-l,i[n+1]=i[t+1]-u,i[n+2]=i[t+2]-h;for(var d=3;d<this.config.vertexSize;d++)i[n+d]=i[t+d];n+=this.config.vertexSize,t+=r}},t.prototype.generateNormals=function(){for(var e=this.config.tesselation,t=this.config.vertexSize,r=t*e,n=0,i=0;i<e;i++)for(var o=i===e-1?0:r,a=0===i?0:-r,s=0;s<e;s++){var l=s===e-1?0:t,u=0===s?0:-t,h=[this.vertices[n+l]-this.vertices[n+u],this.vertices[n+l+1]-this.vertices[n+u+1],this.vertices[n+l+2]-this.vertices[n+u+2]],c=[this.vertices[n+o]-this.vertices[n+a],this.vertices[n+o+1]-this.vertices[n+a+1],this.vertices[n+o+2]-this.vertices[n+a+2]],d=vec3.cross(h,c,[]);vec3.normalize(d),this.vertices[n+3]=d[0],this.vertices[n+4]=d[1],this.vertices[n+5]=d[2],n+=t}},t.prototype.generate=function(e,r,n){this.vertices=this.generateVertices(n);var i=this.config.tesselation,o=this.config.vertexSize;if(this.bbox.compute(this.vertices,o*i*i,o),this.radius=this.bbox.getRadius(),this.config.normals&&this.generateNormals(),this.config.skirt){var a=[0,0,0];mat4.multiplyVec3(this.inverseMatrix,a);var s=o*(i*i);this.buildSkirtVertices(a,0,o,s),s+=o*i,this.buildSkirtVertices(a,o*(i*(i-1)),o,s),s+=o*i,this.buildSkirtVertices(a,0,o*i,s),s+=o*i,this.buildSkirtVertices(a,o*(i-1),o*i,s),s+=o*i,this.buildSkirtVertices(a,o*(i*(i-1)/2),o,s),s+=o*i,this.buildSkirtVertices(a,o*((i-1)/2),o*i,s)}null!==this.vertexBuffer&&null===this.parent&&e.disposeGLBuffer(this.vertexBuffer),this.vertexBuffer=e.createGLBuffer(this.vertices),r&&(this.texture=e.createGLTexture(r),this.imageSize=this.config.imageSize),this.state=t.State.LOADED},t}),r("Utils/Utils",[],function(){var e={};return e.inherits=function(e,t){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t},e}),r("Renderer/GeoBound",[],function(){var e=function(e,t,r,n){this.south=t,this.west=e,this.north=n,this.east=r};return e.prototype.getCenter=function(){return[.5*(this.east+this.west),.5*(this.south+this.north),0]},e.prototype.getNorth=function(){return this.north},e.prototype.getSouth=function(){return this.south},e.prototype.getWest=function(){return this.west},e.prototype.getEast=function(){return this.east},e.prototype.computeFromCoordinates=function(e){this.west=e[0][0],this.east=e[0][0],this.south=e[0][1],this.north=e[0][1];for(var t=1;t<e.length;t++)this.west=Math.min(this.west,e[t][0]),this.east=Math.max(this.east,e[t][0]),this.south=Math.min(this.south,e[t][1]),this.north=Math.max(this.north,e[t][1])},e.prototype.isPointInside=function(e){return e[0]>=this.west&&e[0]<=this.east&&e[1]>=this.south&&e[1]<=this.north},e.prototype.intersects=function(e){return!(this.west>=e.east||this.east<=e.west)&&!(this.south>=e.north||this.north<=e.south)},e.prototype.intersectsGeometry=function(t){var r,n,i=!1,o=new e,a=t.coordinates;switch(t.type){case"LineString":o.computeFromCoordinates(a),i|=this.intersects(o);break;case"Polygon":for(r=0;r<a.length&&!i;r++)o.computeFromCoordinates(a[r]),i|=this.intersects(o);break;case"MultiLineString":for(r=0;r<a.length&&!i;r++)o.computeFromCoordinates(a[r]),i|=this.intersects(o);break;case"MultiPolygon":for(r=0;r<a.length&&!i;r++)for(n=0;n<a[r].length&&!i;n++)o.computeFromCoordinates(a[r][n]),i|=this.intersects(o)}return i},e}),r("Tiling/HEALPixTables",[],function(){var e={ctab:[0,1,256,257,2,3,258,259,512,513,768,769,514,515,770,771,4,5,260,261,6,7,262,263,516,517,772,773,518,519,774,775,1024,1025,1280,1281,1026,1027,1282,1283,1536,1537,1792,1793,1538,1539,1794,1795,1028,1029,1284,1285,1030,1031,1286,1287,1540,1541,1796,1797,1542,1543,1798,1799,8,9,264,265,10,11,266,267,520,521,776,777,522,523,778,779,12,13,268,269,14,15,270,271,524,525,780,781,526,527,782,783,1032,1033,1288,1289,1034,1035,1290,1291,1544,1545,1800,1801,1546,1547,1802,1803,1036,1037,1292,1293,1038,1039,1294,1295,1548,1549,1804,1805,1550,1551,1806,1807,2048,2049,2304,2305,2050,2051,2306,2307,2560,2561,2816,2817,2562,2563,2818,2819,2052,2053,2308,2309,2054,2055,2310,2311,2564,2565,2820,2821,2566,2567,2822,2823,3072,3073,3328,3329,3074,3075,3330,3331,3584,3585,3840,3841,3586,3587,3842,3843,3076,3077,3332,3333,3078,3079,3334,3335,3588,3589,3844,3845,3590,3591,3846,3847,2056,2057,2312,2313,2058,2059,2314,2315,2568,2569,2824,2825,2570,2571,2826,2827,2060,2061,2316,2317,2062,2063,2318,2319,2572,2573,2828,2829,2574,2575,2830,2831,3080,3081,3336,3337,3082,3083,3338,3339,3592,3593,3848,3849,3594,3595,3850,3851,3084,3085,3340,3341,3086,3087,3342,3343,3596,3597,3852,3853,3598,3599,3854,3855],utab:[0,1,4,5,16,17,20,21,64,65,68,69,80,81,84,85,256,257,260,261,272,273,276,277,320,321,324,325,336,337,340,341,1024,1025,1028,1029,1040,1041,1044,1045,1088,1089,1092,1093,1104,1105,1108,1109,1280,1281,1284,1285,1296,1297,1300,1301,1344,1345,1348,1349,1360,1361,1364,1365,4096,4097,4100,4101,4112,4113,4116,4117,4160,4161,4164,4165,4176,4177,4180,4181,4352,4353,4356,4357,4368,4369,4372,4373,4416,4417,4420,4421,4432,4433,4436,4437,5120,5121,5124,5125,5136,5137,5140,5141,5184,5185,5188,5189,5200,5201,5204,5205,5376,5377,5380,5381,5392,5393,5396,5397,5440,5441,5444,5445,5456,5457,5460,5461,16384,16385,16388,16389,16400,16401,16404,16405,16448,16449,16452,16453,16464,16465,16468,16469,16640,16641,16644,16645,16656,16657,16660,16661,16704,16705,16708,16709,16720,16721,16724,16725,17408,17409,17412,17413,17424,17425,17428,17429,17472,17473,17476,17477,17488,17489,17492,17493,17664,17665,17668,17669,17680,17681,17684,17685,17728,17729,17732,17733,17744,17745,17748,17749,20480,20481,20484,20485,20496,20497,20500,20501,20544,20545,20548,20549,20560,20561,20564,20565,20736,20737,20740,20741,20752,20753,20756,20757,20800,20801,20804,20805,20816,20817,20820,20821,21504,21505,21508,21509,21520,21521,21524,21525,21568,21569,21572,21573,21584,21585,21588,21589,21760,21761,21764,21765,21776,21777,21780,21781,21824,21825,21828,21829,21840,21841,21844,21845],jrll:[2,2,2,2,3,3,3,3,4,4,4,4],jpll:[1,3,5,7,0,2,4,6,1,3,5,7],xoffset:[-1,-1,0,1,1,1,0,-1],yoffset:[0,1,1,1,0,-1,-1,-1],facearray:[[8,9,10,11,-1,-1,-1,-1,10,11,8,9],[5,6,7,4,8,9,10,11,9,10,11,8],[-1,-1,-1,-1,5,6,7,4,-1,-1,-1,-1],[4,5,6,7,11,8,9,10,11,8,9,10],[0,1,2,3,4,5,6,7,8,9,10,11],[1,2,3,0,0,1,2,3,5,6,7,4],[-1,-1,-1,-1,7,4,5,6,-1,-1,-1,-1],[3,0,1,2,3,0,1,2,4,5,6,7],[2,3,0,1,-1,-1,-1,-1,0,1,2,3]],swaparray:[[0,0,3],[0,0,6],[0,0,0],[0,0,5],[0,0,0],[5,0,0],[0,0,0],[6,0,0],[3,0,0]],swap_cycle:[[],[0,1,8,12,16,21,40],[0,1,2,40,114],[0,4,160,263],[0,4,30,49,51,87,526,1027,1105,1387,1807,2637],[0,8,10,18,39,74,146,307,452,4737],[0,1,2,7,9,17,80,410,1526,1921,32859,33566,38931],[0,5,6,10,12,24,27,95,372,494,924,1409,3492,4248,9137,66043,103369,156899],[0,1,2,3,4,45,125,351,697,24337,102940,266194,341855,419857],[0,1,2,3,9,16,1705,2082,2126,8177,12753,15410,52642,80493,83235,88387,99444,1675361,2495125],[0,2,6,8,9,11,20,50,93,152,183,2137,13671,44794,486954,741908,4803258,5692573],[0,1,5,6,44,53,470,2847,3433,4906,13654,14710,400447,1797382,2744492,18775974,23541521],[0,4,9,10,16,33,83,117,318,451,5759,10015,128975,171834,211256,347608,1278690,2154097,2590798,3427694,5581717,21012301,27023976,72522811,95032729,139166747,171822389],[0,5,10,267,344,363,2968,3159,9083,18437,76602,147614,1246902,1593138,2035574,6529391,9511830,11340287,29565945,281666026,677946848]]};return e}),r("Utils/Long",[],function(){var e=function(e,t){this.low_=0|e,this.high_=0|t};return e.IntCache_={},e.fromInt=function(t){if(-128<=t&&t<128){var r=e.IntCache_[t];if(r)return r}var n=new e(0|t,t<0?-1:0);return-128<=t&&t<128&&(e.IntCache_[t]=n),n},e.fromNumber=function(t){return isNaN(t)||!isFinite(t)?e.ZERO:t<=-e.TWO_PWR_63_DBL_?e.MIN_VALUE:t+1>=e.TWO_PWR_63_DBL_?e.MAX_VALUE:t<0?e.fromNumber(-t).negate():new e(t%e.TWO_PWR_32_DBL_|0,t/e.TWO_PWR_32_DBL_|0)},e.fromBits=function(t,r){return new e(t,r)},e.TWO_PWR_16_DBL_=65536,e.TWO_PWR_24_DBL_=1<<24,e.TWO_PWR_32_DBL_=e.TWO_PWR_16_DBL_*e.TWO_PWR_16_DBL_,e.TWO_PWR_64_DBL_=e.TWO_PWR_32_DBL_*e.TWO_PWR_32_DBL_,e.TWO_PWR_63_DBL_=e.TWO_PWR_64_DBL_/2,e.ZERO=e.fromInt(0),e.ONE=e.fromInt(1),e.MAX_VALUE=e.fromBits(-1,2147483647),e.MIN_VALUE=e.fromBits(0,-2147483648),e.TWO_PWR_24_=e.fromInt(1<<24),e.prototype.toInt=function(){return this.low_},e.prototype.toNumber=function(){return this.high_*e.TWO_PWR_32_DBL_+this.getLowBitsUnsigned()},e.prototype.getLowBitsUnsigned=function(){return this.low_>=0?this.low_:e.TWO_PWR_32_DBL_+this.low_},e.prototype.isZero=function(){return 0===this.high_&&0===this.low_},e.prototype.isNegative=function(){return this.high_<0},e.prototype.isOdd=function(){return 1===(1&this.low_)},e.prototype.equals=function(e){return this.high_===e.high_&&this.low_===e.low_},e.prototype.lessThan=function(e){return this.compare(e)<0},e.prototype.greaterThanOrEqual=function(e){return this.compare(e)>=0},e.prototype.compare=function(e){if(this.equals(e))return 0;var t=this.isNegative(),r=e.isNegative();return t&&!r?-1:!t&&r?1:this.subtract(e).isNegative()?-1:1},e.prototype.negate=function(){return this.equals(e.MIN_VALUE)?e.MIN_VALUE:this.not().add(e.ONE)},e.prototype.add=function(t){var r=this.high_>>>16,n=65535&this.high_,i=this.low_>>>16,o=65535&this.low_,a=t.high_>>>16,s=65535&t.high_,l=t.low_>>>16,u=65535&t.low_,h=0,c=0,d=0,f=0;return f+=o+u,d+=f>>>16,f&=65535,d+=i+l,c+=d>>>16,d&=65535,c+=n+s,h+=c>>>16,c&=65535,h+=r+a,h&=65535,e.fromBits(d<<16|f,h<<16|c)},e.prototype.subtract=function(e){return this.add(e.negate())},e.prototype.multiply=function(t){if(this.isZero())return e.ZERO;if(t.isZero())return e.ZERO;if(this.equals(e.MIN_VALUE))return t.isOdd()?e.MIN_VALUE:e.ZERO;if(t.equals(e.MIN_VALUE))return this.isOdd()?e.MIN_VALUE:e.ZERO;if(this.isNegative())return t.isNegative()?this.negate().multiply(t.negate()):this.negate().multiply(t).negate();if(t.isNegative())return this.multiply(t.negate()).negate();if(this.lessThan(e.TWO_PWR_24_)&&t.lessThan(e.TWO_PWR_24_))return e.fromNumber(this.toNumber()*t.toNumber());var r=this.high_>>>16,n=65535&this.high_,i=this.low_>>>16,o=65535&this.low_,a=t.high_>>>16,s=65535&t.high_,l=t.low_>>>16,u=65535&t.low_,h=0,c=0,d=0,f=0;return f+=o*u,d+=f>>>16,f&=65535,d+=i*u,c+=d>>>16,d&=65535,d+=o*l,c+=d>>>16,d&=65535,c+=n*u,h+=c>>>16,c&=65535,c+=i*l,h+=c>>>16,c&=65535,c+=o*s,h+=c>>>16,c&=65535,h+=r*u+n*l+i*s+o*a,h&=65535,e.fromBits(d<<16|f,h<<16|c)},e.prototype.not=function(){return e.fromBits(~this.low_,~this.high_)},e.prototype.and=function(t){return e.fromBits(this.low_&t.low_,this.high_&t.high_)},e.prototype.or=function(t){return e.fromBits(this.low_|t.low_,this.high_|t.high_)},e.prototype.shiftRightUnsigned=function(t){if(t&=63,0===t)return this;var r=this.high_;if(t<32){var n=this.low_;return e.fromBits(n>>>t|r<<32-t,r>>>t)}return 32===t?e.fromBits(r,0):e.fromBits(r>>>t-32,0)},e}),r("Utils/CircleFinder",[],function(){var e,t,r=function(r){for(np=r.length,e=vec3.add2(r[0],r[1]),e=vec3.normalize2(e),t=vec3.dot2(r[0],e),i=2;i<np;++i)vec3.dot2(r[i],e)<t&&this.getCircle(r,i)};return r.prototype.getCircle=function(r,n,o){for(e=vec3.add2(r[n],r[o]),e=vec3.normalize2(e),t=vec3.dot2(r[n],e),i=0;i<n;++i)if(vec3.dot2(r[i],e)<t){var a=vec3.subtract2(r[n],r[i]),s=vec3.subtract2(r[o],r[i]);e=vec3.cross2(a,s),e=vec3.normalize2(e),t=vec3.dot2(r[n],e),t<0&&(e=vec3.flip(e),t=-t)}},r.prototype.getCircle=function(r,n){for(e=vec3.add2(r[0],r[n]),e=vec3.normalize2(e),t=vec3.dot2(r[0],e),i=1;i<n;++i)vec3.dot2(r[i],e)<t&&this.getCircle(r,i,n)},r.prototype.getCenter=function(){return e},r.prototype.getCosRad=function(){return t},r}),r("Tiling/HEALPixBase",["./HEALPixTables","../Utils/Long","../Utils/CircleFinder"],function(e,t,r){var n=1.570796325,i=function(e,t){e<0&&(e+=360);var r=e*Math.PI/180,n=(-t+90)*Math.PI/180;return[r,n]},o=function(e,t){if(e>=0)return e<t?e:e%t;var r=e%t+t;return r===t?0:r},a=function(t){return e.utab[255&t]|e.utab[t>>>8&255]<<16|e.utab[t>>>16&255]<<32|e.utab[t>>>24&255]<<48},s=function(e,t,r,n){return(r<<2*n)+a(e)+(a(t)<<1)},l=function(e,r,n){var i=Math.pow(2,e),a=Math.cos(n),l={phi:r,theta:n,z:a};Math.abs(a)>.9&&(l.sth=Math.sin(n),l.have_sth=!0);var u,h,c,d=2/Math.PI,f=o(r*d,4),p=Math.abs(a);if(p<=2/3){var m=i*(.5+f),v=i*(.75*a);u=t.fromNumber(m-v),h=t.fromNumber(m+v);var g,y=u.shiftRightUnsigned(e),x=h.shiftRightUnsigned(e);g=y.equals(x)?y.or(t.fromInt(4)):y.lessThan(x)?y:x.add(t.fromInt(8)),c=t.fromNumber(i-1);var b=h.and(c),T=c.subtract(u.and(c));return s(b.toInt(),T.toInt(),g.toInt(),e)}var w=parseInt(Math.min(3,parseInt(f))),S=f-w,A=p<.9||!l.have_sth?i*Math.sqrt(3*(1-p)):i*l.sth/Math.sqrt((1+p)/3);u=t.fromNumber(S*A),h=t.fromNumber((1-S)*A);var M=t.fromNumber(i);c=t.fromNumber(i-1);var C=t.fromInt(1);return u.greaterThanOrEqual(M)&&(u=c),h.greaterThanOrEqual(M)&&(h=c),a>=0?s(M.subtract(h).subtract(C).toInt(),M.subtract(u).subtract(C).toInt(),w,e):s(u.toInt(),h.toInt(),w+8,e)},u=function(e){this.p=new Array(e),this.o=new Array(e);for(var t=0;t<this.p.length;t++)this.p[t]=0,this.o[t]=0;this.s=this.m=0};u.prototype.push=function(e,t){this.p[this.s]=e,this.o[this.s]=t,++this.s},u.prototype.otop=function(){return this.o[this.s-1]},u.prototype.ptop=function(){return this.p[this.s-1]},u.prototype.pop=function(){this.s--},u.prototype.popToMark=function(){this.s=this.m},u.prototype.mark=function(){this.m=this.s},u.prototype.size=function(){return this.s};var h={init:function(e){this.order_max=29,this.bn=[],this.nside=null;try{for(var t=0;t<=this.order_max;++t)this.bn[t]=this.createBoundaries(1<<t,"NESTED")}catch(e){}},createBoundaries:function(e,t){return this.nside=e-1,this.calculateBoundaries(e,t)},compress_bits:function(r){var n=t.fromNumber(r),i=t.fromNumber(0x5555555555555),o=n.and(i),a=o.shiftRightUnsigned(15);o=o.or(a);var s=o.and(t.fromNumber(65535)).toInt(),l=o.shiftRightUnsigned(32),u=l.and(t.fromNumber(65535)).toInt();return e.ctab[255&s]|e.ctab[s>>>8]<<4|e.ctab[255&u]<<16|e.ctab[u>>>8]<<20},fxyf:function(t,r,i){var o,a,s=e.jrll[i]-t-r,l=0,u=0,h=0,c=!1;s<1?(o=s,a=o*o/3,l=1-a,l>.99&&(h=Math.sqrt(a*(2-a)),c=!0)):s>3?(o=4-s,a=o*o/3,l=a-1,l<-.99&&(h=Math.sqrt(a*(2-a)),c=!0)):(o=1,l=2*(2-s)/3),a=e.jpll[i]*o+t-r,a<0&&(a+=8),a>=8&&(a-=8),u=o<1e-15?0:.5*n*a/o;var d=c?h:Math.sqrt((1-l)*(1+l));return[d*Math.cos(u),d*Math.sin(u),l]},maxPixrad:function(e,t){var r=Math.pow(2,e),n=vec3.createZPhi(2/3,Math.PI/t),i=1-1/r;i*=i;var o=vec3.createZPhi(1-i/3,0);return vec3.angle2(n,o)},pix2vec:function(e,t){var r=this.pix2loc(e,t),n=r.have_sth?r.sth:Math.sqrt((1-r.z)*(1+r.z));return vec3.createFrom(n*Math.cos(r.phi),n*Math.sin(r.phi),r.z)},pix2loc:function(t,r){var i,o,a={phi:null,sth:0,have_sth:!1,z:null},s=this.nest2xyf(t,r.npface,r.order),l=(e.jrll[s.face]<<r.order)-s.ix-s.iy-1;return l<r.nside?(i=l,o=i*i*r.fact2,a.z=1-o,a.z>.99&&(a.sth=Math.sqrt(o*(2-o)),a.have_sth=!0)):l>r.nl3?(i=r.nl4-l,o=i*i*r.fact2,a.z=o-1,a.z<-.99&&(a.sth=Math.sqrt(o*(2-o)),a.have_sth=!0)):(i=r.nside,a.z=(r.nl2-l)*r.fact1),o=e.jpll[s.face]*i+s.ix-s.iy,o<0&&(o+=8*i),a.phi=i===r.nside?.75*n*o*r.fact1:.5*n*o/i,a},nest2xyf:function(e,t,r){var n=e&t-1,i=h.compress_bits(n),o=h.compress_bits(n>>>1),a=e>>>2*r;return{ix:i,iy:o,face:a}},nside2order:function(e){for(var t=0;e>65535;)t+=16,e>>>=16;return e>255&&(t|=8,e>>>=8),e>15&&(t|=4,e>>>=4),e>3&&(t|=2,e>>>=2),e>1&&(t|=1),t},calculateBoundaries:function(e,t){if(this.nside!==e){this.nside=e;var r=this.nside2order(e);if("NESTED"===t&&r<0)throw new Exception("Nside must be a power of 2 for NESTED scheme");var n=2*this.nside,i=3*this.nside,o=4*this.nside,a=this.nside*this.nside,s=2*this.nside*(this.nside-1),l=12*a,u=4/l,h=(this.nside<<1)*u;return{order:r,nside:this.nside,scheme:t,nl2:n,nl3:i,nl4:o,npface:a,ncap:s,npix:l,fact1:h,fact2:u}}},convertPolygonToHealpixOrder:function(e,t,r){var n=[],i=t||4,o=r||5;return _.each(e,function(e){var t=Math.PI/180,r=Math.cos(e[1]*t),i=Math.cos(e[0]*t)*r,o=Math.sin(e[0]*t)*r,a=Math.sin(e[1]*t),s=Math.atan2(Math.sqrt(i*i+o*o),a),l=Math.atan2(o,i);l<0&&(l+=2*Math.PI),l>=2*Math.PI&&(l-=2*Math.PI),n.push({theta:s,phi:l})}),this.queryPolygonInclusive(n,i,o)},queryPolygonInclusive:function(e,t,n){Math.PI=3.141592653589793;var i=Math.PI/2,o=0!==t,a=e.length,s=o?a+1:a;if(a<3)return void alert("not enough vertices in polygon");var l,u=new Array(a);for(l=0;l<a;++l)u[l]=vec3.createPhiTheta(e[l].phi,e[l].theta);var h=new Array(s),c=0;for(l=0;l<a;++l){h[l]=vec3.cross2(u[l],u[(l+1)%a]);var d=vec3.dot2(h[l],u[(l+2)%a]);0===l&&(c=d<0?-1:1),h[l]=vec3.scale2(h[l],c/vec3.length2(h[l]))}var f=new Array(s);if(this.fill(f,i),o){var p=new r(u);h[a]=p.getCenter(),f[a]=Math.acos(p.getCosRad())}var m=this.queryMultiDisc(h,f,t,n);return console.dir(m),m},fill:function(e,t){for(var r=0,n=e.length;r<n;r++)e[r]=t},queryMultiDisc:function(e,t,r,n){var i=n,o=0!==r,a=e.length,s=[],l=0;o&&(l=this.ilog2(r));for(var c,d=i+l,f=new Array(d+1),p=0;p<d+1;p++){f[p]=new Array(a);for(var m=0;m<a;m++)f[p][m]=new Array(3)}var v={order:i};h.init(v);var g;for(g=0;g<=d;++g){c=h.bn[g];var y=h.maxPixrad(g,c.nl4);for(p=0;p<a;++p)f[g][p][0]=t[p]+y>Math.PI?-1:Math.cos(t[p]+y),f[g][p][1]=0===g?Math.cos(t[p]):f[0][p][1],f[g][p][2]=t[p]-y<0?1:Math.cos(t[p]-y)}var x=new u(12+3*d);for(p=0;p<12;p++)x.push(11-p,0);for(;x.size()>0;){var b=x.ptop();g=x.otop(),x.pop(),c=h.bn[g];var T=h.pix2vec(b,c),w=3;for(p=0;p<a&&w>0;++p)for(var S=vec3.dot2(T,e[p]),A=0;A<w;++A)S<f[g][p][A]&&(w=A);w>0&&this.check_pixel(g,d,w,s,b,x,o,n)}return s},check_pixel:function(e,t,r,n,i,o,a,s){var l,u=s;if(0!==r)if(e<u)if(r>=3){var h=2*(u-e),c=i<<h,d=i+1<<h;for(l=c;l<=d;l++)n.push(l)}else for(l=0;l<4;++l)o.push(4*i+3-l,e+1);else if(e>u)if(r>=2)n.push(i>>>2*(e-u)),o.popToMark();else if(e<t)for(l=0;l<4;++l)o.push(4*i+3-l,e+1);else n.push(i>>>2*(e-u)),o.popToMark();else if(r>=2)n.push(i);else if(a)if(u<t)for(o.mark(),l=0;l<4;++l)o.push(4*i+3-l,e+1);else n.push(i)},ilog2:function(e){for(var t=0;e>65535;)t+=16,e>>>=16;return e>255&&(t|=8,e>>>=8),e>15&&(t|=4,e>>>=4),e>3&&(t|=2,e>>>=2),e>1&&(t|=1),t},lonLat2pix:function(e,t,r){var n=i(t,r);return l(e,n[0],n[1])},getChildren:function(e){return[4*e,4*e+1,4*e+2,4*e+3]},uniq2hpix:function(e,t){null===t&&(t=[]),t[0]=h.log2(e/4)/2;var r=h.pow2(t[0]);return t[1]=e-4*r*r,t[0]=parseInt(t[0]),t},log2:function(e){for(var t=0;e>>>++t>0;);return--t},pow2:function(e){return 1<<e},getPixRes:function(e){var t=648e3/Math.PI;return t*Math.sqrt(4*Math.PI/(12*e*e))}};return h}),r("Tiling/GeoTiling",["../Utils/Utils","./Tile","../Renderer/GeoBound","./HEALPixBase"],function(e,t,r,n){var i=function(e,r,n,i){t.prototype.constructor.call(this),this.bound=this.geoBound=e,this.level=r,this.x=n,this.y=i};i.prototype=new t,i.prototype.getElevation=function(e,r){var n=(e-this.geoBound.west)/(this.geoBound.east-this.geoBound.west),i=(r-this.geoBound.north)/(this.geoBound.south-this.geoBound.north),o=2*(i>=1?1:Math.floor(2*i))+Math.floor(2*n);if(this.children&&this.children[o].state===t.State.LOADED)return this.children[o].getElevation(e,r);var a=this.config.tesselation,s=Math.floor(n*a),l=Math.floor(i*a),u=this.config.vertexSize*(l*a+s),h=[this.vertices[u],this.vertices[u+1],this.vertices[u+2]];mat4.multiplyVec3(this.matrix,h);var c=this.config.coordinateSystem.from3DToGeo(h);return c[2]},i.prototype.createChildren=function(){var e=.5*(this.geoBound.east+this.geoBound.west),t=.5*(this.geoBound.north+this.geoBound.south),n=this.level+1,o=new i(new r(this.geoBound.west,t,e,this.geoBound.north),n,2*this.x,2*this.y),a=new i(new r(e,t,this.geoBound.east,this.geoBound.north),n,2*this.x+1,2*this.y),s=new i(new r(this.geoBound.west,this.geoBound.south,e,t),n,2*this.x,2*this.y+1),l=new i(new r(e,this.geoBound.south,this.geoBound.east,t),n,2*this.x+1,2*this.y+1);o.initFromParent(this,0,0),a.initFromParent(this,1,0),s.initFromParent(this,0,1),l.initFromParent(this,1,1),this.children=[o,a,s,l]},i.prototype.lonlat2tile=function(e){for(var t=this.geoBound.east-this.geoBound.west,r=this.geoBound.south-this.geoBound.north,n=this.config.tesselation-1,i=[],o=0;o<e.length;o++){var a=n*(e[o][0]-this.geoBound.west)/t,s=n*(e[o][1]-this.geoBound.north)/r;i.push([a,s])}return i},i.prototype.generateVertices=function(e){this.matrix=this.config.coordinateSystem.getLHVTransform(this.geoBound.getCenter());var t=mat4.create();mat4.inverse(this.matrix,t),this.inverseMatrix=t;for(var r=this.config.vertexSize,n=this.config.tesselation,i=new Float32Array(r*n*(n+6)),o=(this.geoBound.east-this.geoBound.west)/(n-1),a=(this.geoBound.south-this.geoBound.north)/(n-1),s=(this.config.coordinateSystem.geoide.radius,this.config.coordinateSystem.geoide.heightScale,0),l=this.geoBound.north,u=[0,0,0],h=0;h<n;h++){for(var c=this.geoBound.west,d=0;d<n;d++){var f=e?e[s]:0;this.config.coordinateSystem.fromGeoTo3D([c,l,f],u);var p=u[0],m=u[1],v=u[2],g=s*r;i[g]=t[0]*p+t[4]*m+t[8]*v+t[12],i[g+1]=t[1]*p+t[5]*m+t[9]*v+t[13],i[g+2]=t[2]*p+t[6]*m+t[10]*v+t[14],s++,c+=o}l+=a}return i};var o=function(e,t){this.level0NumTilesX=e,this.level0NumTilesY=t};o.prototype.generateLevelZeroTiles=function(e){e.skirt=!e.coordinateSystem.isFlat,e.cullSign=1,e.srs="EPSG:4326";for(var t=[],n=(e.coordinateSystem.geoBound[3]-e.coordinateSystem.geoBound[1])/this.level0NumTilesY,o=(e.coordinateSystem.geoBound[2]-e.coordinateSystem.geoBound[0])/this.level0NumTilesX,a=0;a<this.level0NumTilesY;a++)for(var s=0;s<this.level0NumTilesX;s++){var l=new r(e.coordinateSystem.geoBound[0]+s*o,e.coordinateSystem.geoBound[3]-(a+1)*n,e.coordinateSystem.geoBound[0]+(s+1)*o,e.coordinateSystem.geoBound[3]-a*n),u=new i(l,0,s,a);u.config=e,t.push(u)}return t};var a=function(e){var t,r=!0;switch(e.type){case"Point":return t=e.coordinates,[t[0],t[1],t[0],t[1]];case"MultiPoint":t=e.coordinates,r=!1;break;case"Polygon":t=e.coordinates[0];break;case"MultiPolygon":t=e.coordinates[0][0];break;case"LineString":t=e.coordinates;break;case"MultiLineString":t=e.coordinates[0]}if(t&&0!==t.length){for(var n=t[0][0],i=t[0][1],o=t[0][0],a=t[0][1],s="MultiPolygon"===e.type||"MultiLineString"===e.type?e.coordinates.length:1,l=0;l<s;l++){switch(e.type){case"MultiPolygon":t=e.coordinates[l][0];break;case"MultiLineString":t=e.coordinates[l]}for(var u=0;u<t.length;u++)n=Math.min(n,t[u][0]),i=Math.min(i,t[u][1]),o=Math.max(o,t[u][0]),a=Math.max(a,t[u][1]),r&&u>0&&Math.abs(t[u-1][0]-t[u][0])>180&&(n=-180,o=180)}return[n,i,o,a]}};return o.prototype._lon2LevelZeroIndex=function(e){return Math.min(this.level0NumTilesX-1,Math.floor((e+180)*this.level0NumTilesX/360))},o.prototype._lat2LevelZeroIndex=function(e){return Math.min(this.level0NumTilesY-1,Math.floor((90-e)*this.level0NumTilesY/180))},o.prototype.lonlat2LevelZeroIndex=function(e,t){return this._lat2LevelZeroIndex(t)*this.level0NumTilesX+this._lon2LevelZeroIndex(e)},o.prototype.getOverlappedLevelZeroTiles=function(e){var t=[],r=a(e);if(r)for(var n=this._lon2LevelZeroIndex(r[0]),i=this._lat2LevelZeroIndex(r[3]),o=this._lon2LevelZeroIndex(r[2]),s=this._lat2LevelZeroIndex(r[1]),l=i;l<=s;l++)for(var u=n;u<=o;u++)t.push(l*this.level0NumTilesX+u);return t},o.prototype.findInsideTile=function(e,t,r){var i=mizar.getScene().coordinateSystem;if("EQ"!==i.type){var o=i.convert([e,t],"EQ",i.type);e=o[0],t=o[1]}for(var a=0;a<r.length;a++){var s=r[a],l=n.lonLat2pix(s.order,e,t);if(l===s.pixelIndex)return s}return null},o}),r("Tiling/TilePool",[],function(){var e=function(e){var t=e.gl,r={},n=[],i=this,o=t.getExtension("OES_texture_float_linear"),a=o?t.LINEAR:t.NEAREST;this.numCreatedTextures=0,this.numReusedTextures=0;var s=function(e,r){var n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),"byte"===e.dataType?(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.generateMipmap(t.TEXTURE_2D)):(t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,e.width,e.height,0,t.LUMINANCE,t.FLOAT,e.typedArray),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,a),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,a)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),n.pool=r,i.numCreatedTextures++,n},l=function(e,r){var n=r.pop();return t.bindTexture(t.TEXTURE_2D,n),"byte"===e.dataType?(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.generateMipmap(t.TEXTURE_2D)):t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,e.width,e.height,0,t.LUMINANCE,t.FLOAT,e.typedArray),i.numReusedTextures++,n},u=function(e){var t=e.dataType+e.width;return r[t]||(r[t]=[]),r[t]};this.createGLTexture=function(e){var t=u(e);return t.length>0?l(e,t):s(e,t)},this.createGLBuffer=function(e){var r;return r=n.length>0?n.pop():t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),r},this.disposeGLTexture=function(e){e.pool.push(e)},this.disposeGLBuffer=function(e){n.push(e)},this.disposeAll=function(){var e;for(var i in r)if(r.hasOwnProperty(i)){var o=r[i];for(e=0;e<o.length;e++)t.deleteTexture(o[e])}for(r={},e=0;e<n.length;e++)t.deleteBuffer(n[e]);n.length=0}};return e}),r("Utils/ImageRequest",[],function(){var e=function(e){this.successCallback=e.successCallback,this.failCallback=e.failCallback,this.abortCallback=e.abortCallback,this.image=null};return e.prototype.send=function(e,t){this.image=new Image,this.image.crossOrigin=t,this.image.dataType="byte";var r=this;this.image.onload=function(){var e=0!==r.image.naturalWidth&&r.image.complete;e&&r.successCallback.call(r)},this.image.onerror=this.failCallback.bind(this),this.image.src=e},e.prototype.abort=function(){this.abortCallback&&this.abortCallback(this),this.image.src=""},e}),r("Tiling/TileRequest",["./Tile","../Utils/ImageRequest"],function(e,t){var r=function(r){var n,i=!1,o=!0,a=new XMLHttpRequest;this.tile=null,this.elevations=null,this.image=null;var s=this,l=function(){s.elevations=r.elevationProvider.parseElevations(a.responseText),o=!0,i&&(r.pendingRequests.splice(r.pendingRequests.indexOf(s),1),r.completedRequests.push(s),r.renderContext.requestFrame())},u=function(){s.elevations=null,o=!0,i&&(r.pendingRequests.splice(r.pendingRequests.indexOf(s),1),r.completedRequests.push(s),r.renderContext.requestFrame())};a.onreadystatechange=function(e){4===a.readyState&&(200===a.status?l():u())};var h=function(){i||(i=!0,o&&(r.imageryProvider&&r.imageryProvider.handleImage&&r.imageryProvider.handleImage(n),r.pendingRequests.splice(r.pendingRequests.indexOf(s),1),r.completedRequests.push(s),r.renderContext.requestFrame()),s.image=n.image)},c=function(){s.tile.state=e.State.ERROR,r.pendingRequests.splice(r.pendingRequests.indexOf(s),1),r.availableRequests.push(s)},d=function(){s.tile.state=e.State.NONE,r.pendingRequests.splice(r.pendingRequests.indexOf(s),1),r.availableRequests.push(s)};this.launch=function(l){if(l.state=e.State.LOADING,this.tile=l,r.pendingRequests.push(this),this.image=null,this.elevations=null,r.elevationProvider){o=!1,a.open("GET",r.elevationProvider.getUrl(l));var u="use-credentials"===r.elevationProvider.crossOrigin;a.withCredentials=u,a.send()}else o=!0;if(r.imageryProvider){n||(n=new t({successCallback:function(){h(),r.imageryProvider.cache&&r.imageryProvider.cache.storeInCache(s)},failCallback:c,abortCallback:d}));var f;r.imageryProvider.cache&&(f=f=r.imageryProvider.cache.getFromCache(l)),i=!1,f?(n.image=f.image,h()):n.send(r.imageryProvider.getUrl(l),r.imageryProvider.crossOrigin)}else i=!0;r.imageryProvider||r.elevationProvider||(r.pendingRequests.splice(r.pendingRequests.indexOf(this),1),r.completedRequests.push(this))},this.abort=function(){n&&n.abort()}};return r}),r("Tiling/TileIndexBuffer",[],function(){var e=function(e,t){this.renderContext=e,this.config=t,this.solidIndexBuffer=null,this.subSolidIndexBuffer=[null,null,null,null],this.subIndices=[null,null,null,null]};return e.prototype.reset=function(){for(var e=this.renderContext.gl,t=0;t<4;t++)this.subSolidIndexBuffer[t]&&(e.deleteBuffer(this.subSolidIndexBuffer[t]),this.subSolidIndexBuffer[t]=null);this.solidIndexBuffer&&(e.deleteBuffer(this.solidIndexBuffer),this.solidIndexBuffer=null)},e.prototype.getSubSolid=function(e){if(null===this.subSolidIndexBuffer[e]){var t,r,n=e%2,i=Math.floor(e/2),o=this.config.tesselation,a=(o-1)/2,s=[];for(t=a*i;t<a*(i+1);t++)for(r=a*n;r<a*(n+1);r++)s.push(t*o+r),s.push((t+1)*o+r),s.push(t*o+r+1),s.push(t*o+r+1),s.push((t+1)*o+r),s.push((t+1)*o+r+1);if(this.subIndices[e]=s,this.config.skirt){var l=0===i?o*o:o*o+4*o,u=0===i?0:a*o;for(t=a*n;t<a*(n+1);t++)s.push(l+t),s.push(u+t),s.push(l+t+1),s.push(l+t+1),s.push(u+t),s.push(u+t+1);for(l=0===i?o*o+4*o:o*o+o,u=0===i?a*o:(o-1)*o,t=a*n;t<a*(n+1);t++)s.push(u+t),s.push(l+t),s.push(u+t+1),s.push(u+t+1),s.push(l+t),s.push(l+t+1);for(l=0===n?o*o+2*o:o*o+5*o,u=0===n?0:a,r=a*i;r<a*(i+1);r++)s.push(l+r),s.push(l+r+1),s.push(u+r*o),s.push(u+r*o),s.push(l+r+1),s.push(u+(r+1)*o);for(l=0===n?o*o+5*o:o*o+3*o,u=0===n?a:o-1,r=a*i;r<a*(i+1);r++)s.push(r*o+u),s.push((r+1)*o+u),s.push(l+r),s.push(l+r),s.push((r+1)*o+u),s.push(l+r+1)}var h=this.renderContext.gl,c=h.createBuffer();h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,c),h.bufferData(h.ELEMENT_ARRAY_BUFFER,new Uint16Array(s),h.STATIC_DRAW),c.numIndices=s.length,this.subSolidIndexBuffer[e]=c}return this.subSolidIndexBuffer[e]},e.prototype.getSolid=function(){if(null===this.solidIndexBuffer){var e,t,r=this.config.tesselation,n=[];for(t=0;t<r-1;t++)for(e=0;e<r-1;e++)n.push(t*r+e),n.push((t+1)*r+e),n.push(t*r+e+1),n.push(t*r+e+1),n.push((t+1)*r+e),n.push((t+1)*r+e+1);if(this.config.skirt){var i=r*r;for(e=0;e<r-1;e++)n.push(i+e),n.push(e),n.push(i+e+1),n.push(i+e+1),n.push(e),n.push(e+1);for(i+=r,e=0;e<r-1;e++)n.push((r-1)*r+e),n.push(i+e),n.push((r-1)*r+e+1),n.push((r-1)*r+e+1),n.push(i+e),n.push(i+e+1);for(i+=r,t=0;t<r-1;t++)n.push(i+t),
n.push(i+t+1),n.push(t*r),n.push(t*r),n.push(i+t+1),n.push((t+1)*r);for(i+=r,t=0;t<r-1;t++)n.push(t*r+r-1),n.push((t+1)*r+r-1),n.push(i+t),n.push(i+t),n.push((t+1)*r+r-1),n.push(i+t+1)}var o=this.renderContext.gl,a=o.createBuffer();o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,a),o.bufferData(o.ELEMENT_ARRAY_BUFFER,new Uint16Array(n),o.STATIC_DRAW),this.numIndices=n.length,this.solidIndexBuffer=a,this.solidIndexBuffer.numIndices=n.length}return this.solidIndexBuffer},e}),r("Renderer/Program",[],function(){var e=function(e){this.renderContext=e,this.glProgram=null,this.attributes={},this.uniforms={},this.numActiveAttribArray=0};return e.prototype.createShader=function(e,t){var r=this.renderContext.gl,n=r.createShader(e);return r.shaderSource(n,t),r.compileShader(n),r.getShaderParameter(n,r.COMPILE_STATUS)?n:(console.log("Shader compilation error: "+r.getShaderInfoLog(n)),console.log(t),r.deleteShader(n),null)},e.prototype.createFromSource=function(e,t){var r=this.renderContext.gl,n=this.createShader(r.VERTEX_SHADER,e),i=this.createShader(r.FRAGMENT_SHADER,t);if(null===n||null===i)return!1;var o;if(this.glProgram=r.createProgram(),r.attachShader(this.glProgram,n),r.attachShader(this.glProgram,i),r.linkProgram(this.glProgram),!r.getProgramParameter(this.glProgram,r.LINK_STATUS))return console.log("Program link error: "+r.getProgramInfoLog(this.glProgram)),r.deleteShader(n),r.deleteShader(i),r.deleteProgram(this.glProgram),this.glProgram=null,!1;var a=r.getProgramParameter(this.glProgram,r.ACTIVE_ATTRIBUTES);for(this.numActiveAttribArray=0,o=0;o<a;++o){var s=r.getActiveAttrib(this.glProgram,o),l=r.getAttribLocation(this.glProgram,s.name);this.attributes[s.name]=l,l+1>this.numActiveAttribArray&&(this.numActiveAttribArray=l+1)}var u=r.getProgramParameter(this.glProgram,r.ACTIVE_UNIFORMS);for(o=0;o<u;++o){var h=r.getActiveUniform(this.glProgram,o);this.uniforms[h.name]=r.getUniformLocation(this.glProgram,h.name)}return!0},e.prototype.loadFromFile=function(e,t){var r=new XMLHttpRequest;r.open("get",this.renderContext.shadersPath+e,!1),r.send(null);var n=r.responseText;r.open("get",this.renderContext.shadersPath+t,!1),r.send(null);var i=r.responseText;return this.createFromSource(n,i)},e.prototype.apply=function(){var e,t=this.renderContext,r=t.gl;for(r.useProgram(this.glProgram),e=t.numActiveAttribArray;e<this.numActiveAttribArray;e++)r.enableVertexAttribArray(e);for(e=this.numActiveAttribArray;e<t.numActiveAttribArray;e++)r.disableVertexAttribArray(e);t.numActiveAttribArray=this.numActiveAttribArray},e.prototype.dispose=function(){this.renderContext.gl.deleteProgram(this.glProgram)},e}),r("Tiling/TileManager",["./Tile","./GeoTiling","./TilePool","./TileRequest","./TileIndexBuffer","../Renderer/Program"],function(e,t,r,n,i,o){var a=function(e,a){this.parent=e,this.renderContext=this.parent.renderContext,this.tilePool=e.tilePool||new r(this.renderContext),this.tiling=new t(4,2),this.imageryProvider=null,this.elevationProvider=null,this.tilesToRender=[],this.visibleTiles=[],this.tilesToRequest=[],this.postRenderers=[];var s=this.renderContext.gl;this.defaultTexture=s.createTexture(),s.bindTexture(s.TEXTURE_2D,this.defaultTexture);var l=a.defaultColor?a.defaultColor:[200,200,200,255],u=new Uint8Array(l);s.texImage2D(s.TEXTURE_2D,0,s.RGBA,1,1,0,s.RGBA,s.UNSIGNED_BYTE,u),this.maxRequests=4,this.availableRequests=[];for(var h=0;h<this.maxRequests;h++)this.availableRequests[h]=new n(this);this.pendingRequests=[],this.completedRequests=[],this.level0TilesLoaded=!1,this.tileConfig={tesselation:9,skirt:!0,cullSign:1,imageSize:256,vertexSize:this.renderContext.lighting?6:3,normals:this.renderContext.lighting,coordinateSystem:this.parent.coordinateSystem},this.level0Tiles=this.tiling.generateLevelZeroTiles(this.tileConfig,this.tilePool),this.tcoordBuffer=null,this.tileIndexBuffer=new i(this.renderContext,this.tileConfig),this.renderTileWithoutTexture=!a.hasOwnProperty("renderTileWithoutTexture")||a.renderTileWithoutTexture,this.freeze=!1,this.numTilesGenerated=0,this.frameNumber=0,this.vertexShader="attribute vec3 vertex;\n",this.vertexShader+="attribute vec2 tcoord;\n",this.vertexShader+="uniform mat4 modelViewMatrix;\n",this.vertexShader+="uniform mat4 projectionMatrix;\n",this.vertexShader+="varying vec2 texCoord;\n",this.renderContext.lighting&&(this.vertexShader+="attribute vec3 normal;\nvarying vec3 color;\n"),this.vertexShader+="void main(void) \n",this.vertexShader+="{\n",this.vertexShader+="gl_Position = projectionMatrix * modelViewMatrix * vec4(vertex, 1.0);\n",this.renderContext.lighting&&(this.vertexShader+="vec4 vn = modelViewMatrix * vec4(normal,0);\ncolor = max( vec3(-vn[2],-vn[2],-vn[2]), 0.0 );\n"),this.vertexShader+="texCoord = tcoord;\n",this.vertexShader+="}\n",this.fragmentShader="precision lowp float; \n",this.fragmentShader+="varying vec2 texCoord;\n",this.renderContext.lighting&&(this.fragmentShader+="varying vec3 color;\n"),this.fragmentShader+="uniform sampler2D colorTexture;\n",this.fragmentShader+="void main(void)\n",this.fragmentShader+="{\n",this.fragmentShader+="\tgl_FragColor.rgb = texture2D(colorTexture, texCoord).rgb;\n",this.renderContext.lighting&&(this.fragmentShader+="  gl_FragColor.rgb *= color;\n"),this.fragmentShader+="  gl_FragColor.a = 1.0;\n",this.fragmentShader+="}\n",this.program=new o(this.renderContext),this.program.createFromSource(this.vertexShader,this.fragmentShader)};a.prototype.addPostRenderer=function(e){this.postRenderers.push(e),this.postRenderers.sort(function(e,t){var r=0|e.zIndex,n=0|t.zIndex;return r-n}),e.generate&&this.visitTiles(function(t){e.generate(t)})},a.prototype.removePostRenderer=function(e){var t=this.postRenderers.indexOf(e);t!==-1&&(e.cleanupTile&&this.visitTiles(function(t){e.cleanupTile(t)}),this.postRenderers.splice(t,1))},a.prototype.setImageryProvider=function(e){this.reset(),this.imageryProvider=e,e&&(this.tilePool.disposeAll(),this.tiling=e.tiling,this.tileConfig.imageSize=e.tilePixelSize,this.level0Tiles=this.tiling.generateLevelZeroTiles(this.tileConfig,this.tilePool),e.customShader?(this.program.dispose(),this.program=new o(this.renderContext),this.currentFragmentShader=e.customShader.fragmentCode?e.customShader.fragmentCode:this.fragmentShader,this.program.createFromSource(e.customShader.vertexCode?e.customShader.vertexCode:this.vertexShader,this.currentFragmentShader)):null!==this.currentFragmentShader&&(this.program.dispose(),this.program=new o(this.renderContext),this.program.createFromSource(this.vertexShader,this.fragmentShader),this.currentFragmentShader=null))},a.prototype.setElevationProvider=function(e){this.reset(),this.elevationProvider=e;var t=e?e.tilePixelSize:9;if(t!==this.tileConfig.tesselation){this.tileConfig.tesselation=t;var r=this.renderContext.gl;this.tileIndexBuffer.reset(),r.deleteBuffer(this.tcoordBuffer),this.tcoordBuffer=null}},a.prototype.reset=function(){this.abortRequests();for(var e=0;e<this.level0Tiles.length;e++)this.level0Tiles[e].deleteChildren(this.renderContext,this.tilePool),this.level0Tiles[e].dispose(this.renderContext,this.tilePool);this.level0TilesLoaded=!1},a.prototype.abortRequests=function(){for(var e=this.pendingRequests.length-1;e>=0;e--)this.pendingRequests[e].abort()},a.prototype.visitTiles=function(e){for(var t=this.level0Tiles.concat([]);t.length>0;){var r=t.shift();e(r),r.children&&(t.push(r.children[0]),t.push(r.children[1]),t.push(r.children[2]),t.push(r.children[3]))}},a.prototype.traverseTiles=function(){this.tilesToRender.length=0,this.visibleTiles.length=0,this.tilesToRequest.length=0,this.numTraversedTiles=0;var t,r;if(!this.level0TilesLoaded){for(this.level0TilesLoaded=!0,t=0;t<this.level0Tiles.length;t++){r=this.level0Tiles[t];var n=r.state===e.State.LOADED;r.frameNumber=this.frameNumber,this.level0TilesLoaded=this.level0TilesLoaded&&n,n||(r.state===e.State.NONE?(r.state=e.State.REQUESTED,this.tilesToRequest.push(r)):r.state===e.State.ERROR&&this.imageryProvider&&this.parent.publish("baseLayersError",this.imageryProvider))}this.level0TilesLoaded&&this.imageryProvider&&this.parent.publish("baseLayersReady")}if(this.level0TilesLoaded)for(t=0;t<this.level0Tiles.length;t++)r=this.level0Tiles[t],r.isCulled(this.renderContext)?r.deleteChildren(this.renderContext,this.tilePool):this.processTile(r,0)},a.prototype.processTile=function(t,r){this.numTraversedTiles++,t.frameNumber=this.frameNumber;var n=!0;if(t.state===e.State.NONE&&(t.state=e.State.REQUESTED,this.tilesToRequest.push(t)),t.state===e.State.LOADED&&(n=!!this.imageryProvider&&r>=this.imageryProvider.numberOfLevels,n|=!t.needsToBeRefined(this.renderContext)),n)(t.texture||this.renderTileWithoutTexture)&&this.tilesToRender.push(t),this.visibleTiles.push(t);else{null===t.children&&t.createChildren();for(var i=0;i<4;i++)t.children[i].isCulled(this.renderContext)?t.children[i].deleteChildren(this.renderContext,this.tilePool):this.processTile(t.children[i],r+1)}for(var o in t.extension){var a=t.extension[o];a.traverse&&a.traverse(t,n)}},a.prototype.generateTile=function(e,t){e.generate(this.tilePool,t.image,t.elevations);for(var r=0;r<this.postRenderers.length;r++)this.postRenderers[r].generate&&this.postRenderers[r].generate(e);this.numTilesGenerated++,this.renderContext.requestFrame()},a.prototype.generateReceivedTiles=function(){for(;this.completedRequests.length>0;){var t=this.completedRequests.pop(),r=t.tile;r.frameNumber===this.frameNumber?this.generateTile(r,t):r.state=e.State.NONE,this.availableRequests.push(t)}this.availableRequests.length===this.maxRequests&&this.imageryProvider&&this.parent.publish("endBackgroundLoad")},a.prototype.renderTiles=function(){var t,r,n,i,a=this.renderContext,s=a.gl;if(this.tileConfig.cullSign<0)n=.2*this.tileConfig.coordinateSystem.geoide.radius,i=1.1*this.tileConfig.coordinateSystem.geoide.radius;else for(n=1e9,i=0,t=0;t<this.visibleTiles.length;t++)r=this.visibleTiles[t],n=Math.min(n,r.distance-1.5*r.radius),i=Math.max(i,r.distance+1.5*r.radius);if(a.near=Math.max(a.minNear,n),a.far=Math.max(a.minFar,i),0!==this.tilesToRender.length){this.tileConfig.cullSign<0?(s.depthMask(!1),s.disable(s.DEPTH_TEST),s.disable(s.CULL_FACE)):(s.enable(s.POLYGON_OFFSET_FILL),s.polygonOffset(0,4)),this.currentFragmentShader&&this.currentFragmentShader!==this.imageryProvider.customShader.fragmentCode&&(this.program.dispose(),this.program=new o(this.renderContext),this.imageryProvider&&this.imageryProvider.customShader&&(this.currentFragmentShader=this.imageryProvider.customShader.fragmentCode?this.imageryProvider.customShader.fragmentCode:this.fragmentShader,this.program.createFromSource(this.imageryProvider.customShader.vertexShader?this.imageryProvider.customShader.vertexShader:this.vertexShader,this.currentFragmentShader))),this.program.apply();var l=this.program.attributes;mat4.perspective(a.fov,a.canvas.width/a.canvas.height,a.near,a.far,a.projectionMatrix),this.imageryProvider&&this.imageryProvider.customShader&&this.imageryProvider.customShader.updateUniforms(s,this.program),s.activeTexture(s.TEXTURE0),s.uniformMatrix4fv(this.program.uniforms.projectionMatrix,!1,a.projectionMatrix),s.uniform1i(this.program.uniforms.colorTexture,0),this.tcoordBuffer||this.buildSharedTexCoordBuffer(),s.bindBuffer(s.ARRAY_BUFFER,this.tcoordBuffer),s.vertexAttribPointer(l.tcoord,2,s.FLOAT,!1,0,0);var u=null;for(t=0;t<this.tilesToRender.length;t++){r=this.tilesToRender[t];var h=r.state===e.State.LOADED,c=r.parentIndex===-1;r.texture?s.bindTexture(s.TEXTURE_2D,r.texture):s.bindTexture(s.TEXTURE_2D,this.defaultTexture),mat4.multiply(a.viewMatrix,r.matrix,a.modelViewMatrix),s.uniformMatrix4fv(this.program.uniforms.modelViewMatrix,!1,a.modelViewMatrix),s.bindBuffer(s.ARRAY_BUFFER,r.vertexBuffer),s.vertexAttribPointer(l.vertex,3,s.FLOAT,!1,4*this.tileConfig.vertexSize,0),this.tileConfig.normals&&s.vertexAttribPointer(l.normal,3,s.FLOAT,!1,4*this.tileConfig.vertexSize,12);var d=h||c?this.tileIndexBuffer.getSolid():this.tileIndexBuffer.getSubSolid(r.parentIndex);u!==d&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,d),u=d),s.drawElements(s.TRIANGLES,u.numIndices,s.UNSIGNED_SHORT,0)}this.tileConfig.cullSign<0?(s.depthMask(!0),s.enable(s.DEPTH_TEST)):s.disable(s.POLYGON_OFFSET_FILL)}for(t=0;t<this.postRenderers.length;t++)this.postRenderers[t].render(this.visibleTiles)};var s=function(e,t){return e.distance-t.distance};return a.prototype.launchRequests=function(){this.tilesToRequest.sort(s);for(var t=this.tilesToRequest.length,r=0;r<t;r++){var n=this.tilesToRequest[r];if(this.availableRequests.length>0){this.availableRequests.length===this.maxRequests&&this.imageryProvider&&this.parent.publish("startBackgroundLoad");var i=this.availableRequests.pop();i.launch(n)}else n.state=e.State.NONE}},a.prototype.render=function(){if(!this.imageryProvider||this.imageryProvider._ready){if(!this.level0TilesLoaded&&this.imageryProvider&&this.imageryProvider.levelZeroImage){this.imageryProvider.generateLevel0Textures(this.level0Tiles,this.tilePool);for(var e=0;e<this.level0Tiles.length;e++){var t=this.level0Tiles[e];this.generateTile(t,{})}this.level0TilesLoaded=!0,this.parent.publish("baseLayersReady")}var r=this.renderContext.stats;this.freeze||(r&&r.start("traverseTime"),this.traverseTiles(),r&&r.end("traverseTime")),!this.level0TilesLoaded&&this.imageryProvider||(r&&r.start("renderTime"),this.renderTiles(),r&&r.end("renderTime")),r&&r.start("generateTime"),this.generateReceivedTiles(),r&&r.end("generateTime"),r&&r.start("requestTime"),this.launchRequests(),r&&r.end("requestTime"),this.frameNumber++}},a.prototype.getVisibleTile=function(e,t){return this.tiling.findInsideTile(e,t,this.visibleTiles)},a.prototype.buildSharedTexCoordBuffer=function(){var e=this.tileConfig.tesselation,t=this.tileConfig.skirt,r=2*e*e;t&&(r+=2*e*6);var n,i,o,a,s=new Float32Array(r),l=1/(e-1),u=0;for(i=0,a=0;a<e;a++){for(n=0,o=0;o<e;o++)s[u]=n,s[u+1]=i,u+=2,n+=l;i+=l}if(t){for(n=0,i=0,o=0;o<e;o++)s[u]=n,s[u+1]=i,n+=l,u+=2;for(n=0,i=1,o=0;o<e;o++)s[u]=n,s[u+1]=i,n+=l,u+=2;for(n=0,i=0,o=0;o<e;o++)s[u]=n,s[u+1]=i,i+=l,u+=2;for(n=1,i=0,o=0;o<e;o++)s[u]=n,s[u+1]=i,i+=l,u+=2;for(n=0,i=.5,o=0;o<e;o++)s[u]=n,s[u+1]=i,n+=l,u+=2;for(n=.5,i=0,o=0;o<e;o++)s[u]=n,s[u+1]=i,i+=l,u+=2}var h=this.renderContext.gl,c=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,c),h.bufferData(h.ARRAY_BUFFER,s,h.STATIC_DRAW),this.tcoordBuffer=c},a.prototype.setFreeze=function(e){this.freeze=e},a.prototype.getFreeze=function(){return this.freeze},a}),r("Renderer/VectorRendererManager",[],function(){var e=function(t){this.renderers=[];for(var r=0;r<e.factory.length;r++)this.renderers.push(e.factory[r](t));this.renderables=[],this.bucketId=0};e.factory=[],e.prototype.getRenderer=function(e,t){for(var r=0;r<this.renderers.length;r++)if(this.renderers[r].canApply(e.type,t))return this.renderers[r];return null},e.prototype.generate=function(e){var t;if(e.parent){var r=e.parent.extension.renderer;if(r)for(delete e.extension.renderer,t=0;t<r.renderables.length;t++){var n=r.renderables[t];n.generateChild&&n.generateChild(e)}}else for(t=0;t<this.renderers.length;t++)this.renderers[t].generateLevelZero(e)},e.prototype.addGeometry=function(e,t,r){var n=this.getRenderer(t,r);n.addGeometry(e,t,r)},e.prototype.removeGeometry=function(e,t){var r=e._bucket;return!(!r||r.layer!==t)&&(r.renderer.removeGeometry(e),!0)},e.prototype.addGeometryToTile=function(e,t,r,n){var i=this.getRenderer(t,r);i.addGeometryToTile(e,t,r,n)},e.prototype.removeGeometryFromTile=function(e,t){var r=e._bucket;r.renderer.removeGeometryFromTile(e,t)};var t=function(e,t){var r=e.bucket.style.zIndex-t.bucket.style.zIndex;return 0===r?e.bucket.id-t.bucket.id:r};return e.prototype.render=function(){var e,r;for(r=0;r<this.renderers.length;r++){var n=this.renderers[r].buckets;for(e=0;e<n.length;e++)n[e].layer._visible&&n[e].mainRenderable&&this.renderables.push(n[e].mainRenderable)}for(this.renderables.sort(t),e=0;e<this.renderables.length;){r=e+1;for(var i=this.renderables[e].bucket.renderer;r<this.renderables.length&&this.renderables[r].bucket.renderer===i;)r++;i.render(this.renderables,e,r),e=r}this.renderables.length=0},e}),r("Renderer/Ray",["./glMatrix"],function(){var e=function(e,t){this.orig=e,this.dir=t};e.createFromPixel=function(t,r,n){var i=r/t.canvas.width*2-1,o=-(n/t.canvas.height*2-1),a=mat4.create();mat4.multiply(t.projectionMatrix,t.viewMatrix,a),mat4.inverse(a);var s=mat4.multiplyVec4(a,[i,o,-1,1]);s[0]/=s[3],s[1]/=s[3],s[2]/=s[3];var l=mat4.create();mat4.inverse(t.viewMatrix,l),vec3.set([0,0,0],t.eyePosition),mat4.multiplyVec3(l,t.eyePosition);var u=vec3.create(t.eyePosition),h=vec3.subtract(s,t.eyePosition,vec3.create());return vec3.normalize(h),new e(u,h)},e.createFromEvent=function(t,r){var n=t.getXYRelativeToCanvas(r);return e.createFromPixel(n[0],n[1])},e.Intersection=function(e){this.t=e,this.geometry=null},e.prototype.computePoint=function(e){var t=vec3.create();return vec3.scale(this.dir,e,t),vec3.add(t,this.orig),t},e.prototype.planeIntersect=function(e,t){var r=vec3.dot(t,this.dir),n=1e-6;if(Math.abs(r)>n){var i=vec3.create();vec3.subtract(e,this.orig,i);var o=vec3.dot(i,t)/r;return o}return-1},e.prototype.sphereIntersect=function(e,t){var r=vec3.subtract(this.orig,e,vec3.create()),n=2*vec3.dot(this.dir,r),i=vec3.dot(r,r)-t*t,o=n*n-4*i;if(o<0)return-1;o=Math.sqrt(o);var a=(-n-o)/2,s=(-n+o)/2;if(a>s){var l=a;a=s,s=l}return s<0?-1:a<0?s:a};var t=1e-6;return e.prototype.triangleIntersectOptimized=function(r,n,i,o){var a=r[i]-r[n],s=r[i+1]-r[n+1],l=r[i+2]-r[n+2],u=r[o]-r[n],h=r[o+1]-r[n+1],c=r[o+2]-r[n+2],d=this.dir[1]*c-this.dir[2]*h,f=this.dir[2]*u-this.dir[0]*c,p=this.dir[0]*h-this.dir[1]*u,m=a*d+s*f+l*p;if(m>-t&&m<t)return null;var v=1/m,g=this.orig[0]-r[n],y=this.orig[1]-r[n+1],x=this.orig[2]-r[n+2],b=(g*d+y*f+x*p)*v;if(b<0||b>1)return null;var T=y*l-x*s,w=x*a-g*l,S=g*s-y*a,A=(this.dir[0]*T+this.dir[1]*w+this.dir[2]*S)*v;if(A<0||b+A>1)return null;var M=(u*T+h*w+c*S)*v;return M>=0?new e.Intersection(M):null},e.prototype.nodeIntersect=function(e,t){var r;for(t=t||[],r=0;r<e.children.length;r++)e.children[r].intersectWith(this,t);for(r=0;r<e.geometries.length;r++)this.geometryIntersect(e.geometries[r],t);return t.sort(function(e,t){return e.t-t.t}),t},e.prototype.lodNodeIntersect=function(e,t){var r;if(t=t||[],this.sphereIntersect(e.center,e.radius)>=0)if(e.children.length>0&&0===e.childToLoad)for(r=0;r<e.children.length;r++)this.lodNodeIntersect(e.children[r],t);else for(r=0;r<e.geometries.length;r++)this.geometryIntersect(e.geometries[r],t);return t},e.prototype.geometryIntersect=function(e,t){for(var r=e.mesh.indices,n=0;n<r.length;n+=3){var i=this.triangleIntersectOptimized(e.mesh.vertices,e.mesh.numElements*r[n],e.mesh.numElements*r[n+1],e.mesh.numElements*r[n+2]);i&&(i.geometry=e,t.push(i))}},e}),r("Utils/Event",[],function(){var e=function(){this.callbacks={}};return e.prototype.subscribe=function(e,t){this.callbacks[e]?this.callbacks[e].push(t):this.callbacks[e]=[t]},e.prototype.unsubscribe=function(e,t){if(this.callbacks[e]){var r=this.callbacks[e].indexOf(t);r!==-1&&this.callbacks[e].splice(r,1)}},e.prototype.publish=function(e,t){if(this.callbacks[e])for(var r=this.callbacks[e],n=0;n<r.length;n++)r[n](t)},e}),r("CoordinateSystem/WGS84CoordinateSystem",["./CoordinateSystem","../Utils/Utils"],function(e,t){var r=function(t){t.geoideName="WGS84",e.prototype.constructor.call(this,t)};return t.inherits(e,r),r}),r("CoordinateSystem/AstroCoordTransform",[],function(){var e=2*Math.PI,t=4*Math.PI,r=180/Math.PI,n=[[.57595865315,4.9261918136,0,0,.11129056012,4.7005372834],[.574770433,4.9368292465,0,0,.11142137093,4.71279419371]],i=[[.88781538514,-.88781538514,.39788119938,-.39788119938,.86766174755,-.86766174755],[.88998808748,-.88998808748,.39777715593,-.39777715593,.86766622025,-.86766622025]],o=[[.46019978478,.46019978478,.9174369467,.9174369467,.49715499774,.49715499774],[.45598377618,.45598377618,.91748206207,.91748206207,.49714719172,.49714719172]],a=[[4.9261918136,.57595865315,0,0,4.7005372834,.11129056012],[4.9368292465,.574770433,0,0,4.71279419371,.11142137093]],s={transform:function(r,s){var l,u,h,c,d,f,p,m=1;return h=r[0]-a[m][s],c=r[1],d=Math.sin(c),f=Math.cos(c),p=f*Math.sin(h),c=-i[m][s]*p+o[m][s]*d,c=Math.max(-1,Math.min(c,1)),u=Math.asin(c),h=Math.atan2(o[m][s]*p+i[m][s]*d,f*Math.cos(h)),l=(h+n[m][s]+t)%e,[l,u]},transformInDeg:function(s,l){var u,h,c,d,f,p,m,v=1;return c=s[0]/r-a[v][l],d=s[1]/r,f=Math.sin(d),p=Math.cos(d),m=p*Math.sin(c),d=-i[v][l]*m+o[v][l]*f,d=Math.max(-1,Math.min(d,1)),h=Math.asin(d)*r,c=Math.atan2(o[v][l]*m+i[v][l]*f,p*Math.cos(c)),u=(c+n[v][l]+t)%e*r,[u,h]}};return s.Type={EQ2GAL:0,GAL2EQ:1,EQ2ECL:2,ECL2EQ:3,ECL2GAL:4,GAL2ECL:5},s}),r("CoordinateSystem/EquatorialCoordinateSystem",["./CoordinateSystem","../Utils/Utils","../Utils/Numeric","./AstroCoordTransform","../Renderer/glMatrix"],function(e,t,r,n){var i=function(t){t.geoideName="Sky",e.prototype.constructor.call(this,t),this.type="EQ"};return t.inherits(e,i),i.prototype.from3DToEquatorial=function(e,t,r){t=t||new Array(3),"undefined"==typeof r&&(r=!0);var n=[];return this.from3DToGeo(e,n),this.fromGeoToEquatorial(n,t,r),t},i.prototype.fromEquatorialTo3D=function(e,t,r){t=t||new Array(3),"undefined"==typeof r&&(r=!0);var n=[];return this.fromEquatorialToGeo(e,n,r),this.fromGeoTo3D(n,t),t},i.prototype.fromEquatorialToGeo=function(e,t,r){function n(e){return"-"===e[0]?-1:1}if(t=t||[],"undefined"==typeof r&&(r=!0),r){var i=e[0].split(" "),o=parseFloat(i[0]),a=parseFloat(i[1]),s=parseFloat(i[2]);t[0]=15*(o+a/60+s/3600);var l=e[1].split(" ");o=parseFloat(l[0]),a=parseFloat(l[1]),s=parseFloat(l[2]),t[1]=n(l[0])*(Math.abs(o)+a/60+s/3600)}else t[0]=e[0],t[1]=e[1];return t[0]>180&&(t[0]-=360),t},i.prototype.fromGeoToEquatorial=function(e,t,r){t=t||[],"undefined"==typeof r&&(r=!0);var n=e[0];return n<0&&(n+=360),r?(t[0]=this.fromDegreesToHMS(n),t[1]=this.fromDegreesToDMS(e[1])):(t[0]=n,t[1]=e[1]),t},i.prototype.fromDegreesToDMS=function(e){function t(e){return e>=0?"+":"-"}var n=Math.abs(e),i=Math.floor(n),o=60*(n-i),a=Math.floor(o),s=60*(o-a);return t(e)+i+String.fromCharCode(176)+" "+a+"' "+r.roundNumber(s,2)+'"'},i.prototype.fromDegreesToHMS=function(e){var t=e/15,n=Math.abs(t),i=Math.floor(n),o=60*(n-i),a=Math.floor(o),s=60*(o-a);return i+"h "+a+"m "+r.roundNumber(s,2)+"s"},i.prototype.convert=function(e,t,r){if(t===r)return e;var i=null,o=null;switch(t+"2"+r){case"GAL2EQ":o=n.Type.GAL2EQ,i=n.transformInDeg(e,o);break;case"EQ2GAL":o=n.Type.EQ2GAL,i=n.transformInDeg(e,o),i[0]<0&&(console.warn("EQ2GAL transformation returned negative value"),i[0]+=360);break;default:console.error("Not implemented")}return i},i.prototype.transformVec=function(e){var t=this.computeTransformMatrix(),r=[];return mat4.multiplyVec3(t,e,r),r},i.prototype.computeTransformMatrix=function(){var e=[],t=this.convert([0,90],"GAL","EQ"),r=this.fromGeoTo3D(t),n=this.convert([0,0],"GAL","EQ"),i=this.fromGeoTo3D(n),o=this.convert([90,0],"GAL","EQ"),a=this.fromGeoTo3D(o);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=0,e[4]=a[0],e[5]=a[1],e[6]=a[2],e[7]=0,e[8]=r[0],e[9]=r[1],e[10]=r[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},i}),r("CoordinateSystem/EclipticCoordinateSystem",["./CoordinateSystem","../Utils/Utils"],function(e,t){var r=function(t){t.geoideName="Sky",e.prototype.constructor.call(this,t)};return t.inherits(e,r),r}),r("CoordinateSystem/GalacticCoordinateSystem",["./CoordinateSystem","../Utils/Utils"],function(e,t){var r=function(t){t.geoideName="Sky",e.prototype.constructor.call(this,t)};return t.inherits(e,r),r}),r("CoordinateSystem/SuperGalacticCoordinateSystem",["./CoordinateSystem","../Utils/Utils"],function(e,t){var r=function(t){t.geoideName="Sky",e.prototype.constructor.call(this,t)};return t.inherits(e,r),r}),r("CoordinateSystem/ICRSCoordinateSystem",["./CoordinateSystem","../Utils/Utils"],function(e,t){var r=function(t){t.geoideName="Sky",e.prototype.constructor.call(this,t)};return t.inherits(e,r),r}),r("Projection/AitoffCoordinateSystem",["../CoordinateSystem/CoordinateSystem","../Utils/Utils","../Renderer/glMatrix"],function(e,t){var r=function(t){t?t.projectionName="Aitoff":t={projectionName:"Aitoff"},e.prototype.constructor.call(this,t),this.isFlat=!0};t.inherits(e,r);var n=function(e){return e?e/Math.sin(e):1};return r.prototype.from3DToGeo=function(e,t){t||(t=new Array(3));var r,n,i=.005;if(!(e[0]*e[0]+4*e[1]*e[1]>Math.PI*Math.PI+i)){var o=e[0],a=e[1],s=25;do{var l,u=Math.sin(o),h=Math.sin(o/2),c=Math.cos(o/2),d=Math.sin(a),f=Math.cos(a),p=Math.sin(2*a),m=d*d,v=f*f,g=h*h,y=1-v*c*c,x=y?Math.acos(f*c)*Math.sqrt(l=1/y):l=0,b=2*x*f*h-e[0],T=x*d-e[1],w=l*(v*g+x*f*c*m),S=l*(.5*u*p-2*x*d*h),A=.25*l*(p*h-x*d*v*u),M=l*(m*c+x*g*f),C=S*A-M*w;if(!C)break;r=(T*S-b*M)/C,n=(b*A-T*w)/C,o-=r,a-=n}while((Math.abs(r)>i||Math.abs(n)>i)&&--s>0);return t[0]=180*o/Math.PI,t[1]=180*a/Math.PI,t[2]=0,t}},r.prototype.fromGeoTo3D=function(e,t){t||(t=new Array(3));var r=e[0]*Math.PI/180,i=e[1]*Math.PI/180,o=Math.cos(i),a=n(Math.acos(o*Math.cos(r/=2)));return t[0]=2*o*Math.sin(r)*a,t[1]=Math.sin(i)*a,t[2]=0,t},r}),r("Projection/AugustCoordinateSystem",["../CoordinateSystem/CoordinateSystem","../Utils/Utils","../Renderer/glMatrix"],function(e,t){var r=function(t){t?t.projectionName="August":t={projectionName:"August"},e.prototype.constructor.call(this,t),this.isFlat=!0};return t.inherits(e,r),r.prototype.from3DToGeo=function(e,t){},r.prototype.fromGeoTo3D=function(e,t){t||(t=new Array(3));var r=e[0]*Math.PI/180,n=e[1]*Math.PI/180,i=Math.tan(n/2),o=Math.sqrt(1-i*i),a=1+o*Math.cos(r/=2),s=Math.sin(r)*o/a,l=i/a,u=s*s,h=l*l;return t[0]=4/3*s*(3+u-3*h),t[1]=4/3*l*(3+3*u-h),t[2]=0,t},r}),r("Projection/MercatorCoordinateSystem",["../CoordinateSystem/CoordinateSystem","../Utils/Utils","../Renderer/glMatrix"],function(e,t){var r=function(t){t?t.projectionName="Mercator":t={projectionName:"Mercator"},e.prototype.constructor.call(this,t),this.isFlat=!0,this.lambda0=t&&t.lambda0?t.lambda0:0};t.inherits(e,r);var n=function(e){var t=Math.exp(e);return(t-1/t)/2};return r.prototype.from3DToGeo=function(e,t){return t||(t=new Array(3)),t[0]=this.lambda0+180*e[0]/Math.PI,t[1]=180*Math.atan(n(e[1]))/Math.PI,t[2]=0,t},r.prototype.fromGeoTo3D=function(e,t){t||(t=new Array(3)),e[1]>85.05&&(e[1]=85.05),e[1]<-85.05&&(e[1]=-85.05);var r=e[0]*Math.PI/180,n=e[1]*Math.PI/180,i=r-this.lambda0*Math.PI/180,o=Math.log(Math.tan(n)+1/Math.cos(n));return t[0]=i,t[1]=o,t[2]=0,t},r}),r("Projection/MollweideCoordinateSystem",["../CoordinateSystem/CoordinateSystem","../Utils/Utils","../Renderer/glMatrix"],function(e,t){function r(e){if(Math.abs(e)===Math.PI/2)return e;var t,r=.001,n=e;do{var i=2*n;n=t,n||(n=e),t=i/2-(i+Math.sin(i)-Math.PI*Math.sin(e))/(2+2*Math.cos(i))}while(Math.abs(t-n)>=r);return t}var n=function(t){t?t.projectionName="Mollweide":t={projectionName:"Mollweide"},e.prototype.constructor.call(this,t),this.isFlat=!0};return t.inherits(e,n),n.prototype.from3DToGeo=function(e,t){t||(t=new Array(3));var r=Math.asin(e[1]/Math.sqrt(2)),n=Math.asin((2*r+Math.sin(2*r))/Math.PI),i=Math.PI*e[0]/(2*Math.sqrt(2)*Math.cos(r));return t[0]=180*i/Math.PI,t[1]=180*n/Math.PI,t[2]=0,t},n.prototype.fromGeoTo3D=function(e,t){t||(t=new Array(3));var n=e[0]*Math.PI/180,i=e[1]*Math.PI/180,o=r(i),a=2*Math.sqrt(2)/Math.PI*n*Math.cos(o),s=Math.sqrt(2)*Math.sin(o);return t[0]=a,t[1]=s,t[2]=0,t},n}),r("Projection/PlateCoordinateSystem",["../CoordinateSystem/CoordinateSystem","../Utils/Utils","../Renderer/glMatrix"],function(e,t){var r=function(t){t?t.projectionName="Plate":t={projectionName:"Plate"},e.prototype.constructor.call(this,t),this.isFlat=!0};return t.inherits(e,r),r.prototype.from3DToGeo=function(e,t){return t||(t=new Array(3)),t[0]=180*e[0]/Math.PI,t[1]=180*e[1]/Math.PI,t[2]=0,t},r.prototype.fromGeoTo3D=function(e,t){return t||(t=new Array(3)),t[0]=e[0]*Math.PI/180,t[1]=e[1]*Math.PI/180,t[2]=0,t},r}),r("Projection/AzimuthCoordinateSystem",["../CoordinateSystem/CoordinateSystem","../Utils/Utils","../Renderer/glMatrix"],function(e,t){var r=function(t){t?t.projectionName="Azimuth":t={projectionName:"Azimuth"},e.prototype.constructor.call(this,t),this.isFlat=!0,this.pole=t&&t.pole||"north","south"===this.pole?this.geoBound=[-180,-90,180,0]:(this.geoBound=[-180,0,180,90],this.pole="north")};return t.inherits(e,r),r.prototype.from3DToGeo=function(e,t){t||(t=new Array(3));var r=Math.sqrt(e[0]*e[0]+e[1]*e[1]),n=Math.atan2(e[0],-e[1]);return r=180*r/Math.PI,n=180*n/Math.PI,n*="south"===this.pole?-1:1,t[0]=n,t[1]="south"===this.pole?r-90:90-r,t[2]=0,t},r.prototype.fromGeoTo3D=function(e,t){t||(t=new Array(3));var r="south"===this.pole?90+e[1]:90-e[1];r=r*Math.PI/180;var n=e[0]*Math.PI/180;return n*="south"===this.pole?-1:1,t[0]=r*Math.sin(n),t[1]=-r*Math.cos(n),t[2]=0,t},r}),r("CoordinateSystem/CoordinateSystemFactory",["./WGS84CoordinateSystem","./EquatorialCoordinateSystem","./EclipticCoordinateSystem","./GalacticCoordinateSystem","./SuperGalacticCoordinateSystem","./ICRSCoordinateSystem","../Projection/AitoffCoordinateSystem","../Projection/AugustCoordinateSystem","../Projection/MercatorCoordinateSystem","../Projection/MollweideCoordinateSystem","../Projection/PlateCoordinateSystem","../Projection/AzimuthCoordinateSystem"],function(e,t,r,n,i,o,a,s,l,u,h,c){var d=function(){};return d.prototype.create=function(d){if(d&&d.projectionName)switch(d.projectionName){case"Aitoff":return new a(d);case"August":return new s(d);case"Azimuth":return new c(d);case"Mercator":return new l(d);case"Mollweide":return new u(d);case"Plate":return new h(d);default:return null}if(d&&d.geoideName){switch(d.geoideName){case"Ecliptic":return new r(d);case"Equatorial":return new t(d);case"Galactic":return new n(d);case"SuperGalactic":return new i(d);case"ICRS":return new o(d);case"WGS84":return new e(d);case"Mars":return new CoordinateSystem(d);default:return null}return d&&d.geoide?new CoordinateSystem(d):null}},d.prototype.createWGS84=function(t){return cs=new e(t),cs},d.prototype.createEquatorial=function(e){return cs=new t(e),cs},d.prototype.createEcliptic=function(){return cs=new r,cs},d.prototype.createGalactic=function(e){return cs=new n(e),cs},d.prototype.createSuperGalactic=function(e){return cs=new i(e),cs},d.prototype.createICRS=function(e){return cs=new o(e),cs},d}),r("Context/Planet",["../CoordinateSystem/CoordinateSystem","../Renderer/RenderContext","../Tiling/TileManager","../Tiling/Tile","../Renderer/VectorRendererManager","../Renderer/Ray","../Renderer/GeoBound","../Utils/Event","../Utils/Utils","../CoordinateSystem/CoordinateSystemFactory"],function(e,t,r,n,i,o,a,s,l,u){var h=function(n){s.prototype.constructor.call(this),n.coordinateSystem?n.coordinateSystem.geoBound?this.coordinateSystem=n.coordinateSystem:(n.coordinateSystem=(new u).create(n.coordinateSystem),this.coordinateSystem=n.coordinateSystem):this.coordinateSystem=new e({geoideName:"WGS84"}),n.renderContext?this.renderContext=n.renderContext:this.renderContext=new t(n),this.continuousRendering=n.continuousRendering||!0,this.tileManager=new r(this,n),this.vectorRendererManager=new i(this),this.attributionHandler=null,this.baseImagery=null,this.preRenderers=[],this.nbCreatedLayers=0,this.mode2D=!1,this.tileManager.addPostRenderer(this.vectorRendererManager),this.renderContext.renderers.push(this),this.renderContext.requestFrame()};return l.inherits(s,h),h.prototype.dispose=function(){this.tileManager.tilePool.disposeAll(),this.tileManager.reset()},h.prototype.destroy=function(){this.dispose(),this.tileManager.removePostRenderer(this.vectorRendererManager),this.renderContext.renderers.splice(this.renderContext.renderers.indexOf(this.globe),1)},h.prototype.refresh=function(){this.renderContext.requestFrame()},h.prototype.setBaseImagery=function(e){this.baseImagery!==e&&(this.baseImagery&&(this.removeLayer(this.baseImagery),this.baseImagery=null),e&&(e._overlay=!1,this.addLayer(e),this.baseImagery=e),this.tileManager.setImageryProvider(e))},h.prototype.getBaseImagery=function(){return this.baseImagery},h.prototype.setBaseElevation=function(e){this.tileManager.elevationProvider&&this.removeLayer(this.tileManager.elevationProvider),
this.tileManager.setElevationProvider(e),e&&(e._overlay=!1,this.addLayer(e))},h.prototype.getBaseElevation=function(e){return this.tileManager.elevationProvider},h.prototype.addLayer=function(e){var t=this;e.url?$.ajax({url:e.url,success:function(r){e.addFeatureCollection(r),e.id=t.nbCreatedLayers,e._attach(t),t.renderContext.requestFrame(),t.nbCreatedLayers++,e.callback&&e.callback(r)}}):(e.id=this.nbCreatedLayers,e._attach(this),this.renderContext.requestFrame(),this.nbCreatedLayers++)},h.prototype.removeLayer=function(e){e._detach(),this.renderContext.requestFrame()},h.prototype.addAnimation=function(e){e.renderContext=this.renderContext},h.prototype.removeAnimation=function(e){e.renderContext=null},h.prototype.getElevation=function(e,t){var r=this.tileManager.tiling;this.baseImagery&&(r=this.baseImagery.tiling);var i=this.tileManager.level0Tiles[r.lonlat2LevelZeroIndex(e,t)];return n.State&&i.state===n.State.LOADED?i.getElevation(e,t):0},h.prototype.getViewportGeoBound=function(e){var t=this.renderContext,r=mat4.create();mat4.inverse(t.viewMatrix,r);var n=[r[12],r[13],r[14]];mat4.multiply(t.projectionMatrix,t.viewMatrix,r),mat4.inverse(r);for(var i=[[-1,-1,1,1],[1,-1,1,1],[-1,1,1,1],[1,1,1,1]],s=[0,0,0],l=0;l<4;l++){mat4.multiplyVec4(r,i[l]),vec3.scale(i[l],1/i[l][3]),vec3.subtract(i[l],n,i[l]),vec3.normalize(i[l]);var u=new o(n,i[l]),h=u.sphereIntersect(s,this.coordinateSystem.geoide.radius);if(h<0)return null;var c=u.computePoint(h);i[l]=this.coordinateSystem.from3DToGeo(c),e&&(i[l]=e(i[l]))}var d=new a;return d.computeFromCoordinates(i),d},h.prototype.getLonLatFromPixel=function(e,t){var r,n=o.createFromPixel(this.renderContext,e,t);return r=this.coordinateSystem.isFlat?n.planeIntersect([0,0,0],[0,0,1]):n.sphereIntersect([0,0,0],this.coordinateSystem.geoide.radius),r>=0?this.coordinateSystem.from3DToGeo(n.computePoint(r)):null},h.prototype.getPixelFromLonLat=function(e,t){var r=vec3.create();this.coordinateSystem.fromGeoTo3D([e,t],r);var n=this.renderContext.getPixelFrom3D(r[0],r[1],r[2]);return n},h.prototype.render=function(){if(this.mode2D===!1)for(var e=0;e<this.preRenderers.length;e++)this.preRenderers[e].preRender();this.tileManager.render()},h.prototype.setMode2D=function(e){this.mode2D=e},h.prototype.setCoordinateSystem=function(e){this.coordinateSystem=e,this.tileManager.tileConfig.coordinateSystem=e,this.dispose(),this.tileManager.level0Tiles=this.tileManager.tiling.generateLevelZeroTiles(this.tileManager.tileConfig,this.tileManager.tilePool)},h.prototype.getCoordinateSystem=function(){return this.coordinateSystem},h.prototype.getRenderStats=function(){return"# rendered tiles : "+this.tileManager.tilesToRender.length},h.prototype.getRenderContext=function(){return this.renderContext},h.prototype.setRenderContext=function(e){this.renderContext=e},h}),r("AttributionHandler",[],function(){var e=function(e,t){var r=t?t.element:void 0;r&&("string"==typeof r?this.element=document.getElementById(r):this.element=r),this.element&&(e.attributionHandler=this)};return e.prototype.removeAttribution=function(e){var t=document.getElementById(this.element.id+"_"+e.id);t&&this.element.removeChild(t)},e.prototype.addAttribution=function(e){var t,r=document.createElement("div"),n=void 0!==e.ack?e.ack:"";t=""!==e.copyrightUrl&&void 0!==e.copyrightUrl?'<a class="whiteLink" href="'+e.copyrightUrl+'" target="_blank" title="'+n+'">'+e.attribution+"</a>":e.attribution,r.innerHTML=t,r.id=this.element.id+"_"+e.id,0===e.id?this.element.insertBefore(r,this.element.firstChild):this.element.appendChild(r)},e.prototype.toggleAttribution=function(e){var t=document.getElementById(this.element.id+"_"+e.id);t?this.removeAttribution(e):this.addAttribution(e)},e}),r("Navigation/MouseNavigationHandler",[],function(){var e=function(e){var t=null,r=-1,n=-1,i=-1,o=0,a=0,s=e&&e.panButton||0,l=e&&e.rotateButton||1,u=function(e){var r;return r=void 0===e.wheelDelta?e.detail:-e.wheelDelta/120,t.zoom(r),t.stopAnimations(),t.inertia&&t.inertia.launch("zoom",r<0?-1:1),e.preventDefault&&e.preventDefault(),e.returnValue=!1,!1},h=function(e){return document.addEventListener("mouseup",c),r=e.button,t.stopAnimations(),e.button!==s&&e.button!==l||(n=e.clientX,i=e.clientY,o=0,a=0,!1)},c=function(e){return r=-1,document.removeEventListener("mouseup",c),!t.inertia||0===o&&0===a||(e.button===s&&t.inertia.launch("pan",o,a),e.button===l&&t.inertia.launch("rotate",o,a)),e.button!==s&&e.button!==l||(e.preventDefault(),!1)},d=function(e){if(!(r<0)&&(o=e.clientX-n,a=e.clientY-i,0!==o||0!==a)){var u=!1;return r===s?(t.pan(o,a),u=!0):r===l&&(t.rotate(o,a),u=!0),n=e.clientX,i=e.clientY,u}},f=function(e){if(0===e.button){console.log("navigation",t);var r,n;t.planet?(r=t.planet.renderContext.getXYRelativeToCanvas(e),n=t.planet.getLonLatFromPixel(r[0],r[1])):t.sky&&(r=t.sky.renderContext.getXYRelativeToCanvas(e),n=t.sky.getLonLatFromPixel(r[0],r[1])),n&&t.zoomTo(n)}};this.install=function(r){t=r;var n=t.renderContext.canvas;n.addEventListener("mousedown",h),n.addEventListener("mousemove",d),e&&e.zoomOnDblClick&&n.addEventListener("dblclick",f),n.addEventListener("DOMMouseScroll",u),n.addEventListener("mousewheel",u),n.addEventListener("dragstart",function(e){return e.preventDefault(),!1}),2===l&&n.addEventListener("contextmenu",function(e){return e.preventDefault(),!1},!1)},this.uninstall=function(){var r=t.renderContext.canvas;r.removeEventListener("mousedown",h),r.removeEventListener("mousemove",d),e&&e.zoomOnDblClick&&r.removeEventListener("dblclick",f),r.removeEventListener("DOMMouseScroll",u),r.removeEventListener("mousewheel",u)}};return e}),r("Navigation/KeyboardNavigationHandler",[],function(){var e=function(e){var t=null,r=this;this.panFactor=10,this.zoomFactor=1,e&&(e.panFactor&&"number"==typeof e.panFactor&&(this.panFactor=e.panFactor),e.zoomFactor&&"number"==typeof e.zoomFactor&&(this.zoomFactor=e.zoomFactor));var n=function(e){return this.focus(),!1},i=function(e){switch(e.keyCode){case 32:t.stopAnimations();break;case 187:case 61:case 107:t.zoom(-r.zoomFactor);break;case 189:case 54:case 109:t.zoom(r.zoomFactor);break;case 81:case 37:e.shiftKey?t.rotate(r.panFactor,0):t.pan(r.panFactor,0);break;case 90:case 38:e.shiftKey?t.rotate(0,r.panFactor):t.pan(0,r.panFactor);break;case 68:case 39:e.shiftKey?t.rotate(-r.panFactor,0):t.pan(-r.panFactor,0);break;case 83:case 40:e.shiftKey?t.rotate(0,-r.panFactor):t.pan(0,-r.panFactor)}};this.install=function(r){if(t=r,e&&e.installOnDocument)document.addEventListener("keydown",i);else{var o=t.renderContext.canvas;o.addEventListener("keydown",i),o.tabIndex="0",o.addEventListener("mousedown",n)}},this.uninstall=function(){if(e&&e.installOnDocument)document.removeEventListener("keydown",i);else{var r=t.renderContext.canvas;r.removeEventListener("keydown",i),r.removeEventListener("mousedown",n)}}};return e}),r("Navigation/TouchNavigationHandler",[],function(){var e={PAN:0,ROTATE:1,TILT:2,ZOOM:3},t=function(t){var r,n,i,o,a,s,l,u=null,h=[],c=[0,0,0,0],d=300,f=!(!t||!t.hasOwnProperty("inversed"))&&t.inversed,p=function(e,t){var r=t.clientY-e.clientY,n=t.clientX-e.clientX;return 180*Math.atan2(r,n)/Math.PI},m=function(e,t){return e.length>=2&&t.length>=2?p(t[1],t[0])-p(e[1],e[0]):0},v=function(e){if(n=e.touches,h=e.touches,c=[0,0,0,0],u.stopAnimations(),o=0,a=0,2===e.touches.length){var t=e.touches[0].clientX-e.touches[1].clientX,s=e.touches[0].clientY-e.touches[1].clientY;r=Math.sqrt(t*t+s*s),console.log("Finger distance : "+r),i=m(h,e.touches)}return e.preventDefault&&e.preventDefault(),e.returnValue=!1,!1},g=function(t){o=t.touches[0].clientX-n[0].clientX,a=t.touches[0].clientY-n[0].clientY;var s,d,p,v,g;if(1===t.touches.length)u.pan(o,a),c[e.PAN]++;else{var y=(t.touches[0].clientY-n[0].clientY)*(t.touches[1].clientY-n[1].clientY)>0;y?(u.rotate(0,-a),c[e.TILT]++):(p=m(h,t.touches),s=p-i,i=p,f&&(s*=-1),l=10*s,u.rotate(l,0),c[e.ROTATE]++),s=t.touches[0].clientX-t.touches[1].clientX,d=t.touches[0].clientY-t.touches[1].clientY,v=Math.sqrt(s*s+d*d),g=v-r;var x;x=f?v/r:r/v,0!==r&&(u.zoom(.025*g,x),c[e.ZOOM]++),u.renderContext.requestFrame(),r=v}return n=t.touches,t.preventDefault&&t.preventDefault(),t.returnValue=!1,!1},y=function(r){if(t&&t.zoomOnDblClick&&0===r.touches.length&&0===o&&0===a){var i=Date.now();if(i-s<d){var l=u.planet.getLonLatFromPixel(n[0].clientX,n[0].clientY);l&&u.zoomTo(l)}s=i}if(n=r.touches,u.inertia&&(0!==o||0!==a)){var h=c.indexOf(Math.max.apply(this,c));h===e.PAN?u.inertia.launch("pan",o,a):h===e.ROTATE?console.log("Rotate not implemented in navigation"):h===e.TILT&&console.log("Tilt not implemented in navigation")}return r.preventDefault&&r.preventDefault(),r.returnValue=!1,!1};this.install=function(e){u=e;var t=u.renderContext.canvas;t.addEventListener("touchstart",v,!1),t.addEventListener("touchend",y,!1),t.addEventListener("touchmove",g,!1)},this.uninstall=function(){var e=u.renderContext.canvas;e.removeEventListener("touchstart",v,!1),e.removeEventListener("touchend",y,!1),e.removeEventListener("touchmove",g,!1)}};return t}),r("Animation/Animation",[],function(){var e=function(){this.startTime=-1,this.pauseTime=-1,this.renderContext=null};return e.prototype.getRenderContext=function(){return this.renderContext},e.prototype.setRenderContext=function(e){this.renderContext=e},e.prototype._unregisterActive=function(){var e=this.renderContext.activeAnimations.indexOf(this);e>=0&&this.renderContext.activeAnimations.splice(e,1)},e.prototype.getStatus=function(){return this.startTime===-1?"STOPPED":this.pauseTime===-1?"RUNNING":"PAUSED"},e.prototype.start=function(){if(this.renderContext&&(this.startTime===-1||this.pauseTime!==-1)){var e=Date.now();this.startTime===-1?this.startTime=e:(this.startTime+=e-this.pauseTime,this.pauseTime=-1),this.renderContext.activeAnimations.push(this),this.renderContext.requestFrame()}},e.prototype.pause=function(){this.renderContext&&this.startTime!==-1&&this.pauseTime===-1&&(this.pauseTime=Date.now(),this._unregisterActive(this))},e.prototype.stop=function(){this.startTime=-1,this.pauseTime=-1,this.onstop&&this.onstop(),this._unregisterActive(this)},e}),r("Animation/InertiaAnimation",["../Utils/Utils","./Animation"],function(e,t){var r=.1,n=function(e,r){t.prototype.constructor.call(this),r&&(this.panFactor=r.hasOwnProperty("panFactor")?r.panFactor:.95,this.rotateFactor=r.hasOwnProperty("rotateFactor")?r.rotateFactor:.95,this.zoomFactor=r.hasOwnProperty("zoomFactor")?r.zoomFactor:.95),this.type=null,this.dx=0,this.dy=0,this.navigation=e,this.renderContext=e.renderContext};return e.inherits(t,n),n.prototype.update=function(e){var t=!1;switch(this.type){case"pan":this.navigation.pan(this.dx,this.dy),this.dx*=this.panFactor,this.dy*=this.panFactor,t=Math.abs(this.dx)<r&&Math.abs(this.dy)<r;break;case"rotate":this.navigation.rotate(this.dx,this.dy),this.dx*=this.rotateFactor,this.dy*=this.rotateFactor,t=Math.abs(this.dx)<r&&Math.abs(this.dy)<r;break;case"zoom":this.navigation.zoom(this.dx),this.dx*=this.zoomFactor,t=Math.abs(this.dx)<r}this.navigation.renderContext.requestFrame(),t&&this.stop()},n.prototype.launch=function(e,t,r){this.type=e,this.dx=t,this.dy=r,this.start()},n}),r("Animation/SegmentedAnimation",["../Utils/Utils","./Animation","../Utils/Numeric"],function(e,t,r){var n=function(e,r){t.prototype.constructor.call(this),this.segments=[],this.duration=e,this.valueSetter=r};e.inherits(t,n);var i=function(e,t,r,n,i){this.start=e,this.startValue=t,this.end=r,this.endValue=n,this.interpolator=i};return n.prototype.addSegment=function(e,t,r,n,o){for(var a=this.segments.length,s=0;s<a&&this.segments[s].end<=e;)s++;this.segments.splice(s,0,new i(e,t,r,n,o))},n.prototype.update=function(e){var t=r.map01(e,this.startTime,this.startTime+this.duration);if(t>=1){var n=this.segments.length-1;this.valueSetter(this.segments[n].endValue),this.stop()}else{for(var i=this.segments.length,o=0;o<i&&this.segments[o].end<t;)o++;o=Math.min(o,i-1),t=r.map01(t,this.segments[o].start,this.segments[o].end);var a=this.segments[o].interpolator(t,this.segments[o].startValue,this.segments[o].endValue);this.valueSetter(a)}},n}),r("Navigation/BaseNavigation",["../Utils/Utils","../Utils/Event","../Navigation/MouseNavigationHandler","../Navigation/KeyboardNavigationHandler","../Navigation/TouchNavigationHandler","../Animation/InertiaAnimation","../Animation/SegmentedAnimation","../Utils/Numeric","../Renderer/glMatrix"],function(e,t,r,n,i,o,a,s){var l=function(e,a){t.prototype.constructor.call(this),this.renderContext=e,a&&a.handlers?this.handlers=a.handlers:(this.handlers=[new r(a?a.mouse:null),new n(a?a.keyboard:null)],a&&a.isMobile&&this.handlers.push(new i(a?a.touch:null))),a&&a.inertia&&(this.inertia=new o(this,a)),this.zoomToAnimation=null,this.start()};return e.inherits(t,l),l.prototype.start=function(){for(var e=0;e<this.handlers.length;e++)this.handlers[e].install(this)},l.prototype.stop=function(){for(var e=0;e<this.handlers.length;e++)this.handlers[e].uninstall()},l.prototype.stopAnimations=function(){this.inertia&&this.inertia.stop(),this.zoomToAnimation&&(this.zoomToAnimation.stop(),this.zoomToAnimation=null)},l.prototype.getFov=function(){var e=this.renderContext.canvas.width/this.renderContext.canvas.height;return[e*this.renderContext.fov,this.renderContext.fov]},l.prototype.toViewMatrix=function(e,t,r,n){var i=this,o=this.renderContext.viewMatrix,l=mat4.toMat3(o),u=quat4.fromRotationMatrix(l),h=mat4.toMat3(e),c=quat4.fromRotationMatrix(h),d=t||45;r=r||1e3;var f=[u,[o[12],o[13],o[14]],i.renderContext.fov],p=[c,[e[12],e[13],e[14]],d],m=new a(r,function(e){var t=quat4.toMat4(e[0]);i.renderContext.viewMatrix=mat4.transpose(t),i.renderContext.viewMatrix[12]=e[1][0],i.renderContext.viewMatrix[13]=e[1][1],i.renderContext.viewMatrix[14]=e[1][2],i.renderContext.fov=e[2],i.renderContext.requestFrame()});m.addSegment(0,f,1,p,function(e,t,r){var n=s.easeOutQuad(e),i=quat4.create();quat4.slerp(t[0],r[0],n,i);var o=vec3.create();vec3.lerp(t[1],r[1],n,o);var a=s.lerp(n,t[2],r[2]);return[i,o,a]}),m.onstop=function(){n&&n()},this.planet?this.planet.addAnimation(m):this.sky&&this.sky.addAnimation(m),m.start()},l}),r("Navigation/Navigation",["../Utils/Utils","./BaseNavigation","../Animation/SegmentedAnimation","../Utils/Numeric","../Renderer/glMatrix"],function(e,t,r,n){var i=function(e,r){t.prototype.constructor.call(this,e.renderContext,r),this.type="PlanetNavigation",this.planet=e,this.minDistance=r&&r.minDistance||1,this.maxDistance=r&&r.maxDistance||3*this.planet.coordinateSystem.geoide.realPlanetRadius,this.geoCenter=[0,0,0],this.heading=0,this.tilt=90,this.distance=3*this.planet.coordinateSystem.geoide.radius,this.minDistance*=this.planet.coordinateSystem.geoide.heightScale,this.maxDistance*=this.planet.coordinateSystem.geoide.heightScale,this.inverseViewMatrix=mat4.create();var n=!r||!r.hasOwnProperty("updateViewMatrix")||r.updateViewMatrix;n&&this.computeViewMatrix()};return e.inherits(t,i),i.prototype.save=function(){return{geoCenter:this.geoCenter,heading:this.heading,tilt:this.tilt,distance:this.distance}},i.prototype.restore=function(e){this.geoCenter=e.geoCenter,this.heading=e.heading,this.tilt=e.tilt,this.distance=e.distance,this.computeViewMatrix()},i.prototype.zoomTo=function(e,t,i,o,a){var s=this,l=t||this.distance/(4*this.planet.coordinateSystem.geoide.heightScale);i=i||5e3;var u=o||90,h=[this.geoCenter[0],this.geoCenter[1],this.distance,this.tilt],c=[e[0],e[1],l*this.planet.coordinateSystem.geoide.heightScale,u];this.zoomToAnimation=new r(i,function(e){s.geoCenter[0]=e[0],s.geoCenter[1]=e[1],s.distance=e[2],s.tilt=e[3],s.computeViewMatrix()});var d=this.planet.coordinateSystem.fromGeoTo3D(this.geoCenter),f=this.planet.coordinateSystem.fromGeoTo3D(e),p=vec3.subtract(d,f),m=vec3.length(p),v=this.planet.renderContext.canvas,g=Math.min(n.toRadian(45),n.toRadian(45*v.width/v.height)),y=1.1*(m/2/Math.tan(g/2));if(y>this.distance){var x=[.5*h[0]+.5*c[0],.5*h[1]+.5*c[1],y,u];this.zoomToAnimation.addSegment(0,h,.5,x,function(e,t,r){var i=n.easeInQuad(e),o=n.easeOutQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1]),n.lerp(o,t[2],r[2]),n.lerp(e,t[3],r[3])]}),this.zoomToAnimation.addSegment(.5,x,1,c,function(e,t,r){var i=n.easeOutQuad(e),o=n.easeInQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1]),n.lerp(o,t[2],r[2]),n.lerp(e,t[3],r[3])]})}else this.zoomToAnimation.addSegment(0,h,1,c,function(e,t,r){var i=n.easeOutQuad(e),o=n.easeInQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1]),n.lerp(o,t[2],r[2]),n.lerp(e,t[3],r[3])]});var b=this;this.zoomToAnimation.onstop=function(){a&&a(),b.zoomToAnimation=null},this.planet.addAnimation(this.zoomToAnimation),this.zoomToAnimation.start()},i.prototype.applyLocalRotation=function(e){mat4.rotate(e,this.heading*Math.PI/180,[0,0,1]),mat4.rotate(e,(90-this.tilt)*Math.PI/180,[1,0,0])},i.prototype.computeViewMatrix=function(){this.computeInverseViewMatrix(),mat4.inverse(this.inverseViewMatrix,this.renderContext.viewMatrix),this.publish("modified"),this.renderContext.requestFrame()},i.prototype.computeInverseViewMatrix=function(){this.planet.coordinateSystem.getLHVTransform(this.geoCenter,this.inverseViewMatrix),this.applyLocalRotation(this.inverseViewMatrix),mat4.translate(this.inverseViewMatrix,[0,0,this.distance])},i.prototype.zoom=function(e,t){var r=this.distance;t?this.distance*=t:this.distance*=1+.1*e,this.distance>this.maxDistance&&(this.distance=this.maxDistance),this.distance<this.minDistance&&(this.distance=this.minDistance),this.computeViewMatrix(),this.hasCollision()&&(this.distance=r,this.computeViewMatrix())},i.prototype.hasCollision=function(){var e=[this.inverseViewMatrix[12],this.inverseViewMatrix[13],this.inverseViewMatrix[14]],t=vec3.create();this.planet.coordinateSystem.from3DToGeo(e,t);var r=this.planet.getElevation(t[0],t[1]);return t[2]<r+50},i.prototype.pan=function(e,t){var r=vec3.create();vec3.set(this.geoCenter,r);var n=mat4.create(),i=this.planet.coordinateSystem;i.getLocalTransform(this.geoCenter,n);var o=vec3.create(),a=vec3.create([0,1,0]);i.getUpVector(n,o),mat4.multiplyVec3(n,a,a),this.applyLocalRotation(n);var s=vec3.create(),l=vec3.create();i.getSideVector(n,s),i.getFrontVector(n,l),vec3.cross(o,s,l),vec3.cross(l,o,s),vec3.normalize(s,s),vec3.normalize(l,l),e/=this.renderContext.canvas.width,t/=this.renderContext.canvas.height;var u=vec3.create();i.fromGeoTo3D(this.geoCenter,u),vec3.scale(s,e*this.distance,s),vec3.scale(l,t*this.distance,l),vec3.subtract(u,s,u),vec3.add(u,l,u),vec3.normalize(u),vec3.scale(u,i.geoide.radius),i.from3DToGeo(u,this.geoCenter);var h=vec3.create([0,1,0]);i.getLocalTransform(this.geoCenter,n),mat4.multiplyVec3(n,h,h),vec3.dot(a,h)<0&&(this.heading=(this.heading+180)%360),this.computeViewMatrix(),this.hasCollision()&&(this.geoCenter=r,this.computeViewMatrix())},i.prototype.rotate=function(e,t){var r=this.heading,n=this.tilt;this.heading+=.1*e,this.tilt+=.1*t,this.computeViewMatrix(),this.hasCollision()&&(this.heading=r,this.tilt=n,this.computeViewMatrix())},i}),!function(e,t){"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(e,t){function n(e){var t=e.length,r=oe.type(e);return"function"!==r&&!oe.isWindow(e)&&(!(1!==e.nodeType||!t)||("array"===r||0===t||"number"==typeof t&&t>0&&t-1 in e))}function i(e,t,r){if(oe.isFunction(t))return oe.grep(e,function(e,n){return!!t.call(e,n,e)!==r});if(t.nodeType)return oe.grep(e,function(e){return e===t!==r});if("string"==typeof t){if(fe.test(t))return oe.filter(t,e,r);t=oe.filter(t,e)}return oe.grep(e,function(e){return oe.inArray(e,t)>=0!==r})}function o(e,t){do e=e[t];while(e&&1!==e.nodeType);return e}function a(e){var t=Te[e]={};return oe.each(e.match(be)||[],function(e,r){t[r]=!0}),t}function s(){me.addEventListener?(me.removeEventListener("DOMContentLoaded",l,!1),e.removeEventListener("load",l,!1)):(me.detachEvent("onreadystatechange",l),e.detachEvent("onload",l))}function l(){(me.addEventListener||"load"===event.type||"complete"===me.readyState)&&(s(),oe.ready())}function u(e,t,r){if(void 0===r&&1===e.nodeType){var n="data-"+t.replace(Ce,"-$1").toLowerCase();if(r=e.getAttribute(n),"string"==typeof r){try{r="true"===r||"false"!==r&&("null"===r?null:+r+""===r?+r:Me.test(r)?oe.parseJSON(r):r)}catch(e){}oe.data(e,t,r)}else r=void 0}return r}function h(e){var t;for(t in e)if(("data"!==t||!oe.isEmptyObject(e[t]))&&"toJSON"!==t)return!1;return!0}function c(e,t,r,n){if(oe.acceptData(e)){var i,o,a=oe.expando,s=e.nodeType,l=s?oe.cache:e,u=s?e[a]:e[a]&&a;if(u&&l[u]&&(n||l[u].data)||void 0!==r||"string"!=typeof t)return u||(u=s?e[a]=Q.pop()||oe.guid++:a),l[u]||(l[u]=s?{}:{toJSON:oe.noop}),("object"==typeof t||"function"==typeof t)&&(n?l[u]=oe.extend(l[u],t):l[u].data=oe.extend(l[u].data,t)),o=l[u],n||(o.data||(o.data={}),o=o.data),void 0!==r&&(o[oe.camelCase(t)]=r),"string"==typeof t?(i=o[t],null==i&&(i=o[oe.camelCase(t)])):i=o,i}}function d(e,t,r){if(oe.acceptData(e)){var n,i,o=e.nodeType,a=o?oe.cache:e,s=o?e[oe.expando]:oe.expando;if(a[s]){if(t&&(n=r?a[s]:a[s].data)){oe.isArray(t)?t=t.concat(oe.map(t,oe.camelCase)):t in n?t=[t]:(t=oe.camelCase(t),t=t in n?[t]:t.split(" ")),i=t.length;for(;i--;)delete n[t[i]];if(r?!h(n):!oe.isEmptyObject(n))return}(r||(delete a[s].data,h(a[s])))&&(o?oe.cleanData([e],!0):ne.deleteExpando||a!=a.window?delete a[s]:a[s]=null)}}}function f(){return!0}function p(){return!1}function m(){try{return me.activeElement}catch(e){}}function v(e){var t=De.split("|"),r=e.createDocumentFragment();if(r.createElement)for(;t.length;)r.createElement(t.pop());return r}function g(e,t){var r,n,i=0,o=typeof e.getElementsByTagName!==Ae?e.getElementsByTagName(t||"*"):typeof e.querySelectorAll!==Ae?e.querySelectorAll(t||"*"):void 0;if(!o)for(o=[],r=e.childNodes||e;null!=(n=r[i]);i++)!t||oe.nodeName(n,t)?o.push(n):oe.merge(o,g(n,t));return void 0===t||t&&oe.nodeName(e,t)?oe.merge([e],o):o}function y(e){Ie.test(e.type)&&(e.defaultChecked=e.checked)}function x(e,t){return oe.nodeName(e,"table")&&oe.nodeName(11!==t.nodeType?t:t.firstChild,"tr")?e.getElementsByTagName("tbody")[0]||e.appendChild(e.ownerDocument.createElement("tbody")):e}function b(e){return e.type=(null!==oe.find.attr(e,"type"))+"/"+e.type,e}function T(e){var t=Ye.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function w(e,t){for(var r,n=0;null!=(r=e[n]);n++)oe._data(r,"globalEval",!t||oe._data(t[n],"globalEval"))}function S(e,t){if(1===t.nodeType&&oe.hasData(e)){var r,n,i,o=oe._data(e),a=oe._data(t,o),s=o.events;if(s){delete a.handle,a.events={};for(r in s)for(n=0,i=s[r].length;i>n;n++)oe.event.add(t,r,s[r][n])}a.data&&(a.data=oe.extend({},a.data))}}function A(e,t){var r,n,i;if(1===t.nodeType){if(r=t.nodeName.toLowerCase(),!ne.noCloneEvent&&t[oe.expando]){i=oe._data(t);for(n in i.events)oe.removeEvent(t,n,i.handle);t.removeAttribute(oe.expando)}"script"===r&&t.text!==e.text?(b(t).text=e.text,T(t)):"object"===r?(t.parentNode&&(t.outerHTML=e.outerHTML),ne.html5Clone&&e.innerHTML&&!oe.trim(t.innerHTML)&&(t.innerHTML=e.innerHTML)):"input"===r&&Ie.test(e.type)?(t.defaultChecked=t.checked=e.checked,t.value!==e.value&&(t.value=e.value)):"option"===r?t.defaultSelected=t.selected=e.defaultSelected:("input"===r||"textarea"===r)&&(t.defaultValue=e.defaultValue)}}function M(t,r){var n,i=oe(r.createElement(t)).appendTo(r.body),o=e.getDefaultComputedStyle&&(n=e.getDefaultComputedStyle(i[0]))?n.display:oe.css(i[0],"display");return i.detach(),o}function C(e){var t=me,r=et[e];return r||(r=M(e,t),"none"!==r&&r||($e=($e||oe("<iframe frameborder='0' width='0' height='0'/>")).appendTo(t.documentElement),t=($e[0].contentWindow||$e[0].contentDocument).document,t.write(),t.close(),r=M(e,t),$e.detach()),et[e]=r),r}function E(e,t){return{get:function(){var r=e();if(null!=r)return r?void delete this.get:(this.get=t).apply(this,arguments)}}}function P(e,t){if(t in e)return t;for(var r=t.charAt(0).toUpperCase()+t.slice(1),n=t,i=ft.length;i--;)if(t=ft[i]+r,t in e)return t;return n}function R(e,t){for(var r,n,i,o=[],a=0,s=e.length;s>a;a++)n=e[a],n.style&&(o[a]=oe._data(n,"olddisplay"),r=n.style.display,t?(o[a]||"none"!==r||(n.style.display=""),""===n.style.display&&Re(n)&&(o[a]=oe._data(n,"olddisplay",C(n.nodeName)))):(i=Re(n),(r&&"none"!==r||!i)&&oe._data(n,"olddisplay",i?r:oe.css(n,"display"))));for(a=0;s>a;a++)n=e[a],n.style&&(t&&"none"!==n.style.display&&""!==n.style.display||(n.style.display=t?o[a]||"":"none"));return e}function L(e,t,r){var n=ut.exec(t);return n?Math.max(0,n[1]-(r||0))+(n[2]||"px"):t}function I(e,t,r,n,i){for(var o=r===(n?"border":"content")?4:"width"===t?1:0,a=0;4>o;o+=2)"margin"===r&&(a+=oe.css(e,r+Pe[o],!0,i)),n?("content"===r&&(a-=oe.css(e,"padding"+Pe[o],!0,i)),"margin"!==r&&(a-=oe.css(e,"border"+Pe[o]+"Width",!0,i))):(a+=oe.css(e,"padding"+Pe[o],!0,i),"padding"!==r&&(a+=oe.css(e,"border"+Pe[o]+"Width",!0,i)));return a}function _(e,t,r){var n=!0,i="width"===t?e.offsetWidth:e.offsetHeight,o=tt(e),a=ne.boxSizing&&"border-box"===oe.css(e,"boxSizing",!1,o);if(0>=i||null==i){if(i=rt(e,t,o),(0>i||null==i)&&(i=e.style[t]),it.test(i))return i;n=a&&(ne.boxSizingReliable()||i===e.style[t]),i=parseFloat(i)||0}return i+I(e,t,r||(a?"border":"content"),n,o)+"px"}function F(e,t,r,n,i){return new F.prototype.init(e,t,r,n,i)}function k(){return setTimeout(function(){pt=void 0}),pt=oe.now()}function B(e,t){var r,n={height:e},i=0;for(t=t?1:0;4>i;i+=2-t)r=Pe[i],n["margin"+r]=n["padding"+r]=e;return t&&(n.opacity=n.width=e),n}function N(e,t,r){for(var n,i=(bt[t]||[]).concat(bt["*"]),o=0,a=i.length;a>o;o++)if(n=i[o].call(r,t,e))return n}function D(e,t,r){var n,i,o,a,s,l,u,h,c=this,d={},f=e.style,p=e.nodeType&&Re(e),m=oe._data(e,"fxshow");r.queue||(s=oe._queueHooks(e,"fx"),null==s.unqueued&&(s.unqueued=0,l=s.empty.fire,s.empty.fire=function(){s.unqueued||l()}),s.unqueued++,c.always(function(){c.always(function(){s.unqueued--,oe.queue(e,"fx").length||s.empty.fire()})})),1===e.nodeType&&("height"in t||"width"in t)&&(r.overflow=[f.overflow,f.overflowX,f.overflowY],u=oe.css(e,"display"),h="none"===u?oe._data(e,"olddisplay")||C(e.nodeName):u,"inline"===h&&"none"===oe.css(e,"float")&&(ne.inlineBlockNeedsLayout&&"inline"!==C(e.nodeName)?f.zoom=1:f.display="inline-block")),r.overflow&&(f.overflow="hidden",ne.shrinkWrapBlocks()||c.always(function(){f.overflow=r.overflow[0],f.overflowX=r.overflow[1],f.overflowY=r.overflow[2]}));for(n in t)if(i=t[n],vt.exec(i)){if(delete t[n],o=o||"toggle"===i,i===(p?"hide":"show")){if("show"!==i||!m||void 0===m[n])continue;p=!0}d[n]=m&&m[n]||oe.style(e,n)}else u=void 0;if(oe.isEmptyObject(d))"inline"===("none"===u?C(e.nodeName):u)&&(f.display=u);else{m?"hidden"in m&&(p=m.hidden):m=oe._data(e,"fxshow",{}),o&&(m.hidden=!p),p?oe(e).show():c.done(function(){oe(e).hide()}),c.done(function(){var t;oe._removeData(e,"fxshow");for(t in d)oe.style(e,t,d[t])});for(n in d)a=N(p?m[n]:0,n,c),n in m||(m[n]=a.start,p&&(a.end=a.start,a.start="width"===n||"height"===n?1:0))}}function O(e,t){var r,n,i,o,a;for(r in e)if(n=oe.camelCase(r),i=t[n],o=e[r],oe.isArray(o)&&(i=o[1],o=e[r]=o[0]),r!==n&&(e[n]=o,delete e[r]),a=oe.cssHooks[n],a&&"expand"in a){o=a.expand(o),delete e[n];for(r in o)r in e||(e[r]=o[r],t[r]=i)}else t[n]=i}function U(e,t,r){var n,i,o=0,a=xt.length,s=oe.Deferred().always(function(){delete l.elem}),l=function(){if(i)return!1;for(var t=pt||k(),r=Math.max(0,u.startTime+u.duration-t),n=r/u.duration||0,o=1-n,a=0,l=u.tweens.length;l>a;a++)u.tweens[a].run(o);return s.notifyWith(e,[u,o,r]),1>o&&l?r:(s.resolveWith(e,[u]),!1)},u=s.promise({elem:e,props:oe.extend({},t),opts:oe.extend(!0,{specialEasing:{}},r),originalProperties:t,originalOptions:r,startTime:pt||k(),duration:r.duration,tweens:[],createTween:function(t,r){var n=oe.Tween(e,u.opts,t,r,u.opts.specialEasing[t]||u.opts.easing);return u.tweens.push(n),n},stop:function(t){var r=0,n=t?u.tweens.length:0;if(i)return this;for(i=!0;n>r;r++)u.tweens[r].run(1);return t?s.resolveWith(e,[u,t]):s.rejectWith(e,[u,t]),this}}),h=u.props;for(O(h,u.opts.specialEasing);a>o;o++)if(n=xt[o].call(u,e,h,u.opts))return n;return oe.map(h,N,u),oe.isFunction(u.opts.start)&&u.opts.start.call(e,u),oe.fx.timer(oe.extend(l,{elem:e,anim:u,queue:u.opts.queue})),u.progress(u.opts.progress).done(u.opts.done,u.opts.complete).fail(u.opts.fail).always(u.opts.always)}function j(e){return function(t,r){"string"!=typeof t&&(r=t,t="*");var n,i=0,o=t.toLowerCase().match(be)||[];if(oe.isFunction(r))for(;n=o[i++];)"+"===n.charAt(0)?(n=n.slice(1)||"*",(e[n]=e[n]||[]).unshift(r)):(e[n]=e[n]||[]).push(r)}}function q(e,t,r,n){function i(s){var l;return o[s]=!0,oe.each(e[s]||[],function(e,s){var u=s(t,r,n);return"string"!=typeof u||a||o[u]?a?!(l=u):void 0:(t.dataTypes.unshift(u),i(u),!1)}),l}var o={},a=e===zt;return i(t.dataTypes[0])||!o["*"]&&i("*")}function G(e,t){var r,n,i=oe.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&oe.extend(!0,e,r),e}function V(e,t,r){for(var n,i,o,a,s=e.contents,l=e.dataTypes;"*"===l[0];)l.shift(),void 0===i&&(i=e.mimeType||t.getResponseHeader("Content-Type"));if(i)for(a in s)if(s[a]&&s[a].test(i)){l.unshift(a);break}if(l[0]in r)o=l[0];else{for(a in r){if(!l[0]||e.converters[a+" "+l[0]]){o=a;break}n||(n=a)}o=o||n}return o?(o!==l[0]&&l.unshift(o),r[o]):void 0}function z(e,t,r,n){var i,o,a,s,l,u={},h=e.dataTypes.slice();if(h[1])for(a in e.converters)u[a.toLowerCase()]=e.converters[a];for(o=h.shift();o;)if(e.responseFields[o]&&(r[e.responseFields[o]]=t),!l&&n&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),l=o,o=h.shift())if("*"===o)o=l;else if("*"!==l&&l!==o){if(a=u[l+" "+o]||u["* "+o],!a)for(i in u)if(s=i.split(" "),s[1]===o&&(a=u[l+" "+s[0]]||u["* "+s[0]])){a===!0?a=u[i]:u[i]!==!0&&(o=s[0],h.unshift(s[1]));break}if(a!==!0)if(a&&e.throws)t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+l+" to "+o}}}return{state:"success",data:t}}function H(e,t,r,n){var i;if(oe.isArray(t))oe.each(t,function(t,i){r||Wt.test(e)?n(e,i):H(e+"["+("object"==typeof i?t:"")+"]",i,r,n)});else if(r||"object"!==oe.type(t))n(e,t);else for(i in t)H(e+"["+i+"]",t[i],r,n)}function X(){try{return new e.XMLHttpRequest}catch(e){}}function W(){try{return new e.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}function Y(e){return oe.isWindow(e)?e:9===e.nodeType&&(e.defaultView||e.parentWindow)}var Q=[],Z=Q.slice,K=Q.concat,J=Q.push,$=Q.indexOf,ee={},te=ee.toString,re=ee.hasOwnProperty,ne={},ie="1.11.1",oe=function(e,t){return new oe.fn.init(e,t)},ae=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,se=/^-ms-/,le=/-([\da-z])/gi,ue=function(e,t){return t.toUpperCase()};oe.fn=oe.prototype={jquery:ie,constructor:oe,selector:"",length:0,toArray:function(){return Z.call(this)},get:function(e){return null!=e?0>e?this[e+this.length]:this[e]:Z.call(this)},pushStack:function(e){var t=oe.merge(this.constructor(),e);return t.prevObject=this,t.context=this.context,t},each:function(e,t){return oe.each(this,e,t)},map:function(e){return this.pushStack(oe.map(this,function(t,r){return e.call(t,r,t)}))},slice:function(){return this.pushStack(Z.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,r=+e+(0>e?t:0);return this.pushStack(r>=0&&t>r?[this[r]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:J,sort:Q.sort,splice:Q.splice},oe.extend=oe.fn.extend=function(){var e,t,r,n,i,o,a=arguments[0]||{},s=1,l=arguments.length,u=!1;for("boolean"==typeof a&&(u=a,a=arguments[s]||{},s++),"object"==typeof a||oe.isFunction(a)||(a={}),s===l&&(a=this,s--);l>s;s++)if(null!=(i=arguments[s]))for(n in i)e=a[n],r=i[n],a!==r&&(u&&r&&(oe.isPlainObject(r)||(t=oe.isArray(r)))?(t?(t=!1,o=e&&oe.isArray(e)?e:[]):o=e&&oe.isPlainObject(e)?e:{},a[n]=oe.extend(u,o,r)):void 0!==r&&(a[n]=r));return a},oe.extend({expando:"jQuery"+(ie+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isFunction:function(e){
return"function"===oe.type(e)},isArray:Array.isArray||function(e){return"array"===oe.type(e)},isWindow:function(e){return null!=e&&e==e.window},isNumeric:function(e){return!oe.isArray(e)&&e-parseFloat(e)>=0},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},isPlainObject:function(e){var t;if(!e||"object"!==oe.type(e)||e.nodeType||oe.isWindow(e))return!1;try{if(e.constructor&&!re.call(e,"constructor")&&!re.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}if(ne.ownLast)for(t in e)return re.call(e,t);for(t in e);return void 0===t||re.call(e,t)},type:function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?ee[te.call(e)]||"object":typeof e},globalEval:function(t){t&&oe.trim(t)&&(e.execScript||function(t){e.eval.call(e,t)})(t)},camelCase:function(e){return e.replace(se,"ms-").replace(le,ue)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t,r){var i,o=0,a=e.length,s=n(e);if(r){if(s)for(;a>o&&(i=t.apply(e[o],r),i!==!1);o++);else for(o in e)if(i=t.apply(e[o],r),i===!1)break}else if(s)for(;a>o&&(i=t.call(e[o],o,e[o]),i!==!1);o++);else for(o in e)if(i=t.call(e[o],o,e[o]),i===!1)break;return e},trim:function(e){return null==e?"":(e+"").replace(ae,"")},makeArray:function(e,t){var r=t||[];return null!=e&&(n(Object(e))?oe.merge(r,"string"==typeof e?[e]:e):J.call(r,e)),r},inArray:function(e,t,r){var n;if(t){if($)return $.call(t,e,r);for(n=t.length,r=r?0>r?Math.max(0,n+r):r:0;n>r;r++)if(r in t&&t[r]===e)return r}return-1},merge:function(e,t){for(var r=+t.length,n=0,i=e.length;r>n;)e[i++]=t[n++];if(r!==r)for(;void 0!==t[n];)e[i++]=t[n++];return e.length=i,e},grep:function(e,t,r){for(var n,i=[],o=0,a=e.length,s=!r;a>o;o++)n=!t(e[o],o),n!==s&&i.push(e[o]);return i},map:function(e,t,r){var i,o=0,a=e.length,s=n(e),l=[];if(s)for(;a>o;o++)i=t(e[o],o,r),null!=i&&l.push(i);else for(o in e)i=t(e[o],o,r),null!=i&&l.push(i);return K.apply([],l)},guid:1,proxy:function(e,t){var r,n,i;return"string"==typeof t&&(i=e[t],t=e,e=i),oe.isFunction(e)?(r=Z.call(arguments,2),n=function(){return e.apply(t||this,r.concat(Z.call(arguments)))},n.guid=e.guid=e.guid||oe.guid++,n):void 0},now:function(){return+new Date},support:ne}),oe.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(e,t){ee["[object "+t+"]"]=t.toLowerCase()});var he=function(e){function t(e,t,r,n){var i,o,a,s,l,u,c,f,p,m;if((t?t.ownerDocument||t:j)!==_&&I(t),t=t||_,r=r||[],!e||"string"!=typeof e)return r;if(1!==(s=t.nodeType)&&9!==s)return[];if(k&&!n){if(i=ye.exec(e))if(a=i[1]){if(9===s){if(o=t.getElementById(a),!o||!o.parentNode)return r;if(o.id===a)return r.push(o),r}else if(t.ownerDocument&&(o=t.ownerDocument.getElementById(a))&&O(t,o)&&o.id===a)return r.push(o),r}else{if(i[2])return $.apply(r,t.getElementsByTagName(e)),r;if((a=i[3])&&T.getElementsByClassName&&t.getElementsByClassName)return $.apply(r,t.getElementsByClassName(a)),r}if(T.qsa&&(!B||!B.test(e))){if(f=c=U,p=t,m=9===s&&e,1===s&&"object"!==t.nodeName.toLowerCase()){for(u=M(e),(c=t.getAttribute("id"))?f=c.replace(be,"\\$&"):t.setAttribute("id",f),f="[id='"+f+"'] ",l=u.length;l--;)u[l]=f+d(u[l]);p=xe.test(e)&&h(t.parentNode)||t,m=u.join(",")}if(m)try{return $.apply(r,p.querySelectorAll(m)),r}catch(e){}finally{c||t.removeAttribute("id")}}}return E(e.replace(le,"$1"),t,r,n)}function r(){function e(r,n){return t.push(r+" ")>w.cacheLength&&delete e[t.shift()],e[r+" "]=n}var t=[];return e}function n(e){return e[U]=!0,e}function i(e){var t=_.createElement("div");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function o(e,t){for(var r=e.split("|"),n=e.length;n--;)w.attrHandle[r[n]]=t}function a(e,t){var r=t&&e,n=r&&1===e.nodeType&&1===t.nodeType&&(~t.sourceIndex||Y)-(~e.sourceIndex||Y);if(n)return n;if(r)for(;r=r.nextSibling;)if(r===t)return-1;return e?1:-1}function s(e){return function(t){var r=t.nodeName.toLowerCase();return"input"===r&&t.type===e}}function l(e){return function(t){var r=t.nodeName.toLowerCase();return("input"===r||"button"===r)&&t.type===e}}function u(e){return n(function(t){return t=+t,n(function(r,n){for(var i,o=e([],r.length,t),a=o.length;a--;)r[i=o[a]]&&(r[i]=!(n[i]=r[i]))})})}function h(e){return e&&typeof e.getElementsByTagName!==W&&e}function c(){}function d(e){for(var t=0,r=e.length,n="";r>t;t++)n+=e[t].value;return n}function f(e,t,r){var n=t.dir,i=r&&"parentNode"===n,o=G++;return t.first?function(t,r,o){for(;t=t[n];)if(1===t.nodeType||i)return e(t,r,o)}:function(t,r,a){var s,l,u=[q,o];if(a){for(;t=t[n];)if((1===t.nodeType||i)&&e(t,r,a))return!0}else for(;t=t[n];)if(1===t.nodeType||i){if(l=t[U]||(t[U]={}),(s=l[n])&&s[0]===q&&s[1]===o)return u[2]=s[2];if(l[n]=u,u[2]=e(t,r,a))return!0}}}function p(e){return e.length>1?function(t,r,n){for(var i=e.length;i--;)if(!e[i](t,r,n))return!1;return!0}:e[0]}function m(e,r,n){for(var i=0,o=r.length;o>i;i++)t(e,r[i],n);return n}function v(e,t,r,n,i){for(var o,a=[],s=0,l=e.length,u=null!=t;l>s;s++)(o=e[s])&&(!r||r(o,n,i))&&(a.push(o),u&&t.push(s));return a}function g(e,t,r,i,o,a){return i&&!i[U]&&(i=g(i)),o&&!o[U]&&(o=g(o,a)),n(function(n,a,s,l){var u,h,c,d=[],f=[],p=a.length,g=n||m(t||"*",s.nodeType?[s]:s,[]),y=!e||!n&&t?g:v(g,d,e,s,l),x=r?o||(n?e:p||i)?[]:a:y;if(r&&r(y,x,s,l),i)for(u=v(x,f),i(u,[],s,l),h=u.length;h--;)(c=u[h])&&(x[f[h]]=!(y[f[h]]=c));if(n){if(o||e){if(o){for(u=[],h=x.length;h--;)(c=x[h])&&u.push(y[h]=c);o(null,x=[],u,l)}for(h=x.length;h--;)(c=x[h])&&(u=o?te.call(n,c):d[h])>-1&&(n[u]=!(a[u]=c))}}else x=v(x===a?x.splice(p,x.length):x),o?o(null,a,x,l):$.apply(a,x)})}function y(e){for(var t,r,n,i=e.length,o=w.relative[e[0].type],a=o||w.relative[" "],s=o?1:0,l=f(function(e){return e===t},a,!0),u=f(function(e){return te.call(t,e)>-1},a,!0),h=[function(e,r,n){return!o&&(n||r!==P)||((t=r).nodeType?l(e,r,n):u(e,r,n))}];i>s;s++)if(r=w.relative[e[s].type])h=[f(p(h),r)];else{if(r=w.filter[e[s].type].apply(null,e[s].matches),r[U]){for(n=++s;i>n&&!w.relative[e[n].type];n++);return g(s>1&&p(h),s>1&&d(e.slice(0,s-1).concat({value:" "===e[s-2].type?"*":""})).replace(le,"$1"),r,n>s&&y(e.slice(s,n)),i>n&&y(e=e.slice(n)),i>n&&d(e))}h.push(r)}return p(h)}function x(e,r){var i=r.length>0,o=e.length>0,a=function(n,a,s,l,u){var h,c,d,f=0,p="0",m=n&&[],g=[],y=P,x=n||o&&w.find.TAG("*",u),b=q+=null==y?1:Math.random()||.1,T=x.length;for(u&&(P=a!==_&&a);p!==T&&null!=(h=x[p]);p++){if(o&&h){for(c=0;d=e[c++];)if(d(h,a,s)){l.push(h);break}u&&(q=b)}i&&((h=!d&&h)&&f--,n&&m.push(h))}if(f+=p,i&&p!==f){for(c=0;d=r[c++];)d(m,g,a,s);if(n){if(f>0)for(;p--;)m[p]||g[p]||(g[p]=K.call(l));g=v(g)}$.apply(l,g),u&&!n&&g.length>0&&f+r.length>1&&t.uniqueSort(l)}return u&&(q=b,P=y),m};return i?n(a):a}var b,T,w,S,A,M,C,E,P,R,L,I,_,F,k,B,N,D,O,U="sizzle"+-new Date,j=e.document,q=0,G=0,V=r(),z=r(),H=r(),X=function(e,t){return e===t&&(L=!0),0},W="undefined",Y=1<<31,Q={}.hasOwnProperty,Z=[],K=Z.pop,J=Z.push,$=Z.push,ee=Z.slice,te=Z.indexOf||function(e){for(var t=0,r=this.length;r>t;t++)if(this[t]===e)return t;return-1},re="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",ne="[\\x20\\t\\r\\n\\f]",ie="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",oe=ie.replace("w","w#"),ae="\\["+ne+"*("+ie+")(?:"+ne+"*([*^$|!~]?=)"+ne+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+oe+"))|)"+ne+"*\\]",se=":("+ie+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+ae+")*)|.*)\\)|)",le=new RegExp("^"+ne+"+|((?:^|[^\\\\])(?:\\\\.)*)"+ne+"+$","g"),ue=new RegExp("^"+ne+"*,"+ne+"*"),he=new RegExp("^"+ne+"*([>+~]|"+ne+")"+ne+"*"),ce=new RegExp("="+ne+"*([^\\]'\"]*?)"+ne+"*\\]","g"),de=new RegExp(se),fe=new RegExp("^"+oe+"$"),pe={ID:new RegExp("^#("+ie+")"),CLASS:new RegExp("^\\.("+ie+")"),TAG:new RegExp("^("+ie.replace("w","w*")+")"),ATTR:new RegExp("^"+ae),PSEUDO:new RegExp("^"+se),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+ne+"*(even|odd|(([+-]|)(\\d*)n|)"+ne+"*(?:([+-]|)"+ne+"*(\\d+)|))"+ne+"*\\)|)","i"),bool:new RegExp("^(?:"+re+")$","i"),needsContext:new RegExp("^"+ne+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+ne+"*((?:-\\d)?\\d*)"+ne+"*\\)|)(?=[^-]|$)","i")},me=/^(?:input|select|textarea|button)$/i,ve=/^h\d$/i,ge=/^[^{]+\{\s*\[native \w/,ye=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,xe=/[+~]/,be=/'|\\/g,Te=new RegExp("\\\\([\\da-f]{1,6}"+ne+"?|("+ne+")|.)","ig"),we=function(e,t,r){var n="0x"+t-65536;return n!==n||r?t:0>n?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,1023&n|56320)};try{$.apply(Z=ee.call(j.childNodes),j.childNodes),Z[j.childNodes.length].nodeType}catch(e){$={apply:Z.length?function(e,t){J.apply(e,ee.call(t))}:function(e,t){for(var r=e.length,n=0;e[r++]=t[n++];);e.length=r-1}}}T=t.support={},A=t.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return!!t&&"HTML"!==t.nodeName},I=t.setDocument=function(e){var t,r=e?e.ownerDocument||e:j,n=r.defaultView;return r!==_&&9===r.nodeType&&r.documentElement?(_=r,F=r.documentElement,k=!A(r),n&&n!==n.top&&(n.addEventListener?n.addEventListener("unload",function(){I()},!1):n.attachEvent&&n.attachEvent("onunload",function(){I()})),T.attributes=i(function(e){return e.className="i",!e.getAttribute("className")}),T.getElementsByTagName=i(function(e){return e.appendChild(r.createComment("")),!e.getElementsByTagName("*").length}),T.getElementsByClassName=ge.test(r.getElementsByClassName)&&i(function(e){return e.innerHTML="<div class='a'></div><div class='a i'></div>",e.firstChild.className="i",2===e.getElementsByClassName("i").length}),T.getById=i(function(e){return F.appendChild(e).id=U,!r.getElementsByName||!r.getElementsByName(U).length}),T.getById?(w.find.ID=function(e,t){if(typeof t.getElementById!==W&&k){var r=t.getElementById(e);return r&&r.parentNode?[r]:[]}},w.filter.ID=function(e){var t=e.replace(Te,we);return function(e){return e.getAttribute("id")===t}}):(delete w.find.ID,w.filter.ID=function(e){var t=e.replace(Te,we);return function(e){var r=typeof e.getAttributeNode!==W&&e.getAttributeNode("id");return r&&r.value===t}}),w.find.TAG=T.getElementsByTagName?function(e,t){return typeof t.getElementsByTagName!==W?t.getElementsByTagName(e):void 0}:function(e,t){var r,n=[],i=0,o=t.getElementsByTagName(e);if("*"===e){for(;r=o[i++];)1===r.nodeType&&n.push(r);return n}return o},w.find.CLASS=T.getElementsByClassName&&function(e,t){return typeof t.getElementsByClassName!==W&&k?t.getElementsByClassName(e):void 0},N=[],B=[],(T.qsa=ge.test(r.querySelectorAll))&&(i(function(e){e.innerHTML="<select msallowclip=''><option selected=''></option></select>",e.querySelectorAll("[msallowclip^='']").length&&B.push("[*^$]="+ne+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||B.push("\\["+ne+"*(?:value|"+re+")"),e.querySelectorAll(":checked").length||B.push(":checked")}),i(function(e){var t=r.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&B.push("name"+ne+"*[*^$|!~]?="),e.querySelectorAll(":enabled").length||B.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),B.push(",.*:")})),(T.matchesSelector=ge.test(D=F.matches||F.webkitMatchesSelector||F.mozMatchesSelector||F.oMatchesSelector||F.msMatchesSelector))&&i(function(e){T.disconnectedMatch=D.call(e,"div"),D.call(e,"[s!='']:x"),N.push("!=",se)}),B=B.length&&new RegExp(B.join("|")),N=N.length&&new RegExp(N.join("|")),t=ge.test(F.compareDocumentPosition),O=t||ge.test(F.contains)?function(e,t){var r=9===e.nodeType?e.documentElement:e,n=t&&t.parentNode;return e===n||!(!n||1!==n.nodeType||!(r.contains?r.contains(n):e.compareDocumentPosition&&16&e.compareDocumentPosition(n)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},X=t?function(e,t){if(e===t)return L=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n?n:(n=(e.ownerDocument||e)===(t.ownerDocument||t)?e.compareDocumentPosition(t):1,1&n||!T.sortDetached&&t.compareDocumentPosition(e)===n?e===r||e.ownerDocument===j&&O(j,e)?-1:t===r||t.ownerDocument===j&&O(j,t)?1:R?te.call(R,e)-te.call(R,t):0:4&n?-1:1)}:function(e,t){if(e===t)return L=!0,0;var n,i=0,o=e.parentNode,s=t.parentNode,l=[e],u=[t];if(!o||!s)return e===r?-1:t===r?1:o?-1:s?1:R?te.call(R,e)-te.call(R,t):0;if(o===s)return a(e,t);for(n=e;n=n.parentNode;)l.unshift(n);for(n=t;n=n.parentNode;)u.unshift(n);for(;l[i]===u[i];)i++;return i?a(l[i],u[i]):l[i]===j?-1:u[i]===j?1:0},r):_},t.matches=function(e,r){return t(e,null,null,r)},t.matchesSelector=function(e,r){if((e.ownerDocument||e)!==_&&I(e),r=r.replace(ce,"='$1']"),!(!T.matchesSelector||!k||N&&N.test(r)||B&&B.test(r)))try{var n=D.call(e,r);if(n||T.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){}return t(r,_,null,[e]).length>0},t.contains=function(e,t){return(e.ownerDocument||e)!==_&&I(e),O(e,t)},t.attr=function(e,t){(e.ownerDocument||e)!==_&&I(e);var r=w.attrHandle[t.toLowerCase()],n=r&&Q.call(w.attrHandle,t.toLowerCase())?r(e,t,!k):void 0;return void 0!==n?n:T.attributes||!k?e.getAttribute(t):(n=e.getAttributeNode(t))&&n.specified?n.value:null},t.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},t.uniqueSort=function(e){var t,r=[],n=0,i=0;if(L=!T.detectDuplicates,R=!T.sortStable&&e.slice(0),e.sort(X),L){for(;t=e[i++];)t===e[i]&&(n=r.push(i));for(;n--;)e.splice(r[n],1)}return R=null,e},S=t.getText=function(e){var t,r="",n=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)r+=S(e)}else if(3===i||4===i)return e.nodeValue}else for(;t=e[n++];)r+=S(t);return r},w=t.selectors={cacheLength:50,createPseudo:n,match:pe,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(Te,we),e[3]=(e[3]||e[4]||e[5]||"").replace(Te,we),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||t.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&t.error(e[0]),e},PSEUDO:function(e){var t,r=!e[6]&&e[2];return pe.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":r&&de.test(r)&&(t=M(r,!0))&&(t=r.indexOf(")",r.length-t)-r.length)&&(e[0]=e[0].slice(0,t),e[2]=r.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(Te,we).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=V[e+" "];return t||(t=new RegExp("(^|"+ne+")"+e+"("+ne+"|$)"))&&V(e,function(e){return t.test("string"==typeof e.className&&e.className||typeof e.getAttribute!==W&&e.getAttribute("class")||"")})},ATTR:function(e,r,n){return function(i){var o=t.attr(i,e);return null==o?"!="===r:!r||(o+="","="===r?o===n:"!="===r?o!==n:"^="===r?n&&0===o.indexOf(n):"*="===r?n&&o.indexOf(n)>-1:"$="===r?n&&o.slice(-n.length)===n:"~="===r?(" "+o+" ").indexOf(n)>-1:"|="===r&&(o===n||o.slice(0,n.length+1)===n+"-"))}},CHILD:function(e,t,r,n,i){var o="nth"!==e.slice(0,3),a="last"!==e.slice(-4),s="of-type"===t;return 1===n&&0===i?function(e){return!!e.parentNode}:function(t,r,l){var u,h,c,d,f,p,m=o!==a?"nextSibling":"previousSibling",v=t.parentNode,g=s&&t.nodeName.toLowerCase(),y=!l&&!s;if(v){if(o){for(;m;){for(c=t;c=c[m];)if(s?c.nodeName.toLowerCase()===g:1===c.nodeType)return!1;p=m="only"===e&&!p&&"nextSibling"}return!0}if(p=[a?v.firstChild:v.lastChild],a&&y){for(h=v[U]||(v[U]={}),u=h[e]||[],f=u[0]===q&&u[1],d=u[0]===q&&u[2],c=f&&v.childNodes[f];c=++f&&c&&c[m]||(d=f=0)||p.pop();)if(1===c.nodeType&&++d&&c===t){h[e]=[q,f,d];break}}else if(y&&(u=(t[U]||(t[U]={}))[e])&&u[0]===q)d=u[1];else for(;(c=++f&&c&&c[m]||(d=f=0)||p.pop())&&((s?c.nodeName.toLowerCase()!==g:1!==c.nodeType)||!++d||(y&&((c[U]||(c[U]={}))[e]=[q,d]),c!==t)););return d-=i,d===n||d%n===0&&d/n>=0}}},PSEUDO:function(e,r){var i,o=w.pseudos[e]||w.setFilters[e.toLowerCase()]||t.error("unsupported pseudo: "+e);return o[U]?o(r):o.length>1?(i=[e,e,"",r],w.setFilters.hasOwnProperty(e.toLowerCase())?n(function(e,t){for(var n,i=o(e,r),a=i.length;a--;)n=te.call(e,i[a]),e[n]=!(t[n]=i[a])}):function(e){return o(e,0,i)}):o}},pseudos:{not:n(function(e){var t=[],r=[],i=C(e.replace(le,"$1"));return i[U]?n(function(e,t,r,n){for(var o,a=i(e,null,n,[]),s=e.length;s--;)(o=a[s])&&(e[s]=!(t[s]=o))}):function(e,n,o){return t[0]=e,i(t,null,o,r),!r.pop()}}),has:n(function(e){return function(r){return t(e,r).length>0}}),contains:n(function(e){return function(t){return(t.textContent||t.innerText||S(t)).indexOf(e)>-1}}),lang:n(function(e){return fe.test(e||"")||t.error("unsupported lang: "+e),e=e.replace(Te,we).toLowerCase(),function(t){var r;do if(r=k?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return r=r.toLowerCase(),r===e||0===r.indexOf(e+"-");while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var r=e.location&&e.location.hash;return r&&r.slice(1)===t.id},root:function(e){return e===F},focus:function(e){return e===_.activeElement&&(!_.hasFocus||_.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:function(e){return e.disabled===!1},disabled:function(e){return e.disabled===!0},checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,e.selected===!0},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!w.pseudos.empty(e)},header:function(e){return ve.test(e.nodeName)},input:function(e){return me.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:u(function(){return[0]}),last:u(function(e,t){return[t-1]}),eq:u(function(e,t,r){return[0>r?r+t:r]}),even:u(function(e,t){for(var r=0;t>r;r+=2)e.push(r);return e}),odd:u(function(e,t){for(var r=1;t>r;r+=2)e.push(r);return e}),lt:u(function(e,t,r){for(var n=0>r?r+t:r;--n>=0;)e.push(n);return e}),gt:u(function(e,t,r){for(var n=0>r?r+t:r;++n<t;)e.push(n);return e})}},w.pseudos.nth=w.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})w.pseudos[b]=s(b);for(b in{submit:!0,reset:!0})w.pseudos[b]=l(b);return c.prototype=w.filters=w.pseudos,w.setFilters=new c,M=t.tokenize=function(e,r){var n,i,o,a,s,l,u,h=z[e+" "];if(h)return r?0:h.slice(0);for(s=e,l=[],u=w.preFilter;s;){(!n||(i=ue.exec(s)))&&(i&&(s=s.slice(i[0].length)||s),l.push(o=[])),n=!1,(i=he.exec(s))&&(n=i.shift(),o.push({value:n,type:i[0].replace(le," ")}),s=s.slice(n.length));for(a in w.filter)!(i=pe[a].exec(s))||u[a]&&!(i=u[a](i))||(n=i.shift(),o.push({value:n,type:a,matches:i}),s=s.slice(n.length));if(!n)break}return r?s.length:s?t.error(e):z(e,l).slice(0)},C=t.compile=function(e,t){var r,n=[],i=[],o=H[e+" "];if(!o){for(t||(t=M(e)),r=t.length;r--;)o=y(t[r]),o[U]?n.push(o):i.push(o);o=H(e,x(i,n)),o.selector=e}return o},E=t.select=function(e,t,r,n){var i,o,a,s,l,u="function"==typeof e&&e,c=!n&&M(e=u.selector||e);if(r=r||[],1===c.length){if(o=c[0]=c[0].slice(0),o.length>2&&"ID"===(a=o[0]).type&&T.getById&&9===t.nodeType&&k&&w.relative[o[1].type]){if(t=(w.find.ID(a.matches[0].replace(Te,we),t)||[])[0],!t)return r;u&&(t=t.parentNode),e=e.slice(o.shift().value.length)}for(i=pe.needsContext.test(e)?0:o.length;i--&&(a=o[i],!w.relative[s=a.type]);)if((l=w.find[s])&&(n=l(a.matches[0].replace(Te,we),xe.test(o[0].type)&&h(t.parentNode)||t))){if(o.splice(i,1),e=n.length&&d(o),!e)return $.apply(r,n),r;break}}return(u||C(e,c))(n,t,!k,r,xe.test(e)&&h(t.parentNode)||t),r},T.sortStable=U.split("").sort(X).join("")===U,T.detectDuplicates=!!L,I(),T.sortDetached=i(function(e){return 1&e.compareDocumentPosition(_.createElement("div"))}),i(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||o("type|href|height|width",function(e,t,r){return r?void 0:e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),T.attributes&&i(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||o("value",function(e,t,r){return r||"input"!==e.nodeName.toLowerCase()?void 0:e.defaultValue}),i(function(e){return null==e.getAttribute("disabled")})||o(re,function(e,t,r){var n;return r?void 0:e[t]===!0?t.toLowerCase():(n=e.getAttributeNode(t))&&n.specified?n.value:null}),t}(e);oe.find=he,oe.expr=he.selectors,oe.expr[":"]=oe.expr.pseudos,oe.unique=he.uniqueSort,oe.text=he.getText,oe.isXMLDoc=he.isXML,oe.contains=he.contains;var ce=oe.expr.match.needsContext,de=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,fe=/^.[^:#\[\.,]*$/;oe.filter=function(e,t,r){var n=t[0];return r&&(e=":not("+e+")"),1===t.length&&1===n.nodeType?oe.find.matchesSelector(n,e)?[n]:[]:oe.find.matches(e,oe.grep(t,function(e){return 1===e.nodeType}))},oe.fn.extend({find:function(e){var t,r=[],n=this,i=n.length;if("string"!=typeof e)return this.pushStack(oe(e).filter(function(){for(t=0;i>t;t++)if(oe.contains(n[t],this))return!0}));for(t=0;i>t;t++)oe.find(e,n[t],r);return r=this.pushStack(i>1?oe.unique(r):r),r.selector=this.selector?this.selector+" "+e:e,r},filter:function(e){return this.pushStack(i(this,e||[],!1))},not:function(e){return this.pushStack(i(this,e||[],!0))},is:function(e){return!!i(this,"string"==typeof e&&ce.test(e)?oe(e):e||[],!1).length}});var pe,me=e.document,ve=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,ge=oe.fn.init=function(e,t){var r,n;if(!e)return this;if("string"==typeof e){if(r="<"===e.charAt(0)&&">"===e.charAt(e.length-1)&&e.length>=3?[null,e,null]:ve.exec(e),!r||!r[1]&&t)return!t||t.jquery?(t||pe).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof oe?t[0]:t,oe.merge(this,oe.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:me,!0)),de.test(r[1])&&oe.isPlainObject(t))for(r in t)oe.isFunction(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}if(n=me.getElementById(r[2]),n&&n.parentNode){if(n.id!==r[2])return pe.find(e);this.length=1,this[0]=n}return this.context=me,this.selector=e,this}return e.nodeType?(this.context=this[0]=e,this.length=1,this):oe.isFunction(e)?"undefined"!=typeof pe.ready?pe.ready(e):e(oe):(void 0!==e.selector&&(this.selector=e.selector,this.context=e.context),oe.makeArray(e,this))};ge.prototype=oe.fn,pe=oe(me);var ye=/^(?:parents|prev(?:Until|All))/,xe={children:!0,contents:!0,next:!0,prev:!0};oe.extend({dir:function(e,t,r){for(var n=[],i=e[t];i&&9!==i.nodeType&&(void 0===r||1!==i.nodeType||!oe(i).is(r));)1===i.nodeType&&n.push(i),i=i[t];return n},sibling:function(e,t){for(var r=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&r.push(e);return r}}),oe.fn.extend({has:function(e){var t,r=oe(e,this),n=r.length;return this.filter(function(){for(t=0;n>t;t++)if(oe.contains(this,r[t]))return!0})},closest:function(e,t){for(var r,n=0,i=this.length,o=[],a=ce.test(e)||"string"!=typeof e?oe(e,t||this.context):0;i>n;n++)for(r=this[n];r&&r!==t;r=r.parentNode)if(r.nodeType<11&&(a?a.index(r)>-1:1===r.nodeType&&oe.find.matchesSelector(r,e))){o.push(r);break}return this.pushStack(o.length>1?oe.unique(o):o)},index:function(e){return e?"string"==typeof e?oe.inArray(this[0],oe(e)):oe.inArray(e.jquery?e[0]:e,this):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(oe.unique(oe.merge(this.get(),oe(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),oe.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return oe.dir(e,"parentNode")},parentsUntil:function(e,t,r){return oe.dir(e,"parentNode",r)},next:function(e){return o(e,"nextSibling")},prev:function(e){return o(e,"previousSibling")},nextAll:function(e){return oe.dir(e,"nextSibling")},prevAll:function(e){return oe.dir(e,"previousSibling")},nextUntil:function(e,t,r){return oe.dir(e,"nextSibling",r)},prevUntil:function(e,t,r){return oe.dir(e,"previousSibling",r)},siblings:function(e){return oe.sibling((e.parentNode||{}).firstChild,e)},children:function(e){return oe.sibling(e.firstChild)},contents:function(e){return oe.nodeName(e,"iframe")?e.contentDocument||e.contentWindow.document:oe.merge([],e.childNodes)}},function(e,t){oe.fn[e]=function(r,n){var i=oe.map(this,t,r);return"Until"!==e.slice(-5)&&(n=r),n&&"string"==typeof n&&(i=oe.filter(n,i)),this.length>1&&(xe[e]||(i=oe.unique(i)),ye.test(e)&&(i=i.reverse())),this.pushStack(i)}});var be=/\S+/g,Te={};oe.Callbacks=function(e){e="string"==typeof e?Te[e]||a(e):oe.extend({},e);var t,r,n,i,o,s,l=[],u=!e.once&&[],h=function(a){for(r=e.memory&&a,n=!0,o=s||0,s=0,i=l.length,t=!0;l&&i>o;o++)if(l[o].apply(a[0],a[1])===!1&&e.stopOnFalse){r=!1;break}t=!1,l&&(u?u.length&&h(u.shift()):r?l=[]:c.disable())},c={add:function(){if(l){var n=l.length;!function t(r){oe.each(r,function(r,n){var i=oe.type(n);"function"===i?e.unique&&c.has(n)||l.push(n):n&&n.length&&"string"!==i&&t(n)})}(arguments),t?i=l.length:r&&(s=n,h(r))}return this},remove:function(){return l&&oe.each(arguments,function(e,r){for(var n;(n=oe.inArray(r,l,n))>-1;)l.splice(n,1),t&&(i>=n&&i--,o>=n&&o--)}),this},has:function(e){return e?oe.inArray(e,l)>-1:!(!l||!l.length)},empty:function(){return l=[],i=0,this},disable:function(){return l=u=r=void 0,this},disabled:function(){return!l},lock:function(){return u=void 0,r||c.disable(),this},locked:function(){return!u},fireWith:function(e,r){return!l||n&&!u||(r=r||[],r=[e,r.slice?r.slice():r],t?u.push(r):h(r)),this},fire:function(){return c.fireWith(this,arguments),this},fired:function(){return!!n}};return c},oe.extend({Deferred:function(e){var t=[["resolve","done",oe.Callbacks("once memory"),"resolved"],["reject","fail",oe.Callbacks("once memory"),"rejected"],["notify","progress",oe.Callbacks("memory")]],r="pending",n={state:function(){return r},always:function(){return i.done(arguments).fail(arguments),this},then:function(){var e=arguments;return oe.Deferred(function(r){oe.each(t,function(t,o){var a=oe.isFunction(e[t])&&e[t];i[o[1]](function(){var e=a&&a.apply(this,arguments);e&&oe.isFunction(e.promise)?e.promise().done(r.resolve).fail(r.reject).progress(r.notify):r[o[0]+"With"](this===n?r.promise():this,a?[e]:arguments)})}),e=null}).promise()},promise:function(e){return null!=e?oe.extend(e,n):n}},i={};return n.pipe=n.then,oe.each(t,function(e,o){var a=o[2],s=o[3];n[o[1]]=a.add,s&&a.add(function(){r=s},t[1^e][2].disable,t[2][2].lock),i[o[0]]=function(){return i[o[0]+"With"](this===i?n:this,arguments),this},i[o[0]+"With"]=a.fireWith}),n.promise(i),e&&e.call(i,i),i},when:function(e){var t,r,n,i=0,o=Z.call(arguments),a=o.length,s=1!==a||e&&oe.isFunction(e.promise)?a:0,l=1===s?e:oe.Deferred(),u=function(e,r,n){return function(i){r[e]=this,n[e]=arguments.length>1?Z.call(arguments):i,n===t?l.notifyWith(r,n):--s||l.resolveWith(r,n)}};if(a>1)for(t=new Array(a),r=new Array(a),n=new Array(a);a>i;i++)o[i]&&oe.isFunction(o[i].promise)?o[i].promise().done(u(i,n,o)).fail(l.reject).progress(u(i,r,t)):--s;return s||l.resolveWith(n,o),l.promise()}});var we;oe.fn.ready=function(e){return oe.ready.promise().done(e),this},oe.extend({isReady:!1,readyWait:1,holdReady:function(e){e?oe.readyWait++:oe.ready(!0)},ready:function(e){if(e===!0?!--oe.readyWait:!oe.isReady){if(!me.body)return setTimeout(oe.ready);oe.isReady=!0,e!==!0&&--oe.readyWait>0||(we.resolveWith(me,[oe]),oe.fn.triggerHandler&&(oe(me).triggerHandler("ready"),oe(me).off("ready")))}}}),oe.ready.promise=function(t){if(!we)if(we=oe.Deferred(),"complete"===me.readyState)setTimeout(oe.ready);else if(me.addEventListener)me.addEventListener("DOMContentLoaded",l,!1),e.addEventListener("load",l,!1);else{me.attachEvent("onreadystatechange",l),e.attachEvent("onload",l);var r=!1;try{r=null==e.frameElement&&me.documentElement}catch(e){}r&&r.doScroll&&!function e(){if(!oe.isReady){try{r.doScroll("left")}catch(t){return setTimeout(e,50)}s(),oe.ready()}}()}return we.promise(t)};var Se,Ae="undefined";for(Se in oe(ne))break;ne.ownLast="0"!==Se,ne.inlineBlockNeedsLayout=!1,oe(function(){var e,t,r,n;r=me.getElementsByTagName("body")[0],r&&r.style&&(t=me.createElement("div"),n=me.createElement("div"),n.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",r.appendChild(n).appendChild(t),typeof t.style.zoom!==Ae&&(t.style.cssText="display:inline;margin:0;border:0;padding:1px;width:1px;zoom:1",ne.inlineBlockNeedsLayout=e=3===t.offsetWidth,e&&(r.style.zoom=1)),r.removeChild(n))}),function(){var e=me.createElement("div");if(null==ne.deleteExpando){ne.deleteExpando=!0;try{delete e.test}catch(e){ne.deleteExpando=!1}}e=null}(),oe.acceptData=function(e){var t=oe.noData[(e.nodeName+" ").toLowerCase()],r=+e.nodeType||1;return(1===r||9===r)&&(!t||t!==!0&&e.getAttribute("classid")===t)};var Me=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,Ce=/([A-Z])/g;oe.extend({cache:{},noData:{"applet ":!0,"embed ":!0,"object ":"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"},hasData:function(e){return e=e.nodeType?oe.cache[e[oe.expando]]:e[oe.expando],!!e&&!h(e)},data:function(e,t,r){return c(e,t,r)},removeData:function(e,t){return d(e,t)},_data:function(e,t,r){return c(e,t,r,!0)},_removeData:function(e,t){return d(e,t,!0)}}),oe.fn.extend({data:function(e,t){var r,n,i,o=this[0],a=o&&o.attributes;if(void 0===e){if(this.length&&(i=oe.data(o),1===o.nodeType&&!oe._data(o,"parsedAttrs"))){for(r=a.length;r--;)a[r]&&(n=a[r].name,0===n.indexOf("data-")&&(n=oe.camelCase(n.slice(5)),u(o,n,i[n])));oe._data(o,"parsedAttrs",!0)}return i}return"object"==typeof e?this.each(function(){oe.data(this,e)}):arguments.length>1?this.each(function(){oe.data(this,e,t)}):o?u(o,e,oe.data(o,e)):void 0},removeData:function(e){return this.each(function(){oe.removeData(this,e)})}}),oe.extend({queue:function(e,t,r){var n;return e?(t=(t||"fx")+"queue",n=oe._data(e,t),r&&(!n||oe.isArray(r)?n=oe._data(e,t,oe.makeArray(r)):n.push(r)),n||[]):void 0},dequeue:function(e,t){t=t||"fx";var r=oe.queue(e,t),n=r.length,i=r.shift(),o=oe._queueHooks(e,t),a=function(){oe.dequeue(e,t)};"inprogress"===i&&(i=r.shift(),n--),i&&("fx"===t&&r.unshift("inprogress"),delete o.stop,i.call(e,a,o)),!n&&o&&o.empty.fire()},_queueHooks:function(e,t){var r=t+"queueHooks";return oe._data(e,r)||oe._data(e,r,{empty:oe.Callbacks("once memory").add(function(){oe._removeData(e,t+"queue"),oe._removeData(e,r)})})}}),oe.fn.extend({queue:function(e,t){var r=2;return"string"!=typeof e&&(t=e,e="fx",r--),arguments.length<r?oe.queue(this[0],e):void 0===t?this:this.each(function(){var r=oe.queue(this,e,t);oe._queueHooks(this,e),"fx"===e&&"inprogress"!==r[0]&&oe.dequeue(this,e)})},dequeue:function(e){return this.each(function(){oe.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var r,n=1,i=oe.Deferred(),o=this,a=this.length,s=function(){--n||i.resolveWith(o,[o])};for("string"!=typeof e&&(t=e,e=void 0),e=e||"fx";a--;)r=oe._data(o[a],e+"queueHooks"),r&&r.empty&&(n++,r.empty.add(s));return s(),i.promise(t)}});var Ee=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,Pe=["Top","Right","Bottom","Left"],Re=function(e,t){return e=t||e,"none"===oe.css(e,"display")||!oe.contains(e.ownerDocument,e)},Le=oe.access=function(e,t,r,n,i,o,a){var s=0,l=e.length,u=null==r;if("object"===oe.type(r)){i=!0;for(s in r)oe.access(e,t,s,r[s],!0,o,a)}else if(void 0!==n&&(i=!0,oe.isFunction(n)||(a=!0),u&&(a?(t.call(e,n),t=null):(u=t,t=function(e,t,r){return u.call(oe(e),r)})),t))for(;l>s;s++)t(e[s],r,a?n:n.call(e[s],s,t(e[s],r)));return i?e:u?t.call(e):l?t(e[0],r):o},Ie=/^(?:checkbox|radio)$/i;!function(){var e=me.createElement("input"),t=me.createElement("div"),r=me.createDocumentFragment();if(t.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",ne.leadingWhitespace=3===t.firstChild.nodeType,ne.tbody=!t.getElementsByTagName("tbody").length,ne.htmlSerialize=!!t.getElementsByTagName("link").length,
ne.html5Clone="<:nav></:nav>"!==me.createElement("nav").cloneNode(!0).outerHTML,e.type="checkbox",e.checked=!0,r.appendChild(e),ne.appendChecked=e.checked,t.innerHTML="<textarea>x</textarea>",ne.noCloneChecked=!!t.cloneNode(!0).lastChild.defaultValue,r.appendChild(t),t.innerHTML="<input type='radio' checked='checked' name='t'/>",ne.checkClone=t.cloneNode(!0).cloneNode(!0).lastChild.checked,ne.noCloneEvent=!0,t.attachEvent&&(t.attachEvent("onclick",function(){ne.noCloneEvent=!1}),t.cloneNode(!0).click()),null==ne.deleteExpando){ne.deleteExpando=!0;try{delete t.test}catch(e){ne.deleteExpando=!1}}}(),function(){var t,r,n=me.createElement("div");for(t in{submit:!0,change:!0,focusin:!0})r="on"+t,(ne[t+"Bubbles"]=r in e)||(n.setAttribute(r,"t"),ne[t+"Bubbles"]=n.attributes[r].expando===!1);n=null}();var _e=/^(?:input|select|textarea)$/i,Fe=/^key/,ke=/^(?:mouse|pointer|contextmenu)|click/,Be=/^(?:focusinfocus|focusoutblur)$/,Ne=/^([^.]*)(?:\.(.+)|)$/;oe.event={global:{},add:function(e,t,r,n,i){var o,a,s,l,u,h,c,d,f,p,m,v=oe._data(e);if(v){for(r.handler&&(l=r,r=l.handler,i=l.selector),r.guid||(r.guid=oe.guid++),(a=v.events)||(a=v.events={}),(h=v.handle)||(h=v.handle=function(e){return typeof oe===Ae||e&&oe.event.triggered===e.type?void 0:oe.event.dispatch.apply(h.elem,arguments)},h.elem=e),t=(t||"").match(be)||[""],s=t.length;s--;)o=Ne.exec(t[s])||[],f=m=o[1],p=(o[2]||"").split(".").sort(),f&&(u=oe.event.special[f]||{},f=(i?u.delegateType:u.bindType)||f,u=oe.event.special[f]||{},c=oe.extend({type:f,origType:m,data:n,handler:r,guid:r.guid,selector:i,needsContext:i&&oe.expr.match.needsContext.test(i),namespace:p.join(".")},l),(d=a[f])||(d=a[f]=[],d.delegateCount=0,u.setup&&u.setup.call(e,n,p,h)!==!1||(e.addEventListener?e.addEventListener(f,h,!1):e.attachEvent&&e.attachEvent("on"+f,h))),u.add&&(u.add.call(e,c),c.handler.guid||(c.handler.guid=r.guid)),i?d.splice(d.delegateCount++,0,c):d.push(c),oe.event.global[f]=!0);e=null}},remove:function(e,t,r,n,i){var o,a,s,l,u,h,c,d,f,p,m,v=oe.hasData(e)&&oe._data(e);if(v&&(h=v.events)){for(t=(t||"").match(be)||[""],u=t.length;u--;)if(s=Ne.exec(t[u])||[],f=m=s[1],p=(s[2]||"").split(".").sort(),f){for(c=oe.event.special[f]||{},f=(n?c.delegateType:c.bindType)||f,d=h[f]||[],s=s[2]&&new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),l=o=d.length;o--;)a=d[o],!i&&m!==a.origType||r&&r.guid!==a.guid||s&&!s.test(a.namespace)||n&&n!==a.selector&&("**"!==n||!a.selector)||(d.splice(o,1),a.selector&&d.delegateCount--,c.remove&&c.remove.call(e,a));l&&!d.length&&(c.teardown&&c.teardown.call(e,p,v.handle)!==!1||oe.removeEvent(e,f,v.handle),delete h[f])}else for(f in h)oe.event.remove(e,f+t[u],r,n,!0);oe.isEmptyObject(h)&&(delete v.handle,oe._removeData(e,"events"))}},trigger:function(t,r,n,i){var o,a,s,l,u,h,c,d=[n||me],f=re.call(t,"type")?t.type:t,p=re.call(t,"namespace")?t.namespace.split("."):[];if(s=h=n=n||me,3!==n.nodeType&&8!==n.nodeType&&!Be.test(f+oe.event.triggered)&&(f.indexOf(".")>=0&&(p=f.split("."),f=p.shift(),p.sort()),a=f.indexOf(":")<0&&"on"+f,t=t[oe.expando]?t:new oe.Event(f,"object"==typeof t&&t),t.isTrigger=i?2:3,t.namespace=p.join("."),t.namespace_re=t.namespace?new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,t.result=void 0,t.target||(t.target=n),r=null==r?[t]:oe.makeArray(r,[t]),u=oe.event.special[f]||{},i||!u.trigger||u.trigger.apply(n,r)!==!1)){if(!i&&!u.noBubble&&!oe.isWindow(n)){for(l=u.delegateType||f,Be.test(l+f)||(s=s.parentNode);s;s=s.parentNode)d.push(s),h=s;h===(n.ownerDocument||me)&&d.push(h.defaultView||h.parentWindow||e)}for(c=0;(s=d[c++])&&!t.isPropagationStopped();)t.type=c>1?l:u.bindType||f,o=(oe._data(s,"events")||{})[t.type]&&oe._data(s,"handle"),o&&o.apply(s,r),o=a&&s[a],o&&o.apply&&oe.acceptData(s)&&(t.result=o.apply(s,r),t.result===!1&&t.preventDefault());if(t.type=f,!i&&!t.isDefaultPrevented()&&(!u._default||u._default.apply(d.pop(),r)===!1)&&oe.acceptData(n)&&a&&n[f]&&!oe.isWindow(n)){h=n[a],h&&(n[a]=null),oe.event.triggered=f;try{n[f]()}catch(e){}oe.event.triggered=void 0,h&&(n[a]=h)}return t.result}},dispatch:function(e){e=oe.event.fix(e);var t,r,n,i,o,a=[],s=Z.call(arguments),l=(oe._data(this,"events")||{})[e.type]||[],u=oe.event.special[e.type]||{};if(s[0]=e,e.delegateTarget=this,!u.preDispatch||u.preDispatch.call(this,e)!==!1){for(a=oe.event.handlers.call(this,e,l),t=0;(i=a[t++])&&!e.isPropagationStopped();)for(e.currentTarget=i.elem,o=0;(n=i.handlers[o++])&&!e.isImmediatePropagationStopped();)(!e.namespace_re||e.namespace_re.test(n.namespace))&&(e.handleObj=n,e.data=n.data,r=((oe.event.special[n.origType]||{}).handle||n.handler).apply(i.elem,s),void 0!==r&&(e.result=r)===!1&&(e.preventDefault(),e.stopPropagation()));return u.postDispatch&&u.postDispatch.call(this,e),e.result}},handlers:function(e,t){var r,n,i,o,a=[],s=t.delegateCount,l=e.target;if(s&&l.nodeType&&(!e.button||"click"!==e.type))for(;l!=this;l=l.parentNode||this)if(1===l.nodeType&&(l.disabled!==!0||"click"!==e.type)){for(i=[],o=0;s>o;o++)n=t[o],r=n.selector+" ",void 0===i[r]&&(i[r]=n.needsContext?oe(r,this).index(l)>=0:oe.find(r,this,null,[l]).length),i[r]&&i.push(n);i.length&&a.push({elem:l,handlers:i})}return s<t.length&&a.push({elem:this,handlers:t.slice(s)}),a},fix:function(e){if(e[oe.expando])return e;var t,r,n,i=e.type,o=e,a=this.fixHooks[i];for(a||(this.fixHooks[i]=a=ke.test(i)?this.mouseHooks:Fe.test(i)?this.keyHooks:{}),n=a.props?this.props.concat(a.props):this.props,e=new oe.Event(o),t=n.length;t--;)r=n[t],e[r]=o[r];return e.target||(e.target=o.srcElement||me),3===e.target.nodeType&&(e.target=e.target.parentNode),e.metaKey=!!e.metaKey,a.filter?a.filter(e,o):e},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){return null==e.which&&(e.which=null!=t.charCode?t.charCode:t.keyCode),e}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,t){var r,n,i,o=t.button,a=t.fromElement;return null==e.pageX&&null!=t.clientX&&(n=e.target.ownerDocument||me,i=n.documentElement,r=n.body,e.pageX=t.clientX+(i&&i.scrollLeft||r&&r.scrollLeft||0)-(i&&i.clientLeft||r&&r.clientLeft||0),e.pageY=t.clientY+(i&&i.scrollTop||r&&r.scrollTop||0)-(i&&i.clientTop||r&&r.clientTop||0)),!e.relatedTarget&&a&&(e.relatedTarget=a===e.target?t.toElement:a),e.which||void 0===o||(e.which=1&o?1:2&o?3:4&o?2:0),e}},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==m()&&this.focus)try{return this.focus(),!1}catch(e){}},delegateType:"focusin"},blur:{trigger:function(){return this===m()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return oe.nodeName(this,"input")&&"checkbox"===this.type&&this.click?(this.click(),!1):void 0},_default:function(e){return oe.nodeName(e.target,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}},simulate:function(e,t,r,n){var i=oe.extend(new oe.Event,r,{type:e,isSimulated:!0,originalEvent:{}});n?oe.event.trigger(i,null,t):oe.event.dispatch.call(t,i),i.isDefaultPrevented()&&r.preventDefault()}},oe.removeEvent=me.removeEventListener?function(e,t,r){e.removeEventListener&&e.removeEventListener(t,r,!1)}:function(e,t,r){var n="on"+t;e.detachEvent&&(typeof e[n]===Ae&&(e[n]=null),e.detachEvent(n,r))},oe.Event=function(e,t){return this instanceof oe.Event?(e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&e.returnValue===!1?f:p):this.type=e,t&&oe.extend(this,t),this.timeStamp=e&&e.timeStamp||oe.now(),void(this[oe.expando]=!0)):new oe.Event(e,t)},oe.Event.prototype={isDefaultPrevented:p,isPropagationStopped:p,isImmediatePropagationStopped:p,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=f,e&&(e.preventDefault?e.preventDefault():e.returnValue=!1)},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=f,e&&(e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0)},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=f,e&&e.stopImmediatePropagation&&e.stopImmediatePropagation(),this.stopPropagation()}},oe.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,t){oe.event.special[e]={delegateType:t,bindType:t,handle:function(e){var r,n=this,i=e.relatedTarget,o=e.handleObj;return(!i||i!==n&&!oe.contains(n,i))&&(e.type=o.origType,r=o.handler.apply(this,arguments),e.type=t),r}}}),ne.submitBubbles||(oe.event.special.submit={setup:function(){return!oe.nodeName(this,"form")&&void oe.event.add(this,"click._submit keypress._submit",function(e){var t=e.target,r=oe.nodeName(t,"input")||oe.nodeName(t,"button")?t.form:void 0;r&&!oe._data(r,"submitBubbles")&&(oe.event.add(r,"submit._submit",function(e){e._submit_bubble=!0}),oe._data(r,"submitBubbles",!0))})},postDispatch:function(e){e._submit_bubble&&(delete e._submit_bubble,this.parentNode&&!e.isTrigger&&oe.event.simulate("submit",this.parentNode,e,!0))},teardown:function(){return!oe.nodeName(this,"form")&&void oe.event.remove(this,"._submit")}}),ne.changeBubbles||(oe.event.special.change={setup:function(){return _e.test(this.nodeName)?(("checkbox"===this.type||"radio"===this.type)&&(oe.event.add(this,"propertychange._change",function(e){"checked"===e.originalEvent.propertyName&&(this._just_changed=!0)}),oe.event.add(this,"click._change",function(e){this._just_changed&&!e.isTrigger&&(this._just_changed=!1),oe.event.simulate("change",this,e,!0)})),!1):void oe.event.add(this,"beforeactivate._change",function(e){var t=e.target;_e.test(t.nodeName)&&!oe._data(t,"changeBubbles")&&(oe.event.add(t,"change._change",function(e){!this.parentNode||e.isSimulated||e.isTrigger||oe.event.simulate("change",this.parentNode,e,!0)}),oe._data(t,"changeBubbles",!0))})},handle:function(e){var t=e.target;return this!==t||e.isSimulated||e.isTrigger||"radio"!==t.type&&"checkbox"!==t.type?e.handleObj.handler.apply(this,arguments):void 0},teardown:function(){return oe.event.remove(this,"._change"),!_e.test(this.nodeName)}}),ne.focusinBubbles||oe.each({focus:"focusin",blur:"focusout"},function(e,t){var r=function(e){oe.event.simulate(t,e.target,oe.event.fix(e),!0)};oe.event.special[t]={setup:function(){var n=this.ownerDocument||this,i=oe._data(n,t);i||n.addEventListener(e,r,!0),oe._data(n,t,(i||0)+1)},teardown:function(){var n=this.ownerDocument||this,i=oe._data(n,t)-1;i?oe._data(n,t,i):(n.removeEventListener(e,r,!0),oe._removeData(n,t))}}}),oe.fn.extend({on:function(e,t,r,n,i){var o,a;if("object"==typeof e){"string"!=typeof t&&(r=r||t,t=void 0);for(o in e)this.on(o,t,r,e[o],i);return this}if(null==r&&null==n?(n=t,r=t=void 0):null==n&&("string"==typeof t?(n=r,r=void 0):(n=r,r=t,t=void 0)),n===!1)n=p;else if(!n)return this;return 1===i&&(a=n,n=function(e){return oe().off(e),a.apply(this,arguments)},n.guid=a.guid||(a.guid=oe.guid++)),this.each(function(){oe.event.add(this,e,n,r,t)})},one:function(e,t,r,n){return this.on(e,t,r,n,1)},off:function(e,t,r){var n,i;if(e&&e.preventDefault&&e.handleObj)return n=e.handleObj,oe(e.delegateTarget).off(n.namespace?n.origType+"."+n.namespace:n.origType,n.selector,n.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return(t===!1||"function"==typeof t)&&(r=t,t=void 0),r===!1&&(r=p),this.each(function(){oe.event.remove(this,e,r,t)})},trigger:function(e,t){return this.each(function(){oe.event.trigger(e,t,this)})},triggerHandler:function(e,t){var r=this[0];return r?oe.event.trigger(e,t,r,!0):void 0}});var De="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",Oe=/ jQuery\d+="(?:null|\d+)"/g,Ue=new RegExp("<(?:"+De+")[\\s/>]","i"),je=/^\s+/,qe=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,Ge=/<([\w:]+)/,Ve=/<tbody/i,ze=/<|&#?\w+;/,He=/<(?:script|style|link)/i,Xe=/checked\s*(?:[^=]|=\s*.checked.)/i,We=/^$|\/(?:java|ecma)script/i,Ye=/^true\/(.*)/,Qe=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,Ze={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:ne.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]},Ke=v(me),Je=Ke.appendChild(me.createElement("div"));Ze.optgroup=Ze.option,Ze.tbody=Ze.tfoot=Ze.colgroup=Ze.caption=Ze.thead,Ze.th=Ze.td,oe.extend({clone:function(e,t,r){var n,i,o,a,s,l=oe.contains(e.ownerDocument,e);if(ne.html5Clone||oe.isXMLDoc(e)||!Ue.test("<"+e.nodeName+">")?o=e.cloneNode(!0):(Je.innerHTML=e.outerHTML,Je.removeChild(o=Je.firstChild)),!(ne.noCloneEvent&&ne.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||oe.isXMLDoc(e)))for(n=g(o),s=g(e),a=0;null!=(i=s[a]);++a)n[a]&&A(i,n[a]);if(t)if(r)for(s=s||g(e),n=n||g(o),a=0;null!=(i=s[a]);a++)S(i,n[a]);else S(e,o);return n=g(o,"script"),n.length>0&&w(n,!l&&g(e,"script")),n=s=i=null,o},buildFragment:function(e,t,r,n){for(var i,o,a,s,l,u,h,c=e.length,d=v(t),f=[],p=0;c>p;p++)if(o=e[p],o||0===o)if("object"===oe.type(o))oe.merge(f,o.nodeType?[o]:o);else if(ze.test(o)){for(s=s||d.appendChild(t.createElement("div")),l=(Ge.exec(o)||["",""])[1].toLowerCase(),h=Ze[l]||Ze._default,s.innerHTML=h[1]+o.replace(qe,"<$1></$2>")+h[2],i=h[0];i--;)s=s.lastChild;if(!ne.leadingWhitespace&&je.test(o)&&f.push(t.createTextNode(je.exec(o)[0])),!ne.tbody)for(o="table"!==l||Ve.test(o)?"<table>"!==h[1]||Ve.test(o)?0:s:s.firstChild,i=o&&o.childNodes.length;i--;)oe.nodeName(u=o.childNodes[i],"tbody")&&!u.childNodes.length&&o.removeChild(u);for(oe.merge(f,s.childNodes),s.textContent="";s.firstChild;)s.removeChild(s.firstChild);s=d.lastChild}else f.push(t.createTextNode(o));for(s&&d.removeChild(s),ne.appendChecked||oe.grep(g(f,"input"),y),p=0;o=f[p++];)if((!n||-1===oe.inArray(o,n))&&(a=oe.contains(o.ownerDocument,o),s=g(d.appendChild(o),"script"),a&&w(s),r))for(i=0;o=s[i++];)We.test(o.type||"")&&r.push(o);return s=null,d},cleanData:function(e,t){for(var r,n,i,o,a=0,s=oe.expando,l=oe.cache,u=ne.deleteExpando,h=oe.event.special;null!=(r=e[a]);a++)if((t||oe.acceptData(r))&&(i=r[s],o=i&&l[i])){if(o.events)for(n in o.events)h[n]?oe.event.remove(r,n):oe.removeEvent(r,n,o.handle);l[i]&&(delete l[i],u?delete r[s]:typeof r.removeAttribute!==Ae?r.removeAttribute(s):r[s]=null,Q.push(i))}}}),oe.fn.extend({text:function(e){return Le(this,function(e){return void 0===e?oe.text(this):this.empty().append((this[0]&&this[0].ownerDocument||me).createTextNode(e))},null,e,arguments.length)},append:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=x(this,e);t.appendChild(e)}})},prepend:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=x(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},remove:function(e,t){for(var r,n=e?oe.filter(e,this):this,i=0;null!=(r=n[i]);i++)t||1!==r.nodeType||oe.cleanData(g(r)),r.parentNode&&(t&&oe.contains(r.ownerDocument,r)&&w(g(r,"script")),r.parentNode.removeChild(r));return this},empty:function(){for(var e,t=0;null!=(e=this[t]);t++){for(1===e.nodeType&&oe.cleanData(g(e,!1));e.firstChild;)e.removeChild(e.firstChild);e.options&&oe.nodeName(e,"select")&&(e.options.length=0)}return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return oe.clone(this,e,t)})},html:function(e){return Le(this,function(e){var t=this[0]||{},r=0,n=this.length;if(void 0===e)return 1===t.nodeType?t.innerHTML.replace(Oe,""):void 0;if(!("string"!=typeof e||He.test(e)||!ne.htmlSerialize&&Ue.test(e)||!ne.leadingWhitespace&&je.test(e)||Ze[(Ge.exec(e)||["",""])[1].toLowerCase()])){e=e.replace(qe,"<$1></$2>");try{for(;n>r;r++)t=this[r]||{},1===t.nodeType&&(oe.cleanData(g(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var e=arguments[0];return this.domManip(arguments,function(t){e=this.parentNode,oe.cleanData(g(this)),e&&e.replaceChild(t,this)}),e&&(e.length||e.nodeType)?this:this.remove()},detach:function(e){return this.remove(e,!0)},domManip:function(e,t){e=K.apply([],e);var r,n,i,o,a,s,l=0,u=this.length,h=this,c=u-1,d=e[0],f=oe.isFunction(d);if(f||u>1&&"string"==typeof d&&!ne.checkClone&&Xe.test(d))return this.each(function(r){var n=h.eq(r);f&&(e[0]=d.call(this,r,n.html())),n.domManip(e,t)});if(u&&(s=oe.buildFragment(e,this[0].ownerDocument,!1,this),r=s.firstChild,1===s.childNodes.length&&(s=r),r)){for(o=oe.map(g(s,"script"),b),i=o.length;u>l;l++)n=s,l!==c&&(n=oe.clone(n,!0,!0),i&&oe.merge(o,g(n,"script"))),t.call(this[l],n,l);if(i)for(a=o[o.length-1].ownerDocument,oe.map(o,T),l=0;i>l;l++)n=o[l],We.test(n.type||"")&&!oe._data(n,"globalEval")&&oe.contains(a,n)&&(n.src?oe._evalUrl&&oe._evalUrl(n.src):oe.globalEval((n.text||n.textContent||n.innerHTML||"").replace(Qe,"")));s=r=null}return this}}),oe.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){oe.fn[e]=function(e){for(var r,n=0,i=[],o=oe(e),a=o.length-1;a>=n;n++)r=n===a?this:this.clone(!0),oe(o[n])[t](r),J.apply(i,r.get());return this.pushStack(i)}});var $e,et={};!function(){var e;ne.shrinkWrapBlocks=function(){if(null!=e)return e;e=!1;var t,r,n;return r=me.getElementsByTagName("body")[0],r&&r.style?(t=me.createElement("div"),n=me.createElement("div"),n.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",r.appendChild(n).appendChild(t),typeof t.style.zoom!==Ae&&(t.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:1px;width:1px;zoom:1",t.appendChild(me.createElement("div")).style.width="5px",e=3!==t.offsetWidth),r.removeChild(n),e):void 0}}();var tt,rt,nt=/^margin/,it=new RegExp("^("+Ee+")(?!px)[a-z%]+$","i"),ot=/^(top|right|bottom|left)$/;e.getComputedStyle?(tt=function(e){return e.ownerDocument.defaultView.getComputedStyle(e,null)},rt=function(e,t,r){var n,i,o,a,s=e.style;return r=r||tt(e),a=r?r.getPropertyValue(t)||r[t]:void 0,r&&(""!==a||oe.contains(e.ownerDocument,e)||(a=oe.style(e,t)),it.test(a)&&nt.test(t)&&(n=s.width,i=s.minWidth,o=s.maxWidth,s.minWidth=s.maxWidth=s.width=a,a=r.width,s.width=n,s.minWidth=i,s.maxWidth=o)),void 0===a?a:a+""}):me.documentElement.currentStyle&&(tt=function(e){return e.currentStyle},rt=function(e,t,r){var n,i,o,a,s=e.style;return r=r||tt(e),a=r?r[t]:void 0,null==a&&s&&s[t]&&(a=s[t]),it.test(a)&&!ot.test(t)&&(n=s.left,i=e.runtimeStyle,o=i&&i.left,o&&(i.left=e.currentStyle.left),s.left="fontSize"===t?"1em":a,a=s.pixelLeft+"px",s.left=n,o&&(i.left=o)),void 0===a?a:a+""||"auto"}),!function(){function t(){var t,r,n,i;r=me.getElementsByTagName("body")[0],r&&r.style&&(t=me.createElement("div"),n=me.createElement("div"),n.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",r.appendChild(n).appendChild(t),t.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;display:block;margin-top:1%;top:1%;border:1px;padding:1px;width:4px;position:absolute",o=a=!1,l=!0,e.getComputedStyle&&(o="1%"!==(e.getComputedStyle(t,null)||{}).top,a="4px"===(e.getComputedStyle(t,null)||{width:"4px"}).width,i=t.appendChild(me.createElement("div")),i.style.cssText=t.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",i.style.marginRight=i.style.width="0",t.style.width="1px",l=!parseFloat((e.getComputedStyle(i,null)||{}).marginRight)),t.innerHTML="<table><tr><td></td><td>t</td></tr></table>",i=t.getElementsByTagName("td"),i[0].style.cssText="margin:0;border:0;padding:0;display:none",s=0===i[0].offsetHeight,s&&(i[0].style.display="",i[1].style.display="none",s=0===i[0].offsetHeight),r.removeChild(n))}var r,n,i,o,a,s,l;r=me.createElement("div"),r.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",i=r.getElementsByTagName("a")[0],(n=i&&i.style)&&(n.cssText="float:left;opacity:.5",ne.opacity="0.5"===n.opacity,ne.cssFloat=!!n.cssFloat,r.style.backgroundClip="content-box",r.cloneNode(!0).style.backgroundClip="",ne.clearCloneStyle="content-box"===r.style.backgroundClip,ne.boxSizing=""===n.boxSizing||""===n.MozBoxSizing||""===n.WebkitBoxSizing,oe.extend(ne,{reliableHiddenOffsets:function(){return null==s&&t(),s},boxSizingReliable:function(){return null==a&&t(),a},pixelPosition:function(){return null==o&&t(),o},reliableMarginRight:function(){return null==l&&t(),l}}))}(),oe.swap=function(e,t,r,n){var i,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];i=r.apply(e,n||[]);for(o in t)e.style[o]=a[o];return i};var at=/alpha\([^)]*\)/i,st=/opacity\s*=\s*([^)]*)/,lt=/^(none|table(?!-c[ea]).+)/,ut=new RegExp("^("+Ee+")(.*)$","i"),ht=new RegExp("^([+-])=("+Ee+")","i"),ct={position:"absolute",visibility:"hidden",display:"block"},dt={letterSpacing:"0",fontWeight:"400"},ft=["Webkit","O","Moz","ms"];oe.extend({cssHooks:{opacity:{get:function(e,t){if(t){var r=rt(e,"opacity");return""===r?"1":r}}}},cssNumber:{columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{float:ne.cssFloat?"cssFloat":"styleFloat"},style:function(e,t,r,n){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=oe.camelCase(t),l=e.style;if(t=oe.cssProps[s]||(oe.cssProps[s]=P(l,s)),a=oe.cssHooks[t]||oe.cssHooks[s],void 0===r)return a&&"get"in a&&void 0!==(i=a.get(e,!1,n))?i:l[t];if(o=typeof r,"string"===o&&(i=ht.exec(r))&&(r=(i[1]+1)*i[2]+parseFloat(oe.css(e,t)),o="number"),null!=r&&r===r&&("number"!==o||oe.cssNumber[s]||(r+="px"),ne.clearCloneStyle||""!==r||0!==t.indexOf("background")||(l[t]="inherit"),!(a&&"set"in a&&void 0===(r=a.set(e,r,n)))))try{l[t]=r}catch(e){}}},css:function(e,t,r,n){var i,o,a,s=oe.camelCase(t);return t=oe.cssProps[s]||(oe.cssProps[s]=P(e.style,s)),a=oe.cssHooks[t]||oe.cssHooks[s],a&&"get"in a&&(o=a.get(e,!0,r)),void 0===o&&(o=rt(e,t,n)),"normal"===o&&t in dt&&(o=dt[t]),""===r||r?(i=parseFloat(o),r===!0||oe.isNumeric(i)?i||0:o):o}}),oe.each(["height","width"],function(e,t){oe.cssHooks[t]={get:function(e,r,n){return r?lt.test(oe.css(e,"display"))&&0===e.offsetWidth?oe.swap(e,ct,function(){return _(e,t,n)}):_(e,t,n):void 0},set:function(e,r,n){var i=n&&tt(e);return L(e,r,n?I(e,t,n,ne.boxSizing&&"border-box"===oe.css(e,"boxSizing",!1,i),i):0)}}}),ne.opacity||(oe.cssHooks.opacity={get:function(e,t){return st.test((t&&e.currentStyle?e.currentStyle.filter:e.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":t?"1":""},set:function(e,t){var r=e.style,n=e.currentStyle,i=oe.isNumeric(t)?"alpha(opacity="+100*t+")":"",o=n&&n.filter||r.filter||"";r.zoom=1,(t>=1||""===t)&&""===oe.trim(o.replace(at,""))&&r.removeAttribute&&(r.removeAttribute("filter"),""===t||n&&!n.filter)||(r.filter=at.test(o)?o.replace(at,i):o+" "+i)}}),oe.cssHooks.marginRight=E(ne.reliableMarginRight,function(e,t){return t?oe.swap(e,{display:"inline-block"},rt,[e,"marginRight"]):void 0}),oe.each({margin:"",padding:"",border:"Width"},function(e,t){oe.cssHooks[e+t]={expand:function(r){for(var n=0,i={},o="string"==typeof r?r.split(" "):[r];4>n;n++)i[e+Pe[n]+t]=o[n]||o[n-2]||o[0];return i}},nt.test(e)||(oe.cssHooks[e+t].set=L)}),oe.fn.extend({css:function(e,t){return Le(this,function(e,t,r){var n,i,o={},a=0;if(oe.isArray(t)){for(n=tt(e),i=t.length;i>a;a++)o[t[a]]=oe.css(e,t[a],!1,n);return o}return void 0!==r?oe.style(e,t,r):oe.css(e,t)},e,t,arguments.length>1)},show:function(){return R(this,!0)},hide:function(){return R(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){Re(this)?oe(this).show():oe(this).hide()})}}),oe.Tween=F,F.prototype={constructor:F,init:function(e,t,r,n,i,o){this.elem=e,this.prop=r,this.easing=i||"swing",this.options=t,this.start=this.now=this.cur(),this.end=n,this.unit=o||(oe.cssNumber[r]?"":"px")},cur:function(){var e=F.propHooks[this.prop];return e&&e.get?e.get(this):F.propHooks._default.get(this)},run:function(e){var t,r=F.propHooks[this.prop];return this.pos=t=this.options.duration?oe.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),r&&r.set?r.set(this):F.propHooks._default.set(this),this}},F.prototype.init.prototype=F.prototype,F.propHooks={_default:{get:function(e){var t;return null==e.elem[e.prop]||e.elem.style&&null!=e.elem.style[e.prop]?(t=oe.css(e.elem,e.prop,""),t&&"auto"!==t?t:0):e.elem[e.prop]},set:function(e){oe.fx.step[e.prop]?oe.fx.step[e.prop](e):e.elem.style&&(null!=e.elem.style[oe.cssProps[e.prop]]||oe.cssHooks[e.prop])?oe.style(e.elem,e.prop,e.now+e.unit):e.elem[e.prop]=e.now}}},F.propHooks.scrollTop=F.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},oe.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2}},oe.fx=F.prototype.init,oe.fx.step={};var pt,mt,vt=/^(?:toggle|show|hide)$/,gt=new RegExp("^(?:([+-])=|)("+Ee+")([a-z%]*)$","i"),yt=/queueHooks$/,xt=[D],bt={"*":[function(e,t){var r=this.createTween(e,t),n=r.cur(),i=gt.exec(t),o=i&&i[3]||(oe.cssNumber[e]?"":"px"),a=(oe.cssNumber[e]||"px"!==o&&+n)&&gt.exec(oe.css(r.elem,e)),s=1,l=20;if(a&&a[3]!==o){o=o||a[3],i=i||[],a=+n||1;do s=s||".5",a/=s,oe.style(r.elem,e,a+o);while(s!==(s=r.cur()/n)&&1!==s&&--l)}return i&&(a=r.start=+a||+n||0,r.unit=o,r.end=i[1]?a+(i[1]+1)*i[2]:+i[2]),r}]};oe.Animation=oe.extend(U,{tweener:function(e,t){oe.isFunction(e)?(t=e,e=["*"]):e=e.split(" ");for(var r,n=0,i=e.length;i>n;n++)r=e[n],bt[r]=bt[r]||[],bt[r].unshift(t)},prefilter:function(e,t){t?xt.unshift(e):xt.push(e)}}),oe.speed=function(e,t,r){var n=e&&"object"==typeof e?oe.extend({},e):{complete:r||!r&&t||oe.isFunction(e)&&e,duration:e,easing:r&&t||t&&!oe.isFunction(t)&&t};return n.duration=oe.fx.off?0:"number"==typeof n.duration?n.duration:n.duration in oe.fx.speeds?oe.fx.speeds[n.duration]:oe.fx.speeds._default,(null==n.queue||n.queue===!0)&&(n.queue="fx"),n.old=n.complete,n.complete=function(){oe.isFunction(n.old)&&n.old.call(this),n.queue&&oe.dequeue(this,n.queue)},n},oe.fn.extend({fadeTo:function(e,t,r,n){return this.filter(Re).css("opacity",0).show().end().animate({opacity:t},e,r,n)},animate:function(e,t,r,n){var i=oe.isEmptyObject(e),o=oe.speed(t,r,n),a=function(){var t=U(this,oe.extend({},e),o);(i||oe._data(this,"finish"))&&t.stop(!0)};return a.finish=a,i||o.queue===!1?this.each(a):this.queue(o.queue,a)},stop:function(e,t,r){var n=function(e){var t=e.stop;delete e.stop,t(r)};return"string"!=typeof e&&(r=t,t=e,e=void 0),t&&e!==!1&&this.queue(e||"fx",[]),this.each(function(){var t=!0,i=null!=e&&e+"queueHooks",o=oe.timers,a=oe._data(this);if(i)a[i]&&a[i].stop&&n(a[i]);else for(i in a)a[i]&&a[i].stop&&yt.test(i)&&n(a[i]);for(i=o.length;i--;)o[i].elem!==this||null!=e&&o[i].queue!==e||(o[i].anim.stop(r),t=!1,o.splice(i,1));(t||!r)&&oe.dequeue(this,e)})},finish:function(e){return e!==!1&&(e=e||"fx"),this.each(function(){var t,r=oe._data(this),n=r[e+"queue"],i=r[e+"queueHooks"],o=oe.timers,a=n?n.length:0;for(r.finish=!0,oe.queue(this,e,[]),i&&i.stop&&i.stop.call(this,!0),t=o.length;t--;)o[t].elem===this&&o[t].queue===e&&(o[t].anim.stop(!0),o.splice(t,1));for(t=0;a>t;t++)n[t]&&n[t].finish&&n[t].finish.call(this);delete r.finish})}}),oe.each(["toggle","show","hide"],function(e,t){var r=oe.fn[t];oe.fn[t]=function(e,n,i){return null==e||"boolean"==typeof e?r.apply(this,arguments):this.animate(B(t,!0),e,n,i)}}),oe.each({slideDown:B("show"),slideUp:B("hide"),slideToggle:B("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){oe.fn[e]=function(e,r,n){return this.animate(t,e,r,n)}}),oe.timers=[],oe.fx.tick=function(){var e,t=oe.timers,r=0;for(pt=oe.now();r<t.length;r++)e=t[r],e()||t[r]!==e||t.splice(r--,1);t.length||oe.fx.stop(),pt=void 0},oe.fx.timer=function(e){oe.timers.push(e),e()?oe.fx.start():oe.timers.pop()},oe.fx.interval=13,oe.fx.start=function(){mt||(mt=setInterval(oe.fx.tick,oe.fx.interval))},oe.fx.stop=function(){clearInterval(mt),mt=null},oe.fx.speeds={slow:600,fast:200,_default:400},oe.fn.delay=function(e,t){return e=oe.fx?oe.fx.speeds[e]||e:e,t=t||"fx",this.queue(t,function(t,r){var n=setTimeout(t,e);r.stop=function(){clearTimeout(n)}})},function(){var e,t,r,n,i;t=me.createElement("div"),t.setAttribute("className","t"),t.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",n=t.getElementsByTagName("a")[0],r=me.createElement("select"),i=r.appendChild(me.createElement("option")),e=t.getElementsByTagName("input")[0],n.style.cssText="top:1px",ne.getSetAttribute="t"!==t.className,ne.style=/top/.test(n.getAttribute("style")),ne.hrefNormalized="/a"===n.getAttribute("href"),ne.checkOn=!!e.value,ne.optSelected=i.selected,ne.enctype=!!me.createElement("form").enctype,r.disabled=!0,ne.optDisabled=!i.disabled,e=me.createElement("input"),e.setAttribute("value",""),ne.input=""===e.getAttribute("value"),e.value="t",e.setAttribute("type","radio"),ne.radioValue="t"===e.value}();var Tt=/\r/g;oe.fn.extend({val:function(e){var t,r,n,i=this[0];return arguments.length?(n=oe.isFunction(e),this.each(function(r){var i;1===this.nodeType&&(i=n?e.call(this,r,oe(this).val()):e,null==i?i="":"number"==typeof i?i+="":oe.isArray(i)&&(i=oe.map(i,function(e){return null==e?"":e+""})),t=oe.valHooks[this.type]||oe.valHooks[this.nodeName.toLowerCase()],t&&"set"in t&&void 0!==t.set(this,i,"value")||(this.value=i))})):i?(t=oe.valHooks[i.type]||oe.valHooks[i.nodeName.toLowerCase()],t&&"get"in t&&void 0!==(r=t.get(i,"value"))?r:(r=i.value,"string"==typeof r?r.replace(Tt,""):null==r?"":r)):void 0}}),oe.extend({valHooks:{option:{get:function(e){var t=oe.find.attr(e,"value");return null!=t?t:oe.trim(oe.text(e))}},select:{get:function(e){for(var t,r,n=e.options,i=e.selectedIndex,o="select-one"===e.type||0>i,a=o?null:[],s=o?i+1:n.length,l=0>i?s:o?i:0;s>l;l++)if(r=n[l],!(!r.selected&&l!==i||(ne.optDisabled?r.disabled:null!==r.getAttribute("disabled"))||r.parentNode.disabled&&oe.nodeName(r.parentNode,"optgroup"))){if(t=oe(r).val(),o)return t;a.push(t)}return a},set:function(e,t){for(var r,n,i=e.options,o=oe.makeArray(t),a=i.length;a--;)if(n=i[a],oe.inArray(oe.valHooks.option.get(n),o)>=0)try{n.selected=r=!0}catch(e){n.scrollHeight}else n.selected=!1;return r||(e.selectedIndex=-1),i}}}}),oe.each(["radio","checkbox"],function(){oe.valHooks[this]={set:function(e,t){return oe.isArray(t)?e.checked=oe.inArray(oe(e).val(),t)>=0:void 0}},ne.checkOn||(oe.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var wt,St,At=oe.expr.attrHandle,Mt=/^(?:checked|selected)$/i,Ct=ne.getSetAttribute,Et=ne.input;oe.fn.extend({attr:function(e,t){return Le(this,oe.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){oe.removeAttr(this,e)})}}),oe.extend({attr:function(e,t,r){var n,i,o=e.nodeType;if(e&&3!==o&&8!==o&&2!==o)return typeof e.getAttribute===Ae?oe.prop(e,t,r):(1===o&&oe.isXMLDoc(e)||(t=t.toLowerCase(),n=oe.attrHooks[t]||(oe.expr.match.bool.test(t)?St:wt)),void 0===r?n&&"get"in n&&null!==(i=n.get(e,t))?i:(i=oe.find.attr(e,t),null==i?void 0:i):null!==r?n&&"set"in n&&void 0!==(i=n.set(e,r,t))?i:(e.setAttribute(t,r+""),r):void oe.removeAttr(e,t))},removeAttr:function(e,t){
var r,n,i=0,o=t&&t.match(be);if(o&&1===e.nodeType)for(;r=o[i++];)n=oe.propFix[r]||r,oe.expr.match.bool.test(r)?Et&&Ct||!Mt.test(r)?e[n]=!1:e[oe.camelCase("default-"+r)]=e[n]=!1:oe.attr(e,r,""),e.removeAttribute(Ct?r:n)},attrHooks:{type:{set:function(e,t){if(!ne.radioValue&&"radio"===t&&oe.nodeName(e,"input")){var r=e.value;return e.setAttribute("type",t),r&&(e.value=r),t}}}}}),St={set:function(e,t,r){return t===!1?oe.removeAttr(e,r):Et&&Ct||!Mt.test(r)?e.setAttribute(!Ct&&oe.propFix[r]||r,r):e[oe.camelCase("default-"+r)]=e[r]=!0,r}},oe.each(oe.expr.match.bool.source.match(/\w+/g),function(e,t){var r=At[t]||oe.find.attr;At[t]=Et&&Ct||!Mt.test(t)?function(e,t,n){var i,o;return n||(o=At[t],At[t]=i,i=null!=r(e,t,n)?t.toLowerCase():null,At[t]=o),i}:function(e,t,r){return r?void 0:e[oe.camelCase("default-"+t)]?t.toLowerCase():null}}),Et&&Ct||(oe.attrHooks.value={set:function(e,t,r){return oe.nodeName(e,"input")?void(e.defaultValue=t):wt&&wt.set(e,t,r)}}),Ct||(wt={set:function(e,t,r){var n=e.getAttributeNode(r);return n||e.setAttributeNode(n=e.ownerDocument.createAttribute(r)),n.value=t+="","value"===r||t===e.getAttribute(r)?t:void 0}},At.id=At.name=At.coords=function(e,t,r){var n;return r?void 0:(n=e.getAttributeNode(t))&&""!==n.value?n.value:null},oe.valHooks.button={get:function(e,t){var r=e.getAttributeNode(t);return r&&r.specified?r.value:void 0},set:wt.set},oe.attrHooks.contenteditable={set:function(e,t,r){wt.set(e,""!==t&&t,r)}},oe.each(["width","height"],function(e,t){oe.attrHooks[t]={set:function(e,r){return""===r?(e.setAttribute(t,"auto"),r):void 0}}})),ne.style||(oe.attrHooks.style={get:function(e){return e.style.cssText||void 0},set:function(e,t){return e.style.cssText=t+""}});var Pt=/^(?:input|select|textarea|button|object)$/i,Rt=/^(?:a|area)$/i;oe.fn.extend({prop:function(e,t){return Le(this,oe.prop,e,t,arguments.length>1)},removeProp:function(e){return e=oe.propFix[e]||e,this.each(function(){try{this[e]=void 0,delete this[e]}catch(e){}})}}),oe.extend({propFix:{for:"htmlFor",class:"className"},prop:function(e,t,r){var n,i,o,a=e.nodeType;if(e&&3!==a&&8!==a&&2!==a)return o=1!==a||!oe.isXMLDoc(e),o&&(t=oe.propFix[t]||t,i=oe.propHooks[t]),void 0!==r?i&&"set"in i&&void 0!==(n=i.set(e,r,t))?n:e[t]=r:i&&"get"in i&&null!==(n=i.get(e,t))?n:e[t]},propHooks:{tabIndex:{get:function(e){var t=oe.find.attr(e,"tabindex");return t?parseInt(t,10):Pt.test(e.nodeName)||Rt.test(e.nodeName)&&e.href?0:-1}}}}),ne.hrefNormalized||oe.each(["href","src"],function(e,t){oe.propHooks[t]={get:function(e){return e.getAttribute(t,4)}}}),ne.optSelected||(oe.propHooks.selected={get:function(e){var t=e.parentNode;return t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex),null}}),oe.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){oe.propFix[this.toLowerCase()]=this}),ne.enctype||(oe.propFix.enctype="encoding");var Lt=/[\t\r\n\f]/g;oe.fn.extend({addClass:function(e){var t,r,n,i,o,a,s=0,l=this.length,u="string"==typeof e&&e;if(oe.isFunction(e))return this.each(function(t){oe(this).addClass(e.call(this,t,this.className))});if(u)for(t=(e||"").match(be)||[];l>s;s++)if(r=this[s],n=1===r.nodeType&&(r.className?(" "+r.className+" ").replace(Lt," "):" ")){for(o=0;i=t[o++];)n.indexOf(" "+i+" ")<0&&(n+=i+" ");a=oe.trim(n),r.className!==a&&(r.className=a)}return this},removeClass:function(e){var t,r,n,i,o,a,s=0,l=this.length,u=0===arguments.length||"string"==typeof e&&e;if(oe.isFunction(e))return this.each(function(t){oe(this).removeClass(e.call(this,t,this.className))});if(u)for(t=(e||"").match(be)||[];l>s;s++)if(r=this[s],n=1===r.nodeType&&(r.className?(" "+r.className+" ").replace(Lt," "):"")){for(o=0;i=t[o++];)for(;n.indexOf(" "+i+" ")>=0;)n=n.replace(" "+i+" "," ");a=e?oe.trim(n):"",r.className!==a&&(r.className=a)}return this},toggleClass:function(e,t){var r=typeof e;return"boolean"==typeof t&&"string"===r?t?this.addClass(e):this.removeClass(e):this.each(oe.isFunction(e)?function(r){oe(this).toggleClass(e.call(this,r,this.className,t),t)}:function(){if("string"===r)for(var t,n=0,i=oe(this),o=e.match(be)||[];t=o[n++];)i.hasClass(t)?i.removeClass(t):i.addClass(t);else(r===Ae||"boolean"===r)&&(this.className&&oe._data(this,"__className__",this.className),this.className=this.className||e===!1?"":oe._data(this,"__className__")||"")})},hasClass:function(e){for(var t=" "+e+" ",r=0,n=this.length;n>r;r++)if(1===this[r].nodeType&&(" "+this[r].className+" ").replace(Lt," ").indexOf(t)>=0)return!0;return!1}}),oe.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,t){oe.fn[t]=function(e,r){return arguments.length>0?this.on(t,null,e,r):this.trigger(t)}}),oe.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)},bind:function(e,t,r){return this.on(e,null,t,r)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,r,n){return this.on(t,e,r,n)},undelegate:function(e,t,r){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",r)}});var It=oe.now(),_t=/\?/,Ft=/(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g;oe.parseJSON=function(t){if(e.JSON&&e.JSON.parse)return e.JSON.parse(t+"");var r,n=null,i=oe.trim(t+"");return i&&!oe.trim(i.replace(Ft,function(e,t,i,o){return r&&t&&(n=0),0===n?e:(r=i||t,n+=!o-!i,"")}))?Function("return "+i)():oe.error("Invalid JSON: "+t)},oe.parseXML=function(t){var r,n;if(!t||"string"!=typeof t)return null;try{e.DOMParser?(n=new DOMParser,r=n.parseFromString(t,"text/xml")):(r=new ActiveXObject("Microsoft.XMLDOM"),r.async="false",r.loadXML(t))}catch(e){r=void 0}return r&&r.documentElement&&!r.getElementsByTagName("parsererror").length||oe.error("Invalid XML: "+t),r};var kt,Bt,Nt=/#.*$/,Dt=/([?&])_=[^&]*/,Ot=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,Ut=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,jt=/^(?:GET|HEAD)$/,qt=/^\/\//,Gt=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,Vt={},zt={},Ht="*/".concat("*");try{Bt=location.href}catch(e){Bt=me.createElement("a"),Bt.href="",Bt=Bt.href}kt=Gt.exec(Bt.toLowerCase())||[],oe.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Bt,type:"GET",isLocal:Ut.test(kt[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Ht,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":oe.parseJSON,"text xml":oe.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?G(G(e,oe.ajaxSettings),t):G(oe.ajaxSettings,e)},ajaxPrefilter:j(Vt),ajaxTransport:j(zt),ajax:function(e,t){function r(e,t,r,n){var i,h,g,y,b,w=t;2!==x&&(x=2,s&&clearTimeout(s),u=void 0,a=n||"",T.readyState=e>0?4:0,i=e>=200&&300>e||304===e,r&&(y=V(c,T,r)),y=z(c,y,T,i),i?(c.ifModified&&(b=T.getResponseHeader("Last-Modified"),b&&(oe.lastModified[o]=b),b=T.getResponseHeader("etag"),b&&(oe.etag[o]=b)),204===e||"HEAD"===c.type?w="nocontent":304===e?w="notmodified":(w=y.state,h=y.data,g=y.error,i=!g)):(g=w,(e||!w)&&(w="error",0>e&&(e=0))),T.status=e,T.statusText=(t||w)+"",i?p.resolveWith(d,[h,w,T]):p.rejectWith(d,[T,w,g]),T.statusCode(v),v=void 0,l&&f.trigger(i?"ajaxSuccess":"ajaxError",[T,c,i?h:g]),m.fireWith(d,[T,w]),l&&(f.trigger("ajaxComplete",[T,c]),--oe.active||oe.event.trigger("ajaxStop")))}"object"==typeof e&&(t=e,e=void 0),t=t||{};var n,i,o,a,s,l,u,h,c=oe.ajaxSetup({},t),d=c.context||c,f=c.context&&(d.nodeType||d.jquery)?oe(d):oe.event,p=oe.Deferred(),m=oe.Callbacks("once memory"),v=c.statusCode||{},g={},y={},x=0,b="canceled",T={readyState:0,getResponseHeader:function(e){var t;if(2===x){if(!h)for(h={};t=Ot.exec(a);)h[t[1].toLowerCase()]=t[2];t=h[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return 2===x?a:null},setRequestHeader:function(e,t){var r=e.toLowerCase();return x||(e=y[r]=y[r]||e,g[e]=t),this},overrideMimeType:function(e){return x||(c.mimeType=e),this},statusCode:function(e){var t;if(e)if(2>x)for(t in e)v[t]=[v[t],e[t]];else T.always(e[T.status]);return this},abort:function(e){var t=e||b;return u&&u.abort(t),r(0,t),this}};if(p.promise(T).complete=m.add,T.success=T.done,T.error=T.fail,c.url=((e||c.url||Bt)+"").replace(Nt,"").replace(qt,kt[1]+"//"),c.type=t.method||t.type||c.method||c.type,c.dataTypes=oe.trim(c.dataType||"*").toLowerCase().match(be)||[""],null==c.crossDomain&&(n=Gt.exec(c.url.toLowerCase()),c.crossDomain=!(!n||n[1]===kt[1]&&n[2]===kt[2]&&(n[3]||("http:"===n[1]?"80":"443"))===(kt[3]||("http:"===kt[1]?"80":"443")))),c.data&&c.processData&&"string"!=typeof c.data&&(c.data=oe.param(c.data,c.traditional)),q(Vt,c,t,T),2===x)return T;l=c.global,l&&0===oe.active++&&oe.event.trigger("ajaxStart"),c.type=c.type.toUpperCase(),c.hasContent=!jt.test(c.type),o=c.url,c.hasContent||(c.data&&(o=c.url+=(_t.test(o)?"&":"?")+c.data,delete c.data),c.cache===!1&&(c.url=Dt.test(o)?o.replace(Dt,"$1_="+It++):o+(_t.test(o)?"&":"?")+"_="+It++)),c.ifModified&&(oe.lastModified[o]&&T.setRequestHeader("If-Modified-Since",oe.lastModified[o]),oe.etag[o]&&T.setRequestHeader("If-None-Match",oe.etag[o])),(c.data&&c.hasContent&&c.contentType!==!1||t.contentType)&&T.setRequestHeader("Content-Type",c.contentType),T.setRequestHeader("Accept",c.dataTypes[0]&&c.accepts[c.dataTypes[0]]?c.accepts[c.dataTypes[0]]+("*"!==c.dataTypes[0]?", "+Ht+"; q=0.01":""):c.accepts["*"]);for(i in c.headers)T.setRequestHeader(i,c.headers[i]);if(c.beforeSend&&(c.beforeSend.call(d,T,c)===!1||2===x))return T.abort();b="abort";for(i in{success:1,error:1,complete:1})T[i](c[i]);if(u=q(zt,c,t,T)){T.readyState=1,l&&f.trigger("ajaxSend",[T,c]),c.async&&c.timeout>0&&(s=setTimeout(function(){T.abort("timeout")},c.timeout));try{x=1,u.send(g,r)}catch(e){if(!(2>x))throw e;r(-1,e)}}else r(-1,"No Transport");return T},getJSON:function(e,t,r){return oe.get(e,t,r,"json")},getScript:function(e,t){return oe.get(e,void 0,t,"script")}}),oe.each(["get","post"],function(e,t){oe[t]=function(e,r,n,i){return oe.isFunction(r)&&(i=i||n,n=r,r=void 0),oe.ajax({url:e,type:t,dataType:i,data:r,success:n})}}),oe.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){oe.fn[t]=function(e){return this.on(t,e)}}),oe._evalUrl=function(e){return oe.ajax({url:e,type:"GET",dataType:"script",async:!1,global:!1,throws:!0})},oe.fn.extend({wrapAll:function(e){if(oe.isFunction(e))return this.each(function(t){oe(this).wrapAll(e.call(this,t))});if(this[0]){var t=oe(e,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){for(var e=this;e.firstChild&&1===e.firstChild.nodeType;)e=e.firstChild;return e}).append(this)}return this},wrapInner:function(e){return this.each(oe.isFunction(e)?function(t){oe(this).wrapInner(e.call(this,t))}:function(){var t=oe(this),r=t.contents();r.length?r.wrapAll(e):t.append(e)})},wrap:function(e){var t=oe.isFunction(e);return this.each(function(r){oe(this).wrapAll(t?e.call(this,r):e)})},unwrap:function(){return this.parent().each(function(){oe.nodeName(this,"body")||oe(this).replaceWith(this.childNodes)}).end()}}),oe.expr.filters.hidden=function(e){return e.offsetWidth<=0&&e.offsetHeight<=0||!ne.reliableHiddenOffsets()&&"none"===(e.style&&e.style.display||oe.css(e,"display"))},oe.expr.filters.visible=function(e){return!oe.expr.filters.hidden(e)};var Xt=/%20/g,Wt=/\[\]$/,Yt=/\r?\n/g,Qt=/^(?:submit|button|image|reset|file)$/i,Zt=/^(?:input|select|textarea|keygen)/i;oe.param=function(e,t){var r,n=[],i=function(e,t){t=oe.isFunction(t)?t():null==t?"":t,n[n.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};if(void 0===t&&(t=oe.ajaxSettings&&oe.ajaxSettings.traditional),oe.isArray(e)||e.jquery&&!oe.isPlainObject(e))oe.each(e,function(){i(this.name,this.value)});else for(r in e)H(r,e[r],t,i);return n.join("&").replace(Xt,"+")},oe.fn.extend({serialize:function(){return oe.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=oe.prop(this,"elements");return e?oe.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!oe(this).is(":disabled")&&Zt.test(this.nodeName)&&!Qt.test(e)&&(this.checked||!Ie.test(e))}).map(function(e,t){var r=oe(this).val();return null==r?null:oe.isArray(r)?oe.map(r,function(e){return{name:t.name,value:e.replace(Yt,"\r\n")}}):{name:t.name,value:r.replace(Yt,"\r\n")}}).get()}}),oe.ajaxSettings.xhr=void 0!==e.ActiveXObject?function(){return!this.isLocal&&/^(get|post|head|put|delete|options)$/i.test(this.type)&&X()||W()}:X;var Kt=0,Jt={},$t=oe.ajaxSettings.xhr();e.ActiveXObject&&oe(e).on("unload",function(){for(var e in Jt)Jt[e](void 0,!0)}),ne.cors=!!$t&&"withCredentials"in $t,$t=ne.ajax=!!$t,$t&&oe.ajaxTransport(function(e){if(!e.crossDomain||ne.cors){var t;return{send:function(r,n){var i,o=e.xhr(),a=++Kt;if(o.open(e.type,e.url,e.async,e.username,e.password),e.xhrFields)for(i in e.xhrFields)o[i]=e.xhrFields[i];e.mimeType&&o.overrideMimeType&&o.overrideMimeType(e.mimeType),e.crossDomain||r["X-Requested-With"]||(r["X-Requested-With"]="XMLHttpRequest");for(i in r)void 0!==r[i]&&o.setRequestHeader(i,r[i]+"");o.send(e.hasContent&&e.data||null),t=function(r,i){var s,l,u;if(t&&(i||4===o.readyState))if(delete Jt[a],t=void 0,o.onreadystatechange=oe.noop,i)4!==o.readyState&&o.abort();else{u={},s=o.status,"string"==typeof o.responseText&&(u.text=o.responseText);try{l=o.statusText}catch(e){l=""}s||!e.isLocal||e.crossDomain?1223===s&&(s=204):s=u.text?200:404}u&&n(s,l,u,o.getAllResponseHeaders())},e.async?4===o.readyState?setTimeout(t):o.onreadystatechange=Jt[a]=t:t()},abort:function(){t&&t(void 0,!0)}}}}),oe.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(e){return oe.globalEval(e),e}}}),oe.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET",e.global=!1)}),oe.ajaxTransport("script",function(e){if(e.crossDomain){var t,r=me.head||oe("head")[0]||me.documentElement;return{send:function(n,i){t=me.createElement("script"),t.async=!0,e.scriptCharset&&(t.charset=e.scriptCharset),t.src=e.url,t.onload=t.onreadystatechange=function(e,r){(r||!t.readyState||/loaded|complete/.test(t.readyState))&&(t.onload=t.onreadystatechange=null,t.parentNode&&t.parentNode.removeChild(t),t=null,r||i(200,"success"))},r.insertBefore(t,r.firstChild)},abort:function(){t&&t.onload(void 0,!0)}}}});var er=[],tr=/(=)\?(?=&|$)|\?\?/;oe.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=er.pop()||oe.expando+"_"+It++;return this[e]=!0,e}}),oe.ajaxPrefilter("json jsonp",function(t,r,n){var i,o,a,s=t.jsonp!==!1&&(tr.test(t.url)?"url":"string"==typeof t.data&&!(t.contentType||"").indexOf("application/x-www-form-urlencoded")&&tr.test(t.data)&&"data");return s||"jsonp"===t.dataTypes[0]?(i=t.jsonpCallback=oe.isFunction(t.jsonpCallback)?t.jsonpCallback():t.jsonpCallback,s?t[s]=t[s].replace(tr,"$1"+i):t.jsonp!==!1&&(t.url+=(_t.test(t.url)?"&":"?")+t.jsonp+"="+i),t.converters["script json"]=function(){return a||oe.error(i+" was not called"),a[0]},t.dataTypes[0]="json",o=e[i],e[i]=function(){a=arguments},n.always(function(){e[i]=o,t[i]&&(t.jsonpCallback=r.jsonpCallback,er.push(i)),a&&oe.isFunction(o)&&o(a[0]),a=o=void 0}),"script"):void 0}),oe.parseHTML=function(e,t,r){if(!e||"string"!=typeof e)return null;"boolean"==typeof t&&(r=t,t=!1),t=t||me;var n=de.exec(e),i=!r&&[];return n?[t.createElement(n[1])]:(n=oe.buildFragment([e],t,i),i&&i.length&&oe(i).remove(),oe.merge([],n.childNodes))};var rr=oe.fn.load;oe.fn.load=function(e,t,r){if("string"!=typeof e&&rr)return rr.apply(this,arguments);var n,i,o,a=this,s=e.indexOf(" ");return s>=0&&(n=oe.trim(e.slice(s,e.length)),e=e.slice(0,s)),oe.isFunction(t)?(r=t,t=void 0):t&&"object"==typeof t&&(o="POST"),a.length>0&&oe.ajax({url:e,type:o,dataType:"html",data:t}).done(function(e){i=arguments,a.html(n?oe("<div>").append(oe.parseHTML(e)).find(n):e)}).complete(r&&function(e,t){a.each(r,i||[e.responseText,t,e])}),this},oe.expr.filters.animated=function(e){return oe.grep(oe.timers,function(t){return e===t.elem}).length};var nr=e.document.documentElement;oe.offset={setOffset:function(e,t,r){var n,i,o,a,s,l,u,h=oe.css(e,"position"),c=oe(e),d={};"static"===h&&(e.style.position="relative"),s=c.offset(),o=oe.css(e,"top"),l=oe.css(e,"left"),u=("absolute"===h||"fixed"===h)&&oe.inArray("auto",[o,l])>-1,u?(n=c.position(),a=n.top,i=n.left):(a=parseFloat(o)||0,i=parseFloat(l)||0),oe.isFunction(t)&&(t=t.call(e,r,s)),null!=t.top&&(d.top=t.top-s.top+a),null!=t.left&&(d.left=t.left-s.left+i),"using"in t?t.using.call(e,d):c.css(d)}},oe.fn.extend({offset:function(e){if(arguments.length)return void 0===e?this:this.each(function(t){oe.offset.setOffset(this,e,t)});var t,r,n={top:0,left:0},i=this[0],o=i&&i.ownerDocument;return o?(t=o.documentElement,oe.contains(t,i)?(typeof i.getBoundingClientRect!==Ae&&(n=i.getBoundingClientRect()),r=Y(o),{top:n.top+(r.pageYOffset||t.scrollTop)-(t.clientTop||0),left:n.left+(r.pageXOffset||t.scrollLeft)-(t.clientLeft||0)}):n):void 0},position:function(){if(this[0]){var e,t,r={top:0,left:0},n=this[0];return"fixed"===oe.css(n,"position")?t=n.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),oe.nodeName(e[0],"html")||(r=e.offset()),r.top+=oe.css(e[0],"borderTopWidth",!0),r.left+=oe.css(e[0],"borderLeftWidth",!0)),{top:t.top-r.top-oe.css(n,"marginTop",!0),left:t.left-r.left-oe.css(n,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent||nr;e&&!oe.nodeName(e,"html")&&"static"===oe.css(e,"position");)e=e.offsetParent;return e||nr})}}),oe.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(e,t){var r=/Y/.test(t);oe.fn[e]=function(n){return Le(this,function(e,n,i){var o=Y(e);return void 0===i?o?t in o?o[t]:o.document.documentElement[n]:e[n]:void(o?o.scrollTo(r?oe(o).scrollLeft():i,r?i:oe(o).scrollTop()):e[n]=i)},e,n,arguments.length,null)}}),oe.each(["top","left"],function(e,t){oe.cssHooks[t]=E(ne.pixelPosition,function(e,r){return r?(r=rt(e,t),it.test(r)?oe(e).position()[t]+"px":r):void 0})}),oe.each({Height:"height",Width:"width"},function(e,t){oe.each({padding:"inner"+e,content:t,"":"outer"+e},function(r,n){oe.fn[n]=function(n,i){var o=arguments.length&&(r||"boolean"!=typeof n),a=r||(n===!0||i===!0?"margin":"border");return Le(this,function(t,r,n){var i;return oe.isWindow(t)?t.document.documentElement["client"+e]:9===t.nodeType?(i=t.documentElement,Math.max(t.body["scroll"+e],i["scroll"+e],t.body["offset"+e],i["offset"+e],i["client"+e])):void 0===n?oe.css(t,r,a):oe.style(t,r,n,a)},t,o?n:void 0,o,null)}})}),oe.fn.size=function(){return this.length},oe.fn.andSelf=oe.fn.addBack,"function"==typeof r&&r.amd&&r("jquery",[],function(){return oe});var ir=e.jQuery,or=e.$;return oe.noConflict=function(t){return e.$===oe&&(e.$=or),t&&e.jQuery===oe&&(e.jQuery=ir),oe},typeof t===Ae&&(e.jQuery=e.$=oe),oe}),r("Layer/BaseLayer",["../Utils/Event","../Utils/Utils"],function(e,t){var r=function(t){e.prototype.constructor.call(this,t),this.planet=null,this.name=t&&t.hasOwnProperty("name")?t.name:"",this.attribution=t&&t.hasOwnProperty("attribution")?t.attribution:" ",this.copyrightUrl=t&&t.hasOwnProperty("copyrightUrl")?t.copyrightUrl:"",this.ack=t&&t.hasOwnProperty("ack")?t.ack:"",this.icon=t&&t.hasOwnProperty("icon")?t.icon:"",this.description=t&&t.hasOwnProperty("description")?t.description:"",this._visible=!t||!t.hasOwnProperty("visible")||t.visible,this._opacity=t&&t.hasOwnProperty("opacity")?t.opacity:1,this.properties=t&&t.hasOwnProperty("properties")?t.properties:{},this.type="Base"};return t.inherits(e,r),r.prototype._attach=function(e){this.planet=e,this.attribution&&this.planet.attributionHandler&&this._visible&&this.planet.attributionHandler.addAttribution(this)},r.prototype._detach=function(){this.attribution&&this.planet.attributionHandler&&this.planet.attributionHandler.removeAttribution(this),this.planet=null},r.prototype.setVisible=function(e){"boolean"==typeof e&&(this._visible!==e&&this.planet.attributionHandler&&this.planet.attributionHandler.toggleAttribution(this),this._visible=e,this.planet&&this.planet.renderContext.requestFrame(),this.publish("visibility:changed",this))},r.prototype.getVisible=function(){return this._visible},r.prototype.setOpacity=function(e){"number"==typeof e&&(this._opacity=e,this.planet&&this.planet.renderContext.requestFrame(),this.publish("opacity:changed"))},r.prototype.getOpacity=function(){return this._opacity},r.prototype.getType=function(){return this.typeLayer},r.prototype.isType=function(e){return this.type===e},r}),r("Renderer/RendererTileData",[],function(){var e=function(e){this.manager=e,this.renderables=[]};return e.prototype.initChild=function(t,r,n){for(var i,o=0;o<this.renderables.length;o++)if(this.renderables[o].initChild){var a=this.renderables[o].initChild(r,n,t);a&&(i||(i=t.extension.renderer=new e(this.manager)),i.renderables.push(a))}},e.prototype.traverse=function(e,t){for(var r=0;r<this.renderables.length;r++){var n=this.renderables[r],i=n.bucket;if(i.layer._visible&&i.layer._opacity>0)if(n.traverse)n.traverse(this.manager,e,t);else{if(n.hasChildren&&!t)continue;this.manager.renderables.push(n)}}},e.prototype.getRenderable=function(e){for(var t=0;t<this.renderables.length;t++)if(e===this.renderables[t].bucket)return this.renderables[t];return null},e.prototype.dispose=function(e,t){for(var r=0;r<this.renderables.length;r++)this.renderables[r].dispose(e,t);this.renderables.length=0},e}),r("Renderer/RasterOverlayRenderer",["./Program","../Tiling/Tile","../Utils/ImageRequest","./RendererTileData"],function(e,t,r,n){var i=function(e){this.vertexShader="attribute vec3 vertex;\n",this.vertexShader+="attribute vec2 tcoord;\n",this.vertexShader+="uniform mat4 modelViewMatrix;\n",this.vertexShader+="uniform mat4 projectionMatrix;\n",this.vertexShader+="uniform vec4 textureTransform; \n",this.vertexShader+="varying vec2 texCoord;\n",this.vertexShader+="void main(void) \n",this.vertexShader+="{\n",this.vertexShader+="\tgl_Position = projectionMatrix * modelViewMatrix * vec4(vertex, 1.0);\n",this.vertexShader+="\ttexCoord = tcoord * textureTransform.xy + textureTransform.zw;\n",this.vertexShader+="}\n",this.fragmentShader="precision lowp float;\n",this.fragmentShader+="varying vec2 texCoord;\n",this.fragmentShader+="uniform sampler2D overlayTexture;\n",this.fragmentShader+="uniform float opacity; \n",this.fragmentShader+="void main(void)\n",this.fragmentShader+="{\n",this.fragmentShader+="\tgl_FragColor.rgba = texture2D(overlayTexture, texCoord.xy); \n",this.fragmentShader+="\tgl_FragColor.a *= opacity; \n",this.fragmentShader+="}\n",this.rendererManager=e.vectorRendererManager,this.tileManager=e.tileManager,this.programs=[],this.program=this.createProgram({vertexCode:this.vertexShader,fragmentCode:this.fragmentShader,updateUniforms:null}),this.buckets=[],this.imageRequests=[],this.frameNumber=0;for(var t=this,n=0;n<4;n++){var i=new r({successCallback:function(){this.renderable&&(this.renderable.bucket.layer.handleImage&&this.renderable.bucket.layer.handleImage(this),this.renderable.ownTexture=t.tileManager.tilePool.createGLTexture(this.image),this.renderable.texture=this.renderable.ownTexture,this.renderable.uvScale=1,this.renderable.uTrans=0,this.renderable.vTrans=0,this.renderable.updateChildrenTexture(),this.renderable.onRequestFinished(!0),this.renderable=null,t.tileManager.renderContext.requestFrame())},failCallback:function(){this.renderable&&(this.renderable.onRequestFinished(!0),this.renderable=null)},abortCallback:function(){this.renderable&&(this.renderable.onRequestFinished(!1),this.renderable=null)}});this.imageRequests.push(i)}},o=function(e){this.bucket=e,this.ownTexture=null,this.texture=null,this.request=null,this.requestFinished=!1,this.tile=null,this.uvScale=1,this.uTrans=0,this.vTrans=0};o.prototype.onRequestStarted=function(e){this.request=e,this.requestFinished=!1;var t=this.bucket.layer;0===t._numRequests&&t.planet.publish("startLoad",t),t._numRequests++},o.prototype.onRequestFinished=function(e){this.request=null,this.requestFinished=e;var t=this.bucket.layer;t._numRequests--,t.planet&&0===t._numRequests&&t.planet.publish("endLoad",t)},o.prototype.initChild=function(e,t,r){var n=this.bucket.createRenderable();return n.tile=r,this.texture&&(n.texture=this.texture,n.uvScale=this.uvScale,n.uTrans=this.uTrans,n.vTrans=this.vTrans),n},o.prototype.generateChild=function(e){var t=this.bucket.renderer;t.addOverlayToTile(e,this.bucket,this)},o.prototype.updateChildrenTexture=function(){if(this.tile.children)for(var e=0;e<4;e++){var t=this.tile.children[e].extension.renderer;if(t){var r=t.getRenderable(this.bucket);r&&!r.ownTexture&&(r.updateTextureFromParent(this),r.updateChildrenTexture())}}},o.prototype.updateTextureFromParent=function(e){this.tile.state===t.State.LOADED?(this.texture=e.texture,this.uvScale=.5*e.uvScale,this.uTrans=e.uTrans,this.vTrans=e.vTrans,this.uTrans+=1&this.tile.parentIndex?this.uvScale:0,this.vTrans+=2&this.tile.parentIndex?this.uvScale:0):(this.texture=e.texture,this.uvScale=e.uvScale,this.uTrans=e.uTrans,this.vTrans=e.vTrans)},o.prototype.traverse=function(e,r,n){n&&this.texture&&e.renderables.push(this),this.requestFinished||this.tile.state!==t.State.LOADED||this.bucket.renderer.requestOverlayTextureForTile(this)},o.prototype.dispose=function(e,t){this.ownTexture&&(t.disposeGLTexture(this.ownTexture),this.ownTexture=null)};var a=function(e){this.layer=e,this.renderer=null,this.style=e};a.prototype.createRenderable=function(){return new o(this)},i.prototype.addOverlay=function(e){e._numRequests=0;var r=new a(e);r.renderer=this,r.id=this.rendererManager.bucketId++,this.buckets.push(r),e._bucket=r;for(var n=0;n<this.tileManager.level0Tiles.length;n++){var i=this.tileManager.level0Tiles[n];i.state===t.State.LOADED&&this.addOverlayToTile(i,r)}},i.prototype.removeOverlay=function(e){var t=this.buckets.indexOf(e._bucket);this.buckets.splice(t,1);var r=this.tileManager.renderContext,n=this.tileManager.tilePool;this.tileManager.visitTiles(function(t){var i=t.extension.renderer,o=i?i.getRenderable(e._bucket):null;if(o){var a=i.renderables.indexOf(o);i.renderables.splice(a,1),o.dispose(r,n),0===i.renderables.length&&delete t.extension.renderer}})},i.prototype.addOverlayToTile=function(e,r,i){if(this.overlayIntersects(e.geoBound,r.layer)){e.extension.renderer||(e.extension.renderer=new n(this.rendererManager));var o=r.createRenderable();if(o.tile=e,e.extension.renderer.renderables.push(o),i&&i.texture&&o.updateTextureFromParent(i),e.children)for(var a=0;a<4;a++)e.children[a].state===t.State.LOADED&&this.addOverlayToTile(e.children[a],r,o)}};var s=function(e,t,r){return[t[0]+e*(r[0]-t[0]),t[1]+e*(r[1]-t[1])]};return i.prototype.clipPolygonToSide=function(e,t,r,n){for(var i,o,a=[],l=0;l<n.length;l++){var u=n[l],h=n[(l+1)%n.length],c=u[e],d=h[e],f=(c-r)*t>=0,p=(d-r)*t>=0;!f&&p?(i=(r-c)/(d-c),o=s(i,u,h),a.push(o),a.push(h)):f&&p?a.push(h):f&&!p&&(i=(r-c)/(d-c),o=s(i,u,h),a.push(o))}return a},i.prototype.overlayIntersects=function(e,t){if(t.coordinates){var r;return r=this.clipPolygonToSide(0,1,e.west,t.coordinates),r=this.clipPolygonToSide(0,-1,e.east,r),r=this.clipPolygonToSide(1,1,e.south,r),r=this.clipPolygonToSide(1,-1,e.north,r),r.length>0}return!t.geoBound||t.geoBound.intersects(e)},i.prototype.generateLevelZero=function(e){for(var t=0;t<this.buckets.length;t++)this.addOverlayToTile(e,this.buckets[t])},i.prototype.requestOverlayTextureForTile=function(e){if(e.request)e.request.frameNumber=this.frameNumber;else{for(var t,r=0;r<this.imageRequests.length;r++)if(!this.imageRequests[r].renderable){t=this.imageRequests[r];break}t&&(e.onRequestStarted(t),t.renderable=e,t.frameNumber=this.frameNumber,t.send(e.bucket.layer.getUrl(e.tile),e.bucket.layer.crossOrigin))}},i.prototype.createProgram=function(t){var r=new e(this.tileManager.renderContext);return r.createFromSource(this.vertexShader,t.fragmentCode),r.id=this.programs.length,this.programs.push({fragmentCode:t.fragmentCode,program:r}),r},i.prototype.getProgram=function(e){for(var t,r=0;r<this.programs.length;r++)this.programs[r].fragmentCode===e.fragmentCode&&(t=this.programs[r].program);return t||(t=this.createProgram(e)),t},i.prototype.render=function(e,r,n){var i=this.tileManager.renderContext,o=i.gl;o.enable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),o.depthFunc(o.LEQUAL);for(var a=mat4.create(),s=null,l=null,u=r;u<n;u++){var h,c,d=e[u],f=d.bucket,p=f.layer;p.customShader?(c=this.getProgram(p.customShader),h=p.customShader.updateUniforms):c=this.getProgram({vertexCode:this.vertexShader,fragmentCode:this.fragmentShader,updateUniforms:null}),c!==l&&(l=c,c.apply(),o.uniformMatrix4fv(c.uniforms.projectionMatrix,!1,i.projectionMatrix),o.uniform1i(c.uniforms.overlayTexture,0),o.bindBuffer(o.ARRAY_BUFFER,this.tileManager.tcoordBuffer),o.vertexAttribPointer(c.attributes.tcoord,2,o.FLOAT,!1,0,0)),h&&h(o,c),o.bindBuffer(o.ARRAY_BUFFER,d.tile.vertexBuffer),o.vertexAttribPointer(c.attributes.vertex,3,o.FLOAT,!1,4*d.tile.config.vertexSize,0);var m=d.tile.state===t.State.LOADED?this.tileManager.tileIndexBuffer.getSolid():this.tileManager.tileIndexBuffer.getSubSolid(d.tile.parentIndex);s!==m&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,m),s=m),mat4.multiply(i.viewMatrix,d.tile.matrix,a),o.uniformMatrix4fv(c.uniforms.modelViewMatrix,!1,a),o.uniform1f(c.uniforms.opacity,p._opacity),o.uniform4f(c.uniforms.textureTransform,d.uvScale,d.uvScale,d.uTrans,d.vTrans),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,d.texture),o.drawElements(o.TRIANGLES,s.numIndices,o.UNSIGNED_SHORT,0)}o.disable(o.BLEND),o.depthFunc(o.LESS)},i.prototype.canApply=function(e,t){return!1},i}),r("Utils/Cache",[],function(){var e=function(e){this.layer=e.layer,this.cacheLevel=e.hasOwnProperty("cacheLevel")?e.cacheLevel:1,localStorage.getItem(this.layer.name)||localStorage.setItem(this.layer.name,JSON.stringify({})),this._cacheMap=JSON.parse(localStorage.getItem(this.layer.name)),this.imgCanvas=document.createElement("canvas"),this.imgCanvas.width=e.tilePixelSize||256,this.imgCanvas.height=e.tilePixelSize||256,this.imgContext=this.imgCanvas.getContext("2d")};return e.prototype.getFromCache=function(e){var t=null;if(this.cacheLevel>=e.level){var r=this.layer.getUrl(e),n=this._cacheMap[r];if(n){n.lastAccess=Date.now();var i=new Image;i.src=n.dataUrl,i.dataType="byte",t={image:i,elevations:n.elevations}}}return t},e.prototype._createDataURL=function(e){return this.imgContext.drawImage(e,0,0,e.width,e.height),this.imgCanvas.toDataURL("image/png")},e.prototype.storeInCache=function(e){var t=e.tile;if(this.cacheLevel>=t.level){var r=this.layer.getUrl(t);this._cacheMap[r]={dataUrl:this._createDataURL(e.image),elevations:e.elevations,lastAccess:Date.now()},console.log("Stored for "+e.image.src),localStorage.setItem(this.layer.name,JSON.stringify(this._cacheMap))}},e}),r("Layer/RasterLayer",["../Utils/Utils","./BaseLayer","../Renderer/RasterOverlayRenderer","../Utils/Cache"],function(e,t,r,n){var i=function(e){t.prototype.constructor.call(this,e),this.tilePixelSize=-1,this.tiling=null,this.numberOfLevels=-1,this.geoBound=e.geoBound||null,this.coordinates=e.coordinates||null,this.zIndex=e.zIndex||0,this.crossOrigin=e.crossOrigin||"anonymous",e.cache&&(e.cache.layer=this,this.cache=new n(e.cache)),this._overlay=!0,this._ready=!0};return e.inherits(t,i),i.prototype._attach=function(e){if(this._overlay||(this.id=0),t.prototype._attach.call(this,e),this._overlay){if(!e.rasterOverlayRenderer){var n=new r(e);e.vectorRendererManager.renderers.push(n),e.rasterOverlayRenderer=n;
}e.rasterOverlayRenderer.addOverlay(this)}},i.prototype._detach=function(){this._overlay&&this.planet.rasterOverlayRenderer&&this.planet.rasterOverlayRenderer.removeOverlay(this),t.prototype._detach.call(this)},i}),r("Layer/WMSLayer",["../Utils/Utils","./RasterLayer","../Tiling/GeoTiling"],function(e,t,r){var n=function(e){t.prototype.constructor.call(this,e),this.baseUrl=e.baseUrl,this.tilePixelSize=e.tilePixelSize||256,this.tiling=new r(4,2),this.numberOfLevels=e.numberOfLevels||21;var n=this.baseUrl;n+=n.indexOf("?",0)===-1?"?service=wms":"&service=wms",n+="&version=",n+=e.hasOwnProperty("version")?e.version:"1.1.1",n+="&request=GetMap",n+="&layers="+e.layers,n+="&styles=",e.hasOwnProperty("styles")&&(n+=e.styles),n+="&format=",n+=e.hasOwnProperty("format")?e.format:"image/jpeg",e.hasOwnProperty("transparent")&&(n+="&transparent="+e.transparent),n+="&width=",n+=this.tilePixelSize,n+="&height=",n+=this.tilePixelSize,e.hasOwnProperty("time")&&(n+="&time="+e.time),this.getMapBaseUrl=n};return e.inherits(t,n),n.prototype.getUrl=function(e){var t=e.bound,r=this.getMapBaseUrl;return r+="&srs="+e.config.srs,r+="&bbox=",r+=t.west,r+=",",r+=t.south,r+=",",r+=t.east,r+=",",r+=t.north},n}),r("Layer/WMTSLayer",["../Utils/Utils","./RasterLayer","../Tiling/GeoTiling"],function(e,t,r){var n=function(e){t.prototype.constructor.call(this,e),this.baseUrl=e.baseUrl,this.tilePixelSize=e.tilePixelSize||256,this.tiling=new r(4,2),this.numberOfLevels=e.numberOfLevels||21,this.type="ImageryRaster",this.startLevel=e.startLevel||1;var n=this.baseUrl;n+=n.indexOf("?",0)===-1?"?service=wmts":"&service=wmts",n+="&version=",n+=e.version||"1.0.0",n+="&request=GetTile",n+="&layer="+e.layer,n+="&tilematrixset="+e.matrixSet,e.style&&(n+="&style="+e.style),n+="&format=",e.time&&(n+=e.format||"image/png",n+="&time="+e.time),this.getTileBaseUrl=n};return e.inherits(t,n),n.prototype.getUrl=function(e){var t=this.getTileBaseUrl;return t+="&tilematrix=",t+=e.level+this.startLevel,t+="&tilecol="+e.x,t+="&tilerow="+e.y},n}),r("Layer/WCSElevationLayer",["../Utils/Utils","./RasterLayer","../Tiling/GeoTiling"],function(e,t,r){var n=function(e){t.prototype.constructor.call(this,e),this.baseUrl=e.baseUrl,this.tilePixelSize=e.tilePixelSize||33,this.tiling=new r(4,2),this.numberOfLevels=e.numberOfLevels||21,this.version=e.version||"2.0.0",this.format=e.format||"image/x-aaigrid",this.minElevation=e.minElevation||0,this.scale=e.scale||1;var n=this.baseUrl;switch(n+=n.indexOf("?",0)===-1?"?service=wcs":"&service=wcs",n+="&version="+this.version,n+="&request=GetCoverage",this.version.substring(0,3)){case"2.0":this.crs=e.outputCRS||e.crs||"http://www.opengis.net/def/crs/EPSG/0/4326",n+="&outputCRS="+this.crs,n+="&size=x("+this.tilePixelSize+")",n+="&size=y("+this.tilePixelSize+")",n+="&coverageid="+e.coverage;break;case"1.0":n+="&width="+this.tilePixelSize,n+="&height="+this.tilePixelSize,n+="&crs="+(e.crs||"EPSG:4326"),n+="&coverage="+e.coverage}n+="&format="+this.format,this.getCoverageBaseUrl=n};return e.inherits(t,n),n.prototype.parseElevations=function(e){if(null===e)return this._returnZeroElevations();switch(this.format){case"image/x-aaigrid":return this._parseAAIGrid(e);default:return console.log("Format '"+this.format+"' could not be parsed."),this._returnZeroElevations()}},n.prototype._returnZeroElevations=function(){for(var e=[],t=0;t<this.tilePixelSize*this.tilePixelSize;++t)e.push(0);return e},n.prototype._parseAAIGrid=function(e){var t,r=[],n=e.trim().split("\n"),i=0;for(t=0;t<n.length;++t)if(" "===n[t].substring(0,1)){i=t;break}for(t=i;t<n.length;t++)for(var o=n[t].trim().split(/\s+/),a=0;a<o.length;a++){var s=parseInt(o[a]);s<this.minElevation&&(s=this.minElevation),r.push(s*this.scale)}return r},n.prototype.getUrl=function(e){var t=e.geoBound,r=this.getCoverageBaseUrl;return"2.0"===this.version.substring(0,3)?(r+="&subset=x,"+this.crs+"("+t.west+","+t.east+")",r+="&subset=y,"+this.crs+"("+t.south+","+t.north+")"):"1.0"===this.version.substring(0,3)&&(r+="&bbox=",r+=t.west,r+=",",r+=t.south,r+=",",r+=t.east,r+=",",r+=t.north),r},n}),r("Renderer/FeatureStyle",[],function(){var e={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"},t=/^(\w{2})(\w{2})(\w{2})$/,r=/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,n=/^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3},\s*(\d{1,3}))\)$/,i=function(e){if(this.strokeColor=[1,0,0,1],this.fillColor=[1,0,0,1],this.fillTextureUrl=null,this.fillTexture=null,this.fillShader=null,this.strokeWidth=1,this.iconUrl=null,this.icon=null,this.label=null,this.textColor=[1,1,1,1],this.fill=!1,this.pointMaxSize=40,this.opacity=1,this.zIndex=0,this.extrusionScale=1,e)for(var t in e)this[t]=e[t]};return i.fromStringToColor=function(i){var o,a=0,s=0,l=0,u=255;return i=i.trim(),i=i.toLowerCase(),"#"===i.charAt(0)&&(i=i.substr(1,6)),e.hasOwnProperty(i)&&(i=e[i]),o=t.exec(i),o&&(a=parseInt(o[1],16),s=parseInt(o[2],16),l=parseInt(o[3],16)),o=r.exec(i),o&&(a=parseInt(o[1]),s=parseInt(o[2]),l=parseInt(o[3])),o=n.exec(i),o&&(a=parseInt(o[1]),s=parseInt(o[2]),l=parseInt(o[3]),u=parseInt(o[4])),a=a<0?0:a>255?255:a,s=s<0?0:s>255?255:s,l=l<0?0:l>255?255:l,u=u<0?0:u>255?255:u,[a/255,s/255,l/255,u/255]},i.fromColorToString=function(e){for(var t="#",r=0;r<3;r++){var n=parseInt(255*e[r]).toString(16);t+=n<10?"0"+n:n}return t},i.prototype.getExtrusionScale=function(){return this.extrusionScale},i.prototype.setExtrusionScale=function(e){this.extrusionScale=e},i}),r("Layer/VectorLayer",["../Utils/Utils","./BaseLayer","../Renderer/FeatureStyle"],function(e,t,r){var n=function(e){t.prototype.constructor.call(this,e),e&&e.url?this.url=e.url:this.url=null,e&&e.callback?this.callback=e.callback:this.callback=null,e&&e.style?this.style=e.style:this.style=new r,this.minLevel=e&&e.hasOwnProperty("minLevel")?e.minLevel:0,this.maxLevel=e&&e.hasOwnProperty("maxLevel")?e.maxLevel:15,this.features=[]};return e.inherits(t,n),n.prototype._attach=function(e){t.prototype._attach.call(this,e);for(var r=0;r<this.features.length;r++)this._addFeatureToRenderers(this.features[r])},n.prototype._detach=function(){for(var e=0;e<this.features.length;e++)this._removeFeatureFromRenderers(this.features[e]);t.prototype._detach.call(this)},n.prototype.addFeatureCollection=function(e){var t=e.features;if(t)for(var r=0;r<t.length;r++)this.addFeature(t[r])},n.prototype.removeFeatureCollection=function(e){var t=e.features;if(t)for(var r=0;r<t.length;r++)this.removeFeature(t[r])},n.prototype._addFeatureToRenderers=function(e){var t=e.geometry,r=this.style,n=e.properties;if(n&&n.style&&(r=n.style),"GeometryCollection"===t.type)for(var i=t.geometries,o=0;o<i.length;o++)this.planet.vectorRendererManager.addGeometry(this,i[o],r);else this.planet.vectorRendererManager.addGeometry(this,t,r)},n.prototype._removeFeatureFromRenderers=function(e){var t=e.geometry;if("GeometryCollection"===t.type){var r=t.geometries,n=!1;if(this.planet&&this.planet.vectorRendererManager)for(var i=0;i<r.length;i++)n=this.planet.vectorRendererManager.removeGeometry(r[i],this);return n}if(this.planet&&this.planet.vectorRendererManager)return this.planet.vectorRendererManager.removeGeometry(t,this)},n.prototype.addFeature=function(e){var t=e.geometry;t&&t.type&&(this.features.push(e),this.planet&&(this._addFeatureToRenderers(e),this._visible&&this.planet.renderContext.requestFrame()))},n.prototype.removeFeature=function(e){var t=this.features.indexOf(e);this.features.splice(t,1),this.planet&&(this._removeFeatureFromRenderers(e),this._visible&&this.planet.renderContext.requestFrame())},n.prototype.removeAllFeatures=function(){if(this.planet)for(var e=0;e<this.features.length;e++)this._removeFeatureFromRenderers(this.features[e]);this.features.length=0,this.planet&&this._visible&&this.planet.renderContext.requestFrame()},n.prototype.modifyFeatureStyle=function(e,t){this._removeFeatureFromRenderers(e)&&(e.properties.style=t,this._addFeatureToRenderers(e))},n.prototype.modifyStyle=function(e){var t;for(t=0;t<this.features.length;t++)this._removeFeatureFromRenderers(this.features[t]);for(this.style=e,t=0;t<this.features.length;t++)this._addFeatureToRenderers(this.features[t])},n.prototype.getStyle=function(){return this.style},n.prototype.setStyle=function(e){this.style=e},n}),r("Layer/AtmosphereLayer",["../Utils/Utils","./BaseLayer","../Renderer/Program"],function(e,t,r){var n=function(e){t.prototype.constructor.call(this,e),this.name||(this.name="Atmosphere"),this.kr=e&&e.kr||.0025,this.km=e&&e.km||.0015,this.sunBrightness=e&&e.sunBrightness||15,this.exposure=e&&e.exposure||2,this.wavelength=e&&e.wavelength||[.65,.57,.475],this.lightDir=e&&e.lightDir||[1,0,0],this._skyProgram=null,this._groundProgram=null,this._originalProgram=null,this._isValid=!1,this.zIndex=-1};return e.inherits(t,n),n.prototype._attach=function(e){this.planet=e,this._innerRadius=this.planet.coordinateSystem.geoide.radius,this._outerRadius=1.005*this._innerRadius;var t=e.renderContext;if(this._skyFromSpaceProgram=new r(t),this._skyFromSpaceProgram.loadFromFile("SkyFromSpaceVert.glsl","SkyFrag.glsl"),this._skyFromAtmosphereProgram=new r(t),this._skyFromAtmosphereProgram.loadFromFile("SkyFromAtmosphereVert.glsl","SkyFrag.glsl"),this._groundFromSpaceProgram=new r(t),this._groundFromSpaceProgram.loadFromFile("GroundFromSpaceVert.glsl","GroundFrag.glsl"),this._groundFromAtmosphereProgram=new r(t),this._groundFromAtmosphereProgram.loadFromFile("GroundFromAtmosphereVert.glsl","GroundFrag.glsl"),this._isValid=null!==this._skyFromSpaceProgram.glProgram&&null!==this._skyFromAtmosphereProgram.glProgram&&null!==this._groundFromSpaceProgram.glProgram&&null!==this._groundFromAtmosphereProgram.glProgram,this._isValid){this._skyFromSpaceProgram.apply(),this._initUniforms(this._skyFromSpaceProgram.uniforms),this._skyFromAtmosphereProgram.apply(),this._initUniforms(this._skyFromAtmosphereProgram.uniforms),this._groundFromSpaceProgram.apply(),this._initUniforms(this._groundFromSpaceProgram.uniforms),this._groundFromAtmosphereProgram.apply(),this._initUniforms(this._groundFromAtmosphereProgram.uniforms);var n,i,o=[],a=[],s=72,l=144;for(n=-s;n<=s;n++){var u=n*(.5*Math.PI)/s;for(i=-l;i<=l;i++){var h=i*Math.PI/l,c=this._outerRadius*Math.cos(h)*Math.cos(u),d=this._outerRadius*Math.sin(h)*Math.cos(u),f=this._outerRadius*Math.sin(u);o.push(c),o.push(d),o.push(f)}}for(n=0;n<2*s;n++)for(i=0;i<2*l;i++)a.push(n*(2*l+1)+i),a.push((n+1)*(2*l+1)+i+1),a.push(n*(2*l+1)+i+1),a.push((n+1)*(2*l+1)+i+1),a.push(n*(2*l+1)+i),a.push((n+1)*(2*l+1)+i);var p=t.gl;this._vertexBuffer=p.createBuffer(),p.bindBuffer(p.ARRAY_BUFFER,this._vertexBuffer),p.bufferData(p.ARRAY_BUFFER,new Float32Array(o),p.STATIC_DRAW),this._indexBuffer=p.createBuffer(),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,this._indexBuffer),p.bufferData(p.ELEMENT_ARRAY_BUFFER,new Uint16Array(a),p.STATIC_DRAW),this._numIndices=a.length,this._originalProgram=e.tileManager.program,e.preRenderers.push(this),e.tileManager.addPostRenderer(this)}},n.prototype._initUniforms=function(e){var t=this.planet.renderContext.gl,r=-.95,n=1/(this._outerRadius-this._innerRadius),i=.25;vec3.normalize(this.lightDir),t.uniform1f(e.fKrESun,this.kr*this.sunBrightness),t.uniform1f(e.fKmESun,this.kr*this.sunBrightness),t.uniform1f(e.fKr4PI,4*this.kr*Math.PI),t.uniform1f(e.fKm4PI,4*this.km*Math.PI),t.uniform1f(e.fExposure,this.exposure);var o=[Math.pow(this.wavelength[0],4),Math.pow(this.wavelength[1],4),Math.pow(this.wavelength[2],4)];t.uniform3f(e.v3InvWavelength,1/o[0],1/o[1],1/o[2]),t.uniform3f(e.v3LightPos,this.lightDir[0],this.lightDir[1],this.lightDir[2]),t.uniform1f(e.fInnerRadius,this._innerRadius),t.uniform1f(e.fInnerRadius2,this._innerRadius*this._innerRadius),t.uniform1f(e.fOuterRadius,this._outerRadius),t.uniform1f(e.fOuterRadius2,this._outerRadius*this._outerRadius),t.uniform1f(e.fScale,n),t.uniform1f(e.fScaleDepth,i),t.uniform1f(e.fScaleOverScaleDepth,n/i),t.uniform1f(e.g,r),t.uniform1f(e.g2,r*r)},n.prototype.preRender=function(){if(this._isValid){var e=this.planet.tileManager;if(!this._visible)return void(e.program=this._originalProgram);var t,r,n,i=this.planet.renderContext,o=i.gl,a=i.viewMatrix;t=a[12],r=a[13],n=a[14];var s=[-(a[0]*t+a[1]*r+a[2]*n),-(a[4]*t+a[5]*r+a[6]*n),-(a[8]*t+a[9]*r+a[10]*n)],l=vec3.length(s);this._skyProgram=l<this._outerRadius?this._skyFromAtmosphereProgram:this._skyFromSpaceProgram,this._groundProgram=l<this._outerRadius?this._groundFromAtmosphereProgram:this._groundFromSpaceProgram,this._skyProgram.apply(),o.uniform3f(this._skyProgram.uniforms.v3CameraPos,s[0],s[1],s[2]),o.uniform1f(this._skyProgram.uniforms.fCameraHeight2,l*l),o.uniform1f(this._skyProgram.uniforms.fCameraHeight,l),this._groundProgram.apply();var u=[0,0,0];mat4.multiplyVec3(i.viewMatrix,u),o.uniform3f(this._groundProgram.uniforms.earthCenter,u[0],u[1],u[2]),vec3.normalize(this.lightDir),t=this.lightDir[0],r=this.lightDir[1],n=this.lightDir[2];var h=i.viewMatrix,c=[];c[0]=h[0]*t+h[4]*r+h[8]*n,c[1]=h[1]*t+h[5]*r+h[9]*n,c[2]=h[2]*t+h[6]*r+h[10]*n,o.uniform3f(this._groundProgram.uniforms.lightDir,c[0],c[1],c[2]),o.uniform3f(this._groundProgram.uniforms.v3CameraPos,s[0],s[1],s[2]),o.uniform1f(this._groundProgram.uniforms.fCameraHeight2,l*l),o.uniform1f(this._groundProgram.uniforms.fCameraHeight,l),e.program=this._groundProgram}},n.prototype.render=function(){if(this._isValid&&this._visible&&this.planet){var e=this.planet.renderContext,t=e.gl;t.enable(t.CULL_FACE),t.uniformMatrix4fv(this._skyProgram.uniforms.projectionMatrix,!1,e.projectionMatrix),t.uniformMatrix4fv(this._skyProgram.uniforms.viewMatrix,!1,e.viewMatrix),t.bindBuffer(t.ARRAY_BUFFER,this._vertexBuffer),t.vertexAttribPointer(this._skyProgram.attributes.vertex,3,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indexBuffer),t.drawElements(t.TRIANGLES,this._numIndices,t.UNSIGNED_SHORT,0),t.disable(t.CULL_FACE)}},n}),r("Tiling/MercatorTiling",["./Tile","../Renderer/GeoBound","./GeoTiling"],function(e,t,r){var n=function(e){return 20037508.34*e/180},i=function(e){var t=Math.log(Math.tan((90+e)*Math.PI/360))/(Math.PI/180);return 20037508.34*t/180},o=function(e,t){return e/Math.pow(2,t)*360-180},a=function(e,t){var r=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(r)-Math.exp(-r)))},s=function(r,s,l){e.prototype.constructor.call(this),this.level=r,this.x=s,this.y=l,this.geoBound=new t(o(s,r),a(l+1,r),o(s+1,r),a(l,r)),this.bound=new t(n(this.geoBound.west),i(this.geoBound.south),n(this.geoBound.east),i(this.geoBound.north))};s.prototype=new e,s.prototype.getElevation=function(e,t){return 0},s.prototype.createChildren=function(){var e=new s(this.level+1,2*this.x,2*this.y),t=new s(this.level+1,2*this.x+1,2*this.y),r=new s(this.level+1,2*this.x,2*this.y+1),n=new s(this.level+1,2*this.x+1,2*this.y+1);e.initFromParent(this,0,0),t.initFromParent(this,1,0),r.initFromParent(this,0,1),n.initFromParent(this,1,1),this.children=[e,t,r,n]},s.prototype.lonlat2tile=function(e){for(var t=Math.pow(2,this.level),r=this.config.tesselation-1,n=[],i=0;i<e.length;i++){var o=(e[i][0]+180)/360,a=Math.sin(e[i][1]*Math.PI/180),s=.5-Math.log((1+a)/(1-a))/(4*Math.PI);n.push([r*(o*t-this.x),r*(s*t-this.y)])}return n},s.prototype.generateVertices=function(e){this.matrix=this.config.coordinateSystem.getLHVTransform(this.geoBound.getCenter());var t=mat4.create();mat4.inverse(this.matrix,t),this.inverseMatrix=t;for(var r=this.config.tesselation,n=new Float32Array(3*r*(r+6)),i=1/(r-1),o=(this.config.coordinateSystem.geoide.radius,this.config.coordinateSystem.geoide.heightScale),a=0,s=Math.pow(2,this.level),l=[0,0,0],u=this.y,h=0;h<r;h++){var c=Math.PI*(1-2*u/s),d=Math.atan(.5*(Math.exp(c)-Math.exp(-c)));d=180*d/Math.PI;for(var f=(Math.cos(d),Math.sin(d),this.x),p=0;p<r;p++){var m=180*(2*f/s-1),v=e?o*e[a]:0;this.config.coordinateSystem.fromGeoTo3D([m,d,v],l);var g=l[0],y=l[1],x=l[2],b=3*a;n[b]=t[0]*g+t[4]*y+t[8]*x+t[12],n[b+1]=t[1]*g+t[5]*y+t[9]*x+t[13],n[b+2]=t[2]*g+t[6]*y+t[10]*x+t[14],a++,f+=i}u+=i}return n},s.prototype.buildSkirtVertices=function(t,r,n,i){var o=this.config.tesselation,a=this.config.vertexSize,s=Math.pow(2,this.level),l=0===this.y&&i===a*(o*o),u=this.y===s-1&&i===a*((o+1)*o);if(l||u){var h=this.vertices,c=this.config.coordinateSystem.fromGeoTo3D(l?[0,90,0]:[0,-90,0]);mat4.multiplyVec3(this.inverseMatrix,c);for(var d=0;d<o;d++){h[i]=c[0],h[i+1]=c[1],h[i+2]=c[2];for(var f=3;f<a;f++)h[i+f]=h[r+f];i+=a}}else e.prototype.buildSkirtVertices.call(this,t,r,n,i)};var l=function(e){this.startLevel=e,this.level0NumTilesX=Math.pow(2,this.startLevel)};return l.prototype=new r,l.prototype.generateLevelZeroTiles=function(e){e.skirt=!e.coordinateSystem.isFlat,e.cullSign=1,e.srs="EPSG:3857",e.project=function(e){return[n(e[0]),i(e[1])]};for(var t=[],r=Math.pow(2,this.startLevel),o=Math.pow(2,this.startLevel),a=0;a<o;a++)for(var l=0;l<r;l++){var u=new s(this.startLevel,l,a);u.config=e,t.push(u)}return t},l.prototype._lon2LevelZeroIndex=function(e){var t=(e+180)/360;return Math.min(this.level0NumTilesX-1,Math.floor(t*this.level0NumTilesX))},l.prototype._lat2LevelZeroIndex=function(e){var t=Math.sin(e*Math.PI/180),r=.5-Math.log((1+t)/(1-t))/(4*Math.PI);return Math.min(this.level0NumTilesX-1,Math.floor(r*this.level0NumTilesX))},l}),r("Layer/BingLayer",["../Utils/Utils","../Layer/RasterLayer","../Tiling/MercatorTiling"],function(e,t,r){var n=function(){function e(e,t,r){return Math.min(Math.max(e,t),r)}function t(e){return 256<<e}function r(r,n,l){r=e(r,i,o),n=e(n,a,s);var u=(n+180)/360,h=Math.sin(r*Math.PI/180),c=.5-Math.log((1+h)/(1-h))/(4*Math.PI),d=t(l),f=e(u*d+.5,0,d-1),p=e(c*d+.5,0,d-1);return[Math.floor(f),Math.floor(p)]}function n(e,t,r){for(var n="",i=r;i>0;i--){var o="0",a=1<<i-1;0!==(e&a)&&o++,0!==(t&a)&&(o++,o++),n+=o}return n}var i=-85.05112878,o=85.05112878,a=-180,s=180;return{tileXYToQuadKey:n,latLongToPixelXY:r}}(),i=function(e){t.prototype.constructor.call(this,e),this.tilePixelSize=256,this.tiling=new r(e.baseLevel||2),this.numberOfLevels=18,this.baseUrl="",this.baseUrlSubDomains=[],this._ready=!1;var n=this;window._bingTileProviderCallback=function(t){n.baseUrl=t.resourceSets[0].resources[0].imageUrl,n.baseUrlSubDomains=t.resourceSets[0].resources[0].imageUrlSubdomains,n._ready=!0,e.onready&&e.onready instanceof Function&&e.onready(n),n.planet&&n.planet.renderContext.requestFrame()};var i=document.createElement("script");i.type="text/javascript",i.src="http://dev.virtualearth.net/REST/V1/Imagery/Metadata/"+e.imageSet+"?jsonp=_bingTileProviderCallback&key="+e.key,i.id="_bingTileProviderCallback",document.getElementsByTagName("head")[0].appendChild(i)};return e.inherits(t,i),i.prototype.getUrl=function(e){var t=this.baseUrl.replace("{quadkey}",n.tileXYToQuadKey(e.x,e.y,e.level));return t.replace("{subdomain}",this.baseUrlSubDomains[Math.floor(Math.random()*this.baseUrlSubDomains.length)])},i}),r("Renderer/GroundOverlayRenderer",["./Program","../Tiling/Tile"],function(e,t){var r=function(t){this.renderContext=t.renderContext,this.tileManager=t;var r="attribute vec3 vertex;\n";r+="attribute vec2 tcoord;\n",r+="uniform mat4 modelViewMatrix;\n",r+="uniform mat4 projectionMatrix;\n",r+="uniform vec4 extent; \n",r+="varying vec2 texCoord;\n",r+="void main(void) \n",r+="{\n",r+="\tgl_Position = projectionMatrix * modelViewMatrix * vec4(vertex, 1.0);\n",r+="\ttexCoord.x = tcoord.x * (extent[1] - extent[0]) + extent[0];\n",r+="\ttexCoord.y = tcoord.y * (extent[3] - extent[2]) + extent[2];\n",r+="}\n";var n="#ifdef GL_ES\n";n+="precision highp float;\n",n+="#endif\n",n+="\n",n+="varying vec2 texCoord;\n",n+="uniform sampler2D overlayTexture;\n",n+="uniform mat3 transform;\n",n+="uniform float opacity; \n",n+="\n",n+="void main(void)\n",n+="{\n",n+="\tvec3 tc = transform * vec3(texCoord,1.0); \n",n+="\ttc.xy /= tc.z; \n",n+="\tgl_FragColor.rgba = texture2D(overlayTexture, tc.xy); \n",n+="\tgl_FragColor.a = (tc.x >= 0.0 && tc.x <= 1.0 && tc.y >= 0.0 && tc.y <= 1.0) ? opacity * gl_FragColor.a  : 0.0; \n",n+="}\n",this.program=new e(this.renderContext),this.program.createFromSource(r,n),this.groundOverlays=[]};return r.prototype.render=function(e){var r=this.renderContext.gl;this.program.apply();var n=this.program.attributes;r.uniformMatrix4fv(this.program.uniforms.projectionMatrix,!1,this.renderContext.projectionMatrix),r.uniform1i(this.program.uniforms.overlayTexture,0),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.depthFunc(r.LEQUAL),r.depthMask(!1);for(var i=mat4.create(),o=null,a=0;a<this.groundOverlays.length;a++){var s=this.groundOverlays[a];if(s.image.complete){s.texture||(s.texture=this.renderContext.createNonPowerOfTwoTextureFromImage(s.image,s.flipY));for(var l=!1,u=0;u<e.length;u++){var h=e[u];if(s.geoBound.intersects(h.geoBound)){l||(r.uniformMatrix3fv(this.program.uniforms.transform,!1,s.inverseTransform),r.uniform1f(this.program.uniforms.opacity,s.opacity),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,s.texture),r.bindBuffer(r.ARRAY_BUFFER,this.tileManager.tcoordBuffer),r.vertexAttribPointer(n.tcoord,2,r.FLOAT,!1,0,0),l=!0);var c=h.state===t.State.LOADED?h.bound:h.parent.bound;r.uniform4f(this.program.uniforms.extent,c.west,c.east,c.north,c.south),mat4.multiply(this.renderContext.viewMatrix,h.matrix,i),r.uniformMatrix4fv(this.program.uniforms.modelViewMatrix,!1,i),r.bindBuffer(r.ARRAY_BUFFER,h.vertexBuffer),r.vertexAttribPointer(n.vertex,3,r.FLOAT,!1,0,0);var d=h.state===t.State.LOADED?this.tileManager.tileIndexBuffer.getSolid():this.tileManager.tileIndexBuffer.getSubSolid(h.parentIndex);o!==d&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,d),o=d),r.drawElements(r.TRIANGLES,d.numIndices,r.UNSIGNED_SHORT,0)}}}}r.disable(r.BLEND),r.depthMask(!0)},r}),r("Layer/GroundOverlayLayer",["../Utils/Utils","./BaseLayer","../Renderer/GeoBound","../Renderer/GroundOverlayRenderer"],function(e,t,r,n){var i=function(e){t.prototype.constructor.call(this,e),this.quad=e.quad,this.opacity=e.opacity||1,"undefined"==typeof e.flipY?this.flipY=!0:this.flipY=e.flipY,this.geoBound=new r,this.geoBound.computeFromCoordinates(this.quad),"string"==typeof e.image?(this.image=new Image,this.image.crossOrigin="",this.image.src=e.image):e.image instanceof HTMLImageElement&&(this.image=e.image),this.planet=null};return e.inherits(t,i),i.prototype._attach=function(e){var t=e.groundOverlayRenderer;t||(t=new n(e.tileManager),e.tileManager.addPostRenderer(t),e.groundOverlayRenderer=t),t.groundOverlays.push(this),this.planet=e,this.computeTransform()},i.prototype._detach=function(e){var t=this.planet.groundOverlayRenderer;if(t){var r=t.groundOverlays.indexOf(this);r!==-1&&(t.groundOverlays.splice(r,1),0===t.groundOverlays.length&&(this.planet.tileManager.removePostRenderer(t),this.planet.groundOverlayRenderer=null))}},i.prototype.computeInverse=function(){var e,t,r,n,i,o,a,s,l,u=this.transform[0]*(this.transform[8]*this.transform[4]-this.transform[5]*this.transform[7])-this.transform[3]*(this.transform[8]*this.transform[1]-this.transform[7])*this.transform[3]+this.transform[6]*(this.transform[5]*this.transform[1]-this.transform[4]*this.transform[2]);e=this.transform[4]*this.transform[8]-this.transform[5]*this.transform[7],n=this.transform[5]*this.transform[6]-this.transform[3]*this.transform[8],a=this.transform[3]*this.transform[7]-this.transform[4]*this.transform[6],t=this.transform[2]*this.transform[7]-this.transform[1]*this.transform[8],i=this.transform[0]*this.transform[8]-this.transform[2]*this.transform[6],s=this.transform[1]*this.transform[6]-this.transform[0]*this.transform[7],r=this.transform[1]*this.transform[5]-this.transform[2]*this.transform[4],o=this.transform[2]*this.transform[3]-this.transform[0]*this.transform[5],l=this.transform[0]*this.transform[4]-this.transform[1]*this.transform[3],this.inverseTransform=[e/u,t/u,r/u,n/u,i/u,o/u,a/u,s/u,l/u]},i.prototype.computeTransform=function(){var e=this.quad[0],t=this.quad[1],r=this.quad[2],n=this.quad[3],i=this.planet.tileManager.tileConfig;"EPSG:4326"!==i.srs&&(e=i.project(e),t=i.project(t),r=i.project(r),n=i.project(n));var o=e[0],a=t[0],s=r[0],l=n[0],u=e[1],h=t[1],c=r[1],d=n[1],f=o-a+s-l,p=u-h+c-d;if(f||p){var m,v,g,y,x,b,T,w,S=a-s,A=l-s,M=h-c,C=d-c,E=f*C-A*p,P=S*p-f*M,R=S*C-A*M;if(!R)return;T=E/R,w=P/R,m=a-o+T*a,v=l-o+w*l,g=o,y=h-u+T*h,x=d-u+w*d,b=u,this.transform=[m,y,T,v,x,w,g,b,1]}else this.transform=[a-o,h-u,0,s-a,c-h,0,o,u,1];this.computeInverse()},i}),r("Layer/OSMLayer",["../Utils/Utils","./RasterLayer","../Tiling/MercatorTiling"],function(e,t,r){var n=function(e){t.prototype.constructor.call(this,e),this.tilePixelSize=e.tilePixelSize||256,this.tiling=new r(e.baseLevel||2),this.numberOfLevels=e.numberOfLevels||21,this.baseUrl=e.baseUrl};return e.inherits(t,n),n.prototype.getUrl=function(e){var t=this.baseUrl+"/"+e.level+"/"+e.x+"/"+e.y+".png";return t},n}),r("Layer/TileWireframeLayer",["../Utils/Utils","./BaseLayer","../Renderer/Program","../Tiling/Tile"],function(e,t,r,n){var i=function(e){t.prototype.constructor.call(this,e),this.outline=!(!e||!e.outline)&&e.outline,this.color=e&&e.color?e.color:[1,1,1],this.planet=null,this.program=null,this.indexBuffer=null,this.subIndexBuffer=[null,null,null,null],this.zIndex=-1};return e.inherits(t,i),i.prototype.buildIndexBuffer=function(){var e,t,r,n,i,o,a=this.planet.renderContext.gl,s=this.planet.tileManager.tileConfig.tesselation,l=[],u=this.outline?s-1:1;for(t=0;t<s;t+=u)for(e=0;e<s-1;e++)l.push(t*s+e),l.push(t*s+e+1);for(t=0;t<s;t+=u)for(e=0;e<s-1;e++)l.push(e*s+t),l.push((e+1)*s+t);o=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,o),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(l),a.STATIC_DRAW),o.numIndices=l.length,this.indexBuffer=o;var h=(s-1)/2;for(u=this.outline?h:1,r=0;r<4;r++){for(e=r%2,t=Math.floor(r/2),l=[],n=h*t;n<h*(t+1)+1;n+=u)for(i=h*e;i<h*(e+1);i++)l.push(n*s+i),l.push(n*s+i+1);for(n=h*e;n<h*(e+1)+1;n+=u)for(i=h*t;i<h*(t+1);i++)l.push(i*s+n),l.push((i+1)*s+n);o=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,o),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(l),a.STATIC_DRAW),o.numIndices=l.length,this.subIndexBuffer[r]=o}},i.prototype._attach=function(e){if(t.prototype._attach.call(this,e),this._visible&&this.planet.tileManager.addPostRenderer(this),!this.program){var n="attribute vec3 vertex;\n";n+="uniform mat4 modelViewMatrix;\n",n+="uniform mat4 projectionMatrix;\n",n+="void main(void) \n",n+="{\n",n+="\tgl_Position = projectionMatrix * modelViewMatrix * vec4(vertex, 1.0);\n",n+="}\n";var i="precision highp float; \n";i+="uniform vec3 color; \n",i+="uniform float alpha; \n",i+="void main(void)\n",i+="{\n",i+="\tgl_FragColor = vec4(color,alpha);\n",i+="}\n",this.program=new r(this.planet.renderContext),this.program.createFromSource(n,i),this.buildIndexBuffer()}},i.prototype._detach=function(){this.planet.tileManager.removePostRenderer(this),t.prototype._detach.call(this)},i.prototype.render=function(e){var t=this.planet.renderContext,r=t.gl;r.enable(r.BLEND),this.program.apply(),r.uniformMatrix4fv(this.program.uniforms.projectionMatrix,!1,t.projectionMatrix);for(var i=this.program.attributes.vertex,o=null,a=0;a<e.length;a++){var s=e[a],l=s.state===n.State.LOADED,u=s.parentIndex===-1;mat4.multiply(t.viewMatrix,s.matrix,t.modelViewMatrix),r.uniformMatrix4fv(this.program.uniforms.modelViewMatrix,!1,t.modelViewMatrix),r.uniform3f(this.program.uniforms.color,this.color[0],this.color[1],this.color[2]),r.uniform1f(this.program.uniforms.alpha,this.getOpacity()),r.bindBuffer(r.ARRAY_BUFFER,s.vertexBuffer),r.vertexAttribPointer(i,3,r.FLOAT,!1,4*s.config.vertexSize,0);var h=l||u?this.indexBuffer:this.subIndexBuffer[s.parentIndex];o!==h&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,h),o=h);o.numIndices;r.drawElements(r.LINES,o.numIndices,r.UNSIGNED_SHORT,0)}r.disable(r.BLEND)},i.prototype.setVisible=function(e){return t.prototype.setVisible.call(this,e),"boolean"==typeof e&&(this._visible?this.planet.tileManager.addPostRenderer(this):this.planet.tileManager.removePostRenderer(this)),this._visible},i}),r("Tiling/Mesh",[],function(){var e=function(e){this.renderContext=e,this.vertexBuffer=null,this.tcoordBuffer=null,this.indexBuffer=null,this.colorBuffer=null,this.numVertices=0,this.mode=e.gl.TRIANGLES};return e.prototype.setVertices=function(e){var t=this.renderContext.gl;null===this.vertexBuffer&&(this.vertexBuffer=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW),this.numVertices=e.length},e.prototype.setTexCoords=function(e){var t=this.renderContext.gl;null===this.tcoordBuffer&&(this.tcoordBuffer=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,this.tcoordBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW)},e.prototype.setColors=function(e){var t=this.renderContext.gl;null===this.colorBuffer&&(this.colorBuffer=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW)},e.prototype.setIndices=function(e){var t=this.renderContext.gl;null===this.indexBuffer&&(this.indexBuffer=t.createBuffer()),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),t.STATIC_DRAW),this.numIndices=e.length},e.prototype.setIndicesToWireframe=function(e){this.mode=this.renderContext.gl.LINES;var t=[];t.length=2*e.length;for(var r=0;r<e.length;r+=3)t[2*r]=e[r],t[2*r+1]=e[r+1],t[2*r+2]=e[r+1],t[2*r+3]=e[r+2],t[2*r+4]=e[r+2],t[2*r+5]=e[r];this.setIndices(t);
},e.prototype.render=function(e){var t=this.renderContext.gl;t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.vertexAttribPointer(e.vertex,3,t.FLOAT,!1,0,0),e.hasOwnProperty("tcoord")&&(t.bindBuffer(t.ARRAY_BUFFER,this.tcoordBuffer),t.vertexAttribPointer(e.tcoord,2,t.FLOAT,!1,0,0)),e.hasOwnProperty("color")&&(t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.vertexAttribPointer(e.color,4,t.FLOAT,!1,0,0)),this.indexBuffer?(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),t.drawElements(this.mode,this.numIndices,t.UNSIGNED_SHORT,0)):t.drawArrays(this.mode,0,this.numVertices/3)},e.prototype.dispose=function(){var e=this.renderContext.gl;this.indexBuffer&&e.deleteBuffer(this.indexBuffer),this.vertexBuffer&&e.deleteBuffer(this.vertexBuffer),this.tcoordBuffer&&e.deleteBuffer(this.tcoordBuffer),this.colorBuffer&&e.deleteBuffer(this.colorBuffer),this.indexBuffer=null,this.vertexBuffer=null,this.tcoordBuffer=null,this.colorBuffer=null},e}),r("Layer/CoordinateGridLayer",["./BaseLayer","../Utils/Utils","../Renderer/Ray","../Renderer/Program","../Tiling/Mesh","../CoordinateSystem/AstroCoordTransform","../Renderer/FeatureStyle"],function(e,t,r,n,i,o,a){var s=function(e){var t=e,r=[],n=function(e){var r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r},i=function(e){var n=r.pop();return t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),n};this.createGLTexture=function(e){return r.length>0?i(e):n(e)},this.disposeGLTexture=function(e){r.push(e)},this.disposeAll=function(){for(var e=0;e<r.length;e++)t.deleteTexture(r[e]);r.length=0}},l=function(t){e.prototype.constructor.call(this,t),this.planet=null,this.labels={},this.texturePool=null,this.longitudeSample=t.longitudeSample||15,this.latitudeSample=t.latitudeSample||10,this.canvas2d=document.createElement("canvas"),this.canvas2d.width=100,this.canvas2d.height=20,this.vertexBuffer=null,this.indexBuffer=null,this.color=t.color||[1,1,1],this.coordSystem=t.coordSystem?t.coordSystem:"EQ",this.longFormat=t.longFormat?t.longFormat:"Deg",this.latFormat=t.latFormat?t.latFormat:"Deg",this.geoBound={},this.tesselation=t.tesselation||2};return t.inherits(e,l),l.prototype.generateImageData=function(e){var t=this.canvas2d.getContext("2d");t.clearRect(0,0,this.canvas2d.width,this.canvas2d.height),t.fillStyle=a.fromColorToString(this.color),t.font="18px sans-serif",t.textBaseline="top",t.textAlign="center";var r=this.canvas2d.width/2;return t.fillText(e,r,0),t.getImageData(0,0,this.canvas2d.width,this.canvas2d.height)},l.prototype._attach=function(t){if(e.prototype._attach.call(this,t),this._visible&&this.planet.tileManager.addPostRenderer(this),!this.gridProgram){var r="attribute vec3 vertex;\n";r+="uniform mat4 viewProjectionMatrix;\n",r+="void main(void) \n",r+="{\n",r+="gl_Position = viewProjectionMatrix * vec4(vertex, 1.0);\n",r+="}\n";var o="precision highp float; \n";o+="uniform float alpha; \n",o+="uniform vec3 color; \n",o+="void main(void)\n",o+="{\n",o+="gl_FragColor = vec4(color,alpha);\n",o+="}\n";var a="attribute vec3 vertex; // vertex have z = 0, spans in x,y from -0.5 to 0.5 \n";a+="uniform mat4 viewProjectionMatrix; \n",a+="uniform vec3 poiPosition; // world position \n",a+="uniform vec2 poiScale; // x,y scale \n",a+="\n",a+="varying vec2 texCoord; \n",a+="\n",a+="void main(void)  \n",a+="{ \n",a+="// Generate texture coordinates, input vertex goes from -0.5 to 0.5 (on x,y) \n",a+="texCoord = vertex.xy + vec2(0.5); \n",a+="// Invert y \n",a+="texCoord.y = 1.0 - texCoord.y; \n",a+="\n",a+="// Compute poi position in clip coordinate \n",a+="gl_Position = viewProjectionMatrix * vec4(poiPosition, 1.0); \n",a+="gl_Position.xy += vertex.xy * gl_Position.w * poiScale; \n",a+="} \n";var l="#ifdef GL_ES \n";l+="precision highp float; \n",l+="#endif \n",l+="\n",l+="varying vec2 texCoord; \n",l+="uniform sampler2D texture; \n",l+="uniform float alpha; \n",l+="\n",l+="void main(void) \n",l+="{ \n",l+="\tvec4 textureColor = texture2D(texture, texCoord); \n",l+="\tgl_FragColor = vec4(textureColor.rgb, textureColor.a * alpha); \n",l+="} \n",this.gridProgram=new n(this.planet.renderContext),this.labelProgram=new n(this.planet.renderContext),this.gridProgram.createFromSource(r,o),this.labelProgram.createFromSource(a,l)}this.labelMesh=new i(this.planet.renderContext);var u=[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],h=[0,3,1,1,3,2];this.labelMesh.setVertices(u),this.labelMesh.setIndices(h);var c=this.planet.renderContext.gl;this.vertexBuffer=c.createBuffer(),this.indexBuffer=c.createBuffer(),this.texturePool||(this.texturePool=new s(c))},l.prototype._detach=function(){var t=this.planet.renderContext.gl;t.deleteBuffer(this.vertexBuffer),t.deleteBuffer(this.indexBuffer),this.texturePool.disposeAll();for(var r in this.labels)delete this.labels[r];this.planet.tileManager.removePostRenderer(this),e.prototype._detach.call(this)},l.prototype.clampGeoBound=function(e){return e.west=Math.floor(e.west/this.longitudeSample)*this.longitudeSample,e.east=Math.ceil(e.east/this.longitudeSample)*this.longitudeSample,e.north=Math.ceil(e.north/this.latitudeSample)*this.latitudeSample,e.south=Math.floor(e.south/this.latitudeSample)*this.latitudeSample,e},l.prototype.render=function(e){var t=this.planet.renderContext,r=t.gl;r.disable(r.DEPTH_TEST),r.enable(r.BLEND),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA);var n;if("EQ"!==this.coordSystem){var i=this;n=this.planet.getViewportGeoBound(function(e){return i.planet.coordinateSystem.convert(e,"EQ",i.coordSystem)})}else n=this.planet.getViewportGeoBound();n=this.clampGeoBound(n),this.geoBound.west!==n.west||this.geoBound.east!==n.east||this.geoBound.north!==n.north||this.geoBound.south!==n.south?(this.geoBound=n,this.computeSamples(),this.generateGridBuffers(),this.generateLabels()):this.updateLabels(),this.gridProgram.apply(),mat4.multiply(t.projectionMatrix,t.viewMatrix,t.modelViewMatrix),r.uniformMatrix4fv(this.gridProgram.uniforms.viewProjectionMatrix,!1,t.modelViewMatrix),r.uniform1f(this.gridProgram.uniforms.alpha,this._opacity),r.uniform3f(this.gridProgram.uniforms.color,this.color[0],this.color[1],this.color[2]),r.bindBuffer(r.ARRAY_BUFFER,this.vertexBuffer),r.vertexAttribPointer(this.gridProgram.attributes.vertex,this.vertexBuffer.itemSize,r.FLOAT,!1,0,0),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.indexBuffer),r.drawElements(r.LINES,this.indexBuffer.numItems,r.UNSIGNED_SHORT,0),this.labelProgram.apply(),mat4.multiply(t.projectionMatrix,t.viewMatrix,t.modelViewMatrix),r.uniformMatrix4fv(this.labelProgram.uniforms.viewProjectionMatrix,!1,t.modelViewMatrix),r.uniform1i(this.labelProgram.uniforms.texture,0);var o=t.computePixelSizeVector();for(var a in this.labels){var s=this.labels[a];r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,s.texture);var l=[2*s.textureWidth/t.canvas.width,2*s.textureHeight/t.canvas.height];r.uniform2fv(this.labelProgram.uniforms.poiScale,l);var u=s.pos3d,h=s.vertical;l=s.textureHeight*(o[0]*u[0]+o[1]*u[1]+o[2]*u[2]+o[3]);var c=h[0]*l+u[0],d=h[1]*l+u[1],f=h[2]*l+u[2];r.uniform3f(this.labelProgram.uniforms.poiPosition,c,d,f),r.uniform1f(this.labelProgram.uniforms.alpha,1),this.labelMesh.render(this.labelProgram.attributes),s.needed=!1}r.enable(r.DEPTH_TEST),r.disable(r.BLEND)},l.prototype.setVisible=function(t){e.prototype.setVisible.call(this,t),"boolean"==typeof t&&(this._visible?this.planet.tileManager.addPostRenderer(this):this.planet.tileManager.removePostRenderer(this))},l.prototype.computeSamples=function(){var e=this.geoBound.east-this.geoBound.west;for(this.geoBound.north-this.geoBound.south;e/this.longitudeSample<3&&this.longitudeSample>1;)this.longitudeSample/=2,this.latitudeSample/=2;for(;e/this.longitudeSample>7&&this.longitudeSample<15;)this.longitudeSample*=2,this.latitudeSample*=2},l.prototype.generateGridBuffers=function(){var e,t,r,n,i;this.geoBound.east-this.geoBound.west>180?(e=0,t=360):(e=this.geoBound.west,t=this.geoBound.east);var o=[],a=180/this.latitudeSample;for(r=0;r<=a;r++){var s=r*Math.PI/a,l=Math.sin(s),u=Math.cos(s);for(n=e;n<=t;n+=this.longitudeSample){var h=this.longitudeSample/this.tesselation;for(i=0;i<this.tesselation;i++){var c=(n+i*h)*Math.PI/180,d=Math.sin(c),f=Math.cos(c),p=f*l*this.planet.coordinateSystem.geoide.radius,m=d*l*this.planet.coordinateSystem.geoide.radius,v=u*this.planet.coordinateSystem.geoide.radius;if("EQ"!==this.coordSystem){var g=this.planet.coordinateSystem.from3DToGeo([p,m,v]);g=this.planet.coordinateSystem.convert(g,this.coordSystem,"EQ");var y=this.planet.coordinateSystem.fromGeoTo3D(g);o.push(y[0],y[1],y[2])}else o.push(p,m,v)}}}var x=this.planet.renderContext.gl;x.bindBuffer(x.ARRAY_BUFFER,this.vertexBuffer),x.bufferData(x.ARRAY_BUFFER,new Float32Array(o),x.STATIC_DRAW),this.vertexBuffer.itemSize=3,this.vertexBuffer.numItems=o.length/3;var b=[],T=(t-e)/this.longitudeSample+1;for(T*=this.tesselation,r=0;r<a;r++)for(n=e,longNumber=0;n<t;n+=this.longitudeSample,longNumber+=this.tesselation){var w=r*T+longNumber%(T-1),S=w+T;for(i=0;i<this.tesselation;i++)b.push(w+i),b.push(w+i+1);b.push(w+this.tesselation),b.push(S+this.tesselation),b.push(S),b.push(w)}x.bindBuffer(x.ELEMENT_ARRAY_BUFFER,this.indexBuffer),x.bufferData(x.ELEMENT_ARRAY_BUFFER,new Uint16Array(b),x.STATIC_DRAW),this.indexBuffer.itemSize=1,this.indexBuffer.numItems=b.length},l.prototype.buildAngle=function(e,t){var r;switch(e){case"Deg":r=t+"°";break;case"HMS":r=this.planet.coordinateSystem.fromDegreesToHMS(t);break;case"DMS":r=this.planet.coordinateSystem.fromDegreesToDMS(t);break;default:return console.error(e+" : format not supported"),null}return r},l.prototype.computeGeoCenter=function(){var e=r.createFromPixel(this.planet.renderContext,this.planet.renderContext.canvas.width/2,this.planet.renderContext.canvas.height/2),t=e.computePoint(e.sphereIntersect([0,0,0],this.planet.coordinateSystem.geoide.radius)),n=[];return this.planet.coordinateSystem.from3DToGeo(t,n),"EQ"!==this.coordSystem&&(n=this.planet.coordinateSystem.convert(n,"EQ",this.coordSystem)),n},l.prototype.updateLabel=function(e,t){"EQ"!==this.coordSystem&&(t=this.planet.coordinateSystem.convert(t,this.coordSystem,"EQ"));var r=this.planet.coordinateSystem.fromGeoTo3D(t),n=vec3.create();vec3.normalize(r,n),this.labels[e].pos3d=r,this.labels[e].vertical=n,this.labels[e].needed=!0},l.prototype.updateLabels=function(){var e=this.computeGeoCenter();for(var t in this.labels){var r;"lat"===this.labels[t].type?r=[this.labels[t].angle,e[1]]:"long"===this.labels[t].type&&(r=[e[0],this.labels[t].angle]),this.updateLabel(t,r)}},l.prototype.generateLabels=function(){var e,t,r,n,i,o,a,s;this.geoBound.east-this.geoBound.west>180?(t=0,e=360):(t=this.geoBound.west,e=this.geoBound.east);var l,u=this.computeGeoCenter();for(n=t;n<e;n+=this.longitudeSample)a=n<0?n+360:n,l=this.buildAngle(this.longFormat,a),this.labels["lat_"+l]||(this.labels["lat_"+l]={angle:n,type:"lat"},r=this.generateImageData(l),this._buildTextureFromImage(this.labels["lat_"+l],r)),o=[n,u[1]],this.updateLabel("lat_"+l,o);for(thetaStart=Math.min(this.geoBound.north,this.geoBound.south),thetaStop=Math.max(this.geoBound.north,this.geoBound.south),s=thetaStart;s<=thetaStop;s+=this.latitudeSample)l=this.buildAngle(this.latFormat,s),this.labels["long_"+l]||(this.labels["long_"+l]={angle:s,type:"long"},r=this.generateImageData(l),this._buildTextureFromImage(this.labels["long_"+l],r)),o=[u[0],s],this.updateLabel("long_"+l,o);for(i in this.labels)this.labels[i].needed||(this.texturePool.disposeGLTexture(this.labels[i].texture),delete this.labels[i])},l.prototype._buildTextureFromImage=function(e,t){e.texture=this.texturePool.createGLTexture(t),e.textureWidth=t.width,e.textureHeight=t.height},l}),r("Tiling/HEALPixTiling",["./Tile","./HEALPixBase","../Renderer/GeoBound","../CoordinateSystem/EquatorialCoordinateSystem","../Utils/Numeric"],function(e,t,r,n,i){var o=function(t,r,n){e.prototype.constructor.call(this),this.order=t,this.nside=Math.pow(2,this.order),this.pixelIndex=r,this.face=n,this.geoBound=null};o.prototype=new e,o.prototype.createChildren=function(){var e=new o(this.order+1,4*this.pixelIndex,this.face),t=new o(this.order+1,4*this.pixelIndex+2,this.face),r=new o(this.order+1,4*this.pixelIndex+1,this.face),n=new o(this.order+1,4*this.pixelIndex+3,this.face);e.initFromParent(this,0,0),t.initFromParent(this,1,0),r.initFromParent(this,0,1),n.initFromParent(this,1,1),this.children=[e,t,r,n]},o.prototype.computeLocalMatrix=function(e){for(var t=mat4.create(),r=vec3.create(),n=vec3.create(),i=vec3.create(),o=0,a=0,s=0,l=0;l<e.length;l++)o+=e[l][0],a+=e[l][1],s+=e[l][2];var u=vec3.create([o/e.length,a/e.length,s/e.length]);return vec3.set(u,i),vec3.normalize(i),vec3.subtract(e[0],e[3],n),vec3.cross(i,n,r),vec3.normalize(r),vec3.cross(i,r,n),vec3.normalize(n),t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=0,t[4]=n[0],t[5]=n[1],t[6]=n[2],t[7]=0,t[8]=i[0],t[9]=i[1],t[10]=i[2],t[11]=0,t[12]=u[0],t[13]=u[1],t[14]=u[2],t[15]=1,t},o.prototype.generateVertices=function(){for(var e=this.config.tesselation,n=[],i=1/(e-1),o=this.pixelIndex&this.nside*this.nside-1,a=t.compress_bits(o),s=t.compress_bits(o>>>1),l=this.config.coordinateSystem,u=0;u<e;u++)for(var h=0;h<e;h++){var c=t.fxyf((a+u*i)/this.nside,(s+h*i)/this.nside,this.face);if(c[0]*=this.config.coordinateSystem.geoide.radius,c[1]*=this.config.coordinateSystem.geoide.radius,c[2]*=this.config.coordinateSystem.geoide.radius,"EQ"!==this.config.coordSystem){var d=l.from3DToGeo(c),f=l.convert(d,this.config.coordSystem,"EQ");n[u*e+h]=l.fromGeoTo3D(f)}else n[u*e+h]=c}this.geoBound=new r;var p=[];p.push(l.from3DToGeo(n[0])),p.push(l.from3DToGeo(n[e-1])),p.push(l.from3DToGeo(n[e*(e-1)])),p.push(l.from3DToGeo(n[e*e-1])),this.geoBound.computeFromCoordinates(p),this.matrix=this.computeLocalMatrix(n);var m=mat4.create();mat4.inverse(this.matrix,m),this.inverseMatrix=m;for(var v=new Float32Array(3*e*e),g=0,y=0;y<n.length;y++)v[g]=m[0]*n[y][0]+m[4]*n[y][1]+m[8]*n[y][2]+m[12],v[g+1]=m[1]*n[y][0]+m[5]*n[y][1]+m[9]*n[y][2]+m[13],v[g+2]=m[2]*n[y][0]+m[6]*n[y][1]+m[10]*n[y][2]+m[14],g+=3;return v};var a=function(e,t){this.order=e,this.nside=Math.pow(2,this.order),this.coordSystem=t.coordSystem||"EQ"};a.prototype.generateLevelZeroTiles=function(e,t){e.skirt=!1,e.cullSign=-1,e.tesselation=5,e.coordSystem=this.coordSystem,this.coordinateSystem=e.coordinateSystem;for(var r=[],n=Math.pow(this.nside,2),i=12,a=i*n,s=0;s<a;s++){var l=Math.floor(s/n),u=new o(this.order,s,l);u.config=e,r.push(u)}return r};var s=function(e){var t,r;switch(e.type){case"Point":t=[],t.push(e.coordinates);break;case"MultiPoint":case"LineString":t=e.coordinates;break;case"MultiLineString":for(t=[],r=0;r<e.coordinates.length;r++)t=t.concat(e.coordinates[r]);break;case"Polygon":t=e.coordinates[0];break;case"MultiPolygon":for(t=[],r=0;r<e.coordinates.length;r++)t=t.concat(e.coordinates[r][0]);break;case"GeometryCollection":for(t=[],r=0;r<e.geometries.length;r++)t=t.concat(s(e.geometries[r]))}return t};return a.prototype.getOverlappedLevelZeroTiles=function(e){var t=[],r=s(e);if(!r)return console.log("Invalid geometry type or not supported."),t;for(var n={},i=0;i<r.length;i++){var o=this.lonlat2LevelZeroIndex(r[i][0],r[i][1]);n[o]||(n[o]=!0,t.push(o))}return t},a.prototype.lonlat2LevelZeroIndex=function(e,r){if("EQ"!==this.coordSystem){var n=this.coordinateSystem.convert([e,r],"EQ",this.coordSystem);e=n[0],r=n[1]}return t.lonLat2pix(this.order,e,r)},a.prototype.findInsideTile=function(e,r,n){if("EQ"!==this.coordSystem){var i=this.coordinateSystem.convert([e,r],"EQ",this.coordSystem);e=i[0],r=i[1]}for(var o=0;o<n.length;o++){var a=n[o],s=t.lonLat2pix(a.order,e,r);if(s===a.pixelIndex)return a}return null},a}),r("Renderer/ColorMap",["../Utils/Numeric"],function(e){function t(e,t,r,n,i,o){var a;if(n===e.UNSIGNED_BYTE)a=new Uint8Array(t);else{if(n!==e.FLOAT)return null;a=new Float32Array(t)}var s=e.createTexture();return e.bindTexture(e.TEXTURE_2D,s),e.texImage2D(e.TEXTURE_2D,0,r,i,o,0,r,n,a),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),s}var r={linear:[],asin:[],sqrt:[],sqr:[],log:[]},n=function(){for(var e in r){for(var t,n=Number.MAX_VALUE,i=Number.MIN_VALUE,o=[],a=0;a<256;a++){switch(t=a,e){case"linear":o[a]=t;break;case"asin":o[a]=Math.log(t+Math.sqrt(Math.pow(t,2)+1));break;case"log":o[a]=Math.log(t/10+1);break;case"sqrt":o[a]=Math.sqrt(t/10);break;case"sqr":o[a]=t*t}o[a]<n&&(n=o[a]),o[a]>i&&(i=o[a])}for(a=0;a<256;a++)t=256*((o[a]-n)/(i-n)),t>256?t=256:t<0&&(t=0),r[e][a]=Math.floor(t)}};n();var i={fire:{red:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,4,7,10,13,16,19,22,25,28,31,34,37,40,43,46,49,52,55,58,61,64,67,70,73,76,79,82,85,88,91,94,98,101,104,107,110,113,116,119,122,125,128,131,134,137,140,143,146,148,150,152,154,156,158,160,162,163,164,166,167,168,170,171,173,174,175,177,178,179,181,182,184,185,186,188,189,190,192,193,195,196,198,199,201,202,204,205,207,208,209,210,212,213,214,215,217,218,220,221,223,224,226,227,229,230,231,233,234,235,237,238,240,241,243,244,246,247,249,250,252,252,252,253,253,253,254,254,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],green:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,3,5,7,8,10,12,14,16,19,21,24,27,29,32,35,37,40,43,46,48,51,54,57,59,62,65,68,70,73,76,79,81,84,87,90,92,95,98,101,103,105,107,109,111,113,115,117,119,121,123,125,127,129,131,133,134,136,138,140,141,143,145,147,148,150,152,154,155,157,159,161,162,164,166,168,169,171,173,175,176,178,180,182,184,186,188,190,191,193,195,197,199,201,203,205,206,208,210,212,213,215,217,219,220,222,224,226,228,230,232,234,235,237,239,241,242,244,246,248,248,249,250,251,252,253,254,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],blue:[0,7,15,22,30,38,45,53,61,65,69,74,78,82,87,91,96,100,104,108,113,117,121,125,130,134,138,143,147,151,156,160,165,168,171,175,178,181,185,188,192,195,199,202,206,209,213,216,220,220,221,222,223,224,225,226,227,224,222,220,218,216,214,212,210,206,202,199,195,191,188,184,181,177,173,169,166,162,158,154,151,147,143,140,136,132,129,125,122,118,114,111,107,103,100,96,93,89,85,82,78,74,71,67,64,60,56,53,49,45,42,38,35,31,27,23,20,16,12,8,5,4,3,3,2,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,8,13,17,21,26,30,35,42,50,58,66,74,82,90,98,105,113,121,129,136,144,152,160,167,175,183,191,199,207,215,223,227,231,235,239,243,247,251,255,255,255,255,255,255,255,255]},eosb:{red:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,18,27,36,45,49,57,72,81,91,100,109,118,127,136,131,139,163,173,182,191,200,209,218,227,213,221,255,255,255,255,255,255,255,255,229,229,255,255,255,255,255,255,255,255,229,229,255,255,255,255,255,255,255,255,229,229,255,255,255,255,255,255,255,255,229,229,255,255,255,255,255,255,255,255,229,229,255,255,255,255,255,255,255,255,229,229,255,255,255,255,255,255,255,255,229,229,255,255,255,255,255,255,255,255,229,229,255,255,255,255,255,255,255,255,229,229,255,253,251,249,247,245,243,241,215,214,235,234,232,230,228,226,224,222,198,196,216,215,213,211,209,207,205,203,181,179,197,196,194,192,190,188,186,184,164,162,178,176,175,173,171,169,167,165,147,145,159,157,156,154,152,150,148,146,130,128,140,138,137,135,133,131,129,127,113,111,121,119,117,117],green:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,15,23,31,39,47,55,57,64,79,87,95,103,111,119,127,135,129,136,159,167,175,183,191,199,207,215,200,207,239,247,255,255,255,255,255,255,229,229,255,255,255,255,255,255,255,255,229,229,255,255,255,255,255,255,255,255,229,229,255,250,246,242,238,233,229,225,198,195,212,208,204,199,195,191,187,182,160,156,169,165,161,157,153,148,144,140,122,118,127,125,123,121,119,116,114,112,99,97,106,104,102,99,97,95,93,91,80,78,84,82,80,78,76,74,72,70,61,59,63,61,59,57,55,53,50,48,42,40,42,40,38,36,33,31,29,27,22,21,21,19,16,14,12,13,8,6,3,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],blue:[116,121,127,131,136,140,144,148,153,157,145,149,170,174,178,182,187,191,195,199,183,187,212,216,221,225,229,233,238,242,221,225,255,247,239,231,223,215,207,199,172,164,175,167,159,151,143,135,127,119,100,93,95,87,79,71,63,55,47,39,28,21,15,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},stern:{red:[0,18,36,54,72,90,108,127,145,163,199,217,235,254,249,244,239,234,229,223,218,213,208,203,197,192,187,182,177,172,161,156,151,146,140,135,130,125,120,115,109,104,99,94,89,83,78,73,68,63,52,47,42,37,32,26,21,16,11,6,64,65,66,67,68,69,70,71,72,73,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,117,118,119,120,121,122,123,124,125,126,128,129,130,131,132,133,134,135,136,137,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,181,182,183,184,185,186,187,188,189,190,192,193,194,195,196,197,198,199,200,201,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,245,246,247,248,249,250,251,252,253,254],green:[0,1,2,3,4,5,6,7,8,9,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,53,54,55,56,57,58,59,60,61,62,64,65,66,67,68,69,70,71,72,73,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,117,118,119,120,121,122,123,124,125,126,128,129,130,131,132,133,134,135,136,137,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,181,182,183,184,185,186,187,188,189,190,192,193,194,195,196,197,198,199,200,201,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,245,246,247,248,249,250,251,252,253,254],blue:[0,1,3,5,7,9,11,13,15,17,21,23,25,27,29,31,33,35,37,39,41,43,45,47,49,51,53,55,57,59,63,65,67,69,71,73,75,77,79,81,83,85,87,89,91,93,95,97,99,101,105,107,109,111,113,115,117,119,121,123,127,129,131,133,135,137,139,141,143,145,149,151,153,155,157,159,161,163,165,167,169,171,173,175,177,179,181,183,185,187,191,193,195,197,199,201,203,205,207,209,211,213,215,217,219,221,223,225,227,229,233,235,237,239,241,243,245,247,249,251,255,251,247,243,238,234,230,226,221,217,209,204,200,196,192,187,183,179,175,170,166,162,158,153,149,145,141,136,132,128,119,115,111,107,102,98,94,90,85,81,77,73,68,64,60,56,51,47,43,39,30,26,22,17,13,9,5,0,3,7,15,19,22,26,30,34,38,41,45,49,57,60,64,68,72,76,79,83,87,91,95,98,102,106,110,114,117,121,125,129,137,140,144,148,152,156,159,163,167,171,175,178,182,186,190,194,197,201,205,209,216,220,224,228,232,235,239,243,247,251]},rainbow:{red:[0,4,9,13,18,22,27,31,36,40,45,50,54,58,61,64,68,69,72,74,77,79,80,82,83,85,84,86,87,88,86,87,87,87,85,84,84,84,83,79,78,77,76,71,70,68,66,60,58,55,53,46,43,40,36,33,25,21,16,12,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,8,12,21,25,29,33,42,46,51,55,63,67,72,76,80,89,93,97,101,110,114,119,123,131,135,140,144,153,157,161,165,169,178,182,187,191,199,203,208,212,221,225,229,233,242,246,250,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],green:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,8,16,21,25,29,38,42,46,51,55,63,67,72,76,84,89,93,97,106,110,114,119,127,131,135,140,144,152,157,161,165,174,178,182,187,195,199,203,208,216,220,225,229,233,242,246,250,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,250,242,238,233,229,221,216,212,208,199,195,191,187,178,174,170,165,161,153,148,144,140,131,127,123,119,110,106,102,97,89,85,80,76,72,63,59,55,51,42,38,34,29,21,17,12,8,0],blue:[0,3,7,10,14,19,23,28,32,38,43,48,53,59,63,68,72,77,81,86,91,95,100,104,109,113,118,122,127,132,136,141,145,150,154,159,163,168,173,177,182,186,191,195,200,204,209,214,218,223,227,232,236,241,245,250,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,246,242,238,233,225,220,216,212,203,199,195,191,187,178,174,170,165,157,152,148,144,135,131,127,123,114,110,106,102,97,89,84,80,76,67,63,59,55,46,42,38,34,25,21,16,12,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},grey:{red:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255],green:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255],blue:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255]}};return{addCustomColormap:function(t,r){if(r.length<2)return console.error("Colors length must be >= 2"),null;for(var n=256,o={red:[],green:[],blue:[]},a=r.length-1,s=0;s<a;s++)for(var l=r[s],u=r[s+1],h=n/(r.length-1),c=o.red.length,d=Math.floor((s+1)*h),f=c;f<d;f++)o.red.push(e.lerp(f/d,l[0],u[0])),o.green.push(e.lerp(f/d,l[1],u[1])),o.blue.push(e.lerp(f/d,l[2],u[2]));i[t]=o},generateColormap:function(e,n,o,a){var s,l,u,h=r[n],c=[];s=i[o].red,l=i[o].green,u=i[o].blue;for(var d=s.length-1,f=0;f<256;f++){var p=h[f];p>d?p=d:p<0&&(p=0),a&&(p=d-p),c[3*f]=s[p]/256,c[3*f+1]=l[p]/256,c[3*f+2]=u[p]/256}return t(e,c,e.RGB,e.FLOAT,c.length/3,1)}}}),r("Renderer/DynamicImage",["./ColorMap"],function(e){var t="precision highp float; \n";t+="varying vec2 vTextureCoord;\n",t+="uniform sampler2D texture; \n",t+="uniform sampler2D colormap; \n",t+="uniform float min; \n",t+="uniform float max; \n",t+="uniform vec4 color; \n",t+="void main(void)\n",t+="{\n",t+="\tfloat i = texture2D(texture,vTextureCoord).r;\n",t+="\tfloat d = clamp( ( i - min ) / (max - min), 0.0, 1.0 );\n",t+="\tvec4 cmValue = texture2D(colormap, vec2(d,0.));\n",t+="\tgl_FragColor = vec4(cmValue.r,cmValue.g,cmValue.b,color.a);\n",t+="}\n";var r=function(e,t,r){r||(r=t.polygonProgram),e.uniform1f(r.uniforms.max,t.style.uniformValues.tmax),e.uniform1f(r.uniforms.min,t.style.uniformValues.tmin),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,t.style.uniformValues.colormapTex),e.uniform1i(r.uniforms.colormap,1)},n=function(e,n,i,o,a,s,l){t=l&&l.fragmentCode?l.fragmentCode:t,r=l&&l.updateUniforms?l.updateUniforms:r,this.fragmentCode=t,this.updateUniforms=r,this.tmin=0,this.tmax=1,this.colormapTex=null,this.renderContext=e,this.pixels=n,this.transferFn="raw",this.inverse=!1;var u=e.gl,h=u.createTexture();if(u.bindTexture(u.TEXTURE_2D,h),u.texImage2D(u.TEXTURE_2D,0,i,a,s,0,i,o,n),o===u.FLOAT){var c=u.getExtension("OES_texture_float_linear"),d=c?u.LINEAR:u.NEAREST;u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,d),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,d)}else u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.LINEAR_MIPMAP_LINEAR),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.LINEAR);u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),this.texture=h,this.width=a,this.height=s,
this.computeMinMax(n),e.requestFrame()};return n.prototype.computeMinMax=function(e){for(var t=Number.MIN_VALUE,r=Number.MAX_VALUE,n=1;n<e.length;n++){var i=e[n];isNaN(i)||(t<i&&(t=i),r>i&&(r=i))}this.min=r,this.max=t,this.tmax=t,this.tmin=r},n.prototype.updateColormap=function(n,i,o){var a=this.renderContext.gl;"raw"!==n?(this.fragmentCode=t,this.updateUniforms=r,this.colormapTex&&a.deleteTexture(this.colormapTex),this.colormapTex=e.generateColormap(a,n,i,o)):(this.fragmentCode=null,this.updateUniforms=null),this.transferFn=n,this.inverse=o},n.prototype.dispose=function(){var e=this.renderContext.gl;this.colormapTex&&e.deleteTexture(this.colormapTex),this.texture&&e.deleteTexture(this.texture),this.colormapTex=null,this.texture=null},n}),function(){var e,t,r,n,i,o,a,s,l,u,h,c,d,f,p,m=[].indexOf||function(e){for(var t=0,r=this.length;t<r;t++)if(t in this&&this[t]===e)return t;return-1},v={}.hasOwnProperty,g=function(e,t){function r(){this.constructor=e}for(var n in t)v.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},y=[].slice,x=function(e,t){return function(){return e.apply(t,arguments)}};null==this.astro&&(this.astro={}),i={},i.version="0.2.3",this.astro.FITS=i,p=["included","extended"],c=function(){function e(){}return e.include=function(e){var t,r,n;if(!e)throw"include(obj) requires obj";for(t in e)r=e[t],m.call(p,t)<0&&(this.prototype[t]=r);return null!=(n=e.included)&&n.apply(this),this},e.extend=function(e){var t,r,n;if(!e)throw"extend(obj) requires obj";for(t in e)r=e[t],m.call(p,t)<0&&(this[t]=r);return null!=(n=e.extended)&&n.apply(this),this},e.proxy=function(e){var t=this;return function(){return e.apply(t,arguments)}},e.prototype.proxy=function(e){var t=this;return function(){return e.apply(t,arguments)}},e}(),this.astro.FITS.Module=c,r=function(e){function t(e,t){this.view=e,this.begin=this.current=e.tell(),this.length=void 0}return g(t,e),t}(c),this.astro.FITS.DataUnit=r,l={verifyOrder:function(e,t){if(t!==this.cardIndex)return console.warn(""+e+" should appear at index "+this.cardIndex+" in the FITS header")},verifyBetween:function(e,t,r,n){if(!(t>=r&&t<=n))throw"The "+e+" value of "+t+" is not between "+r+" and "+n},verifyBoolean:function(e){return"T"===e},Functions:{SIMPLE:function(){var e,t;return e=1<=arguments.length?y.call(arguments,0):[],t=arguments[0],this.primary=!0,this.verifyOrder("SIMPLE",0),this.verifyBoolean(t)},XTENSION:function(){var e,t;return e=1<=arguments.length?y.call(arguments,0):[],t=arguments[0],this.extension=!0,this.extensionType=t,this.verifyOrder("XTENSION",0),t},BITPIX:function(){var e,t,r;if(e=1<=arguments.length?y.call(arguments,0):[],t="BITPIX",r=parseInt(arguments[0]),this.verifyOrder(t,1),8!==r&&16!==r&&32!==r&&64!==r&&r!==-32&&r!==-64)throw""+t+" value "+r+" is not permitted";return r},NAXIS:function(){var e,t,r,n,i,o;if(e=1<=arguments.length?y.call(arguments,0):[],r="NAXIS",i=parseInt(arguments[0]),t=arguments[1],!t&&(this.verifyOrder(r,2),this.verifyBetween(r,i,0,999),this.isExtension()&&("TABLE"===(o=this.extensionType)||"BINTABLE"===o)&&(n=2,i!==n)))throw""+r+" must be "+n+" for TABLE and BINTABLE extensions";return i},PCOUNT:function(){var e,t,r,n,i,o;if(e=1<=arguments.length?y.call(arguments,0):[],t="PCOUNT",i=parseInt(arguments[0]),r=3+this.NAXIS,this.verifyOrder(t,r),this.isExtension()&&("IMAGE"===(o=this.extensionType)||"TABLE"===o)&&(n=0,i!==n))throw""+t+" must be "+n+" for the "+this.extensionType+" extensions";return i},GCOUNT:function(){var e,t,r,n,i,o;if(e=1<=arguments.length?y.call(arguments,0):[],t="GCOUNT",i=parseInt(arguments[0]),r=3+this.NAXIS+1,this.verifyOrder(t,r),this.isExtension()&&("IMAGE"===(o=this.extensionType)||"TABLE"===o||"BINTABLE"===o)&&(n=1,i!==n))throw""+t+" must be "+n+" for the "+this.extensionType+" extensions";return i},EXTEND:function(){var e,t,r;if(e=1<=arguments.length?y.call(arguments,0):[],t="EXTEND",r=arguments[0],!this.isPrimary())throw""+t+" must only appear in the primary header";return this.verifyBoolean(r)},BSCALE:function(){var e;return e=1<=arguments.length?y.call(arguments,0):[],parseFloat(arguments[0])},BZERO:function(){var e;return e=1<=arguments.length?y.call(arguments,0):[],parseFloat(arguments[0])},BLANK:function(){var e,t,r;return e=1<=arguments.length?y.call(arguments,0):[],t="BLANK",r=arguments[0],parseInt(r)},DATAMIN:function(){var e;return e=1<=arguments.length?y.call(arguments,0):[],parseFloat(arguments[0])},DATAMAX:function(){var e;return e=1<=arguments.length?y.call(arguments,0):[],parseFloat(arguments[0])},EXTVER:function(){var e,t,r;return e=1<=arguments.length?y.call(arguments,0):[],t="EXTVER",r=arguments[0],r=parseInt(r)},EXTLEVEL:function(){var e,t,r;return e=1<=arguments.length?y.call(arguments,0):[],t="EXTLEVEL",r=arguments[0],r=parseInt(r)},TFIELDS:function(){var e,t,r;return e=1<=arguments.length?y.call(arguments,0):[],t="TFIELDS",r=arguments[0],r=parseInt(r),this.verifyBetween(t,r,0,999),r},TBCOL:function(){var e,t,r,n;return e=1<=arguments.length?y.call(arguments,0):[],r="TBCOL",n=arguments[0],t=arguments[2],this.verifyBetween(r,t,0,this.TFIELDS),n},ZIMAGE:function(){var e,t,r;return e=1<=arguments.length?y.call(arguments,0):[],t="ZIMAGE",r=arguments[0],this.verifyBoolean(r)},ZCMPTYPE:function(){var e,t,r;if(e=1<=arguments.length?y.call(arguments,0):[],t="ZCMPTYPE",r=arguments[0],"GZIP_1"!==r&&"RICE_1"!==r&&"PLIO_1"!==r&&"HCOMPRESS_1"!==r)throw""+t+" value "+r+" is not permitted";if("RICE_1"!==r&&"GZIP_1"!==r)throw"Compress type "+r+" is not yet implement";return r},ZBITPIX:function(){var e,t,r;if(e=1<=arguments.length?y.call(arguments,0):[],t="ZBITPIX",r=parseInt(arguments[0]),8!==r&&16!==r&&32!==r&&64!==r&&r!==-32&&r!==-64)throw""+t+" value "+r+" is not permitted";return r},ZNAXIS:function(){var e,t,r,n;return e=1<=arguments.length?y.call(arguments,0):[],r="ZNAXIS",n=parseInt(arguments[0]),t=arguments[1],n=n,t||this.verifyBetween(r,n,0,999),n},ZTILE:function(){var e,t;return e=1<=arguments.length?y.call(arguments,0):[],t="ZTILE",parseInt(arguments[0])},ZSIMPLE:function(){var e;return e=1<=arguments.length?y.call(arguments,0):[],"T"===arguments[0]},ZPCOUNT:function(){var e,t;return e=1<=arguments.length?y.call(arguments,0):[],t="ZPCOUNT",parseInt(arguments[0])},ZGCOUNT:function(){var e,t;return e=1<=arguments.length?y.call(arguments,0):[],t="ZGCOUNT",parseInt(arguments[0])}}},this.astro.FITS.HeaderVerify=l,s=function(e){function t(){this.init=x(this.init,this);var e,t,r;this.primary=!1,this.extension=!1,this.verifyCard={},r=this.Functions;for(t in r)e=r[t],this.verifyCard[t]=this.proxy(e);this.cards={},this.cardIndex=0}return g(t,e),t.keywordPattern=/^([A-Z0-9_-]+)\s*=\s*(.*)/,t.nonStringPattern=/([^\/]*)\s*\/*(.*)/,t.stringPattern=/'(.*)'\s*\/*(.*)/,t.arrayPattern=/([A-Za-z]+)(\d+)/,t.include(l),t.prototype.get=function(e){return this.contains(e)?this.cards[e]:console.warn("Header does not contain the key "+e)},t.prototype.getIndex=function(e){return this.contains(e)?this.cards[e][0]:console.warn("Header does not contain the key "+e)},t.prototype.getComment=function(e){return this.contains(e)?null!=this.cards[e][2]?this.cards[e][2]:console.warn(""+e+" does not contain a comment"):console.warn("Header does not contain the key "+e)},t.prototype.getComments=function(){return this.contains("COMMENT")?this.cards.COMMENT:console.warn("Header does not contain any COMMENT fields")},t.prototype.getHistory=function(){return this.contains("HISTORY")?this.cards.HISTORY:console.warn("Header does not contain any HISTORY fields")},t.prototype.set=function(e,t,r){return this.cards[e]=r?[this.cardIndex,t,r]:[this.cardIndex,t],this.cardIndex+=1},t.prototype.setComment=function(e){return this.contains("COMMENT")||(this.cards.COMMENT=[],this.cardIndex+=1),this.cards.COMMENT.push(e)},t.prototype.setHistory=function(e){return this.contains("HISTORY")||(this.cards.HISTORY=[],this.cardIndex+=1),this.cards.HISTORY.push(e)},t.prototype.contains=function(e){return this.cards.hasOwnProperty(e)},t.prototype.readCard=function(e){var r,n,i,o,a,s,l,u,h,c,d,f;if(s=e.match(t.keywordPattern),null!=s)switch(u=s.slice(1),o=u[0],l=u[1],"COMMENT"===o||"HISTORY"===o?s[1]=l.trim():"'"===l[0]?(s=l.match(t.stringPattern),s[1]=s[1].trim()):(s=l.match(t.nonStringPattern),s[1]="T"===(h=s[1][0])||"F"===h?s[1].trim():parseFloat(s[1])),s[2]=s[2].trim(),c=s.slice(1),l=c[0],n=c[1],a=o,d=[!1,void 0],r=d[0],i=d[1],s=o.match(t.arrayPattern),null!=s&&(a=s[1],f=[!0,s[2]],r=f[0],i=f[1]),this.verifyCard.hasOwnProperty(a)&&(l=this.verifyCard[a](l,r,i)),o){case"COMMENT":return this.setComment(l);case"HISTORY":return this.setHistory(l);default:return this.set(o,l,n),this.__defineGetter__(o,function(){return this.cards[o][1]})}},t.prototype.init=function(e){var t,r,n,i,o,a,s,l;for(n=80,o=e.length/n,i=600,o=o<i?o:i,l=[],t=a=0,s=o-1;0<=s?a<=s:a>=s;t=0<=s?++a:--a)r=e.slice(t*n,(t+1)*n),l.push(this.readCard(r));return l},t.prototype.hasDataUnit=function(){return 0!==this.NAXIS},t.prototype.isPrimary=function(){return this.primary},t.prototype.isExtension=function(){return this.extension},t}(c),this.astro.FITS.Header=s,h={initArray:function(e){return this.data=new e(this.width*this.height)},getExtremes:function(){var e,t,r,n,i,o;if(null!=this.min&&null!=this.max)return[this.min,this.max];for(e=this.data.length;e--;)if(n=this.data[e],!isNaN(n)){i=[n,n],r=i[0],t=i[1];break}for(;e--;)n=this.data[e],isNaN(n)||(n<r&&(r=n),n>t&&(t=n));return o=[r,t],this.min=o[0],this.max=o[1],[this.min,this.max]},getPixel:function(e,t){return this.data[t*this.width+e]}},this.astro.FITS.ImageUtils=h,u=function(e){function t(e,r){var n,i,o,a,s=this;for(t.__super__.constructor.apply(this,arguments),o=r.NAXIS,n=r.BITPIX,this.naxis=[],i=a=1;1<=o?a<=o:a>=o;i=1<=o?++a:--a)this.naxis.push(r["NAXIS"+i]);switch(this.width=r.NAXIS1,this.height=r.NAXIS2||1,this.bzero=r.BZERO||0,this.bscale=r.BSCALE||1,this.rowByteSize=this.width*Math.abs(n)/8,this.totalRowsRead=0,this.length=this.naxis.reduce(function(e,t){return e*t})*Math.abs(n)/8,this.data=void 0,this.frame=0,n){case 8:this.bscale%1===0?(this.arrayType=Uint8Array,this.accessor=function(){return s.bzero+s.bscale*s.view.getUint8()}):(this.arrayType=Float32Array,this.accessor=function(){return s.bzero+s.bscale*s.view.getUint8()});break;case 16:this.bscale%1===0?(this.arrayType=Int16Array,this.accessor=function(){return s.bzero+s.bscale*s.view.getInt16()}):(this.arrayType=Float32Array,this.accessor=function(){return s.bzero+s.bscale*s.view.getInt16()});break;case 32:this.bscale%1===0?(this.arrayType=Int32Array,this.accessor=function(){return s.bzero+s.bscale*s.view.getUint32()}):(this.arrayType=Float32Array,this.accessor=function(){return s.bzero+s.bscale*s.view.getUint32()});break;case 64:this.arrayType=this.bscale%1===0?Int32Array:Float32Array,console.warn("Unusual behaviour with 64 bit integers."),this.accessor=function(){var e,t,r,n,i;return t=Math.abs(s.view.getInt32()),r=Math.abs(s.view.getInt32()),n=t%10,e=n?-1:1,t-=n,i=e*(t<<32|r),s.bzero+s.bscale*i};break;case-32:this.arrayType=Float32Array,this.accessor=function(){return s.bzero+s.bscale*s.view.getFloat32()};break;case-64:this.arrayType=Float64Array,this.accessor=function(){return s.bzero+s.bscale*s.view.getFloat64()};break;default:throw"Invalid BITPIX."}}return g(t,e),t.include(h),t.prototype.getRow=function(){var e,t,r;for(this.current=this.begin+this.totalRowsRead*this.rowByteSize,this.view.seek(this.current),e=t=0,r=this.width-1;0<=r?t<=r:t>=r;e=0<=r?++t:--t)this.data[this.width*this.rowsRead+e]=this.accessor();return this.rowsRead+=1,this.totalRowsRead+=1},t.prototype.getFrame=function(e){var t;for(this.frame=null!=e?e:this.frame,null==this.data&&this.initArray(this.arrayType),this.totalRowsRead=this.width*this.frame,this.rowsRead=0,t=this.height;t--;)this.getRow();return this.frame+=1,this.data},t.prototype.seek=function(e){return null==e&&(e=0),2===this.naxis.length?(this.totalRowsRead=0,this.frame=0):(this.totalRowsRead=this.height*e,this.frame=this.height/this.totalRowsRead-1)},t.prototype.isDataCube=function(){return this.naxis.length>2},t}(r),this.astro.FITS.Image=u,f=function(e){function t(e,r){this.getRow=x(this.getRow,this),t.__super__.constructor.apply(this,arguments),this.rowByteSize=r.NAXIS1,this.rows=r.NAXIS2,this.cols=r.TFIELDS,this.length=this.tableLength=this.rowByteSize*this.rows,this.rowsRead=0,this.columns=this.getColumnNames(r),this.accessors=[]}return g(t,e),t.dataAccessors={L:function(e){return 84===e.getInt8()},X:function(e){throw"Data type not yet implemented"},B:function(e){return e.getUint8()},I:function(e){return e.getInt16()},J:function(e){return e.getInt32()},K:function(e){var t,r,n,i,o;return r=Math.abs(e.getInt32()),n=Math.abs(e.getInt32()),i=r%10,t=i?-1:1,r-=i,o=t*(r<<32|n),console.warn("Something funky happens here when dealing with 64 bit integers.  Be wary!!!"),o},A:function(e){return e.getChar()},E:function(e){return e.getFloat32()},D:function(e){return e.getFloat64()},C:function(e){return[e.getFloat32(),e.getFloat32()]},M:function(e){return[e.getFloat64(),e.getFloat64()]}},t.prototype.getRow=function(e){var t,r,n,i,o;for(null==e&&(e=null),null!=e&&(this.rowsRead=e),this.current=this.begin+this.rowsRead*this.rowByteSize,this.view.seek(this.current),e={},o=this.accessors,r=n=0,i=o.length;n<i;r=++n)t=o[r],e[this.columns[r]]=t();return this.rowsRead+=1,e},t.prototype.getColumnNames=function(e){var t,r,n,i,o;for(t=[],r=i=1,o=this.cols;1<=o?i<=o:i>=o;r=1<=o?++i:--i){if(n="TTYPE"+r,!e.contains(n))return null;t.push(e[n])}return t},t}(r),this.astro.FITS.Tabular=f,d=function(e){function t(e,r){this.getRow=x(this.getRow,this);var n,i,o,a,s,l,u=this;for(t.__super__.constructor.apply(this,arguments),a=function(){var e,r,n,i,a;return a=o.slice(1),r=a[0],i=a[1],n=a[2],e=function(e){return t.dataAccessors[r](e)},u.accessors.push(e)},i=s=1,l=this.cols;1<=l?s<=l:s>=l;i=1<=l?++s:--s)n=r["TFORM"+i],o=n.match(t.formPattern),a()}return g(t,e),t.formPattern=/([AIFED])(\d+)\.*(\d+)*/,t.dataAccessors={A:function(e){return e.trim()},I:function(e){return parseInt(e)},F:function(e){return parseFloat(e)},E:function(e){return parseFloat(e)},D:function(e){return parseFloat(e)}},t.prototype.getRow=function(e){var t,r,n,i,o,a,s,l;for(null==e&&(e=null),null!=e&&(this.rowsRead=e),this.current=this.begin+this.rowsRead*this.rowByteSize,this.view.seek(this.current),n="",t=o=1,l=this.rowByteSize;1<=l?o<=l:o>=l;t=1<=l?++o:--o)n+=this.view.getChar();for(n=n.trim().split(/\s+/),e={},r=a=0,s=n.length;a<s;r=++a)i=n[r],e[this.columns[r]]=this.accessors[r](i);return this.rowsRead+=1,e},t}(f),this.astro.FITS.Table=d,e=function(e){function t(e,r){var n,i,o,a,s,l,u,h,c,d=this;for(t.__super__.constructor.apply(this,arguments),i=u=1,h=this.cols;1<=h?u<=h:u>=h;i=1<=h?++u:--u)o="TFORM"+i,l=r[o],s=l.match(t.arrayDescriptorPattern),null!=s?!function(){var e,r;return r=s[1],e=function(){var e,n,o,a;for(n=d.view.getInt32(),o=d.view.getInt32(),d.current=d.view.tell(),d.view.seek(d.begin+d.tableLength+o),e=[],i=a=1;1<=n?a<=n:a>=n;i=1<=n?++a:--a)e.push(t.dataAccessors[r](d.view));return d.view.seek(d.current),e},d.accessors.push(e)}():(s=l.match(t.dataTypePattern),c=s.slice(1),a=c[0],n=c[1],a=a?parseInt(a):0,0===a||1===a?!function(e){var r;return r=function(){var r;return r=t.dataAccessors[e](d.view)},d.accessors.push(r)}(n):!function(e,r){var n,o;return"X"===e?(o=Math.log(r)/Math.log(2),n=function(){var e,t,n,a,s,l,u,h;for(a=function(e){var t;for(t=[],i=128;i>=1;)t.push(e&i?1:0),i/=2;return t},s=[],i=l=1;1<=o?l<=o:l>=o;i=1<=o?++l:--l)for(n=d.view.getUint8(),t=a(n),u=0,h=t.length;u<h;u++)e=t[u],s.push(e);return s.slice(0,+(r-1)+1||9e9)}):n="A"===e?function(){var n,o;for(n="",i=o=1;1<=r?o<=r:o>=r;i=1<=r?++o:--o)n+=t.dataAccessors[e](d.view);return n.trim()}:function(){var n,o;for(n=[],i=o=1;1<=r?o<=r:o>=r;i=1<=r?++o:--o)n.push(t.dataAccessors[e](d.view));return n},d.accessors.push(n)}(n,a))}return g(t,e),t.dataTypePattern=/(\d*)([L|X|B|I|J|K|A|E|D|C|M])/,t.arrayDescriptorPattern=/[0,1]*P([L|X|B|I|J|K|A|E|D|C|M])\((\d*)\)/,t}(f),this.astro.FITS.BinaryTable=e,n={Rice:function(e,t,r,n,i,o){var a,s,l,u,h,c,d,f,p,m,v,g,y,x,b,T;for(s=1<<h,b=this.RiceSetup[n](e),h=b[0],c=b[1],m=b[2],x=b[3],g=new Uint8Array(256),y=8,T=[128,255],p=T[0],d=T[1];d>=0;){for(;d>=p;)g[d]=y,d-=1;p/=2,y-=1}for(g[0]=0,a=e[x],x+=1,v=8,d=0;d<o;){for(v-=h;v<0;)a=a<<8|e[x],x+=1,v+=8;if(u=(a>>v)-1,a&=(1<<v)-1,f=d+r,f>o&&(f=o),u<0)for(;d<f;)e[d]=m,d++;else if(u===c)for(;d<f;){for(p=s-v,l=a<<p,p-=8;p>=0;)a=e[x],x+=1,l|=a<<p,p-=8;v>0?(a=e[x],x+=1,l|=a>>-p,a&=(1<<v)-1):a=0,0===(1&l)?l>>=1:l=~(l>>1),e[d]=l+m,m=e[d],d++}else for(;d<f;){for(;0===a;)v+=8,a=e[x],x+=1;for(y=v-g[a],v-=y+1,a^=1<<v,v-=u;v<0;)a=a<<8|e[x],x+=1,v+=8;l=y<<u|a>>v,a&=(1<<v)-1,0===(1&l)?l>>=1:l=~(l>>1),i[d]=l+m,m=i[d],d++}}return i},RiceSetup:{1:function(e){var t,r,n,i;return i=0,t=3,r=6,n=e[i],i+=1,[t,r,n,i]},2:function(e){var t,r,n,i,o;return o=0,r=4,n=14,i=0,t=e[o],o+=1,i|=t<<8,t=e[o],o+=1,i|=t,[r,n,i,o]},4:function(e){var t,r,n,i,o;return o=0,r=5,n=25,i=0,t=e[o],o+=1,i|=t<<24,t=e[o],o+=1,i|=t<<16,t=e[o],o+=1,i|=t<<8,t=e[o],o+=1,i|=t,[r,n,i,o]}},gzip:function(e){throw"Not yet implemented"},plio:function(e,t){throw"Not yet implemented"},hcompress:function(e,t){throw"Not yet implemented"}},this.astro.FITS.Decompress=n,t=function(e){function t(e,r){var n,i,o,a,s,l;for(t.__super__.constructor.apply(this,arguments),this.length+=r.PCOUNT,this.zcmptype=r.ZCMPTYPE,this.zbitpix=r.ZBITPIX,this.znaxis=r.ZNAXIS,this.zblank=t.setValue(r,"ZBLANK",void 0),this.blank=t.setValue(r,"BLANK",void 0),this.ztile=[],n=s=1,l=this.znaxis;1<=l?s<=l:s>=l;n=1<=l?++s:--s)a=r.contains("ZTILE"+n)?r["ZTILE"+n]:1===n?r.ZNAXIS1:1,this.ztile.push(a);for(this.width=r.ZNAXIS1,this.height=r.ZNAXIS2||1,this.algorithmParameters={},n=1;;){if(i="ZNAME"+n,!r.contains(i))break;o="ZVAL"+n,this.algorithmParameters[r[i]]=r[o],n+=1}"RICE_1"===this.zcmptype&&this.setRiceDefaults(),this.zmaskcmp=t.setValue(r,"ZMASKCMP",void 0),this.zquantiz=t.setValue(r,"ZQUANTIZ","LINEAR_SCALING"),this.bzero=t.setValue(r,"BZERO",0),this.bscale=t.setValue(r,"BSCALE",1),this.defineColumnAccessors(r),this.defineGetRow()}return g(t,e),t.dataTypePattern=/(\d*)([L|X|B|I|J|K|A|E|D|C|M])/,t.arrayDescriptorPattern=/[0,1]*P([L|X|B|I|J|K|A|E|D|C|M])\((\d*)\)/,t.include(h),t.extend(n),t.typedArray={B:Uint8Array,I:Int16Array,J:Int32Array,E:Float32Array,D:Float64Array,1:Uint8Array,2:Uint8Array,4:Int16Array,8:Int32Array},t.prototype.defineColumnAccessors=function(e){var r,n,i,o,a,s,l,u,h,c,d,f=this;for(this.columnNames={},d=[],i=u=1,h=this.cols;1<=h?u<=h:u>=h;i=1<=h?++u:--u){if(l=e["TFORM"+i],a=l.match(t.arrayDescriptorPattern),s=e["TTYPE"+i].toUpperCase(),this.columnNames[s]=i-1,r=null,null!=a)switch(n=a[1],s){case"COMPRESSED_DATA":!function(e){return r=function(){var r,n;return r=f._accessor(e),null==r?new Float32Array(f.ztile[0]):(n=new t.typedArray[f.algorithmParameters.BYTEPIX](f.ztile[0]),t.Rice(r,o,f.algorithmParameters.BLOCKSIZE,f.algorithmParameters.BYTEPIX,n,f.ztile[0]),n)}}(n);break;case"UNCOMPRESSED_DATA":!function(e){return r=f._accessor(e)}(n);break;case"GZIP_COMPRESSED_DATA":!function(e){return r=function(){var t,r,n,i,o;if(t=f._accessor(e),null!=t){for(t=new Float32Array(f.width),r=i=0,o=t.length;i<o;r=++i)n=t[r],t[r]=NaN;return t}return null}}(n);break;default:!function(e){return r=f._accessor(e)}(n)}else a=l.match(t.dataTypePattern),c=a.slice(1),o=c[0],n=c[1],o=null!=o?parseInt(o):0,0===o||1===o?!function(e){return r=function(){return t.dataAccessors[e](f.view)}}(n):!function(e,n){return r=function(){var r,o,a;for(r=new t.typedArray[n](e),i=o=0,a=e-1;0<=a?o<=a:o>=a;i=0<=a?++o:--o)r[i]=t.dataAccessors[n](f.view);return r}}(o,n);d.push(this.accessors.push(r))}return d},t.prototype.defineGetRow=function(){var e;return this.totalRowsRead=0,e=null!=this.zblank||null!=this.blank||this.columnNames.hasOwnProperty("ZBLANK"),this.getRow=e?this.getRowHasBlanks:this.getRowNoBlanks},t.prototype.setRiceDefaults=function(){if(this.algorithmParameters.hasOwnProperty("BLOCKSIZE")||(this.algorithmParameters.BLOCKSIZE=32),!this.algorithmParameters.hasOwnProperty("BYTEPIX"))return this.algorithmParameters.BYTEPIX=4},t.setValue=function(e,t,r){return e.contains(t)?e[t]:r},t.prototype.getRowHasBlanks=function(){var e,t,r,n,i,o,a,s,l,u;for(u=this._getRow(),t=u[0],e=u[1],i=u[2],a=u[3],r=s=0,l=t.length;s<l;r=++s)o=t[r],n=this.totalRowsRead*this.width+r,this.data[n]=o===e?NaN:a+i*o;return this.rowsRead+=1,this.totalRowsRead+=1},t.prototype.getRowNoBlanks=function(){var e,t,r,n,i,o,a,s,l,u;for(u=this._getRow(),t=u[0],e=u[1],i=u[2],a=u[3],r=s=0,l=t.length;s<l;r=++s)o=t[r],n=this.totalRowsRead*this.width+r,this.data[n]=a+i*o;return this.rowsRead+=1,this.totalRowsRead+=1},t.prototype.getFrame=function(){var e;for(null==this.data&&this.initArray(Float32Array),this.totalRowsRead=0,this.rowsRead=0,e=this.height;e--;)this.getRow();return this.data},t.prototype._accessor=function(e){var r,n,i,o,a,s,l;if(s=[this.view.getInt32(),this.view.getInt32()],i=s[0],o=s[1],0===i)return null;for(r=new t.typedArray[e](i),this.current=this.view.tell(),this.view.seek(this.begin+this.tableLength+o),n=a=0,l=i-1;0<=l?a<=l:a>=l;n=0<=l?++a:--a)r[n]=t.dataAccessors[e](this.view);return this.view.seek(this.current),r},t.prototype._getRow=function(){var e,t,r,n,i,o,a,s,l;for(this.current=this.begin+this.totalRowsRead*this.rowByteSize,this.view.seek(this.current),n=[],l=this.accessors,a=0,s=l.length;a<s;a++)e=l[a],n.push(e());return r=n[this.columnNames.COMPRESSED_DATA]||n[this.columnNames.UNCOMPRESSED_DATA]||n[this.columnNames.GZIP_COMPRESSED_DATA],t=n[this.columnNames.ZBLANK]||this.zblank,i=n[this.columnNames.ZSCALE]||this.bscale,o=n[this.columnNames.ZZERO]||this.bzero,[r,t,i,o]},t.subtractiveDither1=function(){throw"Not yet implemented"},t.linearScaling=function(){throw"Not yet implemented"},t}(f),this.astro.FITS.CompressedImage=t,a=function(){function e(e,t){this.header=e,this.data=t}return e.prototype.hasData=function(){return null!=this.data},e.prototype.getCard=function(e){return this.header[e]},e}(),this.astro.FITS.HDU=a,o=function(){function r(e){var t;switch(t=r.getType(e)){case"arraybuffer":this.initFromBuffer(e);break;case"object":this.initFromObject(e);break;default:throw"fitsjs cannot initialize object"}}return r.LINEWIDTH=80,r.BLOCKLENGTH=2880,r.getType=function(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()},r.excessBytes=function(e){return(r.BLOCKLENGTH-e%r.BLOCKLENGTH)%r.BLOCKLENGTH},r.extendDataView=function(e){var t,r,n,i,o,a,s,l;return DataView.prototype.getString=function(e){var t,r,n,i,o;for(n="",r=i=0,o=e-1;0<=o?i<=o:i>=o;r=0<=o?++i:--i)t=this.getUint8(),n+=String.fromCharCode(t>127?65533:t);return n},DataView.prototype.getChar=function(){return this.getString(1)},e.offset=0,o=e.getInt8,l=e.getUint8,n=e.getInt16,a=e.getUint16,i=e.getInt32,s=e.getUint32,t=e.getFloat32,r=e.getFloat64,e.getInt8=function(){var e;return e=o.apply(this,[this.offset]),this.offset+=1,e},e.getUint8=function(){var e;return e=l.apply(this,[this.offset]),this.offset+=1,e},e.getInt16=function(){var e;return e=n.apply(this,[this.offset,!1]),this.offset+=2,e},e.getUint16=function(){var e;return e=a.apply(this,[this.offset,!1]),this.offset+=2,e},e.getInt32=function(){var e;return e=i.apply(this,[this.offset,!1]),this.offset+=4,e},e.getUint32=function(){var e;return e=s.apply(this,[this.offset,!1]),this.offset+=4,e},e.getFloat32=function(){var e;return e=t.apply(this,[this.offset,!1]),this.offset+=4,e},e.getFloat64=function(){var e;return e=r.apply(this,[this.offset,!1]),this.offset+=8,e},e.seek=function(e){return this.offset=e},e.tell=function(){return this.offset}},r.prototype.initFromBuffer=function(e){var t,n,i,o;for(this.length=e.byteLength,this.view=new DataView(e),this.hdus=[],this.eof=!1,r.extendDataView(this.view),o=[];;){if(i=this.readHeader(),t=this.readData(i),n=new a(i,t),this.hdus.push(n),this.eof)break;o.push(void 0)}return o},r.prototype.initFromObject=function(e){return this.length=e.length,this.view=null,this.hdus=e.hdus,this.eof=!0},r.prototype.readHeader=function(){var e,t,n,i,o,a,l,u,h,c,d,f;for(f=/\s{80}/,a=/^END\s/,e=this.view.tell(),n=!1;;){if(n)break;for(t=this.view.getString(r.BLOCKLENGTH),u=0;;){if(d=r.BLOCKLENGTH-r.LINEWIDTH*(u+1),i=r.BLOCKLENGTH-r.LINEWIDTH*u,h=t.slice(d,i),c=h.match(f),!c){if(c=h.match(a))return o=this.view.tell(),this.view.seek(e),t=this.view.getString(o-e),l=new s,l.init(t),n=!0,this.checkEOF(),l;break}u+=1}}},r.prototype.readData=function(n){var i,o;if(n.hasDataUnit())return n.isPrimary()?i=new u(this.view,n):n.isExtension()&&("BINTABLE"===n.extensionType?i=n.contains("ZIMAGE")?new t(this.view,n):new e(this.view,n):"TABLE"===n.extensionType?i=new d(this.view,n):"IMAGE"===n.extensionType&&(i=new u(this.view,n))),o=r.excessBytes(i.length),this.view.seek(this.view.tell()+i.length+o),this.checkEOF(),i},r.prototype.checkEOF=function(){if(this.view.offset>=this.length)return this.eof=!0},r.prototype.count=function(){return this.hdus.length},r.prototype.getHDU=function(e){var t,r,n,i;if(null==e&&(e=void 0),null!=e&&null!=this.hdus[e])return this.hdus[e];for(i=this.hdus,r=0,n=i.length;r<n;r++)if(t=i[r],t.hasData())return t},r.prototype.getHeader=function(e){return null==e&&(e=void 0),this.getHDU(e).header},r.prototype.getDataUnit=function(e){return null==e&&(e=void 0),this.getHDU(e).data},r.prototype.getData=function(e){return null==e&&(e=void 0),this.getHDU(e).data.getFrame()},r}(),this.astro.FITS.File=o}.call(this),r("fits",function(){}),r("Layer/FitsLoader",["fits"],function(){function e(e){var t,r=astro.FITS,n=new r.File(e),i=n.getHDU(),o=i.data,a=new Uint8Array(o.view.buffer,o.begin,o.length);t=o.arrayType?o.arrayType.BYTES_PER_ELEMENT:Math.abs(i.header.BITPIX)/8;for(var s=0;s<a.length;s+=t)for(var l,u=0;u<t/2;u++)l=a[s+u],a[s+u]=a[s+t-1-u],a[s+t-1-u]=l;return n}var t=function(t,r,n,i){var o=new XMLHttpRequest;return o.onreadystatechange=function(i){if(4===o.readyState)if(200===o.status){if(o.response){var a=e(o.response);r&&r(a)}}else console.log("Error while loading "+t),n&&n()},o.onprogress=function(e){},o.open("GET",t),o.responseType="arraybuffer",o.send(),o};return{loadFits:t,parseFits:e}}),function(){"use strict";function e(e,t){var r=e.split("."),n=m;!(r[0]in n)&&n.execScript&&n.execScript("var "+r[0]);for(var i;r.length&&(i=r.shift());)r.length||t===f?n=n[i]?n[i]:n[i]={}:n[i]=t}function t(e,t){if(this.index="number"==typeof t?t:0,this.f=0,this.buffer=e instanceof(v?Uint8Array:Array)?e:new(v?Uint8Array:Array)(32768),2*this.buffer.length<=this.index)throw Error("invalid index");this.buffer.length<=this.index&&r(this)}function r(e){var t,r=e.buffer,n=r.length,i=new(v?Uint8Array:Array)(n<<1);if(v)i.set(r);else for(t=0;t<n;++t)i[t]=r[t];return e.buffer=i}function n(e,t,r){var n,i="number"==typeof t?t:t=0,o="number"==typeof r?r:e.length;for(n=-1,i=7&o;i--;++t)n=n>>>8^A[255&(n^e[t])];for(i=o>>3;i--;t+=8)n=n>>>8^A[255&(n^e[t])],n=n>>>8^A[255&(n^e[t+1])],n=n>>>8^A[255&(n^e[t+2])],n=n>>>8^A[255&(n^e[t+3])],n=n>>>8^A[255&(n^e[t+4])],n=n>>>8^A[255&(n^e[t+5])],n=n>>>8^A[255&(n^e[t+6])],n=n>>>8^A[255&(n^e[t+7])];return(4294967295^n)>>>0}function i(e){this.buffer=new(v?Uint16Array:Array)(2*e),this.length=0}function o(e,t){this.h=C,this.j=0,this.input=v&&e instanceof Array?new Uint8Array(e):e,this.c=0,t&&(t.lazy&&(this.j=t.lazy),"number"==typeof t.compressionType&&(this.h=t.compressionType),t.outputBuffer&&(this.a=v&&t.outputBuffer instanceof Array?new Uint8Array(t.outputBuffer):t.outputBuffer),"number"==typeof t.outputIndex&&(this.c=t.outputIndex)),this.a||(this.a=new(v?Uint8Array:Array)(32768))}function a(e,t){this.length=e,this.k=t}function s(e,t){function r(e,t){var r,n=e.k,i=[],o=0;r=R[e.length],i[o++]=65535&r,i[o++]=r>>16&255,i[o++]=r>>24;var a;switch(p){case 1===n:a=[0,n-1,0];break;case 2===n:a=[1,n-2,0];break;case 3===n:a=[2,n-3,0];break;case 4===n:a=[3,n-4,0];break;case 6>=n:a=[4,n-5,1];break;case 8>=n:a=[5,n-7,1];break;case 12>=n:a=[6,n-9,2];break;case 16>=n:a=[7,n-13,2];break;case 24>=n:a=[8,n-17,3];break;case 32>=n:a=[9,n-25,3];break;case 48>=n:a=[10,n-33,4];break;case 64>=n:a=[11,n-49,4];break;case 96>=n:a=[12,n-65,5];break;case 128>=n:a=[13,n-97,5];break;case 192>=n:a=[14,n-129,6];break;case 256>=n:a=[15,n-193,6];break;case 384>=n:a=[16,n-257,7];break;case 512>=n:a=[17,n-385,7];break;case 768>=n:a=[18,n-513,8];break;case 1024>=n:a=[19,n-769,8];break;case 1536>=n:a=[20,n-1025,9];break;case 2048>=n:a=[21,n-1537,9];break;case 3072>=n:a=[22,n-2049,10];break;case 4096>=n:a=[23,n-3073,10];break;case 6144>=n:a=[24,n-4097,11];break;case 8192>=n:a=[25,n-6145,11];break;case 12288>=n:a=[26,n-8193,12];break;case 16384>=n:a=[27,n-12289,12];break;case 24576>=n:a=[28,n-16385,13];break;case 32768>=n:a=[29,n-24577,13];break;default:throw"invalid distance"}r=a,i[o++]=r[0],i[o++]=r[1],i[o++]=r[2];var s,l;for(s=0,l=i.length;s<l;++s)g[y++]=i[s];b[i[0]]++,T[i[3]]++,x=e.length+t-1,c=null}var n,i,o,a,s,u,h,c,d,m={},g=v?new Uint16Array(2*t.length):[],y=0,x=0,b=new(v?Uint32Array:Array)(286),T=new(v?Uint32Array:Array)(30),w=e.j;if(!v){for(o=0;285>=o;)b[o++]=0;for(o=0;29>=o;)T[o++]=0}for(b[256]=1,n=0,i=t.length;n<i;++n){for(o=s=0,a=3;o<a&&n+o!==i;++o)s=s<<8|t[n+o];if(m[s]===f&&(m[s]=[]),u=m[s],!(0<x--)){for(;0<u.length&&32768<n-u[0];)u.shift();if(n+3>=i){for(c&&r(c,-1),o=0,a=i-n;o<a;++o)d=t[n+o],g[y++]=d,++b[d];break}0<u.length?(h=l(t,n,u),c?c.length<h.length?(d=t[n-1],g[y++]=d,++b[d],r(h,0)):r(c,-1):h.length<w?c=h:r(h,0)):c?r(c,-1):(d=t[n],g[y++]=d,++b[d])}u.push(n)}return g[y++]=256,b[256]++,e.n=b,e.m=T,v?g.subarray(0,y):g}function l(e,t,r){var n,i,o,s,l,u,h=0,c=e.length;s=0,u=r.length;e:for(;s<u;s++){if(n=r[u-s-1],o=3,3<h){for(l=h;3<l;l--)if(e[n+l-1]!==e[t+l-1])continue e;o=h}for(;258>o&&t+o<c&&e[n+o]===e[t+o];)++o;if(o>h&&(i=n,h=o),258===o)break}return new a(h,t-i)}function u(e,t){var r,n,o,a,s,l=e.length,u=new i(572),c=new(v?Uint8Array:Array)(l);if(!v)for(a=0;a<l;a++)c[a]=0;for(a=0;a<l;++a)0<e[a]&&u.push(a,e[a]);if(r=Array(u.length/2),n=new(v?Uint32Array:Array)(u.length/2),1===r.length)return c[u.pop().index]=1,c;for(a=0,s=u.length/2;a<s;++a)r[a]=u.pop(),n[a]=r[a].value;for(o=h(n,n.length,t),a=0,s=r.length;a<s;++a)c[r[a].index]=o[a];return c}function h(e,t,r){function n(e){var r=f[e][p[e]];r===t?(n(e+1),n(e+1)):--c[r],++p[e]}var i,o,a,s,l,u=new(v?Uint16Array:Array)(r),h=new(v?Uint8Array:Array)(r),c=new(v?Uint8Array:Array)(t),d=Array(r),f=Array(r),p=Array(r),m=(1<<r)-t,g=1<<r-1;for(u[r-1]=t,o=0;o<r;++o)m<g?h[o]=0:(h[o]=1,m-=g),m<<=1,u[r-2-o]=(u[r-1-o]/2|0)+t;for(u[0]=h[0],d[0]=Array(u[0]),f[0]=Array(u[0]),o=1;o<r;++o)u[o]>2*u[o-1]+h[o]&&(u[o]=2*u[o-1]+h[o]),d[o]=Array(u[o]),f[o]=Array(u[o]);for(i=0;i<t;++i)c[i]=r;for(a=0;a<u[r-1];++a)d[r-1][a]=e[a],f[r-1][a]=a;for(i=0;i<r;++i)p[i]=0;for(1===h[r-1]&&(--c[0],++p[r-1]),o=r-2;0<=o;--o){for(s=i=0,l=p[o+1],a=0;a<u[o];a++)s=d[o+1][l]+d[o+1][l+1],s>e[i]?(d[o][a]=s,f[o][a]=t,l+=2):(d[o][a]=e[i],f[o][a]=i,++i);p[o]=0,1===h[o]&&n(o)}return c}function c(e){var t,r,n,i,o=new(v?Uint16Array:Array)(e.length),a=[],s=[],l=0;for(t=0,r=e.length;t<r;t++)a[e[t]]=(0|a[e[t]])+1;for(t=1,r=16;t<=r;t++)s[t]=l,l+=0|a[t],l<<=1;for(t=0,r=e.length;t<r;t++)for(l=s[e[t]],s[e[t]]+=1,n=o[t]=0,i=e[t];n<i;n++)o[t]=o[t]<<1|1&l,l>>>=1;return o}function d(e,t){this.input=e,this.c=this.i=0,this.d={},t&&(t.flags&&(this.d=t.flags),"string"==typeof t.filename&&(this.filename=t.filename),"string"==typeof t.comment&&(this.l=t.comment),t.deflateOptions&&(this.e=t.deflateOptions)),this.e||(this.e={})}var f=void 0,p=!0,m=this,v="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array&&"undefined"!=typeof DataView;t.prototype.b=function(e,t,n){var i,o=this.buffer,a=this.index,s=this.f,l=o[a];if(n&&1<t&&(e=8<t?(w[255&e]<<24|w[e>>>8&255]<<16|w[e>>>16&255]<<8|w[e>>>24&255])>>32-t:w[e]>>8-t),8>t+s)l=l<<t|e,s+=t;else for(i=0;i<t;++i)l=l<<1|e>>t-i-1&1,8===++s&&(s=0,o[a++]=w[l],l=0,a===o.length&&(o=r(this)));o[a]=l,this.buffer=o,this.f=s,this.index=a},t.prototype.finish=function(){var e,t=this.buffer,r=this.index;return 0<this.f&&(t[r]<<=8-this.f,
t[r]=w[t[r]],r++),v?e=t.subarray(0,r):(t.length=r,e=t),e};var g,y=new(v?Uint8Array:Array)(256);for(g=0;256>g;++g){for(var x=g,b=x,T=7,x=x>>>1;x;x>>>=1)b<<=1,b|=1&x,--T;y[g]=(b<<T&255)>>>0}var w=y,S=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117],A=v?new Uint32Array(S):S;i.prototype.getParent=function(e){return 2*((e-2)/4|0)},i.prototype.push=function(e,t){var r,n,i,o=this.buffer;for(r=this.length,o[this.length++]=t,o[this.length++]=e;0<r&&(n=this.getParent(r),o[r]>o[n]);)i=o[r],o[r]=o[n],o[n]=i,i=o[r+1],o[r+1]=o[n+1],o[n+1]=i,r=n;return this.length},i.prototype.pop=function(){var e,t,r,n,i,o=this.buffer;for(t=o[0],e=o[1],this.length-=2,o[0]=o[this.length],o[1]=o[this.length+1],i=0;(n=2*i+2,!(n>=this.length))&&(n+2<this.length&&o[n+2]>o[n]&&(n+=2),o[n]>o[i]);)r=o[i],o[i]=o[n],o[n]=r,r=o[i+1],o[i+1]=o[n+1],o[n+1]=r,i=n;return{index:e,value:t,length:this.length}};var M,C=2,E=[];for(M=0;288>M;M++)switch(p){case 143>=M:E.push([M+48,8]);break;case 255>=M:E.push([M-144+400,9]);break;case 279>=M:E.push([M-256+0,7]);break;case 287>=M:E.push([M-280+192,8]);break;default:throw"invalid literal: "+M}o.prototype.g=function(){var e,r,n,i,o=this.input;switch(this.h){case 0:for(n=0,i=o.length;n<i;){r=v?o.subarray(n,n+65535):o.slice(n,n+65535),n+=r.length;var a=r,l=n===i,h=f,d=f,m=f,g=f,y=f,x=this.a,b=this.c;if(v){for(x=new Uint8Array(this.a.buffer);x.length<=b+a.length+5;)x=new Uint8Array(x.length<<1);x.set(this.a)}if(h=l?1:0,x[b++]=0|h,d=a.length,m=~d+65536&65535,x[b++]=255&d,x[b++]=d>>>8&255,x[b++]=255&m,x[b++]=m>>>8&255,v)x.set(a,b),b+=a.length,x=x.subarray(0,b);else{for(g=0,y=a.length;g<y;++g)x[b++]=a[g];x.length=b}this.c=b,this.a=x}break;case 1:var T=new t(v?new Uint8Array(this.a.buffer):this.a,this.c);T.b(1,1,p),T.b(1,2,p);var w,S,A,M=s(this,o);for(w=0,S=M.length;w<S;w++)if(A=M[w],t.prototype.b.apply(T,E[A]),256<A)T.b(M[++w],M[++w],p),T.b(M[++w],5),T.b(M[++w],M[++w],p);else if(256===A)break;this.a=T.finish(),this.c=this.a.length;break;case C:var P,R,L,I,_,F,k,B,N,D,O,U,j,q,G,V=new t(v?new Uint8Array(this.a.buffer):this.a,this.c),z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],H=Array(19);for(P=C,V.b(1,1,p),V.b(P,2,p),R=s(this,o),F=u(this.n,15),k=c(F),B=u(this.m,7),N=c(B),L=286;257<L&&0===F[L-1];L--);for(I=30;1<I&&0===B[I-1];I--);var X,W,Y,Q,Z,K,J=L,$=I,ee=new(v?Uint32Array:Array)(J+$),te=new(v?Uint32Array:Array)(316),re=new(v?Uint8Array:Array)(19);for(X=W=0;X<J;X++)ee[W++]=F[X];for(X=0;X<$;X++)ee[W++]=B[X];if(!v)for(X=0,Q=re.length;X<Q;++X)re[X]=0;for(X=Z=0,Q=ee.length;X<Q;X+=W){for(W=1;X+W<Q&&ee[X+W]===ee[X];++W);if(Y=W,0===ee[X])if(3>Y)for(;0<Y--;)te[Z++]=0,re[0]++;else for(;0<Y;)K=138>Y?Y:138,K>Y-3&&K<Y&&(K=Y-3),10>=K?(te[Z++]=17,te[Z++]=K-3,re[17]++):(te[Z++]=18,te[Z++]=K-11,re[18]++),Y-=K;else if(te[Z++]=ee[X],re[ee[X]]++,Y--,3>Y)for(;0<Y--;)te[Z++]=ee[X],re[ee[X]]++;else for(;0<Y;)K=6>Y?Y:6,K>Y-3&&K<Y&&(K=Y-3),te[Z++]=16,te[Z++]=K-3,re[16]++,Y-=K}for(e=v?te.subarray(0,Z):te.slice(0,Z),D=u(re,7),q=0;19>q;q++)H[q]=D[z[q]];for(_=19;4<_&&0===H[_-1];_--);for(O=c(D),V.b(L-257,5,p),V.b(I-1,5,p),V.b(_-4,4,p),q=0;q<_;q++)V.b(H[q],3,p);for(q=0,G=e.length;q<G;q++)if(U=e[q],V.b(O[U],D[U],p),16<=U){switch(q++,U){case 16:j=2;break;case 17:j=3;break;case 18:j=7;break;default:throw"invalid code: "+U}V.b(e[q],j,p)}var ne,ie,oe,ae,se,le,ue,he,ce=[k,F],de=[N,B];for(se=ce[0],le=ce[1],ue=de[0],he=de[1],ne=0,ie=R.length;ne<ie;++ne)if(oe=R[ne],V.b(se[oe],le[oe],p),256<oe)V.b(R[++ne],R[++ne],p),ae=R[++ne],V.b(ue[ae],he[ae],p),V.b(R[++ne],R[++ne],p);else if(256===oe)break;this.a=V.finish(),this.c=this.a.length;break;default:throw"invalid compression type"}return this.a};var P=function(){function e(e){switch(p){case 3===e:return[257,e-3,0];case 4===e:return[258,e-4,0];case 5===e:return[259,e-5,0];case 6===e:return[260,e-6,0];case 7===e:return[261,e-7,0];case 8===e:return[262,e-8,0];case 9===e:return[263,e-9,0];case 10===e:return[264,e-10,0];case 12>=e:return[265,e-11,1];case 14>=e:return[266,e-13,1];case 16>=e:return[267,e-15,1];case 18>=e:return[268,e-17,1];case 22>=e:return[269,e-19,2];case 26>=e:return[270,e-23,2];case 30>=e:return[271,e-27,2];case 34>=e:return[272,e-31,2];case 42>=e:return[273,e-35,3];case 50>=e:return[274,e-43,3];case 58>=e:return[275,e-51,3];case 66>=e:return[276,e-59,3];case 82>=e:return[277,e-67,4];case 98>=e:return[278,e-83,4];case 114>=e:return[279,e-99,4];case 130>=e:return[280,e-115,4];case 162>=e:return[281,e-131,5];case 194>=e:return[282,e-163,5];case 226>=e:return[283,e-195,5];case 257>=e:return[284,e-227,5];case 258===e:return[285,e-258,0];default:throw"invalid length: "+e}}var t,r,n=[];for(t=3;258>=t;t++)r=e(t),n[t]=r[2]<<24|r[1]<<16|r[0];return n}(),R=v?new Uint32Array(P):P;d.prototype.g=function(){var e,t,r,i,a,s,l,u,h=new(v?Uint8Array:Array)(32768),c=0,d=this.input,p=this.i,m=this.filename,g=this.l;if(h[c++]=31,h[c++]=139,h[c++]=8,e=0,this.d.fname&&(e|=_),this.d.fcomment&&(e|=F),this.d.fhcrc&&(e|=I),h[c++]=e,t=(Date.now?Date.now():+new Date)/1e3|0,h[c++]=255&t,h[c++]=t>>>8&255,h[c++]=t>>>16&255,h[c++]=t>>>24&255,h[c++]=0,h[c++]=L,this.d.fname!==f){for(l=0,u=m.length;l<u;++l)s=m.charCodeAt(l),255<s&&(h[c++]=s>>>8&255),h[c++]=255&s;h[c++]=0}if(this.d.comment){for(l=0,u=g.length;l<u;++l)s=g.charCodeAt(l),255<s&&(h[c++]=s>>>8&255),h[c++]=255&s;h[c++]=0}return this.d.fhcrc&&(r=65535&n(h,0,c),h[c++]=255&r,h[c++]=r>>>8&255),this.e.outputBuffer=h,this.e.outputIndex=c,a=new o(d,this.e),h=a.g(),c=a.c,v&&(c+8>h.buffer.byteLength?(this.a=new Uint8Array(c+8),this.a.set(new Uint8Array(h.buffer)),h=this.a):h=new Uint8Array(h.buffer)),i=n(d,f,f),h[c++]=255&i,h[c++]=i>>>8&255,h[c++]=i>>>16&255,h[c++]=i>>>24&255,u=d.length,h[c++]=255&u,h[c++]=u>>>8&255,h[c++]=u>>>16&255,h[c++]=u>>>24&255,this.i=p,v&&c<h.length&&(this.a=h=h.subarray(0,c)),h};var L=255,I=2,_=8,F=16;e("Zlib.Gzip",d),e("Zlib.Gzip.prototype.compress",d.prototype.g)}.call(this),r("gzip",function(){}),r("Layer/FitsRequest",["../Utils/ImageRequest"],function(e){e.prototype.send=function(e,t,r){var n=this;if(r)return void n.failCallback(n);if(e.search("fits")>0){var i=new XMLHttpRequest;i.onreadystatechange=function(t){i&&4===i.readyState&&(200===i.status?i.response&&(n.image=i.response,n.successCallback&&n.successCallback(n)):0!==i.status&&(console.log("Error while loading "+e),n.failCallback&&n.failCallback(n)),i=null)},i.onabort=function(e){n.abortCallback&&n.abortCallback(n),n.xhr=null},i.open("GET",e),i.responseType="arraybuffer",i.send(),this.xhr=i}else this.image=new Image,this.image.aborted=!1,this.image.crossOrigin="",this.image.dataType="byte",this.image.onload=function(){var e=0!==n.image.naturalWidth&&n.image.complete;e&&!this.aborted&&n.successCallback.call(n)},this.image.onerror=function(){n.failCallback&&!this.aborted&&n.failCallback(n)},this.image.src=e},e.prototype.abort=function(){this.xhr?this.xhr.abort():(this.abortCallback&&this.abortCallback(this),this.image.aborted=!0,this.image.src="")}}),r("Layer/HipsFitsLayer",["../Utils/Utils","../Tiling/HEALPixTiling","./RasterLayer","../Renderer/DynamicImage","./FitsLoader","gzip","../Utils/ImageRequest","./FitsRequest"],function(e,t,r,n,i,o,a){var s=function(e){r.prototype.constructor.call(this,e),this.tilePixelSize=e.tilePixelSize||512,this.tiling=new t(e.baseLevel||2,e),this.numberOfLevels=e.numberOfLevels||10,this.type="ImageryRaster",this.baseUrl=e.baseUrl,this.format=e.format||"fits",this.coordSystem=e.coordSystem||"EQ",this._ready=!1,this.fitsSupported=!0,this.levelZeroImage=null,this.rawFragShader="precision lowp float; \n",this.rawFragShader+="varying vec2 texCoord;\n",this.rawFragShader+="uniform sampler2D colorTexture; \n",this.rawFragShader+="uniform float opacity; \n",this.rawFragShader+="uniform float inversed; \n",this.rawFragShader+="bool isnan(float val) {\n",this.rawFragShader+="\t\treturn (val <= 0.0 || 0.0 <= val) ? ((val == 5e-324) ? true : false) : true;\n",this.rawFragShader+="}\n",this.rawFragShader+="void main(void)\n",this.rawFragShader+="{\n",this.rawFragShader+="\tvec4 color = texture2D(colorTexture, vec2(texCoord.x, (inversed == 1.) ? 1.0 - texCoord.y : texCoord.y));\n",this.rawFragShader+="\tgl_FragColor = vec4(color.r,color.g,color.b, color.a*opacity);\n",this.rawFragShader+="\tif (isnan( (gl_FragColor.r + gl_FragColor.g + gl_FragColor.b) / 3. ) )\n",this.rawFragShader+="\t{\n",this.rawFragShader+="\t\tgl_FragColor.a = 0.;\n",this.rawFragShader+="\t}\n",this.rawFragShader+="}\n",this.colormapFragShader="precision lowp float; \n",this.colormapFragShader+="varying vec2 texCoord;\n",this.colormapFragShader+="uniform sampler2D colorTexture; \n",this.colormapFragShader+="uniform sampler2D colormap; \n",this.colormapFragShader+="uniform float min; \n",this.colormapFragShader+="uniform float max; \n",this.colormapFragShader+="uniform float opacity; \n",this.colormapFragShader+="bool isnan(float val) {\n",this.colormapFragShader+="\treturn (val <= 0.0 || 0.0 <= val) ? false : true;\n",this.colormapFragShader+="}\n",this.colormapFragShader+="void main(void)\n",this.colormapFragShader+="{\n",this.colormapFragShader+="\tfloat i = texture2D(colorTexture,vec2(texCoord.x, 1.0 - texCoord.y)).r;\n",this.colormapFragShader+="\tfloat d = clamp( ( i - min ) / (max - min), 0.0, 1.0 );\n",this.colormapFragShader+="\tvec4 cmValue = texture2D(colormap, vec2(d,0.));\n",this.colormapFragShader+="\tgl_FragColor = vec4(cmValue.r,cmValue.g,cmValue.b, cmValue.a*opacity);\n",this.colormapFragShader+="\tif (isnan( i ) )\n",this.colormapFragShader+="\t{\n",this.colormapFragShader+="\t\t gl_FragColor.a = 0.;\n",this.colormapFragShader+="\t}\n",this.colormapFragShader+="}\n";var i=this;this.customShader={fragmentCode:this.rawFragShader,updateUniforms:function(e,t){e.uniform1f(t.uniforms.inversed,i.inversed),i.levelZeroImage&&(e.uniform1f(t.uniforms.max,i.levelZeroImage.tmax),e.uniform1f(t.uniforms.min,i.levelZeroImage.tmin),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,i.levelZeroImage.colormapTex),e.uniform1i(t.uniforms.colormap,1),e.uniform1f(t.uniforms.opacity,i.getOpacity()))}},this.imageRequest=new a({successCallback:function(){var t,r;if(i._ready=!0,"fits"===i.format){try{t=new Uint8Array(i.imageRequest.image),r=o.unzip(t),i.imageRequest.image=new Uint8Array(r).buffer}catch(e){if("Not a GZIP file"!==e)return console.error(e),void this.failCallback();console.log("not gzipped"),t=null}i.handleImage(i.imageRequest);var a=i.imageRequest.image;if(i.planet){var s=i.planet.renderContext.gl;i.levelZeroImage=new n(i.planet.renderContext,a.typedArray,s.LUMINANCE,s.FLOAT,a.width,a.height),i.getLevelZeroTexture=function(){return i.levelZeroImage.texture}}}else i.levelZeroImage=this.image,i.getLevelZeroTexture=null;e.onready&&e.onready instanceof Function&&e.onready(i),i.planet&&i.planet.renderContext.requestFrame()},failCallback:function(){i.planet&&(i.planet.publish("baseLayersError",i),i._ready=!1,console.log("Error while loading background"))},abortCallback:function(e){i._ready=!1,console.log("Background image request has been aborted")}})};return e.inherits(r,s),s.prototype._attach=function(e){r.prototype._attach.call(this,e);var t=this.planet.renderContext.gl;this.requestLevelZeroImage();var n=t.getExtension("OES_texture_float");n||(console.error("no OES_texture_float"),this.fitsSupported=!1)},s.prototype._detach=function(){this._ready||this.imageRequest.abort(),this._ready=!1,this.disposeResources(),r.prototype._detach.call(this)},s.prototype.getUrl=function(e){var t=this.baseUrl;return t+="/Norder",t+=e.order,t+="/Dir",t+=1e4*Math.floor(e.pixelIndex/1e4),t+="/Npix",t+=e.pixelIndex,t+="."+this.format},s.prototype.extractFitsData=function(e,t,r,n){for(var i,o=64,a=(this.levelZeroImage.height,this.levelZeroImage.width),s=this.levelZeroImage.pixels,l=o*a*(28-Math.floor(e/27))+e%27*o,u=0;u<o;u++)i=s.subarray(l+u*a,l+u*a+o),t.set(i,n+128*u+r)},s.prototype.generateLevel0Textures=function(e,t){var r,n,i,o,a,s,l;if("fits"!==this.format){var u=document.createElement("canvas");u.width=128,u.height=128;var h=u.getContext("2d");for(a=0;a<e.length;a++)s=e[a],n=4*s.pixelIndex,i=n%27*64,o=64*Math.floor(n/27),h.drawImage(this.levelZeroImage,i,o,64,64,0,0,64,64),n=4*s.pixelIndex+2,i=n%27*64,o=64*Math.floor(n/27),h.drawImage(this.levelZeroImage,i,o,64,64,64,0,64,64),n=4*s.pixelIndex+1,i=n%27*64,o=64*Math.floor(n/27),h.drawImage(this.levelZeroImage,i,o,64,64,0,64,64,64),n=4*s.pixelIndex+3,i=n%27*64,o=64*Math.floor(n/27),h.drawImage(this.levelZeroImage,i,o,64,64,64,64,64,64),l=h.getImageData(0,0,128,128),l.dataType="byte",s.texture=t.createGLTexture(l),s.imageSize=128}else for(a=0;a<e.length;a++)s=e[a],r=new Float32Array(16384),n=4*s.pixelIndex,this.extractFitsData(n,r,0,8192),n=4*s.pixelIndex+2,this.extractFitsData(n,r,64,8192),n=4*s.pixelIndex+1,this.extractFitsData(n,r,0,0),n=4*s.pixelIndex+3,this.extractFitsData(n,r,64,0),l={typedArray:r,width:128,height:128,dataType:"float"},s.texture=t.createGLTexture(l),s.imageSize=128},s.prototype.handleImage=function(e){if(!(e.image instanceof Image)){var t,r,n,o=i.parseFits(e.image),a=o.getHDU().data,s=a.arrayType.BYTES_PER_ELEMENT;if("Float64Array"===a.arrayType.name)for(r=new Float64Array(a.view.buffer,a.begin,a.length/s),t=new Float32Array(a.length/s),n=0;n<r.length;n++)t[n]=r[n];else t=new Float32Array(a.view.buffer,a.begin,a.length/s);e.image={typedArray:t,width:a.width,height:a.height,dataType:"float"}}},s.prototype.requestLevelZeroImage=function(){this.fitsSupported||(this.format="jpg"),this.customShader.fragmentCode=this.rawFragShader,"fits"===this.format?this.inversed=1:this.inversed=0;var e=this.baseUrl+"/Norder3/Allsky."+this.format;this.imageRequest.send(e)},s.prototype.disposeResources=function(){this.levelZeroImage&&this.levelZeroImage.dispose&&this.levelZeroImage.dispose(),this.levelZeroTexture&&this.planet.renderContext.gl.deleteTexture(this.levelZeroTexture),this.levelZeroImage=null,this.levelZeroTexture=null},s.prototype.setFormat=function(e){this.format=isFits?"fits":"jpg"},s}),r("Layer/HipsLayer",["../Utils/Utils","../Tiling/HEALPixTiling","./RasterLayer"],function(e,t,r){var n=function(e){r.prototype.constructor.call(this,e),this.tilePixelSize=e.tilePixelSize||512,this.tiling=new t(e.baseLevel||2,e),this.numberOfLevels=e.numberOfLevels||10,this.type="ImageryRaster",this.baseUrl=e.baseUrl,this.format=e.format||"jpg",this.coordSystem=e.coordSystem||"EQ",this.levelZeroImage=new Image;var n=this;this.levelZeroImage.crossOrigin="",this.levelZeroImage.onload=function(){n._ready=!0,e.onready&&e.onready instanceof Function&&e.onready(n),n.planet&&n.planet.renderContext.requestFrame()},this.levelZeroImage.onerror=function(e){n.planet.publish("baseLayersError",n),n._ready=!1,console.log("Cannot load "+n.levelZeroImage.src)},this._ready=!1};return e.inherits(r,n),n.prototype._attach=function(e){r.prototype._attach.call(this,e),this._overlay||(this.levelZeroImage.src=this.baseUrl+"/Norder3/Allsky."+this.format)},n.prototype.getUrl=function(e){var t=this.baseUrl;t+="/Norder",t+=e.order,t+="/Dir";var r=1e4*Math.floor(e.pixelIndex/1e4);return t+=r,t+="/Npix",t+=e.pixelIndex,t+="."+this.format},n.prototype.generateLevel0Textures=function(e,t){var r=document.createElement("canvas");r.width=128,r.height=128;var n,i,o,a,s,l=r.getContext("2d");for(n=0;n<e.length;n++){s=e[n],i=4*s.pixelIndex,o=i%27*64,a=64*Math.floor(i/27),l.drawImage(this.levelZeroImage,o,a,64,64,0,0,64,64),i=4*s.pixelIndex+2,o=i%27*64,a=64*Math.floor(i/27),l.drawImage(this.levelZeroImage,o,a,64,64,64,0,64,64),i=4*s.pixelIndex+1,o=i%27*64,a=64*Math.floor(i/27),l.drawImage(this.levelZeroImage,o,a,64,64,0,64,64,64),i=4*s.pixelIndex+3,o=i%27*64,a=64*Math.floor(i/27),l.drawImage(this.levelZeroImage,o,a,64,64,64,64,64,64);var u=l.getImageData(0,0,128,128);u.dataType="byte",s.texture=t.createGLTexture(u),s.imageSize=128}},n}),r("Layer/MocLayer",["jquery","./BaseLayer","../Renderer/FeatureStyle","../Utils/Utils","../Tiling/HEALPixBase","./FitsLoader"],function(e,t,r,n,i,o){var a=function(e){t.prototype.constructor.call(this,e),this.serviceUrl=e.serviceUrl,this.startOrder=e.startOrder||2,e&&e.style?this.style=new r(e.style):this.style=new r,this.featuresSet=null};return n.inherits(t,a),a.prototype._attach=function(r){t.prototype._attach.call(this,r);var n,a=this;String(a.serviceUrl).endsWith(".fits")?o.loadFits(a.serviceUrl,function(e){var t={},r=e.getHDU(1).data;for(n=0;n<r.rows;n++){var o=r.getRow(n),s=i.uniq2hpix(o[r.columns[0]]),l=s[0];void 0===t[l]&&(t[l]=[]),t[l].push(s[1])}if(t.hasOwnProperty("0")||t.hasOwnProperty("1")||t.hasOwnProperty("2"))for(n=0;n<3;n++)if(t.hasOwnProperty(n)){var u=t[n];_.each(u,function(e){var r=i.getChildren(e);t.hasOwnProperty(n+1)||(t[n+1]=[]),t[n+1].push(r[0]),t[n+1].push(r[1]),t[n+1].push(r[2]),t[n+1].push(r[3])}),delete t[n]}a.moc=t,a.handleDistribution(t)}):e.ajax({type:"GET",url:a.serviceUrl,dataType:"json",success:function(e){a.handleDistribution(e)},error:function(t,r,n){e("#addLayer_"+a.id).find("label").css("color","red"),console.error(t.responseText)}}),r.tileManager.addPostRenderer(this)},a.prototype.generate=function(e){if(this.featuresSet&&e.order===this.startOrder){var t=this.featuresSet[e.pixelIndex];if(t)for(var r=0;r<t.length;r++)this.planet.vectorRendererManager.addGeometryToTile(this,t[r],this.style,e)}},a.prototype.render=function(){},a.prototype._detach=function(){for(var e in this.featuresSet)for(var r=this.planet.tileManager.level0Tiles[e],n=0;n<this.featuresSet[e].length;n++)this.planet.vectorRendererManager.removeGeometryFromTile(this.featuresSet[e][n],r);this.featuresSet=null,this.planet.tileManager.removePostRenderer(this),t.prototype._detach.call(this)},a.prototype.findChildIndices=function(e,t){for(var r=this.startOrder,n=r-t,i=Math.pow(4,n),o=e*i,a=[],s=o;s<o+i;s++)a.push(s);return a},a.prototype.findParentIndex=function(e,t){var r=this.startOrder,n=t-r;return Math.floor(e/Math.pow(4,n))},a.prototype.handleDistribution=function(e){this.planet.tileManager.renderContext.gl;this.featuresSet={};var t,r,n,o;for(var a in e){var s=parseInt(a);for(r=0;r<e[a].length;r++){var l=e[a][r];if(s>this.startOrder)t=this.findParentIndex(l,s);else{if(s!==this.startOrder){var u=this.findChildIndices(l,s);void 0===e[this.startOrder.toString()]?e[this.startOrder.toString()]=e[0].concat(u):e[this.startOrder.toString()]=e[this.startOrder.toString()].concat(u);continue}t=l}var h={type:"Polygon",gid:"moc"+this.id+"_"+s+"_"+l,coordinates:[[]]},c=2,d=1;s<5&&(c=5,d=1/(c-1));var f,p,m=Math.pow(2,s),v=l&m*m-1,g=i.compress_bits(v),y=i.compress_bits(v>>>1),x=l>>>2*s;for(n=0;n<2;n++)for(o=0;o<c;o++)f=i.fxyf((g+n*(c-1)*d)/m,(y+o*d)/m,x),p=this.planet.coordinateSystem.from3DToGeo(f),0===n?h.coordinates[0][2*n*c+(c-1)-o]=[p[0],p[1]]:h.coordinates[0][2*n*c+o]=[p[0],p[1]];for(o=0;o<2;o++)for(n=0;n<c;n++)f=i.fxyf((g+n*d)/m,(y+o*(c-1)*d)/m,x),p=this.planet.coordinateSystem.from3DToGeo(f),1===o?h.coordinates[0][c+2*o*c+(c-1)-n]=[p[0],p[1]]:h.coordinates[0][c+2*o*c+n]=[p[0],p[1]];var b=this.planet.tileManager.level0Tiles[t];this.featuresSet[t]||(this.featuresSet[t]=[]),this.featuresSet[t].push(h),this.planet.vectorRendererManager.addGeometryToTile(this,h,this.style,b)}}},a}),r("Layer/OpenSearchLayer",["../Renderer/FeatureStyle","../Renderer/VectorRendererManager","../Utils/Utils","./BaseLayer","../Renderer/RendererTileData","../Tiling/Tile"],function(e,t,r,n,i,o){function a(e,t){return e.tile.distance-t.tile.distance}var s=function(t){n.prototype.constructor.call(this,t),this.serviceUrl=t.serviceUrl,this.minOrder=t.minOrder||5,this.maxRequests=t.maxRequests||2,this.requestProperties="",this.invertY=t.invertY||!1,this.coordSystemRequired=!t.hasOwnProperty("coordSystemRequired")||t.coordSystemRequired,t&&t.style?this.style=t.style:this.style=new e,this.extId="os",this.features=[],this.featuresSet={},this.freeRequests=[],this.tilesToLoad=[];for(var r=0;r<this.maxRequests;r++){var i=new XMLHttpRequest;this.freeRequests.push(i)}};r.inherits(n,s);var l=function(e,t,r){this.layer=e,this.parent=r,this.tile=t,this.featureIds=[],this.state=s.TileState.NOT_LOADED,this.complete=!1,this.childrenCreated=!1};return s.prototype._attach=function(e){n.prototype._attach.call(this,e),this.extId+=this.id,e.tileManager.addPostRenderer(this)},s.prototype._detach=function(){this.planet.tileManager.removePostRenderer(this),n.prototype._detach.call(this)},s.prototype.launchRequest=function(e,t){var r=e.extension[this.extId];if(0!==this.freeRequests.length){r.state=s.TileState.LOADING,""!==this.requestProperties&&(t+="&"+this.requestProperties),this.maxRequests===this.freeRequests.length&&this.planet.publish("startLoad",this);var n=this.freeRequests.pop(),i=this;n.onreadystatechange=function(t){var o,a,l,u;if(4===n.readyState){if(200===n.status){for(l=JSON.parse(n.response),r.complete=l.totalResults===l.features.length,i.updateFeatures(l.features),o=l.features.length-1;o>=0;o--)a=l.features[o],a.hasOwnProperty("id")||(a.id=a.properties.identifier),u=i.featuresSet.hasOwnProperty(a.id),u&&l.features.splice(o,1),i.addFeature(a,e);i.planet.refresh()}else if(n.status>=400)return r.complete=!0,void console.error(n.responseText);r.state=s.TileState.LOADED,i.freeRequests.push(n),void 0!==l&&null!==l.features&&l.features.length>0&&i.publish("features:added",{layer:i,features:l.features}),i.maxRequests===i.freeRequests.length&&i.planet.publish("endLoad",i)}},n.open("GET",t),n.send()}},s.prototype.setRequestProperties=function(e){for(var t in this.featuresSet)for(var r=this.featuresSet[t],n=0;n<r.tiles.length;n++){var i=r.tiles[n],o=this.features[r.index];this.planet.vectorRendererManager.removeGeometryFromTile(this,o.geometry,i)}var a=this;this.planet.tileManager.visitTiles(function(e){e.extension[a.extId]&&(e.extension[a.extId].dispose(),e.extension[a.extId].featureIds=[],e.extension[a.extId].state=s.TileState.NOT_LOADED,e.extension[a.extId].complete=!1)}),this.featuresSet={},this.features=[],this.requestProperties="";for(var l in e)""!==this.requestProperties&&(this.requestProperties+="&"),this.requestProperties+=l+"="+e[l]},s.prototype.addFeature=function(e,t){var r,n=t.extension[this.extId];this.featuresSet.hasOwnProperty(e.id)?(r=this.featuresSet[e.id],r.tiles.push(t),e=this.features[r.index]):(this.features.push(e),r={index:this.features.length-1,tiles:[t]},this.featuresSet[e.properties.identifier]=r,this.featuresSet[e.id]=r),n.featureIds.push(e.id),e.geometry.gid=e.id;var i=e.properties.style?e.properties.style:this.style;this.planet.vectorRendererManager.addGeometryToTile(this,e.geometry,i,t)},s.prototype.removeFeature=function(e,t){var r=this.featuresSet[e];if(r){var n=r.tiles.indexOf(t);if(n>=0?r.tiles.splice(n,1):console.log("OpenSearchLayer internal error : tile not found when removing feature"),0===r.tiles.length){delete this.featuresSet[e];var i=this.features.pop();r.index<this.features.length&&(this.features[r.index]=i,this.featuresSet[i.id].index=r.index)}}},s.prototype.modifyFeatureStyle=function(e,t){e.properties.style=t;var r=this.featuresSet[e.id];if(r)for(var n=0;n<r.tiles.length;n++){var i=r.tiles[n];this.planet.vectorRendererManager.removeGeometryFromTile(e.geometry,i),this.planet.vectorRendererManager.addGeometryToTile(this,e.geometry,t,i)}},s.TileState={LOADING:0,LOADED:1,NOT_LOADED:2,INHERIT_PARENT:3},s.prototype.generate=function(e){e.order===this.minOrder&&(e.extension[this.extId]=new l(this,e,null))},l.prototype.traverse=function(e){if(this.layer._visible&&e.state===o.State.LOADED&&(this.state===s.TileState.NOT_LOADED&&this.layer.tilesToLoad.push(this),this.state===s.TileState.LOADED&&!this.complete&&e.state===o.State.LOADED&&e.children&&!this.childrenCreated)){var t;for(t=0;t<4;t++)e.children[t].extension[this.layer.extId]||(e.children[t].extension[this.layer.extId]=new l(this.layer,e.children[t],this));this.childrenCreated=!0;var r=e.extension.renderer?e.extension.renderer.renderables:[];for(t=0;t<r.length;t++)r[t].bucket.layer===this.layer&&(r[t].hasChildren=!0)}},l.prototype.dispose=function(e,t){var r;if(this.parent&&this.parent.childrenCreated){this.parent.childrenCreated=!1;var n=this.parent.tile.extension.renderer?this.parent.tile.extension.renderer.renderables:[];for(r=0;r<n.length;r++)n[r].bucket.layer===this.layer&&(n[r].hasChildren=!1)}for(r=0;r<this.featureIds.length;r++)this.layer.removeFeature(this.featureIds[r],this.tile);this.tile=null,this.parent=null},s.prototype.buildUrl=function(e){var t=this.serviceUrl+"/search?order="+e.order+"&healpix="+e.pixelIndex;return this.coordSystemRequired&&(t+="&coordSystem=EQUATORIAL"),t+="&media=json"},s.prototype.render=function(e){if(this._visible){this.tilesToLoad.sort(a);for(var t=0;t<this.tilesToLoad.length&&this.freeRequests.length>0;t++){var r=this.tilesToLoad[t].tile,n=this.buildUrl(r);n&&this.launchRequest(r,n)}this.tilesToLoad.length=0}},s.prototype.updateFeatures=function(e){for(var t=0;t<e.length;t++){var r=e[t];switch(r.geometry.type){case"Point":r.geometry.coordinates[0]>180&&(r.geometry.coordinates[0]-=360);break;case"Polygon":for(var n=r.geometry.coordinates[0],i=0;i<n.length;i++)n[i][0]>180&&(n[i][0]-=360)}}},s}),r("Layer/PlanetLayer",["jquery","underscore-min","./BaseLayer","./WMSLayer","./WCSElevationLayer","../Utils/Utils"],function(e,t,r,n,i,o){var a=function(t){r.prototype.constructor.call(this,t),this.name=t.name,this.baseImageries=[],this.layers=[],this.category="Planets",this.nameResolver=t.nameResolver,this.typeLayer="Planet";for(var o=0;o<t.baseImageries.length;o++){var a=t.baseImageries[o];a=e.extend({},t,a);var s=new n(a);s.background=!0,s.category="background",s.type="WMS",this.baseImageries.push(s)}t.elevation&&(this.elevationLayer=new i(t.elevation))};return o.inherits(r,a),a.prototype._attach=function(e){r.prototype._attach.call(this,e);var n=t.findWhere(this.baseImageries,{_visible:!0});n||(n=this.baseImageries[0]),this.planet.setBaseImagery(n),this.elevationLayer&&this.planet.setBaseElevation(this.elevationLayer),n.setVisible(!0);for(var i=0;i<this.layers.length;i++)this.planet.addLayer(this.layers[i])},a.prototype._detach=function(){this.planet.setBaseImagery(null);for(var e=0;e<this.layers.length;e++)this.planet.removeLayer(this.layers[e]);r.prototype._detach.call(this)},a}),r("Layer/WMSElevationLayer",["../Utils/Utils","./WMSLayer"],function(e,t){var r=function(e){e.format="image/x-aaigrid",e.tilePixelSize=e.tilePixelSize||33,t.prototype.constructor.call(this,e)};return e.inherits(t,r),r.prototype.parseElevations=function(e){for(var t=[],r=e.trim().split("\n"),n=5;n<r.length;n++)for(var i=r[n].trim().split(/\s+/),o=0;o<i.length;o++)t.push(parseInt(i[o]));return t},r}),r("Layer/LayerFactory",["./WMSLayer","./WMTSLayer","./WCSElevationLayer","./VectorLayer","./AtmosphereLayer","./BingLayer","./GroundOverlayLayer","./OSMLayer","./TileWireframeLayer","./CoordinateGridLayer","./HipsFitsLayer","./HipsLayer","./MocLayer","./OpenSearchLayer","./PlanetLayer","./WMSElevationLayer"],function(e,t,r,n,i,o,a,s,l,u,h,c,d,f,p,m){var v=function(){};return v.prototype.create=function(e,t){switch(e){case"WMS":return this.createWMS(t);case"WMTS":return this.createWMTS(t);case"WMSElevation":return this.createWMSElevation(t);case"WCSElevation":return this.createWCSElevation(t);case"Vector":return this.createVector(t);case"Atmosphere":return this.createAtmosphere(t);case"Bing":return this.createBing(t);case"GroundOverlay":return this.createGroundOverlay(t);case"OSM":return this.createOSM(t);case"TileWireframe":return this.createTileWireframe(t);case"CoordinateGrid":return this.createCoordinateGrid(t);case"HipsFits":return this.createHipsFits(t);case"Hips":return this.createHips(t);case"Moc":return this.createMoc(t);case"OpenSearch":return this.createOpenSearch(t);case"Planet":return this.createPlanet(t);default:return null}},v.prototype.createWMS=function(t){return layer=new e(t),layer},v.prototype.createWCSElevation=function(e){return layer=new r(e),layer},v.prototype.createVector=function(e){return layer=new n(e),layer},v.prototype.createAtmosphere=function(e){return layer=new i(e),layer},v.prototype.createWMTS=function(e){return layer=new t(e),layer},v.prototype.createBing=function(e){return layer=new o(e),layer},v.prototype.createGroundOverlay=function(e){return layer=new a(e),layer},v.prototype.createOSM=function(e){return layer=new s(e),layer},v.prototype.createTileWireframe=function(e){return layer=new l(e),layer},v.prototype.createCoordinateGrid=function(e){return layer=new u(e),layer},v.prototype.createHipsFits=function(e){return layer=new h(e),layer},v.prototype.createHips=function(e){return layer=new c(e),layer},v.prototype.createMoc=function(e){return layer=new d(e),layer},v.prototype.createOpenSearch=function(e){return layer=new f(e),layer},v.prototype.createPlanet=function(e){return layer=new p(e),layer},v.prototype.createWMSElevation=function(e){return layer=new m(e),layer},v}),r("DrawingFactory",["./Renderer/FeatureStyle"],function(e){var t=function(){};return t.prototype.createFeatureStyle=function(t){return new e(t)},t.prototype.fromStringToColor=function(t){return e.fromStringToColor(t)},t}),function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}},r=[].indexOf||function(e){for(var t=0,r=this.length;t<r;t++)if(t in this&&this[t]===e)return t;return-1};e="undefined"!=typeof exports&&null!==exports&&this||(this.WCS={}),e.Math={},e.Math.R2D=180/Math.PI,e.Math.D2R=Math.PI/180,e.Math.WCSTRIG_TOL=1e-10,e.Math.cosd=function(t){
var r;if(t%90===0)switch(r=Math.abs(Math.floor(t/90+.5))%4){case 0:return 1;case 1:return 0;case 2:return-1;case 3:return 0}return Math.cos(t*e.Math.D2R)},e.Math.sind=function(t){var r;if(t%90===0)switch(r=Math.abs(Math.floor(t/90-.5))%4){case 0:return 1;case 1:return 0;case 2:return-1;case 3:return 0}return Math.sin(t*e.Math.D2R)},e.Math.sincosd=function(t){var r,n,i,o,a;if(t%90===0){switch(n=Math.abs(Math.floor(t/90+.5))%4){case 0:i=0,r=1;break;case 1:i=null!=(o=t>0)?o:{1:-1},r=0;break;case 2:i=0,r=-1;break;case 3:i=null!=(a=t>0)?a:-{1:1},r=0}return i*r}return i=Math.sin(t*e.Math.D2R),r=Math.cos(t*e.Math.D2R),i*r},e.Math.tand=function(t){var r;return r=360&t,0===r||180===Math.abs(r)?0:45===r||225===r?1:r===-135||r===-315?-1:Math.tan(t*e.Math.D2R)},e.Math.acosd=function(t){if(t>=1){if(t-1<e.Math.WCSTRIG_TOL)return 0}else{if(0===t)return 90;if(t<=-1&&t+1>-e.Math.WCSTRIG_TOL)return 180}return Math.acos(t)*e.Math.R2D},e.Math.asind=function(t){if(t<=-1){if(t+1>-e.Math.WCSTRIG_TOL)return-90;if(0===t)return 0;if(t>=1&&t-1<e.Math.WCSTRIG_TOL)return 90}return Math.asin(t)*e.Math.R2D},e.Math.atand=function(t){return t===-1?-45:0===t?0:1===t?45:Math.atan(t)*e.Math.R2D},e.Math.atan2d=function(t,r){if(0===t){if(r>=0)return 0;if(r<0)return 180}else if(0===r){if(t>0)return 90;if(t<0)return-90}return Math.atan2(t,r)*e.Math.R2D},e.Math.toRightTriangular=function(e){var t,r,n,i,o,a,s,l,u;for(s=e.length,i=s,o=e[0].length;;){if(r=i-s,0===e[r][r])for(n=r+1;n<i;){if(0!==e[n][r]){for(t=[],l=o;;)if(u=o-l,t.push(e[r][u]+e[n][u]),!--l)break;e[r]=t;break}n+=1}if(0!==e[r][r])for(n=r+1;n<i;){for(a=e[n][r]/e[r][r],t=[],l=o;;)if(u=o-l,t.push(u<=r?0:e[n][u]-e[r][u]*a),!--l)break;e[n]=t,n+=1}if(!--s)break}return e},e.Math.determinant=function(t){var r,n,i,o,a;for(o=e.Math.toRightTriangular(t),r=o[0][0],a=o.length-1,i=a;;)if(n=i-a+1,r*=o[n][n],!--a)break;return r},e.Math.matrixInverse=function(t){var r,n,i,o,a,s,l,u;for(u=t[0].length,n=t.length,r=new Array(n),o=new Array(n),l=[],s=[],a=0;a<n;){for(s[a]=[],i=0;i<u;)s[a][i]=t[a][i],i+=1;a+=1}for(a=0;a<n;){for(r[a]=new Array(u),o[a]=new Array(u),i=0;i<u;)r[a][i]=i===a?1:0,i+=1;l[a]=s[a].concat(r[a]),a+=1}for(e.Math.gaussJordan(l),a=0;a<n;)o[a]=l[a].slice(u,2*u),a+=1;return o},e.Math.gaussJordan=function(e,t){t||(t=1e-10);var r,n,i,o,a,s,l,u;for(r=e.length,n=e[0].length,i=-1;++i<r;){for(s=i,o=i;++o<r;)Math.abs(e[o][i])>Math.abs(e[s][i])&&(s=o);if(l=e[i],e[i]=e[s],e[s]=l,Math.abs(e[i][i])<=t)return!1;for(o=i;++o<r;)for(u=e[o][i]/e[i][i],a=i-1;++a<n;)e[o][a]-=e[i][a]*u}for(i=r;--i>=0;){for(u=e[i][i],o=-1;++o<i;)for(a=n;--a>=i;)e[o][a]-=e[i][a]*e[o][i]/u;for(e[i][i]/=u,a=r-1;++a<n;)e[i][a]/=u}return!0},e.Mapper=function(){function n(e){this.coordinateToPixel=t(this.coordinateToPixel,this),this.pixelToCoordinate=t(this.pixelToCoordinate,this),this.fromCelestial=t(this.fromCelestial,this),this.toCelestial=t(this.toCelestial,this),this.fromIntermediate=t(this.fromIntermediate,this),this.toIntermediate=t(this.toIntermediate,this),this.computeCelestialParameters=t(this.computeCelestialParameters,this),this.getSipCoefficients=t(this.getSipCoefficients,this),this.setProjection=t(this.setProjection,this),this.derivePC=t(this.derivePC,this),this.checkCard=t(this.checkCard,this),this.verifyHeader=t(this.verifyHeader,this),this.wcsobj={},this.projection=void 0,this.longitudeAxis=void 0,this.latitudeAxis=void 0,this.sip=void 0,this.verifyHeader(e),this.setProjection(e)}return n.prototype.verifyHeader=function(t){var r,n,i,o,a,s,l,u,h,c,d;for(this.wcsobj.naxis=s=t.NAXIS||t.WCSAXES||2,this.wcsobj.radesys=t.RADESYS||"ICRS",l=["CRPIX","CRVAL","CTYPE"],this.wcsobj.crpix=[],this.wcsobj.crval=[],this.wcsobj.ctype=[],n=u=1;1<=s?u<=s:u>=s;n=1<=s?++u:--u)for(o=h=0,d=l.length-1;0<=d?h<=d:h>=d;o=0<=d?++h:--h){if(a=l[o]+n,!t.hasOwnProperty(a))throw"Not enough information to compute WCS, missing required keyword "+a;r=l[o].toLowerCase(),this.wcsobj[r].push(t[a])}for(this.wcsobj.cunit=[],this.wcsobj.cdelt=[],n=c=1;1<=s?c<=s:c>=s;n=1<=s?++c:--c)a="CUNIT"+n,this.wcsobj.cunit.push(t[a]||"deg"),a="CDELT"+n,this.wcsobj.cdelt.push(t[a]||1);if(this.wcsobj.lonpole=t.LONPOLE||0,this.wcsobj.latpole=t.LATPOLE||0,this.wcsobj.equinox=t.EQUINOX||2e3,i=new Date,this.wcsobj.dateObs=t.DATE_OBS||i.getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate(),this.wcsobj.dateObs=t.DATE_OBS||""+i.getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate(),this.wcsobj.pc=this.checkCard(t,"PC",s)||this.derivePC(t),this.wcsobj.pcInv=e.Math.matrixInverse(this.wcsobj.pc),this.wcsobj.cd=this.checkCard(t,"CD",s),null!=this.wcsobj.cd)return this.wcsobj.cdInv=e.Math.matrixInverse(this.wcsobj.cd)},n.prototype.checkCard=function(e,t,r){var n,i,o,a,s,l;for(a=[],i=s=1;1<=r?s<=r:s>=r;i=1<=r?++s:--s)for(a[i-1]=[],o=l=1;1<=r?l<=r:l>=r;o=1<=r?++l:--l){if(n=""+t+i+"_"+o,!e.hasOwnProperty(n))return;a[i-1].push(e[n])}return a},n.prototype.derivePC=function(e){var t,r,n,i,o,a,s,l,u,h,c;return e.hasOwnProperty("CROTA2")?(s=e.CROTA2,l=this.wcsobj.cdelt[1]/this.wcsobj.cdelt[0]):(t=this.checkCard(e,"CD",this.wcsobj.naxis),null==t?(c=[0,1],s=c[0],l=c[1]):(r=t[0][0],n=t[0][1],i=t[1][0],o=t[1][1],u=i>0?Math.atan2(i,r):0===i?0:Math.atan2(-i,-r),h=n>0?Math.atan2(n,-o):0===n?0:Math.atan2(-i,o),s=.5*(u+h),a=Math.cos(s),this.wcsobj.cdelt1=r/a,this.wcsobj.cdelt2=o/a,l=this.wcsobj.cdelt2/this.wcsobj.cdelt1)),t},n.prototype.setProjection=function(t){var n,i,o,a,s,l,u,h,c,d,f,p,m,v,g,y,x,b,T=this;if(c=["AIR","ARC","AZP","NCP","SIN","STG","SZP","TAN","TAN-SIP","ZEA","ZPN"],i=["CYP","CEA","CAR","MER","SFL","PAR","MOL","AIT"],n=["COP","COE","COD","COO"],u=["BON","PCO"],h=["TSC","CSC","QSC"],this.projection=this.wcsobj.ctype[0].slice(5),this.longitudeAxis=this.wcsobj.ctype[0].match("RA|GLON|ELON|HLON|SLON")?1:2,this.latitudeAxis=this.wcsobj.ctype[1].match("DEC|GLAT|ELAT|HLAT|SLAT")?2:1,d=this.projection,r.call(c,d)>=0)switch(this.wcsobj.phi0=0,this.wcsobj.theta0=90,this.wcsobj.alphaP=this.wcsobj.crval[0],this.wcsobj.deltaP=this.wcsobj.crval[1],this.wcsobj.lonpole=this.wcsobj.crval[1]>=this.wcsobj.theta0?0:180,this.projection){case"AIR":o="PV"+this.latitudeAxis+"_1",this.wcsobj.thetaB=t.hasOwnProperty(o)?parseFloat(t[o]):90,this.wcsobj.etaB=(90-this.wcsobj.thetaB)/2;break;case"ARC":this.toSpherical=function(t,r){var n,i,o;return i=Math.sqrt(t*t+r*r),o=T.wcsobj.theta0-i,n=e.Math.atan2d(t,-r),[n,o]},this.fromSpherical=function(t,r){var n,i,o;return n=90-r,i=n*e.Math.sind(t),o=-n*e.Math.cosd(t),[i,o]};break;case"AZP":f=["PV"+this.latitudeAxis+"_1","PV"+this.latitudeAxis+"_2"],a=f[0],s=f[1],this.wcsobj.mu=t.hasOwnProperty(a)?parseFloat(t[a]):0,this.wcsobj.gamma=t.hasOwnProperty(s)?parseFloat(t[s]):0,this.toSpherical=function(e,t){throw"Sorry, not yet implemented!"},this.fromSpherical=function(e,t){throw"Sorry, not yet implemented!"};break;case"NCP":this.toSpherical=function(e,t){throw"Sorry, not yet implemented!"},this.fromSpherical=function(e,t){throw"Sorry, not yet implemented!"};break;case"SIN":p=["PV"+this.latitudeAxis+"_1","PV"+this.latitudeAxis+"_2"],a=p[0],s=p[1],this.wcsobj.eta=t.hasOwnProperty(a)?parseFloat(t[a]):0,this.wcsobj.nu=t.hasOwnProperty(s)?parseFloat(t[s]):0,this.toSpherical=function(t,r){var n,i,o;return i=Math.sqrt(t*t+r*r),o=e.Math.acosd(Math.PI*i/180),n=e.Math.atan2d(t,-r),[n,o]},this.fromSpherical=function(t,r){var n,i,o;return n=180/Math.PI*e.Math.cosd(r),i=n*e.Math.sind(t),o=-n*e.Math.cosd(t),[i,o]};break;case"STG":this.toSpherical=function(t,r){var n,i,o;return i=Math.sqrt(t*t+r*r),o=T.wcsobj.theta0-2*e.Math.atand(Math.PI*i/360),n=e.Math.atan2d(t,-r),[n,o]},this.fromSpherical=function(t,r){var n,i,o;return n=360/Math.PI*e.Math.tand((90-r)/2),i=n*e.Math.sind(t),o=-n*e.Math.cosd(t),[i,o]};break;case"SZP":m=["PV"+this.latitudeAxis+"_1","PV"+this.latitudeAxis+"_2","PV"+this.latitudeAxis+"_3"],a=m[0],s=m[1],l=m[2],this.wcsobj.mu=t.hasOwnProperty(a)?parseFloat(t[a]):0,this.wcsobj.phiC=t.hasOwnProperty(s)?parseFloat(t[s]):0,this.wcsobj.thetaC=t.hasOwnProperty(l)?parseFloat(t[l]):90,this.wcsobj.xp=-this.wcsobj.mu*e.Math.cosd(this.wcsobj.thetaC)*e.Math.sind(this.wcsobj.phiC),this.wcsobj.yp=this.wcsobj.mu*e.Math.cosd(this.wcsobj.thetaC)*e.Math.cosd(this.wcsobj.phiC),this.wcsobj.zp=this.wcsobj.mu*e.Math.sind(this.wcsobj.thetaC)+1,this.toSpherical=function(e,t){throw"Sorry, not yet implemented"},this.fromSpherical=function(t,r){var n,i,o;throw"Sorry, not yet implemented";return n=T.wcsobj.zp-1+e.Math.sind(r),i=180/Math.PI*(T.wcsobj.zp*e.Math.cosd(r)*e.Math.sind(t)-T.wcsobj.xp*(1-e.Math.sind(r)))/n,o=-180/Math.PI*(T.wcsobj.zp*e.Math.cosd(r)*e.Math.cosd(t)+T.wcsobj.yp*(1-e.Math.sind(r)))/n,[i,o]};break;case"TAN":this.toSpherical=function(t,r){var n,i,o;return i=Math.sqrt(t*t+r*r),o=e.Math.atand(180/(Math.PI*i)),n=e.Math.atan2d(t,-r),[n,o]},this.fromSpherical=function(t,r){var n,i,o;return n=180/(Math.PI*e.Math.tand(r)),i=n*e.Math.sind(t),o=-n*e.Math.cosd(t),[i,o]};break;case"TAN-SIP":this.getSipCoefficients(t),this.f=function(e,t,r){var n,i,o,a,s,l;for(a=0,n=r[0].length-1,i=s=0;0<=n?s<=n:s>=n;i=0<=n?++s:--s)for(o=l=0;0<=n?l<=n:l>=n;o=0<=n?++l:--l)a+=r[i][o]*Math.pow(e,i)*Math.pow(t,o);return a},this.toIntermediate=function(e){var t,r,n,i,o,a,s,l,u,h,c;for(o=[],a=e[0]-T.wcsobj.crpix[0],s=e[1]-T.wcsobj.crpix[1],t=r=0,t=T.f(a,s,T.sip.aCoeffs),r=T.f(a,s,T.sip.bCoeffs),e[0]=e[0]+t,e[1]=e[1]+r,n=l=0,h=T.wcsobj.naxis-1;0<=h?l<=h:l>=h;n=0<=h?++l:--l)for(o[n]=0,e[n]-=T.wcsobj.crpix[n],i=u=0,c=T.wcsobj-1;0<=c?u<=c:u>=c;i=0<=c?++u:--u)o[n]+=T.wcsobj.cd[n][i]*e[i];return o},this.fromIntermediate=function(e){var t,r,n,i,o,a,s,l,u,h;for(a=[],n=s=0,u=T.wcsobj.naxis-1;0<=u?s<=u:s>=u;n=0<=u?++s:--s){for(a[n]=0,i=l=0,h=T.wcsobj.naxis-1;0<=h?l<=h:l>=h;i=0<=h?++l:--l)a[n]+=T.wcsobj.cdInv[n][i]*e[i];a[n]+=T.wcsobj.crpix[n]}return t=r=0,t=T.f(a[0],a[1],T.sip.apCoeffs),r=T.f(a[0],a[1],T.sip.bpCoeffs),o=[],o[0]=a[0]+t,o[1]=a[1]+r,o[0]+=T.wcsobj.crpix[0],o[1]+=T.wcsobj.crpix[1],o},this.toSpherical=function(t,r){var n,i,o;return i=Math.sqrt(t*t+r*r),o=e.Math.atand(180/(Math.PI*i)),n=e.Math.atan2d(t,-r),[n,o]},this.fromSpherical=function(t,r){var n,i,o;return n=180/(Math.PI*e.Math.tand(r)),i=n*e.Math.sind(t),o=-n*e.Math.cosd(t),[i,o]};break;case"ZEA":this.toSpherical=function(t,r){var n,i,o;return i=Math.sqrt(t*t+r*r),o=T.wcsobj.theta0-2*e.Math.asind(Math.PI*i/360),n=e.Math.atan2d(t,-r),[n,o]},this.fromSpherical=function(t,r){var n,i,o;return n=360/Math.PI*e.Math.sind((90-r)/2),i=n*e.Math.sind(t),o=-n*e.Math.cosd(t),[i,o]};break;case"ZPN":this.toSpherical=function(e,t){throw"Sorry, not yet implemented!"},this.fromSpherical=function(e,t){throw"Sorry, not yet implemented!"}}if(v=this.projection,r.call(i,v)>=0)switch(this.wcsobj.phi0=0,this.wcsobj.theta0=0,this.computeCelestialParameters(this.wcsobj.phi0,this.wcsobj.theta0),this.projection){case"CYP":g=["PV"+this.latitudeAxis+"_1,","PV"+this.latitudeAxis+"_2"],a=g[0],s=g[1],this.wcsobj.mu=t.hasOwnProperty(a)?parseFloat(t[a]):1,this.wcsobj.lambda=t.hasOwnProperty(s)?parseFloat(t[s]):1,this.wcsobj.mu+this.wcsobj.lambda===0&&raise("Divide by zero error"),this.toSpherical=function(t,r){var n,i,o;return n=Math.PI*r/(180*(T.wcsobj.mu+T.wcsobj.lambda)),o=e.Math.atan2d(n,1)+e.Math.asind(n*T.wcsobj.mu/Math.sqrt(n*n+1)),i=t/T.wcsobj.lambda,[i,o]},this.fromSpherical=function(t,r){var n,i;return n=T.wcsobj.lambda*t,i=180/Math.PI*((T.wcsobj.mu+T.wcsobj.lambda)/(T.wcsobj.mu+e.Math.cosd(r)))*e.Math.sind(r),[n,i]};break;case"CEA":o="PV"+this.latitudeAxis+"_1",this.wcsobj.lambda=t.hasOwnProperty(o)?parseFloat(t[o]):1,this.toSpherical=function(t,r){var n;return n=e.Math.asind(Math.PI*T.wcsobj.lambda*r/180),[t,n]},this.fromSpherical=function(t,r){var n;return n=180/Math.PI*e.Math.sind(r)/T.wcsobj.lambda,[t,n]};break;case"CAR":this.toSpherical=function(e,t){return[e,t]},this.fromSpherical=function(e,t){return[e,t]};break;case"MER":this.toSpherical=function(t,r){var n;return n=2*e.Math.atand(Math.exp(r*Math.PI/180))-90,[t,n]},this.fromSpherical=function(t,r){var n;return n=180/Math.PI*Math.log(e.Math.tand((90+r)/2)),[t,n]};break;case"SFL":this.toSpherical=function(t,r){var n;return n=t/e.Math.cosd(r),[n,r]},this.fromSpherical=function(t,r){var n;return n=t*e.Math.cosd(r),[n,r]};break;case"PAR":this.toSpherical=function(t,r){var n,i;return i=3*e.Math.asind(r/180),n=t/(1-4*Math.pow(r/180,2)),[n,i]},this.fromSpherical=function(t,r){var n,i;return n=t*(2*e.Math.cosd(2*r/3)-1),i=180*e.Math.sind(r/3),[n,i]};break;case"MOL":this.toSpherical=function(t,r){var n,i;return i=e.Math.asind(e.Math.asind(Math.PI*r/(180*Math.sqrt(2)))/90+r/180*Math.sqrt(2-Math.pow(Math.PI*r/180,2))),n=Math.PI*t/(2*Math.sqrt(2-Math.pow(Math.PI*r/180,2))),[n,i]},this.fromSpherical=function(t,r){var n,i;throw"Sorry, not yet implemented!";return n=2*Math.sqrt(2)/Math.PI*t*e.Math.cosd(gamma),i=180*Math.sqrt(2)/Math.PI*e.Math.sind(gamma),[n,i]};break;case"AIT":this.toSpherical=function(t,r){var n,i,o,a,s;return o=Math.pow(Math.PI*t/720,2),a=Math.pow(Math.PI*r/360,2),s=Math.sqrt(1-o-a),i=e.Math.asind(Math.PI*r*s/180),n=2*e.Math.atan2d(Math.PI*s*t/360,2*s*s-1),[n,i]},this.fromSpherical=function(t,r){var n,i,o;return n=180/Math.PI*Math.sqrt(2/(1+e.Math.cosd(r)*e.Math.cosd(t/2))),i=2*n*e.Math.cosd(r)*e.Math.sind(t/2),o=n*e.Math.sind(r),[i,o]}}if(y=this.projection,r.call(n,y)>=0)throw o="PV"+this.latitudeAxis+"_1",this.wcsobj.phi0=0,this.wcsobj.theta0=t.hasOwnProperty(o)?t[o]:0,"Sorry, not yet implemented!";if(x=this.projection,r.call(u,x)>=0)throw this.wcsobj.phi0=0,this.wcsobj.theta0=0,"Sorry, not yet implemented!";if(b=this.projection,r.call(h,b)>=0)throw this.wcsobj.phi0=0,this.wcsobj.theta0=0,"Sorry, not yet implemented!"},n.prototype.getSipCoefficients=function(e){var t,r,n,i,o,a,s,l,u,h,c,d,f,p,m,v,g,y,x;if(!e.hasOwnProperty("A_ORDER")&&!e.hasOwnProperty("B_ORDER"))throw"What's the polynomial order, man!";for(this.sip={},this.sip.aOrder=e.A_ORDER,this.sip.bOrder=e.B_ORDER,this.sip.apOrder=e.AP_ORDER||0,this.sip.bpOrder=e.BP_ORDER||0,this.sip.aCoeffs=[],this.sip.bCoeffs=[],this.sip.apCoeffs=[],this.sip.bpCoeffs=[],t=i=0,d=this.sip.aOrder;0<=d?i<=d:i>=d;t=0<=d?++i:--i)for(this.sip.aCoeffs[t]=[],r=o=0,f=this.sip.aOrder;0<=f?o<=f:o>=f;r=0<=f?++o:--o)n="A_"+t+"_"+r,this.sip.aCoeffs[t][r]=e[n]||0;for(t=a=0,p=this.sip.bOrder;0<=p?a<=p:a>=p;t=0<=p?++a:--a)for(this.sip.bCoeffs[t]=[],r=s=0,m=this.sip.bOrder;0<=m?s<=m:s>=m;r=0<=m?++s:--s)n="B_"+t+"_"+r,this.sip.bCoeffs[t][r]=e[n]||0;for(t=l=0,v=this.sip.apOrder;0<=v?l<=v:l>=v;t=0<=v?++l:--l)for(this.sip.apCoeffs[t]=[],r=u=0,g=this.sip.apOrder;0<=g?u<=g:u>=g;r=0<=g?++u:--u)n="AP_"+t+"_"+r,this.sip.apCoeffs[t][r]=e[n]||0;for(t=h=0,y=this.sip.bpOrder;0<=y?h<=y:h>=y;t=0<=y?++h:--h)for(this.sip.bpCoeffs[t]=[],r=c=0,x=this.sip.bpOrder;0<=x?c<=x:c>=x;r=0<=x?++c:--c)n="BP_"+t+"_"+r,this.sip.bpCoeffs[t][r]=e[n]||0;if(!this.sip.aCoeffs&&!this.sip.bCoeffs)throw"Where are the coefficients dude!"},n.prototype.computeCelestialParameters=function(t,r){var n,i,o,a,s,l,u,h,c,d,f,p;return f=this.wcsobj.crval,n=f[0],i=f[1],p=[this.wcsobj.lonpole,this.wcsobj.latpole],u=p[0],d=p[1],o=e.Math.atan2d(e.Math.sind(this.wcsobj.theta0),e.Math.cosd(this.wcsobj.theta0*e.Math.cosd(u-this.wcsobj.phi0))),a=e.Math.acosd(e.Math.sind(i)/Math.sqrt(1-Math.pow(e.Math.cosd(this.wcsobj.theta0),2)*Math.pow(e.Math.sind(u-this.wcsobj.phi0),2))),h=c=!1,o+a>=-90&&o+a<=90&&(h=!0),o-a>=-90&&o-a<=90&&(c=!0),h&&c?(s=Math.abs(o+a-d),l=Math.abs(o-a-d),this.wcsobj.deltaP=s<l?o+a:o-a):h?this.wcsobj.deltaP=o+a:c?this.wcsobj.deltaP=o-a:this.wcsobj.deltaP=d,this.wcsobj.alphaP=90===Math.abs(i)?n:n-e.Math.asind(e.Math.sind(u-this.wcsobj.phi0)*e.Math.cosd(this.wcsobj.theta0)/e.Math.cosd(i))},n.prototype.toIntermediate=function(e){var t,r,n,i,o,a,s;for(n=[],t=i=0,a=this.wcsobj.naxis-1;0<=a?i<=a:i>=a;t=0<=a?++i:--i)for(n[t]=0,e[t]-=this.wcsobj.crpix[t],r=o=0,s=this.wcsobj.naxis-1;0<=s?o<=s:o>=s;r=0<=s?++o:--o)n[t]+=this.wcsobj.cdelt[t]*this.wcsobj.pc[t][r]*e[r];return n},n.prototype.fromIntermediate=function(e){var t,r,n,i,o,a,s;for(n=[],t=i=0,a=this.wcsobj.naxis-1;0<=a?i<=a:i>=a;t=0<=a?++i:--i){for(n[t]=0,r=o=0,s=this.wcsobj.naxis-1;0<=s?o<=s:o>=s;r=0<=s?++o:--o)n[t]+=this.wcsobj.pcInv[t][r]*e[r]/this.wcsobj.cdelt[t];n[t]+=this.wcsobj.crpix[t]}return n},n.prototype.toCelestial=function(t,r){var n,i,o,a,s,l,u,h,c,d,f;return h=e.Math.sind(r),o=e.Math.cosd(r),u=e.Math.sind(t-this.wcsobj.lonpole),i=e.Math.cosd(t-this.wcsobj.lonpole),l=e.Math.sind(this.wcsobj.deltaP),n=e.Math.cosd(this.wcsobj.deltaP),c=h*n-o*l*i,d=-o*u,f=h*l+o*n*i,s=e.Math.atan2d(d,c)+this.wcsobj.alphaP,s=(s+360)%360,a=e.Math.asind(f),[s,a]},n.prototype.fromCelestial=function(t,r){var n,i,o,a,s,l,u,h,c,d;return l=e.Math.sind(r),i=e.Math.cosd(r),u=e.Math.sind(this.wcsobj.deltaP),o=e.Math.cosd(this.wcsobj.deltaP),s=e.Math.sind(t-this.wcsobj.alphaP),n=e.Math.cosd(t-this.wcsobj.alphaP),c=l*o-i*u*n,d=-i*s,a=this.wcsobj.lonpole+e.Math.atan2d(d,c),h=e.Math.asind(l*u+i*o*n),[a,h]},n.prototype.pixelToCoordinate=function(){var e;return e=this.toIntermediate(arguments[0],arguments[1]),e=this.toSpherical(e[0],e[1]),e=this.toCelestial(e[0],e[1]),{ra:e[this.longitudeAxis-1],dec:e[this.latitudeAxis-1]}},n.prototype.coordinateToPixel=function(){var e;return e=this.fromCelestial(arguments[0],arguments[1]),e=this.fromSpherical(e[0],e[1]),e=this.fromIntermediate(e),{x:e[0],y:e[1]}},n}()}.call(this),r("wcs",function(){}),r("Utils/UtilsCore",["wcs","../Layer/OpenSearchLayer","../Layer/HipsFitsLayer","../Layer/HipsLayer","../Layer/PlanetLayer","../Layer/VectorLayer","../Layer/MocLayer"],function(e,t,r,n,i,o,a){function s(e,t,r){var n,i,o,a=Math.floor(6*e),s=6*e-a,l=r*(1-t),u=r*(1-s*t),h=r*(1-(1-s)*t);switch(a){case 0:n=r,i=h,o=l;break;case 1:n=u,i=r,o=l;break;case 2:n=l,i=r,o=h;break;case 3:n=l,i=u,o=r;break;case 4:n=h,i=l,o=r;break;case 5:n=r,i=l,o=u;break;default:n=1,i=1,o=1}return[n,i,o]}function l(t,r){var n=e.pixelToCoordinate([t,r]);return n.ra>180&&(n.ra-=360),[n.ra,n.dec]}var u,h;return{init:function(e,t){u=e,h=t.votable2geojson.baseUrl},roundNumber:function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)},inherits:function(e,t){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t},generateColor:function(){var e=.618033988749895,t=Math.random();return t+=e,t%=1,s(t,.5,.95)},formatCoordinates:function(e){var t=[];switch(mizar.mode){case"planet":t[0]=this.roundNumber(e[0],3),t[0]+="&deg;",t[1]=this.roundNumber(e[1],3),t[1]+="&deg;";break;case"sky":"EQ"===u.scene.coordinateSystem.type?u.scene.coordinateSystem.fromGeoToEquatorial([e[0],e[1]],t):(e=u.scene.coordinateSystem.convert(e,"EQ",u.scene.coordinateSystem.type),t[0]=this.roundNumber(e[0],4),t[0]+="&deg;",t[1]=this.roundNumber(e[1],4),t[1]+="&deg;");break;default:console.error("This mode "+mizar.mode+" is not supported")}return t},formatId:function(e){return e.replace(/\s{1,}|\.{1,}|\[{1,}|\]{1,}|\({1,}|\){1,}|\~{1,}|\+{1,}|\°{1,}|\-{1,}|\'{1,}|\"{1,}/g,"")},getPolygonCoordinatesFromFits:function(t){var r=t.getHDU(),n=r.data;e=new WCS.Mapper(r.header);var i=[];return i.push(l(0,n.height)),i.push(l(n.width,n.height)),i.push(l(n.width,0)),i.push(l(0,0)),i.push(i[0]),i},computeGeometryBarycenter:function(e){var t,r,n=0,i=0,o=0;switch(e.type){case"MultiLineString":t=e.coordinates[0][0][0],r=e.coordinates[0][0][1];break;case"LineString":t=e.coordinates[0][0],r=e.coordinates[0][1];break;case"Point":t=e.coordinates[0],r=e.coordinates[1];break;case"Polygon":for(var a=0;a<e.coordinates[0].length-1;a++)n+=e.coordinates[0][a][0],i+=e.coordinates[0][a][1],o++;t=n/o,r=i/o;break;case"MultiPolygon":for(var a=0;a<e.coordinates.length;a++)for(var s=e.coordinates[a][0],l=0;l<s.length-1;l++)n+=s[l][0],i+=s[l][1],o++;t=n/o,r=i/o;break;case"LineString":t=n/o,r=i/o;break;default:return}return[t,r]},pointInRing:function(e,t){var r=t.length;t[0][0]===t[r-1][0]&&t[0][1]===t[r-1][1]&&r--;for(var n=!1,i=r-1,o=0;o<r;i=o++)t[o][1]>e[1]!=t[i][1]>e[1]&&e[0]<(t[i][0]-t[o][0])*(e[1]-t[o][1])/(t[i][1]-t[o][1])+t[o][0]&&(n=!n);return n},pointInSphere:function(e,t,r){var n=[],i=[],o=u.scene.renderContext.computePixelSizeVector();u.scene.coordinateSystem.fromGeoTo3D(e,n),u.scene.coordinateSystem.fromGeoTo3D(t,i);var a=r*(o[0]*i[0]+o[1]*i[1]+o[2]*i[2]+o[3]),s=[];return vec3.subtract(n,i,s),s=vec3.dot(s,s),s<a*a},pointInLine:function(e,t,r){var n,i,o=r[0]-t[0],a=!1;return 0==o?a=e[0]==t[0]:(i=(e[0]-t[0])/o,a=i>=0&&i<=1),!!a&&(n=r[1]-t[1],0==o?e[1]==t[1]:(i=(e[1]-t[1])/n,i>=0&&i<=1))},getAstroCoordinatesFromCursorLocation:function(e,t,r){var n=[];return e.coordinateSystem.from3DToGeo(t.center3d,n),_.isEmpty(r)&&(r=[]),e.coordinateSystem.getLHVTransform(n,r),this.formatCoordinates([n[0],n[1]])},getHEALPixCutCoordinates:function(e,t,r){for(var n=[[0,0],[t.renderContext.canvas.width,0],[t.renderContext.canvas.width,t.renderContext.canvas.height],[0,t.renderContext.canvas.height]],i=0;i<n.length;i++){var o=t.getLonLatFromPixel(n[i][0],n[i][1]);o[0]<0&&(o[0]+=360),n[i]=o}var a=[];this.getAstroCoordinatesFromCursorLocation(t,r,a);var s=[a[4],a[5],a[6]],l=vec3.dot(r.up,s),u=Math.acos(l);if(isNaN(u))return void console.error("North is NaN'ed...");var h=180*u/Math.PI;t.renderContext.viewMatrix[8]<0&&(h*=-1);var c=parseFloat($("#cdelt1").val()),d=parseFloat($("#cdelt2").val());t.baseImagery;return context.fileName||ErrorDialog.open("FITS fileName isn't defined for HealpixCut service<br/>"),isNaN(c)||isNaN(d)?void $("#HEALPixCut").find("input").each(function(){$(this).val()||$(this).addClass("inputError")}):{long1:n[0][0],lat1:n[0][1],long2:n[1][0],lat2:n[1][1],long3:n[2][0],lat3:n[2][1],long4:n[3][0],lat4:n[3][1],rotation:h,coordSystem:"EQUATORIAL",cdelt1:c,cdelt2:d,filename:context.fileName,PHASE:"RUN"}},_getMousePos:function(e,t){var r=e.getBoundingClientRect();return{x:t.clientX-r.left,y:t.clientY-r.top}},isHipsFitsLayer:function(e){return e instanceof r},isHipsLayer:function(e){return e instanceof n},isOpenSearchLayer:function(e){return e instanceof t},isVectorLayer:function(e){return e instanceof o},isMocLayer:function(e){return e instanceof a},isPlanetLayer:function(e){return e instanceof i},convertVotable2JsonFromURL:function(e,t){var r=new XMLHttpRequest;r.open("GET",e),r.onload=function(){var e=r.responseXML;e?this.convertVotable2JsonFromXML(r.responseText,t):console.log("No XML response")},r.onerror=function(t){console.log("Error getting table "+e+"\n("+t+")")},r.send(null)},convertVotable2JsonFromXML:function(e,t){try{$.ajax({type:"POST",url:h,data:{votable:e,coordSystem:"EQUATORIAL"},success:function(e){t(e)},error:function(e){console.error(e)}})}catch(e){console.log("Error displaying table:\n"+e.toString())}}}}),r("Gui/PickingManagerCore",["../Renderer/FeatureStyle","../Layer/OpenSearchLayer","../Utils/Utils","../Utils/UtilsCore"],function(e,t,r,n){function i(e){b.indexOf(e)===-1?b.push(e):console.log("WARN:"+e.name+" has been already added")}function o(e){for(var t=0;t<b.length;t++)e.id===b[t].id&&b.splice(t,1)}function a(){return b}function s(){var t=this.getSelection()[this.stackSelectionIndex];if(t){var r=new e(t.feature.properties.style);switch(t.feature.geometry.type){case"LineString":case"MultiLineString":case"Polygon":case"MultiPolygon":r.strokeColor=t.layer.style.strokeColor;break;case"Point":r.fillColor=t.feature.properties.style.strokeColor}r.zIndex=t.layer.style.zIndex,t.layer.modifyFeatureStyle(t.feature,r)}}function l(t,r){r&&r.isExclusive&&h();var n=r.color?e.fromStringToColor(r.color):this.selectedStyle.strokeColor,i=r.color?e.fromStringToColor(r.color):this.selectedStyle.fillColor,o=this.getSelection()[t];if(o){this.stackSelectionIndex=t;var a=new e(o.feature.properties.style);switch(o.feature.geometry.type){case"LineString":case"MultiLineString":case"Polygon":case"MultiPolygon":a.strokeColor=n;break;case"Point":a.fillColor=i}a.zIndex=this.selectedStyle.zIndex,o.layer.modifyFeatureStyle(o.feature,a)}x.refresh()}function u(){return T}function h(){for(var t=0;t<this.getSelection().length;t++){var r=this.getSelection()[t],n=new e(r.feature.properties.style);switch(r.feature.geometry.type){case"LineString":case"MultiLineString":case"Polygon":case"MultiPolygon":n.strokeColor=r.layer.style.strokeColor;break;case"Point":n.fillColor=r.feature.properties.style.strokeColor}n.zIndex=r.layer.style.zIndex,r.layer.globe&&r.layer.modifyFeatureStyle(r.feature,n)}}function c(t){for(var r,n=0;n<t.length;n++){var i=t[n];switch(r=new e(i.feature.properties.style?i.feature.properties.style:i.layer.style),i.feature.geometry.type){case"LineString":case"MultiLineString":case"Polygon":case"MultiPolygon":r.strokeColor=this.selectedStyle.strokeColor;break;case"Point":r.fillColor=this.selectedStyle.fillColor}r.zIndex=this.selectedStyle.zIndex,i.layer.modifyFeatureStyle(i.feature,r)}}function d(){this.blurSelection(),this.setSelection([])}function f(e,t){for(var r=!1,n=t[0][0],i=1;i<t.length&&!r;i++){var o=Math.abs(t[i][0]-n);o>180&&(r=!0)}var a;if(r){var s=[];if(e[0]<0)for(a=0;a<t.length;a++)t[a][0]>0?s[a]=[t[a][0]-360,t[a][1]]:s[a]=[t[a][0],t[a][1]];else for(a=0;a<t.length;a++)t[a][0]<0?s[a]=[t[a][0]+360,t[a][1]]:s[a]=[t[a][0],t[a][1]];return s}return t}function p(e,t){var r,i,o,a,s,l;switch(e.geometry.type){case"LineString":for(r=0;r<e.geometry.coordinates.length-1;r++)if(a=e.geometry.coordinates[r],s=e.geometry.coordinates[r+1],n.pointInLine(t,a,s))return!0;break;case"MultiLineString":for(r=0;r<e.geometry.coordinates.length;r++)for(i=0;i<e.geometry.coordinates[r].length-1;i++)if(a=e.geometry.coordinates[r][i],s=e.geometry.coordinates[r][i+1],n.pointInLine(t,a,s))return!0;break;case"Polygon":return l=this.fixDateLine(t,e.geometry.coordinates[0]),n.pointInRing(t,l);case"MultiPolygon":for(o=0;o<e.geometry.coordinates.length;o++)if(l=this.fixDateLine(t,e.geometry.coordinates[o][0]),n.pointInRing(t,l))return!0;return!1;case"Point":var u=e.geometry.coordinates,h=e.properties.style&&e.properties.style.label;return n.pointInSphere(t,u,e.geometry._bucket.textureHeight)&&!h;default:return console.log("Picking for "+e.geometry.type+" is not implemented yet"),!1}}function m(e){if(!e)return[];var r,n,i,o=[];for(r=0;r<this.getPickableLayers().length;r++){var a=x.tileManager.getVisibleTile(e[0],e[1]),s=this.getPickableLayers()[r];if(s.getVisible()&&s.globe===y.activatedContext.globe)if(s instanceof t){var l=a,u=l.extension[s.extId];if(!u||u.state!==t.TileState.LOADED)for(;l.parent&&(!u||u.state!==t.TileState.LOADED);)l=l.parent,u=l.extension[s.extId];if(u)for(n=0;n<u.featureIds.length;n++)i=s.features[s.featuresSet[u.featureIds[n]].index],this.featureIsPicked(i,e)&&o.push({feature:i,layer:s})}else for(n=0;n<s.features.length;n++)i=s.features[n],this.featureIsPicked(i,e)&&o.push({feature:i,layer:s});o.selectedTile=a}return o}function v(e){return T=e}function g(e,t){T.push(e),l(T-1,t)}var y,x,b=[],T=[],w=-1,S=new e({strokeColor:[1,1,0,1],fillColor:[1,1,0,1],zIndex:1});return{selectedStyle:S,stackSelectionIndex:w,init:function(e){y=e,x=e.scene},addPickableLayer:i,removePickableLayer:o,getPickableLayers:a,blurSelectedFeature:s,focusFeatureByIndex:l,getSelection:u,blurSelection:h,focusSelection:c,clearSelection:d,fixDateLine:f,featureIsPicked:p,computePickSelection:m,setSelection:v,highlightObservation:g}}),r("Parser/JsonProcessor",["../Layer/HipsLayer"],function(e){function t(t,r){for(var n in r.services){var i=r.services[n];switch(t.subLayers||(t.subLayers=[]),i.type){case"healpix":i.layer=new e({format:i.format,baseUrl:i.url,name:i.name,visible:!1,coordinates:r.geometry.coordinates[0]}),t.subLayers.push(i.layer),t.globe&&t.visible()&&t.globe.addLayer(i.layer)}}}var r=0;return{handleFeatureCollection:function(e,n){if(null===n||void 0===n)return void console.log("Error, featureCollection is null");var i=n.features;if(null===i||void 0===i)return void console.log("Erro, not feature in featureCollection : ",n);var o,a,s;for(o=0;o<i.length;o++){var l=i[o],u="EQ";if(l.properties.crs){var h=l.properties.crs.properties.name;if(u=h.substr(0,h.indexOf(".")),u.length>3)switch(u.toLowerCase()){case"equatorial":u="EQ";break;case"galactic":u="GAL";break;default:console.log("Not implemented")}}switch(l.geometry.type){case"Point":e.dataType?"point"!==e.dataType&&(e.dataType="none"):e.dataType="point","EQ"!==u&&(l.geometry.coordinates=e.globe.coordinateSystem.convert(l.geometry.coordinates,u,"EQ")),l.geometry.coordinates[0]>180&&(l.geometry.coordinates[0]-=360);break;case"Polygon":case"MultiPolygon":e.dataType?"line"!==e.dataType&&(e.dataType="none"):e.dataType="line";var c=[],d=l.geometry;if("MultiPolygon"===d.type)for(a=0;a<d.coordinates.length;a++)c.push(d.coordinates[a][0]);else c.push(d.coordinates[0]);for(s=0;s<c.length;s++){var f=c[s],p=f.length;for(a=0;a<p;a++)"EQ"!==u&&(f[a]=e.globe.coordinateSystem.convert(f[a],u,"EQ")),f[a][0]>180&&(f[a][0]-=360)}if(l.properties._imageCoordinates){for(s=0;s<l.properties._imageCoordinates[0].length;s++)l.properties._imageCoordinates[0][s][0]>180&&(l.properties._imageCoordinates[0][s][0]-=360);l.geometry._imageCoordinates=l.properties._imageCoordinates}}l.geometry.gid="jsonProc_"+r,r++,l.services&&t(e,l)}}}}),r("Layer/LayerManager",["jquery","underscore-min","./LayerFactory","../DrawingFactory","../Gui/PickingManagerCore","../Utils/Utils","../Utils/UtilsCore","../Parser/JsonProcessor","../Utils/Constantes"],function(e,t,r,n,i,o,a,s,l){function u(e){var t=[];return e.hips_service_url&&t.push(e.hips_service_url),e.hips_service_url_1&&t.push(e.hips_service_url_1),e.hips_service_url_2&&t.push(e.hips_service_url_2),t}function h(e,r){var n;e.hips_tile_format?n=e.hips_tile_format.match("png")?"png":"jpg":(console.log("No hips_tile_format defined for layer  : "+e.obs_title),n="png");var i;if(console.log(e.obs_collection+" ==> "+e.hips_frame),"equatorial"===e.hips_frame?i="EQ":"galactic"===e.hips_frame&&(i="GAL"),!e.hasOwnProperty("hips_status")||null!==!e.hips_status.match("public")){var o={category:"Image",type:"hips",name:t.isArray(e.obs_collection)?e.obs_collection[0]:e.obs_collection,description:e.obs_description,baseUrl:r,numberOfLevels:e.hips_order,copyright:e.obs_copyright,attribution:e.obs_copyright,copyrightUrl:e.obs_copyright_url,ack:e.obs_ack,serviceUrl:e.moc_access_url,format:n,coordSystem:i,background:!1,visible:!1,properties:{initialRa:e.hasOwnProperty("obs_initial_ra")?parseFloat(e.obs_initial_ra):void 0,initialDec:e.hasOwnProperty("obs_initial_dec")?parseFloat(e.obs_initial_dec):void 0,initialFov:e.hasOwnProperty("obs_initial_fov")?parseFloat(e.obs_initial_fov):void 0,mocCoverage:e.hasOwnProperty("moc_sky_fraction")?e.moc_sky_fraction:void 0}};e.hasOwnProperty("moc_access_url")&&(o.availableServices=["Moc"]);var a=y.addLayer(o);e.hasOwnProperty("moc_access_url")&&(a.serviceUrl=e.moc_access_url)}}function c(e){if(e.getVisible()&&e.properties&&e.properties.hasOwnProperty("initialRa")&&e.properties.hasOwnProperty("initialDec")&&e.properties.hasOwnProperty("initialFov"))if("sky"===y.mode){var t=y.activatedContext.navigation.renderContext.fov;y.activatedContext.navigation.zoomTo([e.properties.initialRa,e.properties.initialDec],t,3e3)}else y.activatedContext.navigation.zoomTo([e.properties.initialRa,e.properties.initialDec],e.properties.initialFov,3e3,null)}function d(e){var r=a.generateColor(),n=r.concat([1]),i={name:e,id:t.uniqueId(e+"_"),style:w.createFeatureStyle({iconUrl:g.mizarBaseUrl+"../css/images/star.png",fillColor:n,strokeColor:n,visible:!0})},o=S.createVector(i);return o.type="GeoJSON",o.deletable=!0,o.pickable=!0,o}function f(e){var t;if(e.attribution&&e.attribution.search("<a")>=0&&e.attribution.search("target=")<0&&(e.attribution=e.attribution.replace(" "," target=_blank ")),e.color)e.color=w.fromStringToColor(e.color);else{var r=a.generateColor();e.color=r.concat([1])}switch(e.opacity&&(e.opacity/=100),e.visible||(e.visible=!1),e.style||(e.style=w.createFeatureStyle({rendererHint:"Basic",opacity:e.opacity,iconUrl:e.icon?e.icon:g.mizarBaseUrl+"../css/images/star.png",fillColor:e.color,strokeColor:e.color})),e.type){case"atmosphere":t=S.create(l.LAYER.Atmosphere,e);break;case"tileWireframe":t=S.create(l.LAYER.TileWireframe,e);break;case"hips":t=e.fitsSupported?S.create(l.LAYER.HipsFits,e):S.create(l.LAYER.Hips,e),
e.availableServices&&(t.availableServices=e.availableServices,t.healpixCutFileName=e.healpixCutFileName);break;case"coordinateGrid":t=S.create(l.LAYER.CoordinateGrid,e);break;case"hipsGrid":t=S.create(l.LAYER.TileWireframe,e);break;case"GeoJSON":t=S.create(l.LAYER.Vector,e),t.pickable=!e.hasOwnProperty("pickable")||e.pickable;break;case"DynamicOpenSearch":t=S.create(l.LAYER.OpenSearch,e),e.displayProperties&&(t.displayProperties=e.displayProperties),t.pickable=!e.hasOwnProperty("pickable")||e.pickable,t.availableServices=e.availableServices;break;case"Moc":e.style.fill=!0,e.style.fillColor[3]=.3,t=S.create(l.LAYER.Moc,e),t.dataType="line";break;case"Vector":t=d(e.name),t.pickable=!e.hasOwnProperty("pickable")||e.pickable,t.deletable=!1;break;case"Planet":t=S.create(l.LAYER.Planet,e);break;case"WMS":t=S.create(l.LAYER.WMS,e);break;case"WMTS":t=S.create(l.LAYER.WMTS,e);break;case"OSM":t=S.create(l.LAYER.OSM,e);break;case"Bing":t=S.create(l.LAYER.Bing,e);break;default:return console.error(e.type+" isn't not implemented"),null}return t.type=e.type,t.dataType=e.dataType,t.category=e.background?"background":e.category,t.subscribe("visibility:changed",c),t}function p(t,r,n){if(0===t.length)return n(void 0);var i=t.shift();e.ajax({type:"GET",url:i+"/Norder3/Allsky."+r,dataType:"text"}).done(function(e,t,r){if(200===r.status)return n(i)}).error(function(){p(t,r,n)})}function m(r,n){e.ajax({type:"GET",url:n,context:r,dataType:"json"}).done(function(n){t.each(n,function(t){var n=u(t),i=t.hips_tile_format.match("jpeg")?"jpg":"png";this.checkHipsServiceIsAvailable(n,i,function(n){return void 0===n?void console.log("Cannot add layer "+t.obs_title+" no mirror available"):void e.proxy(h,r)(t,n)})},r)})}var v,g,y,x=[],b=[],T={},w=new n,S=new r;return{init:function(e,t){y=e,g=t,v=y.scene,i.init(e),m(this,t.hipsServiceUrl)},registerDataProvider:function(e,t){T[e.toString()]=t},getLayers:function(e){var t=[];return"sky"===e?t=x:"planet"===e?t=this.getPlanetLayers():"all"===e?t=this.getAllLayers():console.log("Unknow mode. Correct mode are 'sky' or 'planet' "),t},getAllLayers:function(){return t.union(x,this.getPlanetLayers())},getPlanetLayers:function(){var e=b,r=t.filter(x,function(e){return e.isType("Planet")});if(r&&r.length>0)for(var n=0;n<r.length;n++)e=t.union(e,r[n].layers);return e},getLayerById:function(e){t.find(t.union(this.getAllLayers()),function(t){return t.layerId===e})},getLayerByName:function(e){return t.findWhere(this.getAllLayers(),{name:e})},addLayerToPlanet:function(e){var t=y.activatedContext.planet;"background"===e.category?(e.getVisible()&&(t.baseImagery&&t.baseImagery.setVisible(!1),t.setBaseImagery(e),e.setVisible(!0)),y.publish("backgroundLayer:add",e)):(e.isType("Planet")||t.addLayer(e),y.publish("additionalLayer:add",e))},addLayer:function(e,t){if(t)t.layers.push(e),"planet"===y.mode&&this.addLayerToPlanet(e);else{if(e.isType("Planet"))for(var r=0;r<e.baseImageries.length;r++)b.push(e.baseImageries[r]);x.push(e),"sky"===y.mode&&this.addLayerToPlanet(e)}},addLayerFromDescription:function(e,r){var n=t.findWhere(x,{name:e.name});if(!n){if(n=f(e),n&&this.addLayer(n,r),e.data&&T[e.data.type]){var o=T[e.data.type];o(n,e.data)}n.pickable&&i.addPickableLayer(n)}return n},removeLayer:function(e){var t=x.indexOf(e);x.splice(t,1),e.pickable&&i.removePickableLayer(e),y.publish("layer:remove",e),v.removeLayer(e)},createLayerFromFits:function(e,t){var r=d(e);r.dataType="line";var n=a.getPolygonCoordinatesFromFits(t),o={geometry:{gid:e,coordinates:[n],type:"Polygon"},properties:{identifier:e},type:"Feature"};return r.addFeature(o),i.addPickableLayer(r),this.addLayer(r,y.activatedContext.planetLayer),r},createLayerFromGeoJson:function(e,t){var r=d(e);return s.handleFeatureCollection(r,t),r.addFeatureCollection(t),i.addPickableLayer(r),this.addLayer(r,y.activatedContext.planetLayer),r},searchGlobeLayer:function(e){var r=[],n=this.getLayers();return r=t.filter(n,function(t){return String(t.name).indexOf(e)>=0||String(t.description||"").indexOf(e)>=0})},searchPlanetLayer:function(e){var r=[],n=this.getPlanetLayers();return r=t.filter(n,function(t){return String(t.name).indexOf(e)>=0||String(t.description||"").indexOf(e)>=0})},createSimpleLayer:d,checkHipsServiceIsAvailable:p,getPickingManagerCore:function(){return i}}}),r("Provider/AbstractProvider",["jquery"],function(e){var t=function(e){this.options=e};return t.prototype.loadFiles=function(e,t){},t.prototype.handleFeatures=function(e){},t}),r("Provider/JsonProvider",["jquery","./AbstractProvider","../Layer/LayerManager","../Parser/JsonProcessor","../Utils/Utils"],function(e,t,r,n,i){var o,a=function(e){t.prototype.constructor.call(this,e),o=this};return i.inherits(t,a),a.prototype.loadFiles=function(t,r){e.ajax({type:"GET",url:r.url,success:function(e){o.handleFeatures(t,e)},error:function(e,t,r){console.error(e.responseText)}})},a.prototype.handleFeatures=function(e,t){n.handleFeatureCollection(e,t),e.addFeatureCollection(t)},a}),r("Provider/PlanetProvider",["jquery","./AbstractProvider","../Renderer/FeatureStyle","../Layer/LayerManager"],function(e,t,r,n){function i(e,t,r){var n,i=e.toFixed(r),o=i.length,a="";for(n=0;n<t-o;n++)a+=" ";for(n=0;n<o;n++)a+=i.charAt(n);return a}function o(e,t,n,o){var a;return a=new r("Point"===t?{label:n,strokeColor:r.fromStringToColor(o.color),fillColor:r.fromStringToColor(o.color)}:{iconUrl:e.style.iconUrl,strokeColor:r.fromStringToColor(o.color),fillColor:r.fromStringToColor(o.color)}),{geometry:{type:"Point",gid:"planet"+t+"_"+n,coordinates:[o.ra,o.dec]},properties:{name:n,distance:i(o.rvec,9,6)+" AU",style:a}}}function a(){this.ra=parseFloat("0"),this.dec=parseFloat("0"),this.rvec=parseFloat("0")}function s(e,t,r,n,i){var o=n+i/60;return 367*e-Math.floor(7*(e+Math.floor((t+9)/12))/4)+Math.floor(275*t/9)+r-730531.5+o/24}function l(){this.color="",this.a=parseFloat("0"),this.e=parseFloat("0"),this.i=parseFloat("0"),this.O=parseFloat("0"),this.w=parseFloat("0"),this.L=parseFloat("0")}function u(e){var t;return t=e>=0?Math.floor(e):Math.ceil(e)}function h(e){var t=e/(2*Math.PI),r=2*Math.PI*(t-u(t));return r<0&&(r=2*Math.PI+r),r}function c(e,t){var r,n,i=e+t*Math.sin(e)*(1+t*Math.cos(e));do n=i,i=n-(n-t*Math.sin(n)-e)/(1-t*Math.cos(n));while(Math.abs(i-n)>x);return r=2*Math.atan(Math.sqrt((1+t)/(1-t))*Math.tan(.5*i)),r<0&&(r+=2*Math.PI),r}function d(e,t,r){var n=r/36525;switch(t){case 0:e.color="rgb(170,150,170)",e.a=.38709893+6.6e-7*n,e.e=.20563069+2527e-8*n,e.i=(7.00487-23.51*n/3600)*y,e.O=(48.33167-446.3*n/3600)*y,e.w=(77.45645+573.57*n/3600)*y,e.L=h((252.25084+538101628.29*n/3600)*y);break;case 1:e.color="rgb(245,222,179)",e.a=.72333199+9.2e-7*n,e.e=.00677323-4938e-8*n,e.i=(3.39471-2.86*n/3600)*y,e.O=(76.68069-996.89*n/3600)*y,e.w=(131.53298-108.8*n/3600)*y,e.L=h((181.97973+210664136.06*n/3600)*y);break;case 2:e.color="rgb(255,193,37)",e.a=1.00000011-5e-8*n,e.e=.01671022-3804e-8*n,e.i=(5e-5-46.94*n/3600)*y,e.O=(-11.26064-18228.25*n/3600)*y,e.w=(102.94719+1198.28*n/3600)*y,e.L=h((100.46435+129597740.63*n/3600)*y);break;case 3:e.color="rgb(255,50,50)",e.a=1.52366231-7221e-8*n,e.e=.09341233+11902e-8*n,e.i=(1.85061-25.47*n/3600)*y,e.O=(49.57854-1020.19*n/3600)*y,e.w=(336.04084+1560.78*n/3600)*y,e.L=h((355.45332+68905103.78*n/3600)*y);break;case 4:e.color="rgb(255,150,150)",e.a=5.20336301+60737e-8*n,e.e=.04839266-1288e-7*n,e.i=(1.3053-4.15*n/3600)*y,e.O=(100.55615+1217.17*n/3600)*y,e.w=(14.75385+839.93*n/3600)*y,e.L=h((34.40438+10925078.35*n/3600)*y);break;case 5:e.color="rgb(200,150,150)",e.a=9.53707032-.0030153*n,e.e=.0541506-36762e-8*n,e.i=(2.48446+6.11*n/3600)*y,e.O=(113.71504-1591.05*n/3600)*y,e.w=(92.43194-1948.89*n/3600)*y,e.L=h((49.94432+4401052.95*n/3600)*y);break;case 6:e.color="rgb(130,150,255)",e.a=19.19126393+.00152025*n,e.e=.04716771-1915e-7*n,e.i=(.76986-2.09*n/3600)*y,e.O=(74.22988-1681.4*n/3600)*y,e.w=(170.96424+1312.56*n/3600)*y,e.L=h((313.23218+1542547.79*n/3600)*y);break;case 7:e.color="rgb(100,100,255)",e.a=30.06896348-.00125196*n,e.e=.00858587+251e-7*n,e.i=(1.76917-3.64*n/3600)*y,e.O=(131.72169-151.25*n/3600)*y,e.w=(44.97135-844.43*n/3600)*y,e.L=h((304.88003+786449.21*n/3600)*y);break;case 8:e.color="rgb(100,100,255)",e.a=39.48168677-76912e-8*n,e.e=.24880766+6465e-8*n,e.i=(17.14175+11.07*n/3600)*y,e.O=(110.30347-37.33*n/3600)*y,e.w=(224.06676-132.25*n/3600)*y,e.L=h((238.92881+522747.9*n/3600)*y);break;default:window.alert("function mean_elements() failed!")}}function f(e,t,r){var n=new l;d(n,t,r);var i=n.a,o=n.e,a=n.i,s=n.O,u=n.w,f=n.L,p=new l;d(p,2,r);var m=p.a,v=p.e,x=p.w,b=p.L,T=h(b-x),w=c(T,v),S=m*(1-v*v)/(1+v*Math.cos(w)),A=S*Math.cos(w+x),M=S*Math.sin(w+x),C=0,E=h(f-u),P=c(E,n.e),R=i*(1-o*o)/(1+o*Math.cos(P)),L=R*(Math.cos(s)*Math.cos(P+u-s)-Math.sin(s)*Math.sin(P+u-s)*Math.cos(a)),I=R*(Math.sin(s)*Math.cos(P+u-s)+Math.cos(s)*Math.sin(P+u-s)*Math.cos(a)),_=R*(Math.sin(P+u-s)*Math.sin(a));2===t&&(L=0,I=0,_=0);var F=L-A,k=I-M,B=_-C,N=23.439281*y,D=F,O=k*Math.cos(N)-B*Math.sin(N),U=k*Math.sin(N)+B*Math.cos(N);e.ra=h(Math.atan2(O,D))*g,e.dec=Math.atan(U/Math.sqrt(D*D+O*O))*g,e.rvec=Math.sqrt(D*D+O*O+U*U),e.color=n.color}var p,m,v,g=180/Math.PI,y=Math.PI/180,x=1e-12,b=new Array("Mercury","Venus","Sun","Mars","Jupiter","Saturn","Uranus","Neptune","Pluto"),T=function(e){for(var t=[],r=new Date,n=r.getUTCFullYear(),i=r.getUTCMonth()+1,l=r.getUTCDate(),u=r.getUTCHours(),h=r.getUTCMinutes(),c=r.getUTCSeconds(),d=s(n,i,l,u,h+c/60),p=new a,v=0;v<9;v++){f(p,v,d);var g=o(e,"Label",b[v],p);t.push(g),g=o(e,"Point",b[v],p),t.push(g)}m={type:"FeatureCollection",features:t},e.addFeatureCollection(m)},w=function(e){p=this,t.prototype.constructor.call(this,e)};return w.prototype.handleFeatures=function(e,t){var r=t.interval?t.interval:6e4;T(e),v=t.mizarBaseUrl,setInterval(function(){e.removeFeatureCollection(m),T(e)},r)},w}),r("Context/BaseContext",["jquery","underscore-min","../Layer/LayerManager","../Provider/JsonProvider","../Provider/PlanetProvider"],function(e,t,r,n,i){var o=function(e,t){this.components={"2dMapContainer":!1,posTracker:!0,shareContainer:!1,sampContainer:!1,measureContainer:!1,compassDiv:!1,imageViewerDiv:!1,categoryDiv:!1,searchDiv:!1},this.planet=null,this.navigation=null,this.parentElement=e,this.aboutShown=!1,this.credits=!0,this.configuration=t};o.prototype.initTouchNavigation=function(e){e.navigation.touch={inversed:!!this.planet.isSky,zoomOnDblClick:!0};var t=this;window.addEventListener("orientationchange",function(){t.planet.refresh()},!1)},o.prototype.initCanvas=function(t){var r,n,i=null;t.parentElement?(i=e(t.parentElement),r=i.attr("width"),r||(r=window.innerWidth),n=i.attr("height"),n||(n=window.innerHeight)):(r=window.innerWidth,n=window.innerHeight),t.width=r,t.height=n,i&&i.css({position:"relative",overflow:"hidden"});var o,a=this,s=function(){i&&i.attr("height")&&i.attr("width")?(t.width=i.width(),t.height=i.height()):(t.width=window.innerWidth,t.height=window.innerHeight),a.planet.refresh()};e(window).resize(function(){o&&clearTimeout(o),o=setTimeout(s,500)}),t.addEventListener("webglcontextlost",function(e){e.preventDefault(),document.getElementById("loading").style.display="none",document.getElementById("webGLContextLost").style.display="block"},!1)},o.prototype.showCredits=function(e){this.credits=e},o.prototype.showAbout=function(){this.credits&&void 0===localStorage.showAbout&&!this.aboutShowed&&(this.aboutShowed=!0),e(this.parentElement).find("#loading").hide(300)},o.prototype.initPlanetEvents=function(t){t&&(this.planet=t),this.planet.subscribe("baseLayersReady",e.proxy(this.showAbout,this)),this.planet.subscribe("baseLayersError",function(t){e(this.parentElement).find("#loading").hide();0===t.id?" background layer ":" additional layer "})},o.prototype.show=function(){this.navigation.start();for(var t in this.components)this.components[t]&&e("#"+t).fadeIn(1e3)},o.prototype.hide=function(){this.navigation.stopAnimations(),this.navigation.stop();for(var t in this.components)e("#"+t).fadeOut()},o.prototype.setComponentVisibility=function(t,r){var n=e("#"+t);r?n.show():n.hide(),this.components[t]=r},o.prototype.showAdditionalLayers=function(){t.each(this.visibleLayers,function(e){e.setVisible(!0)})},o.prototype.hideAdditionalLayers=function(){this.visibleLayers=[];var e=this.getAdditionalLayers(),r=this;t.each(e,function(e){e.getVisible()&&(e.setVisible(!1),r.visibleLayers.push(e))})},o.prototype.getAdditionalLayers=function(){return[]},o.prototype.getPositionTracker=function(){return this.positionTracker|console.log("No positionTracker defined")};var a=new n;return o.prototype.loadProviders=function(){var e=new i;r.registerDataProvider("JSON",a.loadFiles),r.registerDataProvider("planets",e.handleFeatures)},o.prototype.setBackgroundSurvey=function(e){},o.prototype.getPlanetRenderContext=function(){if(this.planet)return this.planet.getRenderContext()},o.prototype.getSkyRenderContext=function(){if(this.sky)return this.sky.getRenderContext()},o.prototype.disable=function(){},o.prototype.enable=function(){},o}),r("Gui/Tracker/AbstractTracker",["jquery"],function(e){var t=function(e){this.options=e};return t.prototype.update=function(e){},t.prototype.compute=function(e){},t}),r("Gui/Tracker/PositionTracker",["jquery","./AbstractTracker","../../Utils/Utils"],function(e,t,r){var n,i,o,a=function(r,a){t.prototype.constructor.call(this,a),this.parentElement=r,o=this,n=a.globe,i=a.element,a.positionTracker&&a.positionTracker.position&&e("#"+i).css(a.positionTracker.position,"2px"),n.renderContext.canvas.addEventListener("mousemove",o.update),a.isMobile&&n.renderContext.canvas.addEventListener("touchmove",o.update)};return r.inherits(t,a),a.prototype.update=function(e){e.type.search("touch")>=0&&(e.clientX=e.changedTouches[0].clientX,e.clientY=e.changedTouches[0].clientY);var t=n.getLonLatFromPixel(e.clientX,e.clientY);if(t){var r=o.compute([t[0],t[1]]);document.getElementById(i)&&(document.getElementById(i).innerHTML=r[0]+" x "+r[1])}else document.getElementById(i)&&(document.getElementById(i).innerHTML="")},a.prototype.compute=function(e){return this.parentElement.parentElement.ToolBox.formatCoordinates([e[0],e[1]])},a}),r("Gui/Tracker/ElevationTracker",["jquery","./AbstractTracker","../../Utils/Utils","../../Utils/UtilsCore"],function(e,t,r,n){var i,o,a,s,l=function(r){t.prototype.constructor.call(this,r),s=this,i=r.globe,o=r.element,null!==r.elevationLayer&&void 0!==r.elevationLayer&&(a=r.elevationLayer.hasOwnProperty("scale")?r.elevationLayer.scale:1,r.elevationTracker.position&&e("#"+o).css(r.elevationTracker.position,"2px"),i.renderContext.canvas.addEventListener("mousemove",s.update),r.isMobile&&i.renderContext.canvas.addEventListener("touchmove",s.update))};return r.inherits(t,l),l.prototype.update=function(e){e.type.search("touch")>=0&&(e.clientX=e.changedTouches[0].clientX,e.clientY=e.changedTouches[0].clientY);var t=i.getLonLatFromPixel(e.clientX,e.clientY);if(t&&"planet"===mizar.mode){var r=s.compute([t[0],t[1]]);document.getElementById(o).innerHTML=n.roundNumber(r/a,0)+" meters"}else document.getElementById(o).innerHTML=""},l.prototype.compute=function(e){return i.getElevation(e[0],e[1])},l}),r("Navigation/FlatNavigation",["../Utils/Utils","./BaseNavigation","../Animation/SegmentedAnimation","../Utils/Numeric","../Renderer/Ray","../Renderer/glMatrix"],function(e,t,r,n,i){var o=function(e,r){t.prototype.constructor.call(this,e.renderContext,r),this.type="FlatNavigation",this.planet=e,this.minDistance=r&&r.minDistance||.01,this.maxDistance=r&&r.maxDistance||7,this.center=[0,0,0],this.distance=7*this.planet.coordinateSystem.geoide.radius,this.up=[0,1,0],this.computeViewMatrix()};return e.inherits(t,o),o.prototype.save=function(){return{center:this.center,distance:this.distance,up:this.up}},o.prototype.restore=function(e){this.center=e.center,this.distance=e.distance,this.up=e.up,this.computeViewMatrix()},o.prototype.computeViewMatrix=function(){var e=[],t=this.renderContext.viewMatrix;e=[this.center[0],this.center[1],this.distance],mat4.lookAt(e,this.center,this.up,t),this.up=[t[1],t[5],t[9]],this.publish("modified"),this.renderContext.requestFrame()},o.prototype.zoomTo=function(e,t,i,o){var a=this,s=t||this.distance/(4*this.planet.coordinateSystem.geoide.heightScale);i=i||5e3;var l=this.planet.coordinateSystem.fromGeoTo3D(e),u=[this.center[0],this.center[1],this.distance],h=[l[0],l[1],s*this.planet.coordinateSystem.geoide.heightScale];this.zoomToAnimation=new r(i,function(e){a.center[0]=e[0],a.center[1]=e[1],a.distance=e[2],a.computeViewMatrix()});var c=this.center,d=l,f=vec3.subtract(c,d),p=vec3.length(f),m=this.planet.renderContext.canvas,v=Math.min(n.toRadian(45),n.toRadian(45*m.width/m.height)),g=1.1*(p/2/Math.tan(v/2));if(g>this.distance){var y=[.5*u[0]+.5*h[0],.5*u[1]+.5*h[1],g];this.zoomToAnimation.addSegment(0,u,.5,y,function(e,t,r){var i=n.easeInQuad(e),o=n.easeOutQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1]),n.lerp(o,t[2],r[2])]}),this.zoomToAnimation.addSegment(.5,y,1,h,function(e,t,r){var i=n.easeOutQuad(e),o=n.easeInQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1]),n.lerp(o,t[2],r[2])]})}else this.zoomToAnimation.addSegment(0,u,1,h,function(e,t,r){var i=n.easeOutQuad(e),o=n.easeInQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1]),n.lerp(o,t[2],r[2])]});var x=this;this.zoomToAnimation.onstop=function(){o&&o(),x.zoomToAnimation=null},this.planet.addAnimation(this.zoomToAnimation),this.zoomToAnimation.start()},o.prototype.zoom=function(e,t){this.distance;t?this.distance*=t:this.distance*=1+.1*e,this.distance>this.maxDistance&&(this.distance=this.maxDistance),this.distance<this.minDistance&&(this.distance=this.minDistance),this.computeViewMatrix()},o.prototype.pan=function(e,t){var r=this.renderContext.canvas.width/2,n=this.renderContext.canvas.height/2,o=i.createFromPixel(this.renderContext,r-e,n-t);this.center=o.computePoint(o.planeIntersect([0,0,0],[0,0,1])),this.computeViewMatrix()},o.prototype.rotate=function(e,t){var r=.1*-e*Math.PI/180,n=quat4.fromAngleAxis(r,[0,0,1]);quat4.multiplyVec3(n,this.up),this.computeViewMatrix()},o}),r("Renderer/VectorRenderer",["./RendererTileData","../Tiling/Tile"],function(e,t){var r=function(e){this.tileManager=e.tileManager,this.planet=e,this.buckets=[],this.maxTilePerGeometry=100,this.levelZeroTiledGeometries=[]};return r.prototype.findBucket=function(e,t){for(var r=0;r<this.buckets.length;r++){var n=this.buckets[r];if(n.layer===e&&n.isCompatible(t))return n}return null},r.prototype.generateLevelZero=function(e){for(var t=0;t<this.levelZeroTiledGeometries.length;t++){for(var r=this.levelZeroTiledGeometries[t],n=!1,i=0;i<r._tileIndices.length&&!n;i++){var o=this.tileManager.level0Tiles[r._tileIndices[i]];n=o===e}n&&this._addGeometryToTile(r._bucket,r,e)}},r.prototype._recursiveAddGeometryToTile=function(e,r,n){var i=this._addGeometryToTile(e,r,n);if(i&&i.generateChild&&n.children)for(var o=0;o<4;o++)n.children[o].state===t.State.LOADED&&(i.hasChildren=!0,this._recursiveAddGeometryToTile(e,r,n.children[o]))},r.prototype.addGeometry=function(e,r,n){var i=this.getOrCreateBucket(e,r,n);r._bucket=i;var o=this.maxTilePerGeometry>0?this.tileManager.tiling.getOverlappedLevelZeroTiles(r):null;if(o&&o.length<this.maxTilePerGeometry){for(var a=0;a<o.length;a++){var s=this.tileManager.level0Tiles[o[a]];s.state===t.State.LOADED&&this._recursiveAddGeometryToTile(i,r,s)}r._tileIndices=o,this.levelZeroTiledGeometries.push(r)}else i.mainRenderable||(i.mainRenderable=i.createRenderable()),i.mainRenderable.add(r)},r.prototype.removeGeometry=function(e){var t=e._tileIndices;if(t){for(var r=0;r<t.length;r++){var n=this.tileManager.level0Tiles[t[r]];this.removeGeometryFromTile(e,n)}this.levelZeroTiledGeometries.splice(this.levelZeroTiledGeometries.indexOf(e),1),e._tileIndices=null}else{var i=e._bucket;if(i.mainRenderable){var o=i.mainRenderable.remove(e);0===o&&(i.mainRenderable.dispose(this.renderContext),i.mainRenderable=null)}}},r.prototype.getOrCreateBucket=function(e,t,r){var n=this.findBucket(e,r);return n||(n=this.createBucket(e,r),n.renderer=this,n.id=this.planet.vectorRendererManager.bucketId++,this.buckets.push(n)),n},r.prototype.addGeometryToTile=function(e,t,r,n){var i=this.getOrCreateBucket(e,t,r);return t._bucket=i,this._addGeometryToTile(i,t,n)},r.prototype._addGeometryToTile=function(t,r,n){var i=n.extension.renderer;i||(i=n.extension.renderer=new e(this.planet.vectorRendererManager));var o=i.getRenderable(t),a=!1;return o||(o=t.createRenderable(),a=!0),o.add(r,n)?(a&&i.renderables.push(o),o):null},r.prototype.removeGeometryFromTile=function(e,r){var n=r.extension.renderer;if(n)for(var i=0;i<n.renderables.length;){var o=n.renderables[i],a=o.bucket.renderer;if(a===this){var s=o.remove(e);if(0===s?n.renderables.splice(i,1):i++,o.hasChildren&&r.children)for(var l=0;l<4;l++)r.children[l].state===t.State.LOADED&&this.removeGeometryFromTile(e,r.children[l])}else i++}},r}),r("Renderer/PointRenderer",["../Utils/Utils","./VectorRenderer","./VectorRendererManager","./FeatureStyle","./Program","./GeoBound"],function(e,t,r,n,i,o){var a=function(){var e=18,t=1,r=null,i=function(){r=document.createElement("canvas"),r.width=512,r.height=e+2*t},o=function(o,a){r||i();var s=a;s?s instanceof Array&&(s=n.fromColorToString(a)):s="#fff";var l=r.getContext("2d");l.clearRect(0,0,r.width,r.height),l.fillStyle=s,l.font=e+"px sans-serif",l.textBaseline="top",l.shadowColor="#000",l.shadowOffsetX=1,l.shadowOffsetY=1,l.shadowBlur=2,l.fillText(o,t,t);var u=l.measureText(o);return l.getImageData(0,0,Math.floor(u.width)+2*t,r.height)};return{generateImageData:o}}(),s=function(e){t.prototype.constructor.call(this,e),this.renderContext=e.tileManager.renderContext,this.tileConfig=e.tileManager.tileConfig,this.numberOfRenderPoints=0;var r="attribute vec3 vertex; // vertex have z = 0, spans in x,y from -0.5 to 0.5 \n";r+="uniform mat4 viewProjectionMatrix; \n",r+="uniform vec3 poiPosition; // world position \n",r+="uniform vec2 poiScale; // x,y scale \n",r+="uniform vec2 tst; \n",r+="\n",r+="varying vec2 texCoord; \n",r+="\n",r+="void main(void)  \n",r+="{ \n",r+="\t// Generate texture coordinates, input vertex goes from -0.5 to 0.5 (on x,y) \n",r+="\ttexCoord = vertex.xy + vec2(0.5) + tst; \n",r+="\t// Invert y \n",r+="\ttexCoord.y = 1.0 - texCoord.y; \n",r+="\t\n",r+="\t// Compute poi position in clip coordinate \n",r+="\tgl_Position = viewProjectionMatrix * vec4(poiPosition, 1.0); \n",r+="\tgl_Position.xy += vertex.xy * gl_Position.w * poiScale; \n",r+="} \n";var n="precision lowp float; \n";n+="varying vec2 texCoord; \n",n+="uniform sampler2D texture; \n",n+="uniform float alpha; \n",n+="uniform vec3 color; \n",n+="\n",n+="void main(void) \n",n+="{ \n",n+="\tvec4 textureColor = texture2D(texture, texCoord); \n",n+="\tgl_FragColor = vec4(textureColor.rgb * color, textureColor.a * alpha); \n",n+="\tif (gl_FragColor.a <= 0.0) discard; \n",n+="} \n",this.program=new i(this.renderContext),this.program.createFromSource(r,n);var o=new Float32Array([-.5,-.5,0,.5,-.5,0,.5,.5,0,-.5,.5,0]),a=this.renderContext.gl;this.vertexBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer),a.bufferData(a.ARRAY_BUFFER,o,a.STATIC_DRAW),this.defaultTexture=null};e.inherits(t,s),s.prototype._buildDefaultTexture=function(e){if(!this.defaultTexture){var t=this.renderContext.gl;this.defaultTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.defaultTexture);var r=new Uint8Array([255,255,255,255]);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,r)}e.texture=this.defaultTexture,e.textureWidth=10,e.textureHeight=10},s.prototype._buildTextureFromImage=function(e,t){e.texture=this.renderContext.createNonPowerOfTwoTextureFromImage(t),e.textureWidth=t.width,e.textureHeight=t.height};var l=function(e){this.bucket=e,this.points=[]};l.prototype.add=function(e){var t=e.coordinates,r=this.bucket.layer.planet.coordinateSystem,n=new o(r.geoBound[0],r.geoBound[1],r.geoBound[2],r.geoBound[3]);if(n.isPointInside(t)){var i=r.fromGeoTo3D(t),a=r.getVerticalAt3D(i);return this.points.push({pos3d:i,vertical:a,geometry:e}),!0}return!1},l.prototype.remove=function(e){for(var t=0;t<this.points.length;t++)if(this.points[t].geometry===e)return this.points.splice(t,1),this.points.length;return this.points.length},l.prototype.dispose=function(e){};var u=function(e,t){this.layer=e,this.style=new n(t),this.renderer=null,this.texture=null};return u.prototype.createRenderable=function(){return new l(this)},u.prototype.isCompatible=function(e){return this.style.iconUrl===e.iconUrl&&this.style.icon===e.icon&&this.style.label===e.label},s.prototype.createBucket=function(e,t){var r=new u(e,t);if(t.label){var n=a.generateImageData(t.label,t.textColor);this._buildTextureFromImage(r,n)}else if(t.iconUrl){var i=new Image;i.crossOrigin="";var o=this;i.onload=function(){o._buildTextureFromImage(r,i),o.renderContext.requestFrame()},i.onerror=function(){o._buildDefaultTexture(r)},i.src=t.iconUrl}else t.icon?this._buildTextureFromImage(r,t.icon):this._buildDefaultTexture(r);return r},s.prototype.render=function(e,t,r){this.numberOfRenderPoints=0;var n=this.renderContext,i=this.renderContext.gl;i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),this.program.apply(),mat4.multiply(n.projectionMatrix,n.viewMatrix,n.modelViewMatrix),i.uniformMatrix4fv(this.program.uniforms.viewProjectionMatrix,!1,n.modelViewMatrix),i.uniform1i(this.program.uniforms.texture,0),mat4.inverse(n.viewMatrix,n.modelViewMatrix);var o=[n.modelViewMatrix[8],n.modelViewMatrix[9],n.modelViewMatrix[10]];vec3.normalize(o),vec3.scale(o,this.tileConfig.cullSign,o);var a=n.computePixelSizeVector();i.bindBuffer(i.ARRAY_BUFFER,this.vertexBuffer),i.vertexAttribPointer(this.program.attributes.vertex,3,i.FLOAT,!1,0,0);for(var s,l=null,u=t;u<r;u++){var h=e[u],c=h.bucket;if(0!==h.points.length){c!==l&&(i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,c.texture),s=[2*c.textureWidth/n.canvas.width,2*c.textureHeight/n.canvas.height],i.uniform2fv(this.program.uniforms.poiScale,s),i.uniform2fv(this.program.uniforms.tst,[.5/c.textureWidth,.5/c.textureHeight]));for(var d=0;d<h.points.length;d++){var f=h.points[d].pos3d,p=h.points[d].vertical;s=c.textureHeight*(a[0]*f[0]+a[1]*f[1]+a[2]*f[2]+a[3]),s*=this.tileConfig.cullSign;var m=s/this.planet.coordinateSystem.geoide.heightScale*.001;if(!(m>c.style.pointMaxSize)&&vec3.dot(p,o)>0&&n.worldFrustum.containsSphere(f,s)>=0){var v=p[0]*s+f[0],g=p[1]*s+f[1],y=p[2]*s+f[2];i.uniform3f(this.program.uniforms.poiPosition,v,g,y),i.uniform1f(this.program.uniforms.alpha,c.layer._opacity);var x=c.style.fillColor;i.uniform3f(this.program.uniforms.color,x[0],x[1],x[2]),i.drawArrays(i.TRIANGLE_FAN,0,4),this.numberOfRenderPoints++}}}}i.disable(i.BLEND)},s.prototype.canApply=function(e,t){return"Point"===e},r.factory.push(function(e){return new s(e)}),s}),r("Renderer/BatchRenderable",[],function(){var e=function(e){this.bucket=e,this.vertexBuffer=null,this.indexBuffer=null,this.vertices=[],this.triIndices=[],this.lineIndices=[],this.geometryInfos=[],this.bufferDirty=!0,this.vertexSize=3,this.indexType=0,this.vertexBufferShared=!1};return e.prototype.remove=function(e){for(var t,r=-1,n=0,i=0,o=0,a=0;a<this.geometryInfos.length;a++){var s=this.geometryInfos[a];if(s.geometry===e){this.vertices.splice(n,s.vertexCount),this.lineIndices.splice(i,s.lineIndexCount),this.triIndices.splice(o,s.triIndexCount);var l=s.vertexCount/this.vertexSize;for(t=i;t<this.lineIndices.length;t++)this.lineIndices[t]-=l;for(t=o;t<this.triIndices.length;t++)this.triIndices[t]-=l;r=a;break}n+=s.vertexCount,i+=s.lineIndexCount,o+=s.triIndexCount}return r>=0?(this.bufferDirty=!0,this.geometryInfos.splice(r,1),this.vertices.length):this.vertices.length},e.prototype.add=function(e,t){this.tile=t;var r=this.vertices.length,n=this.lineIndices.length,i=this.triIndices.length,o=this.build(e,t);return!!o&&(this.geometryInfos.push({geometry:e,vertexCount:this.vertices.length-r,lineIndexCount:this.lineIndices.length-n,triIndexCount:this.triIndices.length-i}),this.bufferDirty=!0,!0)},e.prototype.dispose=function(e){var t=e.gl;this.indexBuffer&&t.deleteBuffer(this.indexBuffer),this.indexBuffer=null,this.vertexBuffer&&!this.vertexBufferShared&&(t.deleteBuffer(this.vertexBuffer),this.vertexBuffer=null)},e.prototype.bindBuffers=function(e){var t=e.gl;if(this.bufferDirty){this.dispose(e),this.vertexBuffer?t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer):(this.vertexBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.vertices),t.STATIC_DRAW)),this.indexBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer);var r=this.triIndices;r=this.triIndices.length>0?this.lineIndices.length>0?this.triIndices.concat(this.lineIndices):this.triIndices:this.lineIndices;var n=this.vertices.length/this.vertexSize;n>65535?(t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint32Array(r),t.STATIC_DRAW),this.indexType=t.UNSIGNED_INT):(t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),t.STATIC_DRAW),this.indexType=t.UNSIGNED_SHORT),this.bufferDirty=!1}else t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer)},e}),r("Tiling/TiledVectorRenderable",["../Utils/Utils","../Renderer/BatchRenderable"],function(e,t){var r=function(e){t.prototype.constructor.call(this,e),this.tile=null,this.hasChildren=!0};return e.inherits(t,r),r.prototype.initChild=function(e,t){var n=new r(this.bucket);return n.tile=this.tile,n.vertexBufferShared=!0,n.vertexBuffer=this.vertexBuffer,n.vertices=this.vertices,n.buildChildrenIndices(this,2*t+e),n},r.prototype.generateChild=function(e){for(var t=0;t<this.geometryInfos.length;t++)this.bucket.renderer._addGeometryToTile(this.bucket,this.geometryInfos[t].geometry,e)},r.prototype.buildChildrenIndices=function(e,t){var r,n,i,o,a,s,l,u,h,c,d,f;for(r=0;r<e.triIndices.length;r+=3)n=3*e.triIndices[r],i=3*e.triIndices[r+1],o=3*e.triIndices[r+2],a=e.vertices[n],s=e.vertices[i],l=e.vertices[o],u=0,(a>0||0===a&&s>0||0===a&&0===s&&l>0)&&(u=1),h=e.vertices[n+1],c=e.vertices[i+1],d=e.vertices[o+1],f=1,(h>0||0===h&&c>0||0===h&&0===c&&d>0)&&(f=0),t===2*f+u&&this.triIndices.push(e.triIndices[r],e.triIndices[r+1],e.triIndices[r+2]);for(r=0;r<e.lineIndices.length/2;r++)n=3*e.lineIndices[2*r],i=3*e.lineIndices[2*r+1],a=e.vertices[n],s=e.vertices[i],u=0,(a>0||0===a&&s>0)&&(u=1),h=e.vertices[n+1],c=e.vertices[i+1],f=1,(h>0||0===h&&c>0)&&(f=0),t===2*f+u&&this.lineIndices.push(e.lineIndices[2*r],e.lineIndices[2*r+1])},r.prototype.build=function(e,t){this.tile=t;var r,n,i=this.bucket.layer.minLevel<=t.level&&this.bucket.layer.maxLevel>t.level;if(i){var o=e.coordinates;switch(e.type){case"LineString":this.buildVerticesAndIndices(t,o);break;case"Polygon":for(r=0;r<o.length;r++)this.buildVerticesAndIndices(t,o[r]);break;case"MultiLineString":for(r=0;r<o.length;r++)this.buildVerticesAndIndices(t,o[r]);break;case"MultiPolygon":for(n=0;n<o.length;n++)for(r=0;r<o[n].length;r++)this.buildVerticesAndIndices(t,o[n][r])}}return t.geoBound.intersectsGeometry(e)},r}),r("Tiling/TiledVectorRenderer",["../Utils/Utils","../Renderer/VectorRenderer","../Renderer/Program"],function(e,t,r){var n=function(e){t.prototype.constructor.call(this,e);var n="attribute vec3 vertex; \n";n+="uniform float zOffset; \n",n+="uniform mat4 modelViewMatrix;\n",n+="uniform mat4 projectionMatrix;\n",n+="\n",n+="void main(void)  \n",n+="{ \n",n+="\tgl_Position = projectionMatrix * modelViewMatrix * vec4(vertex.x, vertex.y, vertex.z + zOffset, 1.0); \n",n+="} \n";var i="#ifdef GL_ES \n";i+="precision highp float; \n",i+="#endif \n",i+="uniform vec4 color; \n",i+="\n",i+="void main(void) \n",i+="{ \n",i+="\tgl_FragColor = color; \n",i+="} \n",this.program=new r(this.tileManager.renderContext),this.program.createFromSource(n,i)};return e.inherits(t,n),n.prototype.render=function(e,t,r){var n=this.tileManager.renderContext,i=n.gl,o=mat4.create();this.program.apply(),i.depthFunc(i.LEQUAL),i.depthMask(!1),i.uniformMatrix4fv(this.program.uniforms.projectionMatrix,!1,n.projectionMatrix);
for(var a=null,s=t;s<r;s++){var l=e[s],u=l.tile;if(mat4.multiply(n.viewMatrix,u.matrix,o),i.uniformMatrix4fv(this.program.uniforms.modelViewMatrix,!1,o),i.uniform1f(this.program.uniforms.zOffset,7e-4*u.radius),a=l.bucket.style,l.bindBuffers(n),i.vertexAttribPointer(this.program.attributes.vertex,3,i.FLOAT,!1,0,0),l.triIndices.length>0&&(i.uniform4f(this.program.uniforms.color,a.fillColor[0],a.fillColor[1],a.fillColor[2],a.fillColor[3]*l.bucket.layer._opacity),i.drawElements(i.TRIANGLES,l.triIndices.length,l.indexType,0)),l.lineIndices.length>0){i.lineWidth(a.strokeWidth),i.uniform4f(this.program.uniforms.color,a.strokeColor[0],a.strokeColor[1],a.strokeColor[2],a.strokeColor[3]*l.bucket.layer._opacity);var h=l.indexType===i.UNSIGNED_INT?4:2;i.drawElements(i.LINES,l.lineIndices.length,l.indexType,l.triIndices.length*h)}}i.depthMask(!0),i.depthFunc(i.LESS)},n}),r("Renderer/LineStringRenderable",["../Utils/Utils","./FeatureStyle","./VectorRendererManager","../Tiling/TiledVectorRenderable","../Tiling/TiledVectorRenderer","../Utils/Numeric"],function(e,t,r,n,i,o){var a=function(e){n.prototype.constructor.call(this,e)};e.inherits(n,a),a.prototype._fixDateLine=function(e,t){for(var r=[],n=[r],i=0;i<t.length-1;i++){r.push(t[i]);var o=t[i][0],a=t[i][1],s=t[i+1][0],l=t[i+1][1];if(Math.abs(s-o)>180){o<0&&(o+=360),s<0&&(s+=360);var u=(180-o)/(s-o);if(u>0&&u<1){var h=a+u*(l-a),c=t[i][0]>0?180:-180;r.push([c,h]),r=[[-c,h]],n.push(r)}}}return r.push(t[t.length-1]),n},a.prototype.buildVerticesAndIndices=function(e,t){if(0!==t.length)for(var r=this._fixDateLine(e,t),n=0;n<r.length;n++)this._buildVerticesAndIndices(e,r[n])},a.prototype._buildVerticesAndIndices=function(e,t){var r=e.config.tesselation,n=e.config.vertexSize;t.push(t[t.length-1]);for(var i=e.lonlat2tile(t),a=0;a<t.length-1;a++){var s,l,u,h,c,d,f,p,m=i[a][0],v=i[a][1],g=i[a+1][0],y=i[a+1][1],x=[],b=Math.max(-1,Math.min(m,g)),T=Math.min(r-1,Math.max(m,g));for(s=Math.floor(b)+1;s<Math.floor(T)+1;s++)if(h=s,u=o.lineIntersection(m,v,g,y,h,0,h,r-1),u[0]>0&&u[0]<1&&u[1]>=0&&u[1]<=1){l=u[1]*(r-1);var w=Math.floor(l),S=l-w;c=n*(w*r+s),d=(1-S)*e.vertices[c]+S*e.vertices[c+n*r],f=(1-S)*e.vertices[c+1]+S*e.vertices[c+n*r+1],p=(1-S)*e.vertices[c+2]+S*e.vertices[c+n*r+2],x.push([u[0],d,f,p])}var A=Math.max(-1,Math.min(v,y)),M=Math.min(r-1,Math.max(v,y));for(s=Math.floor(A)+1;s<Math.floor(M)+1;s++)if(l=s,u=o.lineIntersection(m,v,g,y,0,l,r-1,l),u[0]>0&&u[0]<1&&u[1]>=0&&u[1]<=1){h=u[1]*(r-1);var C=Math.floor(h),E=h-C;c=n*(s*r+C),d=(1-E)*e.vertices[c]+E*e.vertices[c+n],f=(1-E)*e.vertices[c+1]+E*e.vertices[c+n+1],p=(1-E)*e.vertices[c+2]+E*e.vertices[c+n+2],x.push([u[0],d,f,p])}x.sort(function(e,t){return e[0]>t[0]});var P,R=this.vertices.length/3;for(m>=0&&m<=r-1&&v>=0&&v<=r-1&&(P=e.computePosition(m,v),this.vertices.push(P[0]),this.vertices.push(P[1]),this.vertices.push(P[2])),s=0;s<x.length;s++)this.vertices.push(x[s][1]),this.vertices.push(x[s][2]),this.vertices.push(x[s][3]);g>=0&&g<=r-1&&y>=0&&y<=r-1&&(P=e.computePosition(g,y),this.vertices.push(P[0]),this.vertices.push(P[1]),this.vertices.push(P[2]));var L=this.vertices.length/3;for(s=R;s<L-1;s++)this.lineIndices.push(s),this.lineIndices.push(s+1)}};var s=function(e){i.prototype.constructor.call(this,e)};e.inherits(i,s),s.prototype.canApply=function(e,t){return!this.planet.isSky&&!("LineString"!==e&&"MultiLineString"!==e&&(t.fill||"Polygon"!==e&&"MultiPolygon"!==e)||t.gradientLength)};var l=function(e,r){this.layer=e,this.style=new t(r),this.renderer=null};return l.prototype.createRenderable=function(){return new a(this)},l.prototype.isCompatible=function(e){return this.style.strokeColor[0]===e.strokeColor[0]&&this.style.strokeColor[1]===e.strokeColor[1]&&this.style.strokeColor[2]===e.strokeColor[2]&&this.style.strokeColor[3]===e.strokeColor[3]&&this.style.strokeWidth===e.strokeWidth},s.prototype.createBucket=function(e,t){return new l(e,t)},r.factory.push(function(e){return new s(e)}),a}),r("Renderer/pnltri",[],function(){var e={REVISION:"2.1.1"};return e.Math={random:Math.random,array_shuffle:function(t){for(var r=t.length-1;r>0;r--){var n=Math.floor(e.Math.random()*(r+1)),i=t[r];t[r]=t[n],t[n]=i}return t},compare_pts_yx:function(t,r){var n=t.y-r.y;if(n<e.Math.EPSILON_N)return-1;if(n>e.Math.EPSILON_P)return 1;var i=t.x-r.x;return i<e.Math.EPSILON_N?-1:i>e.Math.EPSILON_P?1:0},ptsCrossProd:function(e,t,r){return(t.x-e.x)*(r.y-e.y)-(t.y-e.y)*(r.x-e.x)}},e.Math.EPSILON_P=Math.pow(2,-43),e.Math.EPSILON_N=-e.Math.EPSILON_P,e.PolygonData=function(e){if(this.vertices=[],this.segments=[],this.diagonals=[],this.idNextPolyChain=0,this.PolyLeftArr=[],this.monoSubPolyChains=[],this.triangles=[],e)for(var t=0,r=e.length;t<r;t++)this.addPolygonChain(e[t])},e.PolygonData.prototype={constructor:e.PolygonData,nbVertices:function(){return this.vertices.length},getSegments:function(){return this.segments},getFirstSegment:function(){return this.segments[0]},getMonoSubPolys:function(){return this.monoSubPolyChains},getTriangles:function(){return this.triangles.concat()},nbPolyChains:function(){return this.idNextPolyChain},get_PolyLeftArr:function(){return this.PolyLeftArr.concat()},set_PolyLeft_wrong:function(e){this.PolyLeftArr[e]=!1},isClockWise:function(e){var t=e,r=0;do r+=(t.vFrom.x-t.vTo.x)*(t.vFrom.y+t.vTo.y),t=t.snext;while(t!=e);return r<0},appendVertexEntry:function(e,t){var r={id:this.vertices.length,x:e,y:t};return this.vertices.push(r),r},createSegmentEntry:function(t,r){return{chainId:this.idNextPolyChain,vFrom:t,vTo:r,upward:1==e.Math.compare_pts_yx(r,t),sprev:null,snext:null,rootFrom:null,rootTo:null,is_inserted:!1,trLeft:null,trRight:null,mprev:null,mnext:null,marked:!1}},appendSegmentEntry:function(e){return this.segments.push(e),e},appendDiagonalsEntry:function(e){return this.diagonals.push(e),e},addVertexChain:function(t){function r(t,r){return Math.abs(t.x-r.x)<e.Math.EPSILON_P&&Math.abs(t.y-r.y)<e.Math.EPSILON_P}function n(t,r,n){if(Math.abs(e.Math.ptsCrossProd(r,t,n))>e.Math.EPSILON_P)return!1;var i,o,a;return Math.abs(t.y-r.y)<e.Math.EPSILON_P?(o=r.x,t.x<n.x?(i=t.x,a=n.x):(i=n.x,a=t.x)):(o=r.y,t.y<n.y?(i=t.y,a=n.y):(i=n.y,a=t.y)),i-o<e.Math.EPSILON_P&&o-a<e.Math.EPSILON_P}for(var i,o,a,s=[],l=0;l<t.length;l++)i=this.appendVertexEntry(t[l].x,t[l].y),o=!0,a=s.length-1,a>=0&&(r(i,s[a])?o=!1:a>0&&n(s[a-1],s[a],i)&&s.pop()),o&&s.push(i);return a=s.length-1,a>0&&r(s[a],s[0])&&(s.pop(),a--),a>1&&(n(s[a-1],s[a],s[0])&&(s.pop(),a--),a>1&&n(s[a],s[0],s[1])&&s.shift()),s},addPolygonChain:function(e){var t=this.addVertexChain(e);if(t.length<3)return console.log("Polygon has < 3 vertices!",t),0;for(var r,n,i,o=this.segments.length,a=0;a<t.length-1;a++)r=this.createSegmentEntry(t[a],t[a+1]),i?(r.sprev=i,i.snext=r):n=r,i=r,this.appendSegmentEntry(r);return r=this.createSegmentEntry(t[t.length-1],t[0]),r.sprev=i,i.snext=r,this.appendSegmentEntry(r),n.sprev=r,r.snext=n,this.PolyLeftArr[this.idNextPolyChain++]=!0,this.segments.length-o},create_mono_chains:function(){for(var e,t,r,n,i=0,o=this.segments.length;i<o;i++)e=this.segments[i],this.PolyLeftArr[e.chainId]?(t=e.vTo,e.mprev=e.sprev,e.mnext=e.snext):(t=e.vFrom,e=e.snext,e.mprev=e.snext,e.mnext=e.sprev),(n=e.vFrom.lastInDiag)&&(n.mnext=e,e.mprev=n,e.vFrom.lastInDiag=null),(r=t.firstOutDiag)&&(r.mprev=e,e.mnext=r,t.firstOutDiag=null)},unique_monotone_chains_max:function(){function t(t){var r,n,i,o=t;for(n=i=t.vFrom,t.marked=!0,t=t.mnext;r=t.vFrom;){if(t.marked){if(r==n)break;return console.log("ERR unique_monotone: segment in two chains",n,t),null}t.marked=!0,1==e.Math.compare_pts_yx(r,i)&&(i=r,o=t),t=t.mnext}return o}var r,n;this.monoSubPolyChains=[];for(var i=0,o=this.segments.length;i<o;i++)r=this.segments[i],r.marked||(n=t(r),n&&this.monoSubPolyChains.push(n));return this.monoSubPolyChains},clearTriangles:function(){this.triangles=[]},addTriangle:function(e,t,r){this.triangles.push([e.id,t.id,r.id])}},e.EarClipTriangulator=function(e){this.polyData=e},e.EarClipTriangulator.prototype={constructor:e.EarClipTriangulator,triangulate_polygon_no_holes:function(){function t(t){var r=t.mprev.vFrom.x,n=t.mprev.vFrom.y,i=t.vFrom.x,o=t.vFrom.y,a=t.mnext.vFrom.x,s=t.mnext.vFrom.y,l=a-i,u=s-o,h=r-a,c=n-s,d=i-r,f=o-n;if(e.Math.EPSILON_P>d*u-l*f)return!1;for(var p=t.mprev.mprev,m=t.mnext;m!=p;){m=m.mnext;var v=m.vFrom.x,g=m.vFrom.y,y=v-r,x=g-n;if(0!==y||0!==x){var b=v-i,T=g-o;if(0!==b||0!==T){var w=v-a,S=g-s;if((0!==w||0!==S)&&l*T-u*b>=e.Math.EPSILON_N&&d*x-f*y>=e.Math.EPSILON_N&&h*S-c*w>=e.Math.EPSILON_N)return!1}}}return!0}var r=this.polyData,n=r.getFirstSegment(),i=n;if(r.isClockWise(n)){do i.mprev=i.snext,i.mnext=i.sprev,i=i.sprev;while(i!=n);r.set_PolyLeft_wrong(0)}else do i.mprev=i.sprev,i.mnext=i.snext,i=i.snext;while(i!=n);for(var o=n,a=o;o.mnext!=o.mprev;)if(t(o))this.polyData.addTriangle(o.mprev.vFrom,o.vFrom,o.mnext.vFrom),o.mprev.mnext=o.mnext,o.mnext.mprev=o.mprev,o=o.mnext,a=o;else if(o=o.mnext,o==a)return!1;return!0}},e.Trapezoid=function(e,t,r,n){this.vHigh=e?e:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY},this.vLow=t?t:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY},this.lseg=r,this.rseg=n,this.depth=-1,this.monoDone=!1},e.Trapezoid.prototype={constructor:e.Trapezoid,clone:function(){var t=new e.Trapezoid(this.vHigh,this.vLow,this.lseg,this.rseg);return t.uL=this.uL,t.uR=this.uR,t.dL=this.dL,t.dR=this.dR,t.sink=this.sink,t},splitOffLower:function(e){var t=this.clone();return this.vLow=t.vHigh=e,this.dL=t,t.uL=this,this.dR=t.uR=null,t.dL&&(t.dL.uL=t),t.dR&&(t.dR.uR=t),t}},e.QsNode=function(e){this.trap=e,e.sink=this},e.QsNode.prototype={constructor:e.QsNode},e.QueryStructure=function(t){var r=new e.Trapezoid(null,null,null,null);if(this.trapArray=[],this.appendTrapEntry(r),this.root=new e.QsNode(r),t)for(var n=t.getSegments(),i=0;i<n.length;i++)n[i].rootFrom=n[i].rootTo=this.root,n[i].is_inserted=!1},e.QueryStructure.prototype={constructor:e.QueryStructure,getRoot:function(){return this.root},appendTrapEntry:function(e){e.trapID=this.trapArray.length,this.trapArray.push(e)},cloneTrap:function(e){var t=e.clone();return this.appendTrapEntry(t),t},splitNodeAtPoint:function(t,r,n){var i=t.trap;if(i.vHigh==r)return t;if(i.vLow==r)return t;var o=i.splitOffLower(r);return this.appendTrapEntry(o),t.yval=r,t.trap=null,t.right=new e.QsNode(i),t.left=new e.QsNode(o),n?i.sink:o.sink},fpEqual:function(t,r){return Math.abs(t-r)<e.Math.EPSILON_P},is_left_of:function(t,r,n){var i,o=t.vFrom.x-r.x,a=t.vTo.x-r.x,s=this.fpEqual(t.vFrom.y,r.y);if(this.fpEqual(t.vTo.y,r.y)){if(s)return 0;i=a}else{if(!s)return t.upward?e.Math.ptsCrossProd(t.vFrom,t.vTo,r):e.Math.ptsCrossProd(t.vTo,t.vFrom,r);i=o}return Math.abs(i)<e.Math.EPSILON_P?0:i},segNodes:function(e){this.ptNode(e,!0),this.ptNode(e,!1)},ptNode:function(t,r){var n,i,o;r?(n=t.vFrom,i=t.vTo,o=t.rootFrom):(n=t.vTo,i=t.vFrom,o=t.rootTo);for(var a,s;o;)if(o.yval)o=e.Math.compare_pts_yx(n==o.yval?i:n,o.yval)==-1?o.left:o.right;else{if(!o.seg)return o.trap||console.log("ptNode: unknown type",o),r?t.rootFrom=o:t.rootTo=o,o;if(n==o.seg.vFrom||n==o.seg.vTo){if(this.fpEqual(n.y,i.y)){this.fpEqual(o.seg.vFrom.y,o.seg.vTo.y)?n==o.seg.vFrom?(s=t.upward?i.x>=o.seg.vTo.x:i.x<o.seg.vTo.x,o=(s?t.sprev.upward:o.seg.snext.upward)?o.right:o.left):(s=t.upward?i.x<o.seg.vFrom.x:i.x>=o.seg.vFrom.x,o=(s?t.snext.upward:o.seg.sprev.upward)?o.left:o.right):o=i.x<n.x?o.left:o.right;continue}a=this.is_left_of(o.seg,i,!1),0===a&&(n==o.seg.vFrom?(s=t.upward?i.y>=o.seg.vTo.y:i.y<o.seg.vTo.y,a=s?this.is_left_of(o.seg,t.sprev.vFrom,!1):-this.is_left_of(o.seg,o.seg.snext.vTo,!1)):(s=t.upward?i.y<o.seg.vFrom.y:i.y>=o.seg.vFrom.y,a=s?this.is_left_of(o.seg,t.snext.vTo,!1):-this.is_left_of(o.seg,o.seg.sprev.vFrom,!1)))}else if(a=this.is_left_of(o.seg,n,!0),0===a&&(a=this.is_left_of(o.seg,i,!1),0===a)){var l=r?t.sprev.vFrom:t.snext.vTo;a=this.is_left_of(o.seg,l,!1)}if(a>0)o=o.left;else{if(!(a<0))return o;o=o.right}}},add_segment:function(t){function r(){var e=T.uL||T.uR;e.dL&&e.dR?T==e.dL?(v.uL=null,e.dL=m):(m.uR=null,e.dR=v):(v.uL=null,v.uR=e,e.dR=v)}function n(){T.usave?(T.uleft?(v.uL=T.uR,v.uR=T.usave,v.uL.dL=v,v.uR.dR=v):(m.uR=T.uL,m.uL=T.usave,m.uL.dL=m,m.uR.dR=m),m.usave=v.usave=null):T.vHigh==p.vHigh?(v.uR.dR=v,m.uR=v.uL=null):v==T?(v.uL=v.uR,v.uR=null,v.uL.dL=v):(m.uR=m.uL,m.uL=null)}function i(e){T.vLow==b.vLow?(u?T.dL?(e.uL=m,m.dL=e,v.dR=null):(e.uR=v,m.dL=null,v.dR=e):(e.uL=m,e.uR=v,m.dL=v.dR=e),m.dR=v.dL=null):(e.uL&&e.uR&&(e.uL==T?(e.usave=e.uR,e.uleft=!0):(e.usave=e.uL,e.uleft=!1)),e.uL=m,e.uR=v,m.dR=v.dL=e,m.dL=v.dR=null)}function o(){var e;if(T.vLow==b.vLow&&u)T.dL.uL=m,T.dR.uR=v,m.dL=T.dL,v.dR=T.dR,m.dR=v.dL=null,e=null;else{T.dL.uL=m,T.dR.uR=v;var r,n=a.is_left_of(t,T.vLow,!0);if(n>0)r=!0;else if(n<0)r=!1;else{var i=T.dL.rseg,o=i.upward,s=o?i.vFrom:i.vTo;n=a.is_left_of(t,s,!1),n>0?r=!0:n<0?r=!1:(i=o?i.snext:i.sprev,s=o?i.vTo:i.vFrom,n=a.is_left_of(t,s,!1),r=n>0)}r?(e=T.dR,T.dR.uL=m,m.dL=T.dL,v.dR=null):(e=T.dL,T.dL.uR=v,v.dR=T.dR,m.dL=null),m.dR=v.dL=e}return e}var a=this;this.segNodes(t);var s,l,u,h,c,d;if(t.upward?(s=t.vFrom,h=t.vTo,l=t.rootFrom,c=t.rootTo,u=t.sprev.is_inserted,d=t.snext.is_inserted):(s=t.vTo,h=t.vFrom,l=t.rootTo,c=t.rootFrom,u=t.snext.is_inserted,d=t.sprev.is_inserted),!d){var f=this.splitNodeAtPoint(c,h,!1);c==l&&(l=f),c=f}var p=c.trap;if(!p.uL&&!p.uR)return void console.log("ERR add_segment: missing trFirst.uX: ",p);if(p.vHigh!=h)return void console.log("ERR add_segment: trFirstHigh != segHigh: ",p);u||(l=this.splitNodeAtPoint(l,s,!0));for(var m,v,g,y,x,b=l.trap,T=p,w=this.trapArray.length+2;T;){if(--w<0)return void console.log("ERR add_segment: infinite loop",T,t,this);if(!T.dL&&!T.dR)return void console.log("ERR add_segment: missing successors",T,t,this);var S=T.sink;S.seg=t,S.trap=null,y&&y.rseg==T.rseg?(m=T,v=y,v.vLow=T.vLow,S.left=new e.QsNode(m),S.right=y.sink):g&&g.lseg==T.lseg?(v=T,m=g,m.vLow=T.vLow,S.left=g.sink,S.right=new e.QsNode(v)):(m=T,v=this.cloneTrap(T),S.left=new e.QsNode(m),S.right=new e.QsNode(v)),T.uL&&T.uR?n():r(),T.dL&&T.dR?x=o():(x=T.dL?T.dL:T.dR,i(x)),m.rseg&&(m.rseg.trLeft=v),v.lseg&&(v.lseg.trRight=m),m.rseg=v.lseg=t,t.trLeft=m,t.trRight=v,T.vLow!=b.vLow?(g=m,y=v,T=x):T=null}t.is_inserted=!0},assignDepths:function(e){var t,r,n=[this.trapArray[0]],i=[],o=0;do{for(var a=o%2==1;t=n.pop();)t.depth==-1&&(t.depth=o,t.uL&&n.push(t.uL),t.uR&&n.push(t.uR),t.dL&&n.push(t.dL),t.dR&&n.push(t.dR),(r=t.lseg)&&r.trLeft.depth==-1&&i.push(r.trLeft),(r=t.rseg)&&(r.trRight.depth==-1&&i.push(r.trRight),r.upward!=a&&e.set_PolyLeft_wrong(r.chainId)));n=i,i=[],o++}while(n.length>0)},create_visibility_map:function(e){var t,r,n=0,i=1,o=2,a=3,s=4,l=5,u=6,h=7,c=e.nbVertices(),d=new Array(c);for(t=0;t<c;t++)d[t]=new Array(h+1);var f=new Array(c);for(t=0,r=this.trapArray.length;t<r;t++){var p=this.trapArray[t],m=p.uL?p.uR?l:h:p.uR?s:u,v=p.dL?p.dR?i:n:p.dR?a:o;if(p.depth%2==1){if(m==l||v==i||m==h&&v==a||m==s&&v==n){var g=e.appendDiagonalsEntry({vFrom:p.vLow,vTo:p.vHigh,mprev:null,mnext:null,marked:!1}),y=e.appendDiagonalsEntry({vFrom:p.vHigh,vTo:p.vLow,revDiag:g,mprev:null,mnext:null,marked:!1});g.revDiag=y,d[p.vLow.id][v]=g,d[p.vHigh.id][m]=y}}else null!==p.vHigh.id&&(f[p.vHigh.id]=m),null!==p.vLow.id&&(f[p.vLow.id]=v)}var x,b,T,w,S;for(t=0;t<c;t++)if(b=d[t],T=f[t],null!=T){r=T,S=null;do r++>h&&(r=n),(x=b[r])&&(S?(x.mprev=S,S.mnext=x):(w=x.vFrom,w.firstOutDiag=x),S=x.revDiag);while(r!=T);S&&(w.lastInDiag=S)}}},e.Trapezoider=function(t){this.polyData=t,this.queryStructure=new e.QueryStructure(this.polyData)},e.Trapezoider.prototype={constructor:e.Trapezoider,optimise_randomlist:function(e){var t=0,r=this.polyData.nbPolyChains();if(1!=r)for(var n=new Array(r),i=e.concat(),o=0;o<i.length;o++){var a=i[o].chainId;n[a]?e[r++]=i[o]:(e[t++]=i[o],n[a]=!0)}},trapezoide_polygon:function(){var t=this.polyData.getSegments().concat();e.Math.array_shuffle(t),this.optimise_randomlist(t);for(var r,n=t.length,i=this.queryStructure,o=0,a=n;o<n;){a=Math.log(a)/Math.LN2;for(var s=a>1?Math.floor(n/a):n;o<s;o++)i.add_segment(t[o]);for(r=o;r<n;r++)this.queryStructure.segNodes(t[r])}for(i.assignDepths(this.polyData),r=0;r<n;r++)t[r].trLeft=t[r].trRight=null},create_visibility_map:function(){return this.queryStructure.create_visibility_map(this.polyData)}},e.MonoSplitter=function(e){this.polyData=e,this.trapezoider=null},e.MonoSplitter.prototype={constructor:e.MonoSplitter,monotonate_trapezoids:function(){this.trapezoider=new e.Trapezoider(this.polyData),this.trapezoider.trapezoide_polygon(),this.trapezoider.create_visibility_map(),this.polyData.create_mono_chains(),this.polyData.unique_monotone_chains_max()}},e.MonoTriangulator=function(e){this.polyData=e},e.MonoTriangulator.prototype={constructor:e.MonoTriangulator,triangulate_all_polygons:function(){var e=this.polyData.getMonoSubPolys();this.polyData.clearTriangles();for(var t=0;t<e.length;t++){var r=e[t],n=r.mprev,i=r.mnext;i.mnext==n?this.polyData.addTriangle(r.vFrom,i.vFrom,n.vFrom):this.triangulate_monotone_polygon(r)}},triangulate_monotone_polygon:function(t){function r(){for(console.log("ERR uni-y-monotone: only concave angles left",a);s>1;)s--,n.polyData.addTriangle(a[s-1],a[s],a[s+1])}var n=this,i=t.mnext,o=t.vFrom,a=[i.vFrom],s=0;i=i.mnext;var l=i.vFrom;if(l!=o){for(;l!=o||s>1;)if(s>0){var u=e.Math.ptsCrossProd(a[s],l,a[s-1]);Math.abs(u)<=e.Math.EPSILON_P&&(l!=o&&e.Math.compare_pts_yx(a[s],l)!=e.Math.compare_pts_yx(a[s],a[s-1])||(u=1)),u>0?(this.polyData.addTriangle(a[s-1],a[s],l),s--):(a[++s]=l,l==o?r():(i=i.mnext,l=i.vFrom))}else a[++s]=l,i=i.mnext,l=i.vFrom;this.polyData.addTriangle(a[s-1],a[s],l)}}},e.Triangulator=function(){this.lastPolyData=null},e.Triangulator.prototype={constructor:e.Triangulator,clear_lastData:function(){this.lastPolyData=null},get_PolyLeftArr:function(){return this.lastPolyData?this.lastPolyData.get_PolyLeftArr():null},triangulate_polygon:function(t,r){function n(){return!r&&1==o.nbPolyChains()}if(this.clear_lastData(),!t||0===t.length)return[];var i,o=new e.PolygonData(t),a=n();if(a&&(i=new e.EarClipTriangulator(o),a=i.triangulate_polygon_no_holes()),!a){var s=new e.MonoSplitter(o);s.monotonate_trapezoids(),i=new e.MonoTriangulator(o),i.triangulate_all_polygons()}return this.lastPolyData=o,o.getTriangles()}},e}),r("Renderer/PolygonRenderer",["../Utils/Utils","./VectorRenderer","./VectorRendererManager","./FeatureStyle","./Program","./BatchRenderable","./pnltri","./GeoBound"],function(e,t,r,n,i,o,a,s){var l=function(e){t.prototype.constructor.call(this,e),this.maxTilePerGeometry=2,this.renderContext=e.renderContext,this.defaultVertexShader="attribute vec3 vertex;\n",this.defaultVertexShader+="uniform mat4 mvp;\n",this.defaultVertexShader+="void main(void) \n",this.defaultVertexShader+="{\n",this.defaultVertexShader+="\tgl_Position = mvp * vec4(vertex, 1.0);\n",this.defaultVertexShader+="}\n",this.extrudeVertexShader="attribute vec3 vertex;\n",this.extrudeVertexShader+="attribute vec4 normal;\n",this.extrudeVertexShader+="uniform float extrusionScale; \n",this.extrudeVertexShader+="uniform mat4 mvp;\n",this.extrudeVertexShader+="void main(void) \n",this.extrudeVertexShader+="{\n",this.extrudeVertexShader+="\tvec3 extrudedVertex = vertex + normal.w * vec3(normal.x, normal.y, normal.z) * extrusionScale;",this.extrudeVertexShader+="\tgl_Position = mvp * vec4(extrudedVertex, 1.0);\n",this.extrudeVertexShader+="}\n",this.fragmentShader="precision lowp float; \n",this.fragmentShader+="uniform vec4 u_color;\n",this.fragmentShader+="void main(void)\n",this.fragmentShader+="{\n",this.fragmentShader+="\tgl_FragColor = u_color;\n",this.fragmentShader+="\t//if (u_color.a == 0.0) discard;\n",this.fragmentShader+="}\n",this.program=new i(e.renderContext),this.program.createFromSource(this.defaultVertexShader,this.fragmentShader),this.extrudeProgram=new i(e.renderContext),this.extrudeProgram.createFromSource(this.extrudeVertexShader,this.fragmentShader)};e.inherits(t,l);var u=function(e){o.prototype.constructor.call(this,e),this.origin=null,this.vertexSize=e.style.extrude?7:3,this.matrix=mat4.create()};e.inherits(o,u);var h=function(e,t,r){return[t[0]+e*(r[0]-t[0]),t[1]+e*(r[1]-t[1])]},c=function(e,t,r,n){for(var i,o,a=[],s=0;s<n.length;s++){var l=n[s],u=n[(s+1)%n.length],c=l[e],d=u[e],f=(c-r)*t>=0,p=(d-r)*t>=0;!f&&p?(i=(r-c)/(d-c),o=h(i,l,u),a.push(o),a.push(u)):f&&p?a.push(u):f&&!p&&(i=(r-c)/(d-c),o=h(i,l,u),a.push(o))}return a},d=function(e,t){var r;return r=c(0,1,t.west,e),r=c(0,-1,t.east,r),r=c(1,1,t.south,r),r=c(1,-1,t.north,r)},f=function(e){for(var t=!1,r=1;r<e.length&&!t;r++){var n=Math.abs(e[r][0]-e[r-1][0]);n>180&&n<360&&(t=!0)}var i;if(t){var o=[];for(i=0;i<e.length;i++)e[i][0]>0?o[i]=[e[i][0]-360,e[i][1]]:o[i]=[e[i][0],e[i][1]];var a=[];for(i=0;i<e.length;i++)e[i][0]<0?a[i]=[e[i][0]+360,e[i][1]]:a[i]=[e[i][0],e[i][1]];return[a,o]}return[e]};u.prototype.build=function(e){var t=this.bucket.renderer,r=this.bucket.style,n=t.planet.coordinateSystem,i="MultiPolygon"===e.type?e.coordinates:[e.coordinates],o=new s,l=new s(n.geoBound[0],n.geoBound[1],n.geoBound[2],n.geoBound[3]);if(o.computeFromCoordinates(i[0][0]),o.intersects(l)){var u,h,c=vec3.create();this.origin||(this.origin=vec3.create(),n.fromGeoTo3D(i[0][0][0],this.origin),mat4.identity(this.matrix),mat4.translate(this.matrix,this.origin));var p,m,v=this.vertices.length/this.vertexSize,g=this.vertices.length,y=[];for(h=0;h<i.length;h++)y=y.concat(f(i[h][0]));for(h=0;h<y.length;h++){var x=d(y[h],l);g=this.vertices.length;var b=0;for(u=0;u<x.length;u++){if(n.fromGeoTo3D([x[u][0],x[u][1],0],c),this.vertices[g]=c[0]-this.origin[0],this.vertices[g+1]=c[1]-this.origin[1],this.vertices[g+2]=c[2]-this.origin[2],u<x.length-1&&(b+=(x[u+1][0]-x[u][0])*(x[u+1][1]+x[u][1])),r.extrude){vec3.normalize(c),this.vertices[g+3]=c[0],this.vertices[g+4]=c[1],this.vertices[g+5]=c[2];var T;T="boolean"==typeof r.extrude?x[u][2]:r.extrude,this.vertices[g+6]=T*n.geoide.heightScale}g+=this.vertexSize}if(r.extrude){var w=v*this.vertexSize;for(this.vertices=this.vertices.concat(this.vertices.slice(w,g)),u=g;u<this.vertices.length;u+=this.vertexSize)this.vertices[u+6]=0}var S=new a.Triangulator,A=x.map(function(e){return{x:e[0],y:e[1]}}),M=S.triangulate_polygon([A]);for(u=0;u<M.length;u++)this.triIndices.push(v+M[u][0],v+M[u][1],v+M[u][2]);if(r.extrude)for(p=v,m=v+x.length,u=0;u<x.length-1;u++)b>0?(this.triIndices.push(p,p+1,m),this.triIndices.push(p+1,m+1,m)):(this.triIndices.push(p,m,p+1),this.triIndices.push(p+1,m,m+1)),p+=1,m+=1;for(u=0;u<x.length-1;u++)this.lineIndices.push(v+u,v+u+1);if(r.extrude)for(p=v,m=v+x.length,u=0;u<x.length-1;u++)this.lineIndices.push(p+u,m+u);v=this.vertices.length/this.vertexSize}return!0}};var p=function(e,t){this.layer=e,this.style=t,this.renderer=null};p.prototype.createRenderable=function(){return new u(this)},p.prototype.isCompatible=function(e){return this.style===e},l.prototype.render=function(e,t,r){var n=this.planet.renderContext,i=n.gl;i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.depthFunc(i.LEQUAL);var o=null,a=mat4.create();mat4.multiply(n.projectionMatrix,n.viewMatrix,a);for(var s=mat4.create(),l=t;l<r;l++){var u=e[l],h=u.bucket.style,c=h.extrude?this.extrudeProgram:this.program;if(c!==o&&(c.apply(),o=c),mat4.multiply(a,u.matrix,s),i.uniformMatrix4fv(c.uniforms.mvp,!1,s),i.uniform4f(c.uniforms.u_color,h.fillColor[0],h.fillColor[1],h.fillColor[2],h.fillColor[3]*u.bucket.layer._opacity),u.bindBuffers(n),i.lineWidth(h.strokeWidth),i.vertexAttribPointer(c.attributes.vertex,3,i.FLOAT,!1,4*u.vertexSize,0),h.extrude&&(i.vertexAttribPointer(c.attributes.normal,4,i.FLOAT,!1,4*u.vertexSize,12),i.uniform1f(c.uniforms.extrusionScale,h.extrusionScale)),i.drawElements(i.TRIANGLES,u.triIndices.length,u.indexType,0),u.lineIndices.length>0){i.uniform4f(c.uniforms.u_color,h.strokeColor[0],h.strokeColor[1],h.strokeColor[2],h.strokeColor[3]*u.bucket.layer._opacity);var d=u.indexType===i.UNSIGNED_INT?4:2;i.drawElements(i.LINES,u.lineIndices.length,u.indexType,u.triIndices.length*d)}}i.lineWidth(1),i.depthFunc(i.LESS),i.disable(i.BLEND)},l.prototype.canApply=function(e,t){return("Polygon"===e||"MultiPolygon"===e)&&t.fill},l.prototype.createBucket=function(e,t){return new p(e,t)},r.factory.push(function(e){return new l(e)})}),r("Renderer/LineRenderer",["../Utils/Utils","../Utils/Numeric","./VectorRenderer","./VectorRendererManager","./Program","./BatchRenderable"],function(e,t,r,n,i,o){var a=function(e){r.prototype.constructor.call(this,e),this.maxTilePerGeometry=2,this.renderContext=e.renderContext,this.defaultVertexShader="attribute vec4 vertex;\n",this.defaultVertexShader+="uniform mat4 mvp;\n",this.defaultVertexShader+="varying float s;\n",this.defaultVertexShader+="void main(void) \n",this.defaultVertexShader+="{\n",this.defaultVertexShader+="\ts = vertex.w;\n",this.defaultVertexShader+="\tgl_Position = mvp * vec4(vertex.xyz, 1.0);\n",this.defaultVertexShader+="}\n",this.fragmentShader="precision lowp float; \n",this.fragmentShader+="uniform vec4 u_color;\n",this.fragmentShader+="uniform float speed;\n",this.fragmentShader+="uniform float time;\n",this.fragmentShader+="uniform float gradientLength;\n",this.fragmentShader+="varying float s;\n",this.fragmentShader+="uniform sampler2D colorTexture;\n",this.fragmentShader+="void main(void)\n",this.fragmentShader+="{\n",this.fragmentShader+="\t// 0.5 is a time scale parameter, parametrize it ?\n",this.fragmentShader+="\tfloat m = speed * time * 0.5;\n",this.fragmentShader+="\tfloat u = (-s+m)/gradientLength;\n",this.fragmentShader+="\tgl_FragColor.rgb = texture2D(colorTexture, vec2(u,0.)).rgb;\n",this.fragmentShader+="\t// TODO: handle appereance of rivers\n",this.fragmentShader+="\tif ( s < m )\n",this.fragmentShader+="\t{\n",this.fragmentShader+="\t\tgl_FragColor.a = 1.0;\n",this.fragmentShader+="\t}\n",this.fragmentShader+="\telse\n",this.fragmentShader+="\t{\n",this.fragmentShader+="\t\tgl_FragColor.a = 0.0;\n",this.fragmentShader+="\t}\n",this.fragmentShader+="}\n",this.program=new i(e.renderContext),this.program.createFromSource(this.defaultVertexShader,this.fragmentShader),this.time=Date.now()/1e3,this.palette=null,this.colorTexture=this.generateTexture([[0,0,255],[0,200,255]])};e.inherits(r,a),a.prototype.generateTexture=function(e){var r,n,i,o,a=e[0],s=e[1],l=[],u=this.planet.renderContext.gl;for(this.colorTexture=u.createTexture(),u.bindTexture(u.TEXTURE_2D,this.colorTexture),r=0;r<128;r++)n=t.coserp(r/128,a[0],s[0]),i=t.coserp(r/128,a[1],s[1]),o=t.coserp(r/128,a[2],s[2]),l.push(n),l.push(i),l.push(o),l.push(255);for(r=0;r<128;r++)n=t.coserp(r/128,s[0],a[0]),i=t.coserp(r/128,s[1],a[1]),o=t.coserp(r/128,s[2],a[2]),l.push(n),l.push(i),l.push(o),l.push(255);u.texImage2D(u.TEXTURE_2D,0,u.RGBA,l.length/4,1,0,u.RGBA,u.UNSIGNED_BYTE,new Uint8Array(l)),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.LINEAR),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.LINEAR),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.REPEAT),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.REPEAT),this.palette=e};var s=function(e){o.prototype.constructor.call(this,e),this.vertexSize=4,this.matrix=mat4.create(),mat4.identity(this.matrix)};e.inherits(o,s),s.prototype.build=function(e){var t,r,n=this.bucket.renderer,i=(this.bucket.style,"MultiLineString"===e.type?e.coordinates:[e.coordinates]),o=vec3.create(),a=vec3.create();for(r=0;r<i.length;r++){var s=i[r],l=this.vertices.length/4,u=n.planet.coordinateSystem,h=4*l,c=0;for(t=0;t<s.length;t++){u.fromGeoTo3D(s[t],o),this.vertices[h]=o[0],this.vertices[h+1]=o[1],this.vertices[h+2]=o[2],t>0&&(c+=vec3.dist(o,a));var d=a;a=o,o=d,this.vertices[h+3]=c,h+=4}for(t=0;t<s.length-1;t++)this.lineIndices.push(l+t,l+t+1)}return!0};var l=function(e,t){this.layer=e,this.style=t,this.renderer=null};l.prototype.createRenderable=function(){return new s(this)},l.prototype.isCompatible=function(e){return this.style===e},a.prototype.render=function(e,t,r){var n=this.planet.renderContext,i=n.gl;i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.depthFunc(i.LEQUAL);var o=mat4.create();mat4.multiply(n.projectionMatrix,n.viewMatrix,o);var a=mat4.create();this.program.apply(),i.activeTexture(i.TEXTURE0),i.uniform1i(this.program.uniforms.colorTexture,0),i.bindTexture(i.TEXTURE_2D,this.colorTexture);for(var s=t;s<r;s++){var l=e[s],u=l.bucket.style;mat4.multiply(o,l.matrix,a),i.uniformMatrix4fv(this.program.uniforms.mvp,!1,a),u.palette&&u.palette!==this.palette&&(i.deleteTexture(this.colorTexture),this.generateTexture(u.palette)),i.lineWidth(u.strokeWidth),i.uniform4f(this.program.uniforms.u_color,u.strokeColor[0],u.strokeColor[1],u.strokeColor[2],u.strokeColor[3]*l.bucket.layer._opacity),i.uniform1f(this.program.uniforms.speed,u.hasOwnProperty("speed")?u.speed:1),i.uniform1f(this.program.uniforms.time,Date.now()/1e3-this.time),i.uniform1f(this.program.uniforms.gradientLength,u.hasOwnProperty("gradientLength")?u.gradientLength:10),l.bindBuffers(n),i.vertexAttribPointer(this.program.attributes.vertex,4,i.FLOAT,!1,0,0),i.drawElements(i.LINES,l.lineIndices.length,l.indexType,0)}i.lineWidth(1),i.depthFunc(i.LESS),i.disable(i.BLEND)},a.prototype.canApply=function(e,t){return("LineString"===e||"MultiLineString"===e)&&t.gradientLength},a.prototype.createBucket=function(e,t){return new l(e,t)},n.factory.push(function(e){return new a(e)})}),r("Context/PlanetContext",["underscore-min","./Planet","../AttributionHandler","../Navigation/Navigation","../Utils/Utils","./BaseContext","../Layer/LayerManager","../Provider/JsonProvider","../Gui/Tracker/PositionTracker","../Gui/Tracker/ElevationTracker","../Navigation/FlatNavigation","../Projection/MercatorCoordinateSystem","../Layer/WCSElevationLayer","../Renderer/PointRenderer","../Renderer/LineStringRenderable","../Renderer/PolygonRenderer","../Renderer/LineRenderer","../CoordinateSystem/CoordinateSystemFactory"],function(e,t,r,n,i,o,a,s,l,u,h,c,d,f,p,m,v,g){var y=function(e,i){o.prototype.constructor.call(this,e,i),this.parentElement=e,this.canvas=this.parentElement.canvas,this.parentElement.context=this.parentElement.CONTEXT.Planet,this.parentElement.planetContext=this,this.coordinateSystemFactory=new g,planetOptions={tileErrorTreshold:i.tileErrorTreshold||3,continuousRendering:i.continuousRendering||!1,renderContext:i.renderContext,canvas:this.canvas,coordinateSystem:i.projection,shadersPath:"../../shaders/"};try{this.planet=new t(planetOptions)}catch(e){console.log("Erreur creation Planet : ",e),document.getElementById("GlobWebCanvas")&&(document.getElementById("GlobWebCanvas").style.display="none"),document.getElementById("loading")&&(document.getElementById("loading").style.display="none"),document.getElementById("webGLNotAvailable")&&(document.getElementById("webGLNotAvailable").style.display="block")}this.initPlanetEvents(this.planet),this.parentElement.scene=this.planet,new r(this.planet,{element:"globeAttributions"}),this.planetLayer=i.planetLayer,this.planetLayer&&this.planet.addLayer(this.planetLayer),i.isMobile&&this.initTouchNavigation(i),i.navigation&&(i.navigation.updateViewMatrix=!1),this.positionTracker=new l(this,{element:"posTracker",globe:this.planet,positionTracker:i.positionTracker}),this.navigationOptions=i.navigation,this.getCoordinateSystem().isFlat?(this.navigation=new h(this.planet,i.navigation),i.initTarget&&this.navigation.zoomTo(i.initTarget)):(this.elevationTracker=new u({element:"elevTracker",globe:this.planet,elevationTracker:i.elevationTracker,elevationLayer:void 0!==i.planetLayer?i.planetLayer.elevationLayer:void 0}),this.navigation=new n(this.planet,i.navigation),i.initTarget&&this.navigation.zoomTo(i.initTarget,18e6)),this.planet.publish("baseLayersReady")};return i.inherits(o,y),y.prototype.getAdditionalLayers=function(){return this.planetLayer.layers},y.prototype.getElevationTracker=function(){return this.elevationTracker|console.log("No elevationTracker defined")},y.prototype.dispose=function(){this.planet.dispose()},y.prototype.destroy=function(){this.planet.removeLayer(this.planetLayer),
this.hide(),this.planet.destroy(),this.planet=null},y.prototype.toggleDimension=function(e){return this.planet.getCoordinateSystem().isFlat?(this.parentElement.skyContext.enable(),this.planet.setMode2D(!1),this.setCoordinateSystem(this.coordinateSystemFactory.create({geoideName:"WGS84"})),this.navigation.zoom(0),this.render()):(this.parentElement.skyContext.disable(),this.planet.setMode2D(!0),this.setCoordinateSystem(this.coordinateSystemFactory.create({geoideName:"WGS84",projectionName:"Plate"})),this.render()),this.getCoordinateSystem().isFlat},y.prototype.loadProviders=function(){o.prototype.loadProviders.call(this)},y.prototype.setBackgroundSurvey=function(t){var r,n=this.planet,i=mizar.getLayers("planet");r=e.findWhere(i,{name:t}),e.isEmpty(r)||(n.baseImagery&&n.baseImagery.setVisible(!1),n.setBaseImagery(r),r.setVisible(!0),this.parentElement.publish("backgroundLayer:change",r))},y.prototype.setBaseImagery=function(e){this.planet&&this.planet.setBaseImagery(e)},y.prototype.setBaseElevation=function(e){this.planet&&this.planet.setBaseElevation(e)},y.prototype.addLayer=function(e){this.planet?this.planet.addLayer(e):console.log("planet is not defined for planet context")},y.prototype.render=function(){this.planet&&this.planet.render()},y.prototype.setCoordinateSystem=function(e){var t,r;this.planet.coordinateSystem.isFlat?(t=this.planet.coordinateSystem.from3DToGeo(this.navigation.center),r=this.navigation.distance/this.planet.coordinateSystem.geoide.heightScale):(t=this.navigation.geoCenter,r=this.navigation.distance/this.planet.coordinateSystem.geoide.heightScale),this.planet.setCoordinateSystem(e),this.navigation.stop(),e.isFlat?(this.navigation=new h(this.planet,this.navigationOptions),this.navigation.center=this.planet.coordinateSystem.fromGeoTo3D(t),this.navigation.distance=r*this.planet.coordinateSystem.geoide.heightScale):(this.navigation=new n(this.planet,this.navigationOptions),this.navigation.geoCenter=t,this.navigation.distance=r*this.planet.coordinateSystem.geoide.heightScale),this.navigation.computeViewMatrix()},y.prototype.getCoordinateSystem=function(){return this.planet?this.planet.coordinateSystem:null},y}),r("Provider/StarProvider",["jquery","./AbstractProvider","../Renderer/FeatureStyle","../Layer/LayerManager","../Utils/Utils"],function(e,t,r,n,i){function o(){console.error("Failed to load files")}var a,s,l,u=function(e){t.prototype.constructor.call(this,e),l=this};return i.inherits(t,u),u.prototype.loadFiles=function(t,r){if(!r.nameUrl||!r.catalogueUrl)return console.error("Not valid options"),null;var n={type:"GET",url:r.nameUrl,success:function(e){a=e},error:function(e,t,r){console.error(e.responseText)}},i={type:"GET",url:r.catalogueUrl,success:function(e){s=e},error:function(e,t,r){console.error(e.responseText)}};e.proxy(e.when(e.ajax(n),e.ajax(i)).then(function(){l.handleFeatures(t)},o))},u.prototype.handleFeatures=function(e){var t=a.slice(a.indexOf("897;Acamar"),a.indexOf("1231;Zaurak")+11),n=t.split("\n");t=s.slice(s.indexOf("001."),s.indexOf("4.98;K3Ibv")+10);for(var i=t.split("\n"),o=[],l=0;l<n.length;l++)for(var u=n[l].split(";"),h=parseInt(u[0]),c=u[1],d=0;d<i.length;d++)if(u=i[d].split(";"),parseInt(u[2])===h){var f=u[6],p=u[7],m=[];e.planet.coordinateSystem.fromEquatorialToGeo([f,p],m);var v={geometry:{type:"Point",gid:"star_"+c,coordinates:[m[0],m[1]]},properties:{name:c,style:new r({label:c,fillColor:[1,1,1,1]})}};o.push(v)}var g={type:"FeatureCollection",features:o};e.addFeatureCollection(g)},u}),r("Provider/ConstellationProvider",["jquery","./AbstractProvider","../Layer/LayerManager","../Renderer/FeatureStyle","../Utils/Utils"],function(e,t,r,n,i){function o(){for(var e=l.split("\n"),t=u.split("\n"),r=0;r<t.length;r++){var n=t[r].replace("  "," ");n=n.split(" ");var i=parseFloat(n[0]),o=parseFloat(n[1]),a=n[2];n[3];if(i*=15,!c[a])for(var h=0;h<e.length;h++){n=e[h].split(";");var d=n[0];if(d===a){var f=n[1];c[a]={coord:[],name:f,x:0,y:0,z:0,nbStars:0};break}}var p=[i,o],m=[];s.planet.coordinateSystem.fromGeoTo3D(p,m),c[a].x+=m[0],c[a].y+=m[1],c[a].z+=m[2],c[a].nbStars++,c[a].coord.push(p)}}function a(){console.error("Failed to load files")}var s,l,u,h,c={},d=function(e){t.prototype.constructor.call(this,e),h=this};return i.inherits(t,d),d.prototype.loadFiles=function(t,r){if(s=t,!r.nameUrl||!r.catalogueUrl)return console.error("Not valid options"),!1;var n={type:"GET",url:r.nameUrl,success:function(e){l=e},error:function(e,t,r){console.error(e.responseText)}},i={type:"GET",url:r.catalogueUrl,success:function(e){u=e},error:function(e,t,r){console.error(e.responseText)}};e.when(e.ajax(n),e.ajax(i)).then(function(){o(),h.handleFeatures(s)},a)},d.prototype.handleFeatures=function(){var e=[],t=[];for(var r in c){var i=c[r];i.coord.push(i.coord[0]);var o={geometry:{type:"Polygon",gid:"constellationShape_"+i.name,coordinates:[i.coord]},properties:{name:i.name}};t.push(o);var a=[];s.planet.coordinateSystem.from3DToGeo([i.x/i.nbStars,i.y/i.nbStars,i.z/i.nbStars],a);var l={geometry:{type:"Point",gid:"constellationName_"+i.name,coordinates:[a[0],a[1]]},properties:{name:i.name,style:new n({textColor:"#083BA8",fillColor:[1,1,1,1],label:i.name})}};e.push(l)}var u={type:"FeatureCollection",features:t},h={type:"FeatureCollection",features:e};s.addFeatureCollection(u),s.addFeatureCollection(h)},d}),r("Provider/OpenSearchProvider",["jquery","./AbstractProvider","../Layer/LayerManager","../Parser/JsonProcessor"],function(e,t,r,n){var i,o=function(e){i=this,t.prototype.constructor.call(this,e)};return o.prototype.loadFiles=function(t,r,n){e.ajax({type:"GET",url:r.url+"startIndex="+n+"&count=500",success:function(e){i.handleFeatures(t,r,n,e)},error:function(e,t,r){console.error(e.responseText)}})},o.prototype.handleFeatures=function(e,t,r,o){n.handleFeatureCollection(e,o),e.addFeatureCollection(o),r+o.features.length<o.totalResults&&i.loadFiles(e,t.url,r+o.features.length)},o}),r("Context/Sky",["../Context/Planet","../CoordinateSystem/EquatorialCoordinateSystem","../Tiling/TileManager","../Tiling/TilePool","../Utils/Utils"],function(e,t,r,n,i){var o=function(i){i.geoideName="Sky",i.coordinateSystem=new t(i),e.prototype.constructor.call(this,i),this.isEnable=!0,this.isSky=!0,this.tilePool=new n(this.renderContext),this.tileManagers={EQ:this.tileManager,GAL:new r(this,i)},this.renderContext.requestFrame()};return i.inherits(e,o),o.prototype.dispose=function(){for(var e in this.tileManagers)this.tileManagers[e].tilePool.disposeAll(),this.tileManagers[e].reset()},o.prototype.setBaseImagery=function(e){this.baseImagery!==e&&(this.baseImagery&&(this.removeLayer(this.baseImagery),this.tileManagers[this.baseImagery.coordSystem].setImageryProvider(null),this.baseImagery=null),e&&(e._overlay=!1,this.addLayer(e),this.tileManagers[e.coordSystem].setImageryProvider(e),this.baseImagery=e))},o.prototype.getBaseImagery=function(e){return this.baseImagery},o.prototype.setTileManager=function(e){this.tileManager=tilemanager},o.prototype.getTileManager=function(){return this.tileManager},o.prototype.render=function(){this.isEnable&&(this.tileManagers.GAL.render(),this.tileManagers.EQ.render())},o.prototype.enable=function(){this.isEnable=!0,this.tileManagers.GAL.render(),this.tileManagers.EQ.render()},o.prototype.disable=function(){this.isEnable=!1,this.tileManagers.GAL.render(!1),this.tileManagers.EQ.render(!1)},o}),r("Navigation/AstroNavigation",["../Utils/Utils","./BaseNavigation","../Animation/SegmentedAnimation","../Utils/Numeric","../Renderer/Ray","../Renderer/glMatrix"],function(e,t,r,n,i){var o=function(e,r){t.prototype.constructor.call(this,e.renderContext,r),this.sky=e,this.minFov=r&&r.minFov||.001,this.maxFov=r&&r.maxFov||100,this.center3d=[1,0,0],this.up=[0,0,1],r&&(r.initTarget&&this.sky&&this.sky.coordinateSystem&&this.sky.coordinateSystem.fromGeoTo3D(r.initTarget,this.center3d),r.initFov&&(this.renderContext.fov=r.initFov,this._clampFov()),r.up&&(this.up=r.up)),this.computeViewMatrix()};return e.inherits(t,o),o.prototype.zoomTo=function(e,t,i,o){var a=this,s=t||2;i=i||2e3;var l=[],u=25;this.sky.coordinateSystem.from3DToGeo(this.center3d,l);var h=[l[0],l[1],this.renderContext.fov],c=[e[0],e[1],s];Math.abs(e[0]-l[0])>180&&(l[0]<e[0]?h[0]+=360:c[0]+=360);var d=new r(i,function(e){var t=a.sky.coordinateSystem.fromGeoTo3D([e[0],e[1]]);a.center3d[0]=t[0],a.center3d[1]=t[1],a.center3d[2]=t[2],a.sky.renderContext.fov=e[2],a.computeViewMatrix()}),f=this.sky.coordinateSystem.fromGeoTo3D(e);if(u>this.renderContext.fov&&this.renderContext.worldFrustum.containsSphere(f,.005)<0){var p=[.5*h[0]+.5*c[0],.5*h[1]+.5*c[1],u];d.addSegment(0,h,.5,p,function(e,t,r){var i=n.easeInQuad(e),o=n.easeOutQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1]),n.lerp(o,t[2],r[2])]}),d.addSegment(.5,p,1,c,function(e,t,r){var i=n.easeOutQuad(e),o=n.easeInQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1]),n.lerp(o,t[2],r[2])]})}else d.addSegment(0,h,1,c,function(e,t,r){var i=n.easeOutQuad(e),o=n.easeInQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1]),n.lerp(o,t[2],r[2])]});d.onstop=function(){o&&o(),a.zoomToAnimation=null},this.sky.addAnimation(d),d.start(),this.zoomToAnimation=d},o.prototype.moveTo=function(e,t,i){var o=this;t=t||5e3;var a=[];this.sky.coordinateSystem.from3DToGeo(this.center3d,a);var s=[a[0],a[1]],l=[e[0],e[1]];Math.abs(e[0]-a[0])>180&&(a[0]<e[0]?s[0]+=360:l[0]+=360);var u=new r(t,function(e){var t=o.sky.coordinateSystem.fromGeoTo3D([e[0],e[1]]);o.center3d[0]=t[0],o.center3d[1]=t[1],o.center3d[2]=t[2],o.computeViewMatrix()});u.addSegment(0,s,1,l,function(e,t,r){var i=n.easeOutQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1])]}),u.onstop=function(){i&&i()},this.sky.addAnimation(u),u.start()},o.prototype.moveUpTo=function(e,t){var i=[],o=[];this.sky.coordinateSystem.from3DToGeo(this.up,i),this.sky.coordinateSystem.from3DToGeo(e,o),t=t||1e3;var a=this,s=new r(t,function(e){var t=a.sky.coordinateSystem.fromGeoTo3D([e[0],e[1]]);a.up[0]=t[0],a.up[1]=t[1],a.up[2]=t[2],a.computeViewMatrix()});s.addSegment(0,i,1,o,function(e,t,r){var i=n.easeOutQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1])]}),this.sky.addAnimation(s),s.start()},o.prototype.computeViewMatrix=function(){vec3.normalize(this.center3d);var e=this.renderContext.viewMatrix;mat4.lookAt([0,0,0],this.center3d,this.up,e),this.up=[e[1],e[5],e[9]],this.publish("modified"),this.renderContext.requestFrame()},o.prototype.zoom=function(e,t){t?this.renderContext.fov*=1/t:this.renderContext.fov*=1+.1*e,this._clampFov(),this.computeViewMatrix()},o.prototype.pan=function(e,t){var r=this.renderContext.canvas.width/2,n=this.renderContext.canvas.height/2,o=i.createFromPixel(this.renderContext,r-e,n-t);this.center3d=o.computePoint(o.sphereIntersect([0,0,0],this.sky.coordinateSystem.geoide.radius)),this.computeViewMatrix()},o.prototype.rotate=function(e,t){var r=.1*e*Math.PI/180,n=quat4.fromAngleAxis(r,this.center3d);quat4.multiplyVec3(n,this.up),this.computeViewMatrix()},o.prototype._clampFov=function(){this.renderContext.fov>this.maxFov&&(this.renderContext.fov=this.maxFov),this.renderContext.fov<this.minFov&&(this.renderContext.fov=this.minFov)},o}),r("Renderer/PointSpriteRenderer",["../Utils/Utils","./VectorRenderer","./Program","./FeatureStyle","./VectorRendererManager"],function(e,t,r,n,i){var o=function(e){t.prototype.constructor.call(this,e),this.numberOfRenderPoints=0;var n="attribute vec3 vertex; \n";n+="uniform mat4 viewProjectionMatrix; \n",n+="uniform float pointSize; \n",n+="void main(void)  \n",n+="{ \n",n+="\tgl_Position = viewProjectionMatrix * vec4(vertex,1.0); \n",n+="\tgl_PointSize = pointSize; \n",n+="} \n";var i="precision lowp float; \n";i+="uniform sampler2D texture; \n",i+="uniform float alpha; \n",i+="uniform vec3 color; \n",i+="\n",i+="void main(void) \n",i+="{ \n",i+="\tvec4 textureColor = texture2D(texture, gl_PointCoord); \n",i+="\tgl_FragColor = vec4(textureColor.rgb * color, textureColor.a * alpha); \n",i+="\tif (gl_FragColor.a <= 0.0) discard; \n",i+="\t//gl_FragColor = vec4(1.0); \n",i+="} \n",this.program=new r(e.renderContext),this.program.createFromSource(n,i),this.defaultTexture=null};e.inherits(t,o);var a=function(e){this.bucket=e,this.geometry2vb={},this.vertices=[],this.vertexBuffer=null,this.vertexBufferDirty=!1};a.prototype.add=function(e){this.geometry2vb[e.gid]=this.vertices.length;var t=this.bucket.renderer.planet.coordinateSystem.fromGeoTo3D(e.coordinates),r=this.bucket.renderer.planet.coordinateSystem.geoide.realPlanetRadius,n=this.bucket.renderer.planet.isSky?.985:this.bucket.renderer.planet.getElevation(e.coordinates[0],e.coordinates[1])/r+1.0015;return this.vertices.push(n*t[0],n*t[1],n*t[2]),this.vertexBufferDirty=!0,!0},a.prototype.remove=function(e){if(this.geometry2vb.hasOwnProperty(e.gid)){var t=this.geometry2vb[e.gid];delete this.geometry2vb[e.gid],this.vertices.splice(t,3),this.vertexBufferDirty=!0;for(var r in this.geometry2vb)r&&this.geometry2vb[r]>t&&(this.geometry2vb[r]-=3)}return this.vertices.length},a.prototype.dispose=function(e){this.vertexBuffer&&e.gl.deleteBuffer(this.vertexBuffer)},o.prototype._buildDefaultTexture=function(e){if(!this.defaultTexture){var t=this.planet.renderContext.gl;this.defaultTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.defaultTexture);var r=new Uint8Array([255,255,255,255]);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,r)}e.texture=this.defaultTexture,e.textureWidth=10,e.textureHeight=10},o.prototype._buildTextureFromImage=function(e,t){e.texture=this.planet.renderContext.createNonPowerOfTwoTextureFromImage(t),e.textureWidth=t.width,e.textureHeight=t.height},o.prototype.canApply=function(e,t){return"Point"===e&&!t.label};var s=function(e,t){this.layer=e,this.style=new n(t),this.texture=null,this.renderer=null};return s.prototype.createRenderable=function(){return new a(this)},s.prototype.isCompatible=function(e){return this.style.iconUrl===e.iconUrl&&this.style.icon===e.icon&&this.style.fillColor[0]===e.fillColor[0]&&this.style.fillColor[1]===e.fillColor[1]&&this.style.fillColor[2]===e.fillColor[2]},o.prototype.createBucket=function(e,t){var r=this.planet.renderContext.gl,n=(r.createBuffer(),new s(e,t));if(n.renderer=this,t.iconUrl){var i=new Image;i.crossOrigin="";var o=this;i.onload=function(){o._buildTextureFromImage(n,i),o.planet.renderContext.requestFrame()},i.onerror=function(){o._buildDefaultTexture(n)},i.src=t.iconUrl}else t.icon?this._buildTextureFromImage(n,t.icon):this._buildDefaultTexture(n);return n},o.prototype.render=function(e,t,r){var n=this.planet.renderContext,i=n.gl;i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),this.program.apply(),mat4.multiply(n.projectionMatrix,n.viewMatrix,n.modelViewMatrix),i.uniformMatrix4fv(this.program.uniforms.viewProjectionMatrix,!1,n.modelViewMatrix),i.uniform1i(this.program.uniforms.texture,0);for(var o=null,a=t;a<r;a++){var s=e[a],l=s.bucket;if(o!==l){i.uniform1f(this.program.uniforms.alpha,l.layer._opacity);var u=l.style.fillColor;i.uniform3f(this.program.uniforms.color,u[0],u[1],u[2]),i.uniform1f(this.program.uniforms.pointSize,l.textureWidth),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,l.texture),o=l}s.vertexBuffer||(s.vertexBuffer=i.createBuffer()),i.bindBuffer(i.ARRAY_BUFFER,s.vertexBuffer),i.vertexAttribPointer(this.program.attributes.vertex,3,i.FLOAT,!1,0,0),s.vertexBufferDirty&&(i.bufferData(i.ARRAY_BUFFER,new Float32Array(s.vertices),i.STATIC_DRAW),s.vertexBufferDirty=!1),i.drawArrays(i.POINTS,0,s.vertices.length/3)}i.disable(i.BLEND)},i.factory.push(function(e){return new o(e)}),o}),r("Tiling/Triangulator",[],function(){var e=1e-10,t=function(e){for(var t=e.length,r=0,n=t-1,i=0;i<t;n=i++)r+=e[n][0]*e[i][1]-e[i][0]*e[n][1];return.5*r},r=function(e,t,r,n,i,o,a,s){var l,u,h,c,d,f,p,m,v,g,y,x,b,T,w;return l=i-r,u=o-n,h=e-i,c=t-o,d=r-e,f=n-t,p=a-e,m=s-t,v=a-r,g=s-n,y=a-i,x=s-o,w=l*g-u*v,b=d*m-f*p,T=h*x-c*y,w>=0&&T>=0&&b>=0},n=function(t,n,i,o,a,s){var l,u,h,c,d,f,p,m,v;if(u=t[s[n]][0],h=t[s[n]][1],c=t[s[i]][0],d=t[s[i]][1],f=t[s[o]][0],p=t[s[o]][1],e>(c-u)*(p-h)-(d-h)*(f-u))return!1;for(l=0;l<a;l++)if(l!==n&&l!==i&&l!==o&&(m=t[s[l]][0],v=t[s[l]][1],r(u,h,c,d,f,p,m,v)))return!1;return!0},i=function(e){var r=e.length;if(e[0][0]===e[r-1][0]&&e[0][1]===e[r-1][1]&&r--,r<3)return null;var i,o,a=new Array(r);if(0<t(e))for(o=0;o<r;o++)a[o]=o;else for(o=0;o<r;o++)a[o]=r-1-o;var s=r,l=[],u=2*s;for(i=0,o=s-1;s>2;){if(0>=u--)return null;var h=o;s<=h&&(h=0),o=h+1,s<=o&&(o=0);var c=o+1;if(s<=c&&(c=0),n(e,h,o,c,s,a)){var d,f,p,m,v;for(d=a[h],f=a[o],p=a[c],l.push(d),l.push(f),l.push(p),i++,m=o,v=o+1;v<s;m++,v++)a[m]=a[v];s--,u=2*s}}return l},o={process:i};return o}),r("Renderer/ConvexPolygonRenderer",["../Utils/Utils","./VectorRenderer","./Program","./FeatureStyle","./VectorRendererManager","../Tiling/Triangulator","./glMatrix"],function(e,t,r,n,i,o){var a=function(e,t){this.layer=e,this.style=new n(t),this.texture=null,this.polygonProgram=null,this.renderer=null,this.mainRenderable=null};a.prototype.isCompatible=function(e){return this.style.strokeColor[0]===e.strokeColor[0]&&this.style.strokeColor[1]===e.strokeColor[1]&&this.style.strokeColor[2]===e.strokeColor[2]&&this.style.fill===e.fill&&this.style.fillTexture===e.fillTexture&&this.style.fillTextureUrl===e.fillTextureUrl&&this.style.fillShader===e.fillShader};var s=function(e){this.bucket=e,this.geometry2vb={},this.vertices=[],this.lineIndices=[],this.triangleIndices=[],this.vertexBuffer=null,this.lineIndexBuffer=null,this.triangleIndexBuffer=null,this.bufferDirty=!1,this.triBufferDirty=!1,this.tcoords=[]};s.prototype.add=function(e){var t,r,n,i=[];if("MultiPolygon"===e.type)for(t=0;t<e.coordinates.length;t++)i.push(e.coordinates[t][0]);else if("LineString"===e.type)i.push(e.coordinates);else if("MultiLineString"===e.type)for(t=0;t<e.coordinates.length;t++)i.push(e.coordinates[t]);else i.push(e.coordinates[0]);for(r=0;r<i.length;r++){var a=i[r],s=a.length,l={vertexStart:this.vertices.length,vertexCount:3*s,lineIndexStart:this.lineIndices.length,lineIndexCount:2*s,triIndexStart:0,triIndexCount:0},u=this.bucket.renderer.planet.coordinateSystem;if(e._imageCoordinates){l.tcoordsStart=this.tcoords.length,l.tcoordsCount=2*s;var h=u.fromGeoTo3D(e._imageCoordinates[0][0]),c=u.fromGeoTo3D(e._imageCoordinates[0][1]),d=u.fromGeoTo3D(e._imageCoordinates[0][3]),f=[];vec3.subtract(c,h,f);var p=[];vec3.subtract(d,h,p);var m=vec3.length(f)*vec3.length(f),v=vec3.length(p)*vec3.length(p);for(t=0;t<s;t++){n=u.fromGeoTo3D(a[t]);var g=[];vec3.subtract(n,h,g);var y=vec3.dot(g,f),x=vec3.dot(g,p),b=y/m,T=x/v;this.tcoords.push(b),this.tcoords.push(T)}}var w=this.vertices.length/3;for(t=0;t<s&&(n=u.fromGeoTo3D(a[t]),this.vertices.push(n[0],n[1],n[2]),"MultiLineString"!==e.type&&"LineString"!==e.type||t!==s-1);t++)this.lineIndices.push(w+t,w+(t+1)%s);if(this.bucket.style.fill){l.triIndexStart=this.triangleIndices.length,l.triIndexCount=3*(s-2);var S=o.process(a);if(null!==S)this.triangleIndices=S;else for(t=0;t<s-2;t++)this.triangleIndices.push(w,w+t+1,w+t+2)}this.geometry2vb[e.gid]?(this.geometry2vb[e.gid].vertexCount+=l.vertexCount,this.geometry2vb[e.gid].lineIndexCount+=l.lineIndexCount,this.geometry2vb[e.gid].triIndexCount+=l.triIndexCount):this.geometry2vb[e.gid]=l,this.bufferDirty=!0,this.triBufferDirty=!0}return!0},s.prototype.remove=function(e){var t;if(this.geometry2vb.hasOwnProperty(e.gid)){var r=this.geometry2vb[e.gid];for(delete this.geometry2vb[e.gid],this.vertices.splice(r.vertexStart,r.vertexCount),t=r.lineIndexStart+r.lineIndexCount;t<this.lineIndices.length;t++)this.lineIndices[t]-=r.vertexCount/3;for(t=r.triIndexStart+r.triIndexCount;t<this.triangleIndices.length;t++)this.triangleIndices[t]-=r.vertexCount/3;this.lineIndices.splice(r.lineIndexStart,r.lineIndexCount),this.triangleIndices.splice(r.triIndexStart,r.triIndexCount),r.tcoordsStart>=0&&this.tcoords.splice(r.tcoordsStart,r.tcoordsCount);for(var n in this.geometry2vb)if(n){var i=this.geometry2vb[n];i.vertexStart>r.vertexStart&&(i.vertexStart-=r.vertexCount,i.lineIndexStart-=r.lineIndexCount,i.triIndexStart-=r.triIndexCount,i.tcoordsStart>=0&&(i.tcoordsStart-=r.tcoordsCount))}this.bufferDirty=!0,this.triBufferDirty=!0}return this.vertices.length},s.prototype.dispose=function(e){this.vertexBuffer&&e.gl.deleteBuffer(this.vertexBuffer),this.lineIndexBuffer&&e.gl.deleteBuffer(this.lineIndexBuffer),this.triangleIndexBuffer&&e.gl.deleteBuffer(this.triangleIndexBuffer),this.tcoordBuffer&&e.gl.deleteBuffer(this.tcoordBuffer)},a.prototype.createRenderable=function(){return new s(this)};var l=function(e){t.prototype.constructor.call(this,e),this.maxTilePerGeometry=2,this.renderContext=e.tileManager.renderContext,this.tileConfig=e.tileManager.tileConfig,this.programs=[],this.basicVertexShader="attribute vec3 vertex;\n",this.basicVertexShader+="uniform mat4 viewProjectionMatrix;\n",this.basicVertexShader+="    \n",this.basicVertexShader+="    void main(void)\n",this.basicVertexShader+="    {\n",this.basicVertexShader+="        gl_Position = viewProjectionMatrix * vec4(vertex, 1.0);\n",this.basicVertexShader+="    }\n",this.basicFragmentShader="precision lowp float; \n",this.basicFragmentShader+="    uniform vec4 color; \n",this.basicFragmentShader+="    \n",this.basicFragmentShader+="    void main(void) \n",this.basicFragmentShader+="    { \n",this.basicFragmentShader+="        gl_FragColor = color; \n",this.basicFragmentShader+="    } \n",this.texVertexShader="attribute vec3 vertex;\n",this.texVertexShader+="    attribute vec2 tcoord;\n",this.texVertexShader+="    uniform mat4 viewProjectionMatrix;\n",this.texVertexShader+="    \n",this.texVertexShader+="    varying vec2 vTextureCoord;\n",this.texVertexShader+="    \n",this.texVertexShader+="    void main(void) \n",this.texVertexShader+="    {\n",this.texVertexShader+="        vTextureCoord = tcoord;\n",this.texVertexShader+="        vTextureCoord.y = 1.0 - vTextureCoord.y; \n",this.texVertexShader+="        gl_Position = viewProjectionMatrix * vec4(vertex, 1.0);\n",this.texVertexShader+="    }\n",this.texFragmentShader="precision lowp float; \n",this.texFragmentShader+="    uniform vec4 color;\n",this.texFragmentShader+="    varying vec2 vTextureCoord;\n",this.texFragmentShader+="    uniform sampler2D texture; \n",this.texFragmentShader+="    void main(void)\n",this.texFragmentShader+="    {\n",this.texFragmentShader+="        gl_FragColor = texture2D(texture, vTextureCoord) * color;\n",this.texFragmentShader+="    }\n",this.basicFillShader={vertexCode:this.basicVertexShader,fragmentCode:this.basicFragmentShader,updateUniforms:null},this.texFillShader={vertexCode:this.texVertexShader,fragmentCode:this.texFragmentShader,updateUniforms:null},this.basicProgram=this.createProgram(this.basicFillShader),this.texProgram=this.createProgram(this.texFillShader);var r=this.renderContext.gl;this.whiteTexture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this.whiteTexture);var n=new Uint8Array([255,255,255,255]);r.texImage2D(r.TEXTURE_2D,0,r.RGBA,1,1,0,r.RGBA,r.UNSIGNED_BYTE,n),this.tcoordBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.tcoordBuffer);var i=[0,0,1,0,1,1,0,1,0,0];r.bufferData(r.ARRAY_BUFFER,new Float32Array(i),r.STATIC_DRAW),this.tcoordBuffer.itemSize=2,this.tcoordBuffer.numItems=5};return e.inherits(t,l),l.prototype.canApply=function(e,t){return!!this.planet.isSky&&("Polygon"===e||"MultiPolygon"===e||"LineString"===e||"MultiLineString"===e)},l.prototype.createProgram=function(e){var t=new r(this.renderContext);return t.createFromSource(e.vertexCode,e.fragmentCode),t.id=this.programs.length,this.programs.push({fillShader:e,program:t}),t},l.prototype.getProgram=function(e){for(var t,r=0;r<this.programs.length;r++)this.programs[r].fillShader===e&&(t=this.programs[r].program);return t||(t=this.createProgram(e)),t},l.prototype.createBucket=function(e,t){var r=this.renderContext.gl,n=(r.createBuffer(),new a(e,t)),i=this;if(t.fill){var o=!1;if(t.fillTextureUrl){var s=new Image;s.crossOrigin="",s.onload=function(){n.texture=i.renderContext.createNonPowerOfTwoTextureFromImage(s,e.invertY)},s.onerror=function(e){console.log("Cannot load "+s.src)},s.src=t.fillTextureUrl,o=!0}else t.fillTexture&&(n.texture=t.fillTexture,o=!0);t.fillShader&&t.fillShader.fragmentCode?(t.fillShader.vertexCode||(t.fillShader.vertexCode=this.texVertexShader),t.fillShader.vertexCode||(t.fillShader.fragmentCode=this.texFragmentShader),n.polygonProgram=this.getProgram(t.fillShader)):n.polygonProgram=o?this.texProgram:this.basicProgram}return n},l.prototype.render=function(e,t,r){var n=this.renderContext,i=this.renderContext.gl;i.disable(i.DEPTH_TEST),i.depthMask(!1),i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),this.basicProgram.apply(),mat4.multiply(n.projectionMatrix,n.viewMatrix,n.modelViewMatrix),i.uniformMatrix4fv(this.basicProgram.uniforms.viewProjectionMatrix,!1,n.modelViewMatrix);for(var o=t;o<r;o++){var a=e[o],s=a.bucket,l=s.style.strokeColor;if(i.uniform4f(this.basicProgram.uniforms.color,l[0],l[1],l[2],l[3]*s.layer.getOpacity()),a.vertexBuffer||(a.vertexBuffer=i.createBuffer(),a.lineIndexBuffer=i.createBuffer()),i.bindBuffer(i.ARRAY_BUFFER,a.vertexBuffer),i.vertexAttribPointer(this.basicProgram.attributes.vertex,3,i.FLOAT,!1,0,0),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,a.lineIndexBuffer),a.bufferDirty&&(i.bufferData(i.ARRAY_BUFFER,new Float32Array(a.vertices),i.STATIC_DRAW),i.bufferData(i.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.lineIndices),i.STATIC_DRAW),a.bufferDirty=!1),i.drawElements(i.LINES,a.lineIndices.length,i.UNSIGNED_SHORT,0),s.polygonProgram){var u=s.polygonProgram;u.apply(),i.uniformMatrix4fv(u.uniforms.viewProjectionMatrix,!1,n.modelViewMatrix),i.uniform1i(u.uniforms.texture,0),a.tcoords.length>0?(a.tcoordBuffer||(a.tcoordBuffer=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,a.tcoordBuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(a.tcoords),i.STATIC_DRAW),a.tcoordBuffer.itemSize=2,a.tcoordBuffer.numItems=a.tcoords.length/2),i.bindBuffer(i.ARRAY_BUFFER,a.tcoordBuffer)):i.bindBuffer(i.ARRAY_BUFFER,this.tcoordBuffer),i.vertexAttribPointer(u.attributes.tcoord,2,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,a.vertexBuffer),i.vertexAttribPointer(u.attributes.vertex,3,i.FLOAT,!1,0,0),s.style.fillShader&&s.style.fillShader.updateUniforms&&s.style.fillShader.updateUniforms(i,a.bucket,u),a.triangleIndexBuffer||(a.triangleIndexBuffer=i.createBuffer()),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,a.triangleIndexBuffer),a.triBufferDirty&&(i.bufferData(i.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.triangleIndices),i.STATIC_DRAW),a.triBufferDirty=!1),i.activeTexture(i.TEXTURE0),a.bucket.texture?(i.bindTexture(i.TEXTURE_2D,a.bucket.texture),i.uniform4f(u.uniforms.color,1,1,1,l[3]*s.layer.getOpacity())):(i.bindTexture(i.TEXTURE_2D,this.whiteTexture),l=a.bucket.style.fillColor,i.uniform4f(u.uniforms.color,l[0],l[1],l[2],l[3]*s.layer.getOpacity())),i.drawElements(i.TRIANGLES,a.triangleIndices.length,i.UNSIGNED_SHORT,0),this.basicProgram.apply()}}i.enable(i.DEPTH_TEST),i.depthMask(!0),i.disable(i.BLEND)},i.factory.push(function(e){return new l(e)}),l}),r("Context/SkyContext",["underscore-min","../Utils/Utils","./BaseContext","../Layer/LayerManager","../Provider/StarProvider","../Provider/ConstellationProvider","../Provider/JsonProvider","../Provider/OpenSearchProvider","../Gui/Tracker/PositionTracker","../Gui/PickingManagerCore","./Sky","./Planet","../Navigation/AstroNavigation","../Renderer/PointSpriteRenderer","../Renderer/ConvexPolygonRenderer"],function(e,t,r,n,i,o,a,s,l,u,h,c,d,f,p){var m=function(e,t){r.prototype.constructor.call(this,e,t),this.parentElement=e,t.canvas?this.canvas=t.canvas:this.canvas=this.parentElement.canvas,this.parentElement.context=this.parentElement.CONTEXT.Sky,this.parentElement.skyContext=this,skyOptions={canvas:this.canvas,tileErrorTreshold:t.tileErrorTreshold||1.5,continuousRendering:t.continuousRendering||!1,renderTileWithoutTexture:t.renderTileWithoutTexture||!1,radius:t.radius||10,minFar:t.minFar||15},t.renderContext&&(skyOptions.renderContext=t.renderContext);try{this.sky=new h(skyOptions)}catch(e){console.log("Erreur creation Sky : ",e),document.getElementById("GlobWebCanvas")&&(document.getElementById("GlobWebCanvas").style.display="none"),document.getElementById("loading")&&(document.getElementById("loading").style.display="none"),document.getElementById("webGLNotAvailable")&&(document.getElementById("webGLNotAvailable").style.display="block")}this.parentElement.scene=this.sky,currentView=this.sky,this.initPlanetEvents(currentView),t.isMobile&&this.initTouchNavigation(t),t.navigation?this.navigation=new d(currentView,t.navigation):this.navigation=new d(currentView,t),this.positionTracker=new l(this,{element:"posTracker",globe:currentView,navigation:this.navigation,isMobile:this.isMobile,positionTracker:t.positionTracker})};return t.inherits(r,m),m.prototype.getAdditionalLayers=function(){return e.filter(n.getLayers("sky"),function(e){return"background"!==e.category})},m.prototype.loadProviders=function(){r.prototype.loadProviders.call(this);var e=new i,t=new o,a=new s;n.registerDataProvider("constellation",t.loadFiles),n.registerDataProvider("star",e.loadFiles),n.registerDataProvider("OpenSearch",function(e,t){a.loadFiles(e,t,1)})},m.prototype.setBackgroundSurvey=function(t){var r,n=this.sky,i=mizar.getLayers("sky");if(r=e.findWhere(i,{name:t})){if(r!==n.baseImagery){n.baseImagery&&n.baseImagery.setVisible(!1),n.setBaseImagery(r),r.setVisible(!0),u.getSelection().length=0;for(var o=0;o<i.length;o++){var a=i[o];if(a.subLayers)for(var s=a.subLayers.length,l=0;l<s;l++){var h=a.subLayers[l];"SolarObjectsSublayer"===h.name&&(u.removePickableLayer(h),n.removeLayer(h),a.subLayers.splice(l,1))}}this.parentElement.publish("backgroundLayer:change",r)}}else this.parentElement.publish("backgroundSurveyError","Survey "+t+" hasn't been found")},m.prototype.setBaseImagery=function(e){this.sky&&this.sky.setBaseImagery(e)},m.prototype.addLayer=function(e){this.sky?this.sky.addLayer(e):console.log("sky is not defined for sky context")},m.prototype.render=function(){this.sky&&this.sky.render()},m.prototype.dispose=function(){this.sky&&this.sky.dispose()},m.prototype.enable=function(){renderers[0].isSky?this.planet.renderContext.renderers[0].enable():renderers[1].isSky&&this.planet.renderContext.renderers[1].enable()},m.prototype.disable=function(){renderers=this.planet.renderContext.renderers,renderers[0].isSky?this.planet.renderContext.renderers[0].disable():renderers[1].isSky&&this.planet.renderContext.renderers[1].disable()},m}),r("Context/ContextFactory",["../Utils/Constantes","./PlanetContext","./SkyContext"],function(e,t,r){var n=function(e){this.parentElement=e};return n.prototype.create=function(t,r){switch(t){case e.CONTEXT.Planet:return this.createPlanet(r);case e.CONTEXT.Sky:return this.createSky(r)}return null},n.prototype.createPlanet=function(e){var r=e||{};r.renderContext=this.parentElement.renderContext;var n=new t(this.parentElement,r);return this.parentElement.renderContext=n.planet.renderContext,n},n.prototype.createSky=function(e){var t=e||{};t.renderContext=this.parentElement.renderContext;var n=new r(this.parentElement,t);return this.parentElement.renderContext=n.sky.renderContext,n},n}),r("Navigation/GoogleMouseNavigationHandler",[],function(){var e=function(e){var t=null,r=-1,n=-1,i=-1,o=!1,a=!1,s=0,l=0,u=null,h=null,c=0,d=function(e){t.planet.publish("startNavigation");var r,n,i;if(r=void 0===e.wheelDelta?e.detail:-e.wheelDelta/120,t.inertia||(i=t.planet.renderContext.getXYRelativeToCanvas(e),n=t.planet.getLonLatFromPixel(i[0],i[1])),t.zoom(r),t.stopAnimations(),t.inertia)t.inertia.launch("zoom",r<0?-1:1);else if(n){var o=t.planet.getPixelFromLonLat(n[0],n[1]),a=i[0]-o[0],s=Math.round(t.planet.renderContext.canvas.width/t.planet.renderContext.canvas.height);s=s<1?1:s,a*=s;var l=i[1]-o[1];t.pan(a,l)}return e.preventDefault&&e.preventDefault(),e.returnValue=!1,t.planet.publish("endNavigation"),t.planet.renderContext.requestFrame(),
!1},f=function(e){if(r=e.button,t.stopAnimations(),n=e.clientX,i=e.clientY,s=0,l=0,1===e.button)t.planet.renderContext.canvas.style.cursor="url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABeUlEQVR42u2XS07DMBCGbaCCQstzy4YDcAGWCAE3YI3omsN0XcSaGxSEWHIBDsCGLY9SykM80m/CFLkhIBycVpVi6ZetUez/S2x5JtYMudkCYJQBbGJ+pBoIgMybQKUoijrW2hnGr+jNFyILQM+8jHkLc0Nv6OeIPflC+AJ8M++1rBA+AD+a/wfCB2Bczdtp5gmIqkK8hwSQt69gcNu3gJ6BRGyB7kG/QlAAOe3rSD5zFeO6cwj3ibVRC52hTmgA2YJJVUUgML5wAFbVXN78RRV0C+TZMVUZLWJ86QCsELsxn3v/oQp6CN02hZYwvnIAloldo2efhQqAAqAAGKl7IL4JpQDpWyA9F8iVHfwmjHMBZnd/yIbzJodcEGdDtInJ0S/1wA7DE5NDNozrATSLtjE7SKmI9hg20b3JoR74qogUYgvThnMIa8SOHfPgFVEaxAbmh5jvMj71Nc8CkISYRmvoHD36mmcFcCFKOhbDgf0XuHOH9mcUrHUBoVXvIfh2krcAAAAASUVORK5CYII=), auto";else{var a=t.planet.renderContext.getXYRelativeToCanvas(e);u=t.planet.getLonLatFromPixel(a[0],a[1]),0===e.button?t.planet.renderContext.canvas.style.cursor="url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKTWlDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVN3WJP3Fj7f92UPVkLY8LGXbIEAIiOsCMgQWaIQkgBhhBASQMWFiApWFBURnEhVxILVCkidiOKgKLhnQYqIWotVXDjuH9yntX167+3t+9f7vOec5/zOec8PgBESJpHmomoAOVKFPDrYH49PSMTJvYACFUjgBCAQ5svCZwXFAADwA3l4fnSwP/wBr28AAgBw1S4kEsfh/4O6UCZXACCRAOAiEucLAZBSAMguVMgUAMgYALBTs2QKAJQAAGx5fEIiAKoNAOz0ST4FANipk9wXANiiHKkIAI0BAJkoRyQCQLsAYFWBUiwCwMIAoKxAIi4EwK4BgFm2MkcCgL0FAHaOWJAPQGAAgJlCLMwAIDgCAEMeE80DIEwDoDDSv+CpX3CFuEgBAMDLlc2XS9IzFLiV0Bp38vDg4iHiwmyxQmEXKRBmCeQinJebIxNI5wNMzgwAABr50cH+OD+Q5+bk4eZm52zv9MWi/mvwbyI+IfHf/ryMAgQAEE7P79pf5eXWA3DHAbB1v2upWwDaVgBo3/ldM9sJoFoK0Hr5i3k4/EAenqFQyDwdHAoLC+0lYqG9MOOLPv8z4W/gi372/EAe/tt68ABxmkCZrcCjg/1xYW52rlKO58sEQjFu9+cj/seFf/2OKdHiNLFcLBWK8ViJuFAiTcd5uVKRRCHJleIS6X8y8R+W/QmTdw0ArIZPwE62B7XLbMB+7gECiw5Y0nYAQH7zLYwaC5EAEGc0Mnn3AACTv/mPQCsBAM2XpOMAALzoGFyolBdMxggAAESggSqwQQcMwRSswA6cwR28wBcCYQZEQAwkwDwQQgbkgBwKoRiWQRlUwDrYBLWwAxqgEZrhELTBMTgN5+ASXIHrcBcGYBiewhi8hgkEQcgIE2EhOogRYo7YIs4IF5mOBCJhSDSSgKQg6YgUUSLFyHKkAqlCapFdSCPyLXIUOY1cQPqQ28ggMor8irxHMZSBslED1AJ1QLmoHxqKxqBz0XQ0D12AlqJr0Rq0Hj2AtqKn0UvodXQAfYqOY4DRMQ5mjNlhXIyHRWCJWBomxxZj5Vg1Vo81Yx1YN3YVG8CeYe8IJAKLgBPsCF6EEMJsgpCQR1hMWEOoJewjtBK6CFcJg4Qxwicik6hPtCV6EvnEeGI6sZBYRqwm7iEeIZ4lXicOE1+TSCQOyZLkTgohJZAySQtJa0jbSC2kU6Q+0hBpnEwm65Btyd7kCLKArCCXkbeQD5BPkvvJw+S3FDrFiOJMCaIkUqSUEko1ZT/lBKWfMkKZoKpRzame1AiqiDqfWkltoHZQL1OHqRM0dZolzZsWQ8ukLaPV0JppZ2n3aC/pdLoJ3YMeRZfQl9Jr6Afp5+mD9HcMDYYNg8dIYigZaxl7GacYtxkvmUymBdOXmchUMNcyG5lnmA+Yb1VYKvYqfBWRyhKVOpVWlX6V56pUVXNVP9V5qgtUq1UPq15WfaZGVbNQ46kJ1Bar1akdVbupNq7OUndSj1DPUV+jvl/9gvpjDbKGhUaghkijVGO3xhmNIRbGMmXxWELWclYD6yxrmE1iW7L57Ex2Bfsbdi97TFNDc6pmrGaRZp3mcc0BDsax4PA52ZxKziHODc57LQMtPy2x1mqtZq1+rTfaetq+2mLtcu0W7eva73VwnUCdLJ31Om0693UJuja6UbqFutt1z+o+02PreekJ9cr1Dund0Uf1bfSj9Rfq79bv0R83MDQINpAZbDE4Y/DMkGPoa5hpuNHwhOGoEctoupHEaKPRSaMnuCbuh2fjNXgXPmasbxxirDTeZdxrPGFiaTLbpMSkxeS+Kc2Ua5pmutG003TMzMgs3KzYrMnsjjnVnGueYb7ZvNv8jYWlRZzFSos2i8eW2pZ8ywWWTZb3rJhWPlZ5VvVW16xJ1lzrLOtt1ldsUBtXmwybOpvLtqitm63Edptt3xTiFI8p0in1U27aMez87ArsmuwG7Tn2YfYl9m32zx3MHBId1jt0O3xydHXMdmxwvOuk4TTDqcSpw+lXZxtnoXOd8zUXpkuQyxKXdpcXU22niqdun3rLleUa7rrStdP1o5u7m9yt2W3U3cw9xX2r+00umxvJXcM970H08PdY4nHM452nm6fC85DnL152Xlle+70eT7OcJp7WMG3I28Rb4L3Le2A6Pj1l+s7pAz7GPgKfep+Hvqa+It89viN+1n6Zfgf8nvs7+sv9j/i/4XnyFvFOBWABwQHlAb2BGoGzA2sDHwSZBKUHNQWNBbsGLww+FUIMCQ1ZH3KTb8AX8hv5YzPcZyya0RXKCJ0VWhv6MMwmTB7WEY6GzwjfEH5vpvlM6cy2CIjgR2yIuB9pGZkX+X0UKSoyqi7qUbRTdHF09yzWrORZ+2e9jvGPqYy5O9tqtnJ2Z6xqbFJsY+ybuIC4qriBeIf4RfGXEnQTJAntieTE2MQ9ieNzAudsmjOc5JpUlnRjruXcorkX5unOy553PFk1WZB8OIWYEpeyP+WDIEJQLxhP5aduTR0T8oSbhU9FvqKNolGxt7hKPJLmnVaV9jjdO31D+miGT0Z1xjMJT1IreZEZkrkj801WRNberM/ZcdktOZSclJyjUg1plrQr1zC3KLdPZisrkw3keeZtyhuTh8r35CP5c/PbFWyFTNGjtFKuUA4WTC+oK3hbGFt4uEi9SFrUM99m/ur5IwuCFny9kLBQuLCz2Lh4WfHgIr9FuxYji1MXdy4xXVK6ZHhp8NJ9y2jLspb9UOJYUlXyannc8o5Sg9KlpUMrglc0lamUycturvRauWMVYZVkVe9ql9VbVn8qF5VfrHCsqK74sEa45uJXTl/VfPV5bdra3kq3yu3rSOuk626s91m/r0q9akHV0IbwDa0b8Y3lG19tSt50oXpq9Y7NtM3KzQM1YTXtW8y2rNvyoTaj9nqdf13LVv2tq7e+2Sba1r/dd3vzDoMdFTve75TsvLUreFdrvUV99W7S7oLdjxpiG7q/5n7duEd3T8Wej3ulewf2Re/ranRvbNyvv7+yCW1SNo0eSDpw5ZuAb9qb7Zp3tXBaKg7CQeXBJ9+mfHvjUOihzsPcw83fmX+39QjrSHkr0jq/dawto22gPaG97+iMo50dXh1Hvrf/fu8x42N1xzWPV56gnSg98fnkgpPjp2Snnp1OPz3Umdx590z8mWtdUV29Z0PPnj8XdO5Mt1/3yfPe549d8Lxw9CL3Ytslt0utPa49R35w/eFIr1tv62X3y+1XPK509E3rO9Hv03/6asDVc9f41y5dn3m978bsG7duJt0cuCW69fh29u0XdwruTNxdeo94r/y+2v3qB/oP6n+0/rFlwG3g+GDAYM/DWQ/vDgmHnv6U/9OH4dJHzEfVI0YjjY+dHx8bDRq98mTOk+GnsqcTz8p+Vv9563Or59/94vtLz1j82PAL+YvPv655qfNy76uprzrHI8cfvM55PfGm/K3O233vuO+638e9H5ko/ED+UPPR+mPHp9BP9z7nfP78L/eE8/sl0p8zAAAABGdBTUEAALGOfPtRkwAAACBjSFJNAAB6JQAAgIMAAPn/AACA6QAAdTAAAOpgAAA6mAAAF2+SX8VGAAAAZUlEQVR42sSTQQrAMAgEHcn/v7w9tYgNNsGW7kkI2TgbRZJ15NbU+waAAFV11MiXz0yq2sxMEiVCDDcHLeky8nQAUDJnM88IuyGOGf/n3wjcQ1zhf+xgxSS+PkXY7aQ9yvy+jccAMs9AI/bwo38AAAAASUVORK5CYII=), auto":t.planet.renderContext.canvas.style.cursor="url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABeUlEQVR42u2XS07DMBCGbaCCQstzy4YDcAGWCAE3YI3omsN0XcSaGxSEWHIBDsCGLY9SykM80m/CFLkhIBycVpVi6ZetUez/S2x5JtYMudkCYJQBbGJ+pBoIgMybQKUoijrW2hnGr+jNFyILQM+8jHkLc0Nv6OeIPflC+AJ8M++1rBA+AD+a/wfCB2Bczdtp5gmIqkK8hwSQt69gcNu3gJ6BRGyB7kG/QlAAOe3rSD5zFeO6cwj3ibVRC52hTmgA2YJJVUUgML5wAFbVXN78RRV0C+TZMVUZLWJ86QCsELsxn3v/oQp6CN02hZYwvnIAloldo2efhQqAAqAAGKl7IL4JpQDpWyA9F8iVHfwmjHMBZnd/yIbzJodcEGdDtInJ0S/1wA7DE5NDNozrATSLtjE7SKmI9hg20b3JoR74qogUYgvThnMIa8SOHfPgFVEaxAbmh5jvMj71Nc8CkISYRmvoHD36mmcFcCFKOhbDgf0XuHOH9mcUrHUBoVXvIfh2krcAAAAASUVORK5CYII=), auto"}return o=!0,!1},p=function(e){return r=-1,!t.inertia||0===s&&0===l||(0===e.button?h?t.inertia.launch("rotate",h,0):t.inertia.launch("pan",s,l):1===e.button&&t.inertia.launch("rotate",-s,-l)),t.planet.renderContext.canvas.style.cursor="url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKTWlDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVN3WJP3Fj7f92UPVkLY8LGXbIEAIiOsCMgQWaIQkgBhhBASQMWFiApWFBURnEhVxILVCkidiOKgKLhnQYqIWotVXDjuH9yntX167+3t+9f7vOec5/zOec8PgBESJpHmomoAOVKFPDrYH49PSMTJvYACFUjgBCAQ5svCZwXFAADwA3l4fnSwP/wBr28AAgBw1S4kEsfh/4O6UCZXACCRAOAiEucLAZBSAMguVMgUAMgYALBTs2QKAJQAAGx5fEIiAKoNAOz0ST4FANipk9wXANiiHKkIAI0BAJkoRyQCQLsAYFWBUiwCwMIAoKxAIi4EwK4BgFm2MkcCgL0FAHaOWJAPQGAAgJlCLMwAIDgCAEMeE80DIEwDoDDSv+CpX3CFuEgBAMDLlc2XS9IzFLiV0Bp38vDg4iHiwmyxQmEXKRBmCeQinJebIxNI5wNMzgwAABr50cH+OD+Q5+bk4eZm52zv9MWi/mvwbyI+IfHf/ryMAgQAEE7P79pf5eXWA3DHAbB1v2upWwDaVgBo3/ldM9sJoFoK0Hr5i3k4/EAenqFQyDwdHAoLC+0lYqG9MOOLPv8z4W/gi372/EAe/tt68ABxmkCZrcCjg/1xYW52rlKO58sEQjFu9+cj/seFf/2OKdHiNLFcLBWK8ViJuFAiTcd5uVKRRCHJleIS6X8y8R+W/QmTdw0ArIZPwE62B7XLbMB+7gECiw5Y0nYAQH7zLYwaC5EAEGc0Mnn3AACTv/mPQCsBAM2XpOMAALzoGFyolBdMxggAAESggSqwQQcMwRSswA6cwR28wBcCYQZEQAwkwDwQQgbkgBwKoRiWQRlUwDrYBLWwAxqgEZrhELTBMTgN5+ASXIHrcBcGYBiewhi8hgkEQcgIE2EhOogRYo7YIs4IF5mOBCJhSDSSgKQg6YgUUSLFyHKkAqlCapFdSCPyLXIUOY1cQPqQ28ggMor8irxHMZSBslED1AJ1QLmoHxqKxqBz0XQ0D12AlqJr0Rq0Hj2AtqKn0UvodXQAfYqOY4DRMQ5mjNlhXIyHRWCJWBomxxZj5Vg1Vo81Yx1YN3YVG8CeYe8IJAKLgBPsCF6EEMJsgpCQR1hMWEOoJewjtBK6CFcJg4Qxwicik6hPtCV6EvnEeGI6sZBYRqwm7iEeIZ4lXicOE1+TSCQOyZLkTgohJZAySQtJa0jbSC2kU6Q+0hBpnEwm65Btyd7kCLKArCCXkbeQD5BPkvvJw+S3FDrFiOJMCaIkUqSUEko1ZT/lBKWfMkKZoKpRzame1AiqiDqfWkltoHZQL1OHqRM0dZolzZsWQ8ukLaPV0JppZ2n3aC/pdLoJ3YMeRZfQl9Jr6Afp5+mD9HcMDYYNg8dIYigZaxl7GacYtxkvmUymBdOXmchUMNcyG5lnmA+Yb1VYKvYqfBWRyhKVOpVWlX6V56pUVXNVP9V5qgtUq1UPq15WfaZGVbNQ46kJ1Bar1akdVbupNq7OUndSj1DPUV+jvl/9gvpjDbKGhUaghkijVGO3xhmNIRbGMmXxWELWclYD6yxrmE1iW7L57Ex2Bfsbdi97TFNDc6pmrGaRZp3mcc0BDsax4PA52ZxKziHODc57LQMtPy2x1mqtZq1+rTfaetq+2mLtcu0W7eva73VwnUCdLJ31Om0693UJuja6UbqFutt1z+o+02PreekJ9cr1Dund0Uf1bfSj9Rfq79bv0R83MDQINpAZbDE4Y/DMkGPoa5hpuNHwhOGoEctoupHEaKPRSaMnuCbuh2fjNXgXPmasbxxirDTeZdxrPGFiaTLbpMSkxeS+Kc2Ua5pmutG003TMzMgs3KzYrMnsjjnVnGueYb7ZvNv8jYWlRZzFSos2i8eW2pZ8ywWWTZb3rJhWPlZ5VvVW16xJ1lzrLOtt1ldsUBtXmwybOpvLtqitm63Edptt3xTiFI8p0in1U27aMez87ArsmuwG7Tn2YfYl9m32zx3MHBId1jt0O3xydHXMdmxwvOuk4TTDqcSpw+lXZxtnoXOd8zUXpkuQyxKXdpcXU22niqdun3rLleUa7rrStdP1o5u7m9yt2W3U3cw9xX2r+00umxvJXcM970H08PdY4nHM452nm6fC85DnL152Xlle+70eT7OcJp7WMG3I28Rb4L3Le2A6Pj1l+s7pAz7GPgKfep+Hvqa+It89viN+1n6Zfgf8nvs7+sv9j/i/4XnyFvFOBWABwQHlAb2BGoGzA2sDHwSZBKUHNQWNBbsGLww+FUIMCQ1ZH3KTb8AX8hv5YzPcZyya0RXKCJ0VWhv6MMwmTB7WEY6GzwjfEH5vpvlM6cy2CIjgR2yIuB9pGZkX+X0UKSoyqi7qUbRTdHF09yzWrORZ+2e9jvGPqYy5O9tqtnJ2Z6xqbFJsY+ybuIC4qriBeIf4RfGXEnQTJAntieTE2MQ9ieNzAudsmjOc5JpUlnRjruXcorkX5unOy553PFk1WZB8OIWYEpeyP+WDIEJQLxhP5aduTR0T8oSbhU9FvqKNolGxt7hKPJLmnVaV9jjdO31D+miGT0Z1xjMJT1IreZEZkrkj801WRNberM/ZcdktOZSclJyjUg1plrQr1zC3KLdPZisrkw3keeZtyhuTh8r35CP5c/PbFWyFTNGjtFKuUA4WTC+oK3hbGFt4uEi9SFrUM99m/ur5IwuCFny9kLBQuLCz2Lh4WfHgIr9FuxYji1MXdy4xXVK6ZHhp8NJ9y2jLspb9UOJYUlXyannc8o5Sg9KlpUMrglc0lamUycturvRauWMVYZVkVe9ql9VbVn8qF5VfrHCsqK74sEa45uJXTl/VfPV5bdra3kq3yu3rSOuk626s91m/r0q9akHV0IbwDa0b8Y3lG19tSt50oXpq9Y7NtM3KzQM1YTXtW8y2rNvyoTaj9nqdf13LVv2tq7e+2Sba1r/dd3vzDoMdFTve75TsvLUreFdrvUV99W7S7oLdjxpiG7q/5n7duEd3T8Wej3ulewf2Re/ranRvbNyvv7+yCW1SNo0eSDpw5ZuAb9qb7Zp3tXBaKg7CQeXBJ9+mfHvjUOihzsPcw83fmX+39QjrSHkr0jq/dawto22gPaG97+iMo50dXh1Hvrf/fu8x42N1xzWPV56gnSg98fnkgpPjp2Snnp1OPz3Umdx590z8mWtdUV29Z0PPnj8XdO5Mt1/3yfPe549d8Lxw9CL3Ytslt0utPa49R35w/eFIr1tv62X3y+1XPK509E3rO9Hv03/6asDVc9f41y5dn3m978bsG7duJt0cuCW69fh29u0XdwruTNxdeo94r/y+2v3qB/oP6n+0/rFlwG3g+GDAYM/DWQ/vDgmHnv6U/9OH4dJHzEfVI0YjjY+dHx8bDRq98mTOk+GnsqcTz8p+Vv9563Or59/94vtLz1j82PAL+YvPv655qfNy76uprzrHI8cfvM55PfGm/K3O233vuO+638e9H5ko/ED+UPPR+mPHp9BP9z7nfP78L/eE8/sl0p8zAAAABGdBTUEAALGOfPtRkwAAACBjSFJNAAB6JQAAgIMAAPn/AACA6QAAdTAAAOpgAAA6mAAAF2+SX8VGAAAAjElEQVR42pyRQRLAIAwCoePD8vT8jB7aONHRVuWagBuku2MmMxMAuDtnO2VmMDNJAgCQVOz0YSWbR4ZQnuWQC4cK2pLRSEoSJIHkp/nd0RFBnFMJUnkgiaAYGXrxmdeCfg2NmWxLXDWG2d15veUdhdRv7EO2A3YV+E3AKUVDsBKSXx+esEvC3dZ73QMAeuphLLn/cTIAAAAASUVORK5CYII=), auto",u=null,c=0,a&&t.planet.publish("endNavigation"),o=!1,a=!1,!1},m=function(e){if(!(r<0)&&(s=e.clientX-n,l=e.clientY-i,0!==s||0!==l)){var d,f,p,m=!1;if(0===r)o&&(t.planet.publish("startNavigation"),o=!1,a=!0),f=t.planet.renderContext.getXYRelativeToCanvas(e),u&&(h=null,d=t.planet.getLonLatFromPixel(f[0],f[1]),d&&(p=t.planet.getPixelFromLonLat(u[0],u[1]),s=f[0]-p[0],l=f[1]-p[1],t.pan(s,l))),u&&d||(h=Math.abs(s)>Math.abs(l)?f[1]>t.planet.renderContext.canvas.height/2?-s:s:f[0]>t.planet.renderContext.canvas.width/2?l:-l,t.rotate(h,0),f=t.planet.renderContext.getXYRelativeToCanvas(e),u=t.planet.getLonLatFromPixel(f[0],f[1]),u&&(h=null)),t.planet.renderContext.requestFrame(),m=!0;else if(1===r)t.rotate(-s,-l),t.planet.renderContext.requestFrame(),m=!0;else{if(c++,c%3===0&&c>1){if(t.planet.publish("startNavigation"),t.zoom(-l/10),l>0&&l>s&&u){f=[t.planet.renderContext.canvas.clientLeft+t.planet.renderContext.canvas.clientWidth/2,t.planet.renderContext.canvas.clientTop+t.planet.renderContext.canvas.clientHeight/2],p=t.planet.getPixelFromLonLat(u[0],u[1]);var v=f[0]-p[0];v=10*v/100;var g=f[1]-p[1];g=10*g/100,t.pan(v,g)}t.stopAnimations(),t.planet.publish("endNavigation"),t.planet.renderContext.requestFrame()}m=!0}return n=e.clientX,i=e.clientY,m}},v=function(e){if(0===e.button){var r=t.planet.renderContext.getXYRelativeToCanvas(e),n=t.planet.getLonLatFromPixel(r[0],r[1]);n&&t.zoomTo(n)}},g=function(e){return e.preventDefault(),!1};this.install=function(e){t=e;var r=t.renderContext.canvas;r.style.cursor="url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKTWlDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVN3WJP3Fj7f92UPVkLY8LGXbIEAIiOsCMgQWaIQkgBhhBASQMWFiApWFBURnEhVxILVCkidiOKgKLhnQYqIWotVXDjuH9yntX167+3t+9f7vOec5/zOec8PgBESJpHmomoAOVKFPDrYH49PSMTJvYACFUjgBCAQ5svCZwXFAADwA3l4fnSwP/wBr28AAgBw1S4kEsfh/4O6UCZXACCRAOAiEucLAZBSAMguVMgUAMgYALBTs2QKAJQAAGx5fEIiAKoNAOz0ST4FANipk9wXANiiHKkIAI0BAJkoRyQCQLsAYFWBUiwCwMIAoKxAIi4EwK4BgFm2MkcCgL0FAHaOWJAPQGAAgJlCLMwAIDgCAEMeE80DIEwDoDDSv+CpX3CFuEgBAMDLlc2XS9IzFLiV0Bp38vDg4iHiwmyxQmEXKRBmCeQinJebIxNI5wNMzgwAABr50cH+OD+Q5+bk4eZm52zv9MWi/mvwbyI+IfHf/ryMAgQAEE7P79pf5eXWA3DHAbB1v2upWwDaVgBo3/ldM9sJoFoK0Hr5i3k4/EAenqFQyDwdHAoLC+0lYqG9MOOLPv8z4W/gi372/EAe/tt68ABxmkCZrcCjg/1xYW52rlKO58sEQjFu9+cj/seFf/2OKdHiNLFcLBWK8ViJuFAiTcd5uVKRRCHJleIS6X8y8R+W/QmTdw0ArIZPwE62B7XLbMB+7gECiw5Y0nYAQH7zLYwaC5EAEGc0Mnn3AACTv/mPQCsBAM2XpOMAALzoGFyolBdMxggAAESggSqwQQcMwRSswA6cwR28wBcCYQZEQAwkwDwQQgbkgBwKoRiWQRlUwDrYBLWwAxqgEZrhELTBMTgN5+ASXIHrcBcGYBiewhi8hgkEQcgIE2EhOogRYo7YIs4IF5mOBCJhSDSSgKQg6YgUUSLFyHKkAqlCapFdSCPyLXIUOY1cQPqQ28ggMor8irxHMZSBslED1AJ1QLmoHxqKxqBz0XQ0D12AlqJr0Rq0Hj2AtqKn0UvodXQAfYqOY4DRMQ5mjNlhXIyHRWCJWBomxxZj5Vg1Vo81Yx1YN3YVG8CeYe8IJAKLgBPsCF6EEMJsgpCQR1hMWEOoJewjtBK6CFcJg4Qxwicik6hPtCV6EvnEeGI6sZBYRqwm7iEeIZ4lXicOE1+TSCQOyZLkTgohJZAySQtJa0jbSC2kU6Q+0hBpnEwm65Btyd7kCLKArCCXkbeQD5BPkvvJw+S3FDrFiOJMCaIkUqSUEko1ZT/lBKWfMkKZoKpRzame1AiqiDqfWkltoHZQL1OHqRM0dZolzZsWQ8ukLaPV0JppZ2n3aC/pdLoJ3YMeRZfQl9Jr6Afp5+mD9HcMDYYNg8dIYigZaxl7GacYtxkvmUymBdOXmchUMNcyG5lnmA+Yb1VYKvYqfBWRyhKVOpVWlX6V56pUVXNVP9V5qgtUq1UPq15WfaZGVbNQ46kJ1Bar1akdVbupNq7OUndSj1DPUV+jvl/9gvpjDbKGhUaghkijVGO3xhmNIRbGMmXxWELWclYD6yxrmE1iW7L57Ex2Bfsbdi97TFNDc6pmrGaRZp3mcc0BDsax4PA52ZxKziHODc57LQMtPy2x1mqtZq1+rTfaetq+2mLtcu0W7eva73VwnUCdLJ31Om0693UJuja6UbqFutt1z+o+02PreekJ9cr1Dund0Uf1bfSj9Rfq79bv0R83MDQINpAZbDE4Y/DMkGPoa5hpuNHwhOGoEctoupHEaKPRSaMnuCbuh2fjNXgXPmasbxxirDTeZdxrPGFiaTLbpMSkxeS+Kc2Ua5pmutG003TMzMgs3KzYrMnsjjnVnGueYb7ZvNv8jYWlRZzFSos2i8eW2pZ8ywWWTZb3rJhWPlZ5VvVW16xJ1lzrLOtt1ldsUBtXmwybOpvLtqitm63Edptt3xTiFI8p0in1U27aMez87ArsmuwG7Tn2YfYl9m32zx3MHBId1jt0O3xydHXMdmxwvOuk4TTDqcSpw+lXZxtnoXOd8zUXpkuQyxKXdpcXU22niqdun3rLleUa7rrStdP1o5u7m9yt2W3U3cw9xX2r+00umxvJXcM970H08PdY4nHM452nm6fC85DnL152Xlle+70eT7OcJp7WMG3I28Rb4L3Le2A6Pj1l+s7pAz7GPgKfep+Hvqa+It89viN+1n6Zfgf8nvs7+sv9j/i/4XnyFvFOBWABwQHlAb2BGoGzA2sDHwSZBKUHNQWNBbsGLww+FUIMCQ1ZH3KTb8AX8hv5YzPcZyya0RXKCJ0VWhv6MMwmTB7WEY6GzwjfEH5vpvlM6cy2CIjgR2yIuB9pGZkX+X0UKSoyqi7qUbRTdHF09yzWrORZ+2e9jvGPqYy5O9tqtnJ2Z6xqbFJsY+ybuIC4qriBeIf4RfGXEnQTJAntieTE2MQ9ieNzAudsmjOc5JpUlnRjruXcorkX5unOy553PFk1WZB8OIWYEpeyP+WDIEJQLxhP5aduTR0T8oSbhU9FvqKNolGxt7hKPJLmnVaV9jjdO31D+miGT0Z1xjMJT1IreZEZkrkj801WRNberM/ZcdktOZSclJyjUg1plrQr1zC3KLdPZisrkw3keeZtyhuTh8r35CP5c/PbFWyFTNGjtFKuUA4WTC+oK3hbGFt4uEi9SFrUM99m/ur5IwuCFny9kLBQuLCz2Lh4WfHgIr9FuxYji1MXdy4xXVK6ZHhp8NJ9y2jLspb9UOJYUlXyannc8o5Sg9KlpUMrglc0lamUycturvRauWMVYZVkVe9ql9VbVn8qF5VfrHCsqK74sEa45uJXTl/VfPV5bdra3kq3yu3rSOuk626s91m/r0q9akHV0IbwDa0b8Y3lG19tSt50oXpq9Y7NtM3KzQM1YTXtW8y2rNvyoTaj9nqdf13LVv2tq7e+2Sba1r/dd3vzDoMdFTve75TsvLUreFdrvUV99W7S7oLdjxpiG7q/5n7duEd3T8Wej3ulewf2Re/ranRvbNyvv7+yCW1SNo0eSDpw5ZuAb9qb7Zp3tXBaKg7CQeXBJ9+mfHvjUOihzsPcw83fmX+39QjrSHkr0jq/dawto22gPaG97+iMo50dXh1Hvrf/fu8x42N1xzWPV56gnSg98fnkgpPjp2Snnp1OPz3Umdx590z8mWtdUV29Z0PPnj8XdO5Mt1/3yfPe549d8Lxw9CL3Ytslt0utPa49R35w/eFIr1tv62X3y+1XPK509E3rO9Hv03/6asDVc9f41y5dn3m978bsG7duJt0cuCW69fh29u0XdwruTNxdeo94r/y+2v3qB/oP6n+0/rFlwG3g+GDAYM/DWQ/vDgmHnv6U/9OH4dJHzEfVI0YjjY+dHx8bDRq98mTOk+GnsqcTz8p+Vv9563Or59/94vtLz1j82PAL+YvPv655qfNy76uprzrHI8cfvM55PfGm/K3O233vuO+638e9H5ko/ED+UPPR+mPHp9BP9z7nfP78L/eE8/sl0p8zAAAABGdBTUEAALGOfPtRkwAAACBjSFJNAAB6JQAAgIMAAPn/AACA6QAAdTAAAOpgAAA6mAAAF2+SX8VGAAAAjElEQVR42pyRQRLAIAwCoePD8vT8jB7aONHRVuWagBuku2MmMxMAuDtnO2VmMDNJAgCQVOz0YSWbR4ZQnuWQC4cK2pLRSEoSJIHkp/nd0RFBnFMJUnkgiaAYGXrxmdeCfg2NmWxLXDWG2d15veUdhdRv7EO2A3YV+E3AKUVDsBKSXx+esEvC3dZ73QMAeuphLLn/cTIAAAAASUVORK5CYII=), auto",r.addEventListener("mousedown",f),document.addEventListener("mouseup",p),r.addEventListener("mousemove",m),r.addEventListener("contextmenu",g),r.addEventListener("dblclick",v),r.addEventListener("DOMMouseScroll",d),r.addEventListener("mousewheel",d)},this.uninstall=function(){var e=t.renderContext.canvas;e.style.cursor="auto",e.removeEventListener("mousedown",f),document.removeEventListener("mouseup",p),e.removeEventListener("mousemove",m),e.removeEventListener("contextmenu",g),e.removeEventListener("dblclick",v),e.removeEventListener("DOMMouseScroll",d),e.removeEventListener("mousewheel",d)}};return e}),r("Navigation/NavigationFactory",["./Navigation","./AstroNavigation","./FlatNavigation","./GoogleMouseNavigationHandler","./KeyboardNavigationHandler"],function(e,t,r,n,i){var o=function(){};return o.prototype.createPlanete=function(t,r){return planetNavigation=new e(t),planetNavigation},o.prototype.createAstro=function(e,r){return astroNavigation=new t(e,r),astroNavigation},o.prototype.createFlat=function(e,t){return flatNavigation=new r(e,t),flatNavigation},o.prototype.createGoogleMouseHandler=function(){return handler=new n,handler},o.prototype.createKeyboardHandler=function(){return handler=new i,handler},o}),r("Animation/PathAnimation",["../Utils/Utils","./Animation","../Utils/Numeric"],function(e,t,r){var n=function(e){var r,n,i,o,a,s,l,u;for(t.prototype.constructor.call(this),this.planet=e.planet,this.speed=e.speed*this.planet.coordinateSystem.geoide.heightScale/1e3,this.nodes=[],r=0;r<e.coords.length;r++)l={position:this.planet.coordinateSystem.fromGeoTo3D(e.coords[r]),velocity:null,distance:0},this.nodes.push(l),r>0&&(o=this.nodes[r].position[0]-this.nodes[r-1].position[0],a=this.nodes[r].position[1]-this.nodes[r-1].position[1],s=this.nodes[r].position[2]-this.nodes[r-1].position[2],this.nodes[r-1].distance=Math.sqrt(o*o+a*a+s*s));for(r=1;r<e.coords.length-1;r++)n=vec3.subtract(this.nodes[r+1].position,this.nodes[r].position,vec3.create()),i=vec3.subtract(this.nodes[r-1].position,this.nodes[r].position,vec3.create()),vec3.normalize(n),vec3.normalize(i),this.nodes[r].velocity=vec3.subtract(n,i,vec3.create()),vec3.normalize(this.nodes[r].velocity);u=vec3.subtract(this.nodes[1].position,this.nodes[0].position,vec3.create()),vec3.scale(u,3/this.nodes[0].distance),this.nodes[0].velocity=vec3.subtract(u,this.nodes[1].velocity,vec3.create()),vec3.scale(this.nodes[0].velocity,.5),r=e.coords.length-1,u=vec3.subtract(this.nodes[r].position,this.nodes[r-1].position,vec3.create()),vec3.scale(u,3/this.nodes[r-1].distance),this.nodes[r].velocity=vec3.subtract(u,this.nodes[r-1].velocity,vec3.create()),vec3.scale(this.nodes[r].velocity,.5),this.index=0,this.currentDistance=0,this.previousTime=-1,this.currentDirection=[],this.centerOffset=-.2,this.altitudeOffset=1e3;var h=this;e.setter?this.valueSetter=e.setter:this.valueSetter=function(t,r){var n,i=vec3.normalize(t,vec3.create());if(e.planet){var o=e.planet.coordinateSystem.from3DToGeo(t);o[2]=e.planet.getElevation(o[0],o[1])+h.altitudeOffset,n=e.planet.coordinateSystem.fromGeoTo3D(o)}else n=t,n[2]+=h.altitudeOffset;var a=vec3.normalize(r,vec3.create()),s=vec3.add(n,a,vec3.create());vec3.add(s,vec3.scale(i,h.centerOffset,vec3.create())),mat4.lookAt(n,s,i,h.renderContext.viewMatrix)}};return e.inherits(t,n),n.prototype.setSpeed=function(e){this.speed=parseFloat(e)*this.planet.coordinateSystem.geoide.heightScale/1e3},n.prototype.getSpeed=function(){return this.speed/(this.planet.coordinateSystem.geoide.heightScale/1e3)},n.prototype.setAltitudeOffset=function(e){this.altitudeOffset=parseFloat(e)},n.prototype.getAltitudeOffset=function(){return this.altitudeOffset},n.prototype.setDirectionAngle=function(e){this.centerOffset=Math.tan(parseFloat(e)*Math.PI/180)},n.prototype.start=function(){var e=-1;this.pauseTime!==-1&&(e=this.startTime),t.prototype.start.call(this),e!==-1?this.previousTime+=this.startTime-e:this.previousTime=-1},n.prototype.update=function(e){for(this.previousTime===-1?(this.index=0,this.currentDistance=0):this.currentDistance+=(e-this.previousTime)*this.speed,this.previousTime=e;this.currentDistance>=this.nodes[this.index].distance&&this.index<this.nodes.length-1;)this.currentDistance-=this.nodes[this.index].distance,this.index=this.index+1;if(this.index<this.nodes.length-1){var t=this.currentDistance/this.nodes[this.index].distance,n=this.nodes[this.index].position,i=this.nodes[this.index+1].position,o=vec3.scale(this.nodes[this.index].velocity,this.nodes[this.index].distance,vec3.create()),a=vec3.scale(this.nodes[this.index+1].velocity,this.nodes[this.index].distance,vec3.create()),s=r.cubicInterpolation(t,n,o,i,a),l=r.cubicInterpolationDerivative(t,n,o,i,a);this.valueSetter(s,l)}else this.index===this.nodes.length-1?this.valueSetter(this.nodes[this.index].position,this.nodes[this.index].velocity):this.stop()},n}),r("Animation/AnimationFactory",["./SegmentedAnimation","./PathAnimation"],function(e,t){var r=function(){};return r.prototype.createSegmented=function(t,r){return segmented=new e(t,r),segmented},r.prototype.createPath=function(e){return path=new t(e),path},r}),r("Parser/KMLParser",["../Renderer/FeatureStyle"],function(e){var t=function(){var t={type:"FeatureCollection",features:[]},r={},n=/^(\w{2})(\w{2})(\w{2})(\w{2})$/,i=function(e){var t=n.exec(e);return t?[parseInt(t[4],16)/255,parseInt(t[3],16)/255,parseInt(t[2],16)/255,parseInt(t[1],16)/255]:[1,1,1,1]},o=function(e){for(var t=[],r=e.trim().split(/[\s,]+/),n=0;n<r.length;n+=3)t.push([parseFloat(r[n]),parseFloat(r[n+1]),parseFloat(r[n+2])]);return t},a=function(e,t){var r,n,i;switch(e.nodeName){case"MultiGeometry":for(var s=[],l=e.childNodes,u=0;u<l.length;u++){var h=a(l[u],t);h&&s.push(h)}return{type:"GeometryCollection",geometries:s};break;case"LineString":if(i=e.getElementsByTagName("coordinates"),1===i.length)return{type:"LineString",coordinates:o(i[0].textContent)};break;case"Polygon":if(r=e.getElementsByTagName("extrude"),1===r.length&&(t.extrude=0!==parseInt(r[0].childNodes[0].nodeValue)),t&&(t.fill=!0),n=e.getElementsByTagName("outerBoundaryIs"),i=n[0].getElementsByTagName("coordinates"),1===i.length)return{type:"Polygon",coordinates:[o(i[0].textContent)]};break;case"Point":if(i=e.getElementsByTagName("coordinates"),1===i.length){var c=i[0].textContent.split(",");return{type:"Point",coordinates:[parseFloat(c[0]),parseFloat(c[1])]}}}return null},s=function(e,t){for(var r=e.firstElementChild;r;){switch(r.nodeName){case"color":t.fillColor=i(r.childNodes[0].nodeValue)}r=r.nextElementSibling}},l=function(e,t){for(var r=e.firstElementChild;r;){switch(r.nodeName){case"color":t.strokeColor=i(r.childNodes[0].nodeValue);break;case"width":t.strokeWidth=parseFloat(r.childNodes[0].nodeValue)}r=r.nextElementSibling}},u=function(e,t){for(var r=e.firstElementChild;r;){switch(r.nodeName){case"color":break;case"Icon":r.firstElementChild?t.iconUrl=r.firstElementChild.childNodes[0].nodeValue:t.iconUrl=null}r=r.nextElementSibling}},h=function(e,t){for(var r=e.firstElementChild;r;){switch(r.nodeName){case"color":var n=i(r.textContent.trim());0===n[3]&&(t.label=null,t.textColor=n)}r=r.nextElementSibling}},c=function(t,n){var i="#"+t.getAttribute("id"),o=new e(n);r[i]=o;for(var a=t.firstElementChild;a;){switch(a.nodeName){case"PolyStyle":s(a,o);break;case"LineStyle":l(a,o);break;case"IconStyle":u(a,o);break;case"LabelStyle":h(a,o)}a=a.nextElementSibling}return o},d=function(n){for(var i,o,s={type:"Feature",properties:{},geometry:null},l=!1,u=n.firstElementChild;u;){switch(u.nodeName){case"name":s.properties.name=u.childNodes[0].nodeValue;break;case"styleUrl":o=u.childNodes[0].nodeValue,r.hasOwnProperty(o)&&(s.properties.style=r[o],l=!0);break;case"Style":i=c(u,s.properties.name,s.properties.style),i&&(s.properties.style=i);break;default:null===s.geometry&&(s.geometry=a(u,i))}u=u.nextElementSibling}s.geometry&&(i=s.properties.style,i&&i.textColor[3]>0&&"Point"===s.geometry.type&&(l&&(i=s.properties.style=new e(i)),i.label=s.properties.name),t.features.push(s))},f=function(e){for(var t,r=e.firstElementChild;r;){switch(r.nodeName){case"visibility":if(t=parseInt(r.textContent),0===t)return;break;case"Style":c(r);break;default:p(r)}r=r.nextElementSibling}},p=function(e){switch(e.nodeName){case"Style":c(e);break;case"Placemark":d(e);break;case"Document":case"Folder":f(e)}},m=function(e){for(var r=e.documentElement,n=r.firstElementChild;n;)p(n),n=n.nextElementSibling;return t};return{parse:m}}();return t}),r("Parser/ParserFactory",["./KMLParser"],function(e){var t=function(){};return t.prototype.getKML=function(){return e},t}),r("UtilityFactory",["./Renderer/BoundingBox","./Renderer/GeoBound"],function(e,t){var r=function(){};return r.prototype.createBoundingBox=function(e,t){return new BoundingBox(e,t)},r.prototype.createGeoBound=function(e,r,n,i){return new t(e,r,n,i)},r}),r("Gui/CompassCore",["jquery"],function(e){function t(e){var t=[0,0,1],r=a.coordinateSystem,n=[];r.from3DToEquatorial(t,n,!1),n=r.convert(n,r.type,"EQ"),r.fromEquatorialTo3D(n,t,!1),s.moveUpTo(t)}function r(){var e=[],t=a.coordinateSystem;t.from3DToEquatorial(s.center3d,e,!1),e=t.convert(e,"EQ",t.type);var r=[];t.getLHVTransform(e,r);var n=[],o=[r[4],r[5],r[6]],l=[r[8],r[9],r[10]],u=vec3.create(s.up);t.from3DToEquatorial(u,n,!1),n=t.convert(n,"EQ",t.type),t.fromEquatorialTo3D(n,u,!1),vec3.normalize(u);var h=vec3.dot(u,o)/(vec3.length(u)*vec3.length(o)),c=Math.acos(h);if(!isNaN(c)){var d,f=180*c/Math.PI;vec3.cross(u,o,n),d=vec3.dot(n,[l[0],l[1],l[2]]),d<0&&(f*=-1);var p=i.getElementById("NorthText");p.setAttribute("transform","rotate("+f+" 40 40)")}}function n(){s.unsubscribe("modified",r),document.getElementById(o).innerHTML=""}var i,o=null,a=null,s=null;return{init:function(e){o=e.element,a=e.planet,s=e.navigation,i=e.svgDoc},updateNorth:r,_alignWithNorth:t,remove:n}}),r("Gui/Compass",["jquery","./CompassCore"],function(e,t){var r,n=null,i=null,o=null,a=function(a){n=a.element,i=a.planet,o=a.navigation,document.getElementById(n).innerHTML='<div id="objectCompass"></div>',e.get(a.mizarBaseUrl+"css/images/compass.svg",function(i){r=document.importNode(i.documentElement,!0),r.height.baseVal.value=100,r.width.baseVal.value=100,e("#objectCompass").append(r),a.svgDoc=r,t.init(a),s(),o.publish("modified"),e("#"+n).css("display","block")},"xml");var s=function(){var e=r.getElementById("East"),n=r.getElementById("West"),i=r.getElementById("South"),s=r.getElementById("North"),l=r.getElementById("NorthText"),u=r.getElementById("OuterCircle"),h=a.panFactor?a.panFactor:30,c=-1,d=-1,f=0,p=0,m=!1,v=u.ownerSVGElement.clientWidth/2,g=function(e){e.preventDefault(),e.type.search("touch")>=0&&(e.layerX=e.changedTouches[0].clientX,e.layerY=e.changedTouches[0].clientY),m=!0,c=e.layerX-v,d=e.layerY-v,f=0,p=0};r.addEventListener("mousedown",g);var y=function(e){if(e.preventDefault(),e.type.search("touch")>=0&&(e.layerX=e.changedTouches[0].clientX,e.layerY=e.changedTouches[0].clientY),m){var r=c*(e.layerY-v)-d*(e.layerX-v);o.rotate(r,0),c=e.layerX-v,d=e.layerY-v,t.updateNorth()}};r.addEventListener("mousemove",y);var x=function(e){e.preventDefault(),m=!1};r.addEventListener("mouseup",x),e.addEventListener("click",function(){o.pan(h,0),t.updateNorth()}),n.addEventListener("click",function(){o.pan(-h,0),t.updateNorth()}),s.addEventListener("click",function(){o.pan(0,h),t.updateNorth()}),i.addEventListener("click",function(){o.pan(0,-h),t.updateNorth()}),l.addEventListener("click",t._alignWithNorth),a.isMobile&&(r.addEventListener("touchstart",g),r.addEventListener("touchup",x),r.addEventListener("touchmove",y),l.addEventListener("touchstart",t._alignWithNorth)),o.subscribe("modified",t.updateNorth,l)}};return a.prototype.remove=t.remove,a}),r("Utils/ToolBox",["wcs","underscore-min","../Layer/OpenSearchLayer","../Layer/HipsFitsLayer","../Layer/HipsLayer","../Layer/PlanetLayer","../Layer/VectorLayer","../Layer/MocLayer"],function(e,t,r,n,i,o,a,s){var l=function(e,t){this.parentElement=e,t.votable2geojson&&(this.votable2geojsonUrl=t.votable2geojson.baseUrl)};return l.prototype.hsv_to_rgb=function(e,t,r){var n,i,o,a=Math.floor(6*e),s=6*e-a,l=r*(1-t),u=r*(1-s*t),h=r*(1-(1-s)*t);switch(a){case 0:n=r,i=h,o=l;break;case 1:n=u,i=r,o=l;break;case 2:n=l,i=r,o=h;break;case 3:n=l,i=u,o=r;break;case 4:n=h,i=l,o=r;break;case 5:n=r,i=l,o=u;break;default:n=1,i=1,o=1}return[n,i,o]},l.prototype.createCoordinate=function(t,r){var n=e.pixelToCoordinate([t,r]);return n.ra>180&&(n.ra-=360),[n.ra,n.dec]},l.prototype.roundNumber=function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)},l.prototype.generateColor=function(){var e=.618033988749895,t=Math.random();return t+=e,t%=1,hsv_to_rgb(t,.5,.95)},l.prototype.formatCoordinates=function(e){var t=[];switch(this.parentElement.context){case"Planet":t[0]=this.roundNumber(e[0],3),t[0]+="&deg;",t[1]=this.roundNumber(e[1],3),t[1]+="&deg;";break;case"Sky":"EQ"===this.parentElement.scene.coordinateSystem.type?this.parentElement.scene.coordinateSystem.fromGeoToEquatorial([e[0],e[1]],t):(e=this.parentElement.scene.coordinateSystem.convert(e,"EQ",this.parentElement.scene.coordinateSystem.type),t[0]=this.roundNumber(e[0],4),t[0]+="&deg;",t[1]=this.roundNumber(e[1],4),t[1]+="&deg;");break;default:console.error("This mode "+this.parentElement.mode+" is not supported")}return t},l.prototype.formatId=function(e){return e.replace(/\s{1,}|\.{1,}|\[{1,}|\]{1,}|\({1,}|\){1,}|\~{1,}|\+{1,}|\°{1,}|\-{1,}|\'{1,}|\"{1,}/g,"")},l.prototype.getPolygonCoordinatesFromFits=function(t){var r=t.getHDU(),n=r.data;e=new WCS.Mapper(r.header);var i=[];return i.push(createCoordinate(0,n.height)),i.push(createCoordinate(n.width,n.height)),i.push(createCoordinate(n.width,0)),i.push(createCoordinate(0,0)),i.push(i[0]),i},l.prototype.computeGeometryBarycenter=function(e){var r,n,i,o,a=0,s=0,l=0;switch(e.type){case"MultiLineString":r=e.coordinates[0][0][0],n=e.coordinates[0][0][1];break;case"LineString":r=e.coordinates[0][0],n=e.coordinates[0][1];break;case"Point":r=e.coordinates[0],n=e.coordinates[1];break;case"Polygon":for(i=0;i<e.coordinates[0].length-1;i++)a+=e.coordinates[0][i][0],s+=e.coordinates[0][i][1],l++;r=a/l,n=s/l;break;case"MultiPolygon":for(i=0;i<e.coordinates.length;i++){var u=e.coordinates[i][0];for(o=0;o<u.length-1;o++)a+=u[o][0],s+=u[o][1],l++}r=a/l,n=s/l;break;case"LineString":t.each(e.coordinates,function(e,t){a+=e[0],s+=e[1],l++}),r=a/l,n=s/l;break;default:return}return[r,n]},l.prototype.pointInRing=function(e,t){var r=t.length;t[0][0]===t[r-1][0]&&t[0][1]===t[r-1][1]&&r--;for(var n=!1,i=r-1,o=0;o<r;i=o++)t[o][1]>e[1]!=t[i][1]>e[1]&&e[0]<(t[i][0]-t[o][0])*(e[1]-t[o][1])/(t[i][1]-t[o][1])+t[o][0]&&(n=!n);return n},l.prototype.pointInSphere=function(e,t,r){var n=[],i=[],o=this.parentElement.scene.renderContext.computePixelSizeVector();this.parentElement.scene.coordinateSystem.fromGeoTo3D(e,n),this.parentElement.scene.coordinateSystem.fromGeoTo3D(t,i);var a=r*(o[0]*i[0]+o[1]*i[1]+o[2]*i[2]+o[3]),s=[];return vec3.subtract(n,i,s),s=vec3.dot(s,s),s<a*a},l.prototype.pointInLine=function(e,t,r){var n,i,o=r[0]-t[0],a=!1;return 0===o?a=e[0]===t[0]:(i=(e[0]-t[0])/o,a=i>=0&&i<=1),!!a&&(n=r[1]-t[1],0===o?e[1]===t[1]:(i=(e[1]-t[1])/n,i>=0&&i<=1))},l.prototype.getAstroCoordinatesFromCursorLocation=function(e,r,n){var i=[];return e.coordinateSystem.from3DToGeo(r.center3d,i),t.isEmpty(n)&&(n=[]),e.coordinateSystem.getLHVTransform(i,n),this.formatCoordinates([i[0],i[1]])},l.prototype.getHEALPixCutCoordinates=function(e,t,r){for(var n=[[0,0],[t.renderContext.canvas.width,0],[t.renderContext.canvas.width,t.renderContext.canvas.height],[0,t.renderContext.canvas.height]],i=0;i<n.length;i++){var o=t.getLonLatFromPixel(n[i][0],n[i][1]);o[0]<0&&(o[0]+=360),n[i]=o}var a=[];this.getAstroCoordinatesFromCursorLocation(t,r,a);var s=[a[4],a[5],a[6]],l=vec3.dot(r.up,s),u=Math.acos(l);if(isNaN(u))return void console.error("North is NaN'ed...");var h=180*u/Math.PI;t.renderContext.viewMatrix[8]<0&&(h*=-1);var c=parseFloat($("#cdelt1").val()),d=parseFloat($("#cdelt2").val());t.baseImagery;return context.fileName||ErrorDialog.open("FITS fileName isn't defined for HealpixCut service<br/>"),isNaN(c)||isNaN(d)?void $("#HEALPixCut").find("input").each(function(){$(this).val()||$(this).addClass("inputError")}):{long1:n[0][0],lat1:n[0][1],long2:n[1][0],lat2:n[1][1],long3:n[2][0],lat3:n[2][1],long4:n[3][0],lat4:n[3][1],rotation:h,coordSystem:"EQUATORIAL",cdelt1:c,cdelt2:d,filename:context.fileName,PHASE:"RUN"}},l.prototype._getMousePos=function(e,t){var r=e.getBoundingClientRect();return{x:t.clientX-r.left,y:t.clientY-r.top}},l.prototype.isHipsFitsLayer=function(e){return e instanceof n},l.prototype.isHipsLayer=function(e){return e instanceof i},l.prototype.isOpenSearchLayer=function(e){return e instanceof r},l.prototype.isVectorLayer=function(e){return e instanceof a},l.prototype.isMocLayer=function(e){return e instanceof s},l.prototype.isPlanetLayer=function(e){return e instanceof o;
},l.prototype.convertVotable2JsonFromURL=function(e,t){var r=new XMLHttpRequest;r.open("GET",e),r.onload=function(){var e=r.responseXML;e?this.convertVotable2JsonFromXML(r.responseText,t):console.log("No XML response")},r.onerror=function(t){console.log("Error getting table "+e+"\n("+t+")")},r.send(null)},l.prototype.convertVotable2JsonFromXML=function(e,t){try{$.ajax({type:"POST",url:votable2geojsonUrl,data:{votable:e,coordSystem:"EQUATORIAL"},success:function(e){t(e)},error:function(e){console.error(e)}})}catch(e){console.log("Error displaying table:\n"+e.toString())}},l}),r("Mizar",["./Utils/Stats","./Context/ContextFactory","./Navigation/NavigationFactory","./Layer/LayerFactory","./CoordinateSystem/CoordinateSystemFactory","./AttributionHandler","./DrawingFactory","./Animation/AnimationFactory","./Parser/ParserFactory","./UtilityFactory","./Gui/Compass","./Utils/Numeric","./Utils/Utils","./Utils/ToolBox","./Utils/Event","./Utils/Constantes"],function(e,t,r,n,i,o,a,s,l,u,h,c,d,f,p,m){var v=function(e){return p.prototype.constructor.call(this),void 0===e?void console.log("Error : no options found"):void 0===e.canvas?void console.log("Error : no canvas found"):("string"==typeof e.canvas?this.canvas=document.getElementById(e.canvas):this.canvas=e.canvas,this.ContextFactory=new t(this),this.NavigationFactory=new r,this.LayerFactory=new n,this.CoordinateSystemFactory=new i,this.DrawingFactory=new a,this.AnimationFactory=new s,this.ParserFactory=new l,this.UtilityFactory=new u,this.ToolBox=new f(this,e),this.planetContext=null,this.skyContext=null,this.currentNavigation=null,this.navigations=[],this.renderContext=null,e.skyContext&&(this.skyContext=this.ContextFactory.create(this.CONTEXT.Sky,e.skyContext),e.skyContext.projection&&(e.skyContext.projection=this.CoordinateSystemFactory.create(e.skyContext.projection))),e.planetContext&&(this.renderContext&&(e.planetContext.renderContext=this.renderContext),e.planetContext.projection&&(e.planetContext.projection=this.CoordinateSystemFactory.create(e.planetContext.projection)),this.planetContext=this.ContextFactory.create(this.CONTEXT.Planet,e.planetContext)),void(e.compass&&e.compass===!0&&(this.compass=new h({element:"compassDiv",planet:this.planetContext.planet,navigation:this.navigation,coordSystem:this.planetContext.planet.coordinateSystem.type}),console.log(this.compass))))};return d.inherits(p,v),v.prototype.LAYER=m.LAYER,v.prototype.CONTEXT=m.CONTEXT,v.prototype.PROJECTION=m.PROJECTION,v.prototype.render=function(){this.renderContext.frame()},v.prototype.dispose=function(){this.planetContext?this.planetContext.dispose():this.skyContext&&this.skyContext.dispose()},v.prototype.destroy=function(){this.planetContext?this.planetContext.destroy():this.skyContext&&this.skyContext.destroy()},v.prototype.getImageData=function(e){return this.render(),canvas=document.getElementById(e),canvas?canvas.toDataURL():null},v.prototype.createStats=function(t){return this.skyContext?this.Stats=new e(this.skyContext,t):this.planetContext?this.Stats=new e(this.planetContext,t):console.log("No context"),this.Stats},v.prototype.createAttributionHandler=function(e,t){return this.AttributionHandler=new o(e,t),this.AttributionHandler},v.prototype.getContextFactory=function(){return this.ContextFactory},v.prototype.getNavigationFactory=function(){return this.NavigationFactory},v.prototype.getLayerFactory=function(){return this.LayerFactory},v.prototype.getCoordinateSystemFactory=function(){return this.CoordinateSystemFactory},v.prototype.getDrawingFactory=function(){return this.DrawingFactory},v.prototype.getAnimationFactory=function(){return this.AnimationFactory},v.prototype.getParserFactory=function(){return this.ParserFactory},v.prototype.getUtilityFactory=function(){return this.UtilityFactory},v.prototype.getUtilityNumeric=function(){return c},v.prototype.getUtils=function(){return d},v.prototype.addPlanetLayer=function(e){this.planetContext?this.planetContext.addLayer(e):console.log("No planet context defined")},v.prototype.setPlanetBaseImagery=function(e){this.planetContext?this.planetContext.setBaseImagery(e):console.log("No planet context defined")},v.prototype.setBaseElevation=function(e){this.planetContext?this.planetContext.setBaseElevation(e):console.log("No planet context defined")},v.prototype.setSkyBaseImagery=function(e){this.skyContext?this.skyContext.setBaseImagery(e):console.log("No sky context defined")},v.prototype.addSkyLayer=function(e){this.skyContext?this.skyContext.addLayer(e):console.log("No sky context defined")},v.prototype.getEvent=function(){return p},window.Mizar=v,v}),t("Mizar")});